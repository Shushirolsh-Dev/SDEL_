<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thesdel Assessment Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .glass-panel { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .hidden { display: none; }
        .option-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; outline: none; }
        .option-selected { background: #ff6600 !important; border-color: #ff6600 !important; color: white !important; }
        input { background: rgba(255,255,255,0.05) !important; color: white !important; border: 1px solid #ff660033; outline: none; }
        .subject-tab { padding: 10px 18px; border-radius: 14px; font-size: 10px; font-weight: 800; text-transform: uppercase; white-space: nowrap; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .tab-active { background: #ff6600; border-color: #ff6600; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-5 pb-32">

    <div id="join-screen" class="pt-10">
        <h2 class="text-2xl font-black text-orange-500 uppercase mb-6 tracking-tighter">Enter Exam Code</h2>
        <div class="glass-panel p-6 rounded-[32px] space-y-4">
            <input type="text" id="join-code-input" placeholder="THESDEL-XXXXXX" class="w-full p-5 rounded-2xl text-center font-bold tracking-widest uppercase text-sm border-orange-500/20">
            
            <button onclick="validateAndJoin()" id="btn-join" class="w-full bg-white text-black font-black py-5 rounded-2xl uppercase text-xs tracking-widest active:scale-95 transition">Verify & Start</button>
            
            <button onclick="window.location.href='scholars.html'" class="w-full bg-orange-600/10 text-orange-500 border border-orange-500/20 font-black py-4 rounded-2xl uppercase text-[10px]">Take Scholars Test</button>
            
            <p id="error-msg" class="text-red-500 text-[10px] font-bold text-center uppercase mt-2 hidden"></p>
        </div>
    </div>

    <div id="exam-screen" class="hidden">
        <div class="flex justify-between items-center mb-6">
            <h3 id="exam-title" class="text-xs font-black uppercase text-orange-500"></h3>
            <p id="timer" class="text-2xl font-black text-white tabular-nums">00:00</p>
        </div>
        <div id="subject-nav" class="flex gap-2 overflow-x-auto pb-6 no-scrollbar"></div>
        <div class="glass-panel p-7 rounded-[35px] min-h-[160px] flex items-center mb-6">
            <p id="question-text" class="text-lg font-bold leading-snug"></p>
        </div>
        <div class="space-y-3" id="options-container"></div>
        <div class="fixed bottom-10 left-5 right-5 grid grid-cols-3 gap-3">
            <button onclick="prevQuestion()" class="glass-panel py-5 rounded-2xl font-black text-[10px] uppercase">Back</button>
            <button onclick="confirmSubmit()" class="bg-orange-600 text-white py-5 rounded-2xl font-black text-[10px] uppercase">Submit</button>
            <button onclick="nextQuestion()" class="glass-panel py-5 rounded-2xl font-black text-[10px] uppercase">Next</button>
        </div>
    </div>

    <div id="result-screen" class="hidden text-center pt-10">
        <div class="glass-panel p-12 rounded-[50px] border border-orange-500/20">
            <h1 id="score-text" class="text-7xl font-black text-white mb-2">0/0</h1>
            <p id="xp-gain" class="text-orange-500 font-black text-sm uppercase">COMPLETED</p>
        </div>
        <button onclick="window.location.href='index.html'" class="mt-12 bg-white text-black px-12 py-5 rounded-2xl font-black uppercase text-xs">Finish</button>
    </div>

    <script>
        const _URL = "https://lgfyrlfjoazedwymjpfc.supabase.co";
        const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw";
        const sb = supabase.createClient(_URL, _KEY);

        let allQuestions = []; 
        let subjects = []; 
        let activeSub = ""; 
        let subQuestions = []; 
        let userAnswers = {}; 
        let currentIdx = 0; 
        let activeBuildId = null;
        let timeLeft = 0;
        let isExamActive = false;
        const userId = localStorage.getItem('thesdel_user_id');

        async function validateAndJoin() {
            const inputCode = document.getElementById('join-code-input').value.trim();
            const btn = document.getElementById('btn-join');
            const err = document.getElementById('error-msg');

            if(!inputCode) return;

            btn.innerText = "AUTHENTICATING...";
            btn.disabled = true;
            err.classList.add('hidden');

            try {
                // 1. Fetch using a standard select to avoid .single() crashing if multiple/none found
                const { data: builds, error: bErr } = await sb
                    .from('cbt_builds')
                    .select('*')
                    .eq('join_code', inputCode);

                if (bErr) throw bErr;

                if (builds && builds.length > 0) {
                    const build = builds[0];

                    // 2. Double Attempt Check
                    const { data: check } = await sb.from('cbt_results')
                        .select('id')
                        .eq('user_id', userId)
                        .eq('build_id', build.id);

                    if (check && check.length > 0) {
                        btn.innerText = "Verify & Start";
                        btn.disabled = false;
                        err.innerText = "ACCESS DENIED: EXAM ALREADY TAKEN.";
                        err.classList.remove('hidden');
                        return;
                    }

                    // 3. SECURE QUESTION FETCH (No correct_answer in browser)
                    const { data: qData, error: qErr } = await sb
                        .from('cbt_questions')
                        .select('id, subject_tag, question_text, option_a, option_b, option_c, option_d')
                        .eq('build_id', build.id);

                    if (qErr) throw qErr;

                    if (qData && qData.length > 0) {
                        allQuestions = qData;
                        subjects = build.subjects_list || ["General"];
                        activeBuildId = build.id;
                        startExam(build);
                    } else {
                        throw new Error("EXAM HAS NO QUESTIONS.");
                    }
                } else {
                    throw new Error("CODE NOT FOUND IN DATABASE.");
                }
            } catch (e) {
                btn.innerText = "Verify & Start";
                btn.disabled = false;
                err.innerText = e.message;
                err.classList.remove('hidden');
            }
        }

        function startExam(build) {
            isExamActive = true;
            document.getElementById('join-screen').classList.add('hidden');
            document.getElementById('exam-screen').classList.remove('hidden');
            document.getElementById('exam-title').innerText = build.build_name;
            timeLeft = (build.duration_mins || 30) * 60;
            
            startTimer();
            switchSubject(subjects[0]);
        }

        function switchSubject(subName) {
            activeSub = subName;
            // Filter by tag. If no tags found (or if it was a general build), show all
            subQuestions = allQuestions.filter(q => q.subject_tag === subName);
            if (subQuestions.length === 0) subQuestions = allQuestions; 

            currentIdx = 0;
            renderTabs();
            showQuestion();
        }

        function renderTabs() {
            const nav = document.getElementById('subject-nav');
            if(subjects.length <= 1) { nav.innerHTML = ""; return; }
            nav.innerHTML = subjects.map(s => `
                <div onclick="switchSubject('${s}')" class="subject-tab ${s === activeSub ? 'tab-active' : ''}">${s}</div>
            `).join('');
        }

        function showQuestion() {
            const q = subQuestions[currentIdx];
            document.getElementById('question-text').innerText = q.question_text;
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            ['a', 'b', 'c', 'd'].forEach(opt => {
                const key = opt.toUpperCase();
                const btn = document.createElement('button');
                btn.className = `option-btn w-full p-6 rounded-2xl text-left font-bold text-sm uppercase flex justify-between items-center ${userAnswers[q.id] === key ? 'option-selected' : ''}`;
                btn.innerHTML = `<span>${q[`option_${opt}`]}</span> <span class="opacity-30 text-[10px]">${key}</span>`;
                btn.onclick = () => { userAnswers[q.id] = key; showQuestion(); };
                container.appendChild(btn);
            });
        }

        function nextQuestion() { if (currentIdx < subQuestions.length - 1) { currentIdx++; showQuestion(); } }
        function prevQuestion() { if (currentIdx > 0) { currentIdx--; showQuestion(); } }

        function startTimer() {
            const timerDisplay = document.getElementById('timer');
            const interval = setInterval(() => {
                if(!isExamActive) { clearInterval(interval); return; }
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                timerDisplay.innerText = `${m}:${s.toString().padStart(2, '0')}`;
                if (timeLeft <= 0) { clearInterval(interval); finishExam(); }
                timeLeft--;
            }, 1000);
        }

        function confirmSubmit() { if (confirm("Submit Assessment?")) finishExam(); }

        async function finishExam() {
            isExamActive = false;
            // Fetch keys from server at the last second for security
            const { data: keys } = await sb.from('cbt_questions').select('id, correct_answer').eq('build_id', activeBuildId);
            
            let score = 0;
            keys.forEach(k => { if (userAnswers[k.id] === k.correct_answer) score++; });

            document.getElementById('exam-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('score-text').innerText = `${score}/${allQuestions.length}`;
            
            // Log result
            await sb.from('cbt_results').insert([{ user_id: userId, build_id: activeBuildId, score: score, total_questions: allQuestions.length }]);
        }
    </script>
</body>
</html>
