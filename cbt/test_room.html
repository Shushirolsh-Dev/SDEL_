<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thesdel Secure Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; user-select: none; }
        .glass-panel { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .option-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 20px; transition: 0.2s; cursor: pointer; }
        .option-selected { border-color: #ff6600; background: rgba(255, 102, 0, 0.1); box-shadow: 0 0 15px rgba(255, 102, 0, 0.2); }
        .subject-pill { padding: 8px 16px; border-radius: 99px; font-size: 10px; font-weight: 800; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .subject-active { background: #ff6600; border-color: #ff6600; color: white; box-shadow: 0 0 15px rgba(255, 102, 0, 0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .timer-low { color: #ef4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .hidden { display: none; }
        
        /* Review Colors */
        .rev-correct { border-color: #22c55e !important; background: rgba(34, 197, 94, 0.1) !important; }
        .rev-wrong { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; }
    </style>
</head>
<body class="p-6">

    <script>
        history.pushState(null, null, location.href);
        window.onpopstate = function () { history.go(1); };
    </script>

    <div id="submit-confirm-modal" class="fixed inset-0 z-[500] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-panel p-8 rounded-[40px] w-full max-w-sm text-center border-orange-500/30">
            <h2 class="text-xl font-black uppercase tracking-tighter">End Battle?</h2>
            <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mt-2 leading-relaxed">Unanswered questions and mistakes result in -10 XP penalty.</p>
            <div class="mt-8 flex flex-col gap-3">
                <button onclick="finishExam()" class="w-full bg-orange-600 text-white font-black py-5 rounded-2xl uppercase text-[10px] tracking-widest active:scale-95 transition">Submit Now</button>
                <button onclick="closeSubmitModal()" class="w-full bg-white/5 text-gray-400 font-black py-5 rounded-2xl uppercase text-[10px] tracking-widest">Reject</button>
            </div>
        </div>
    </div>

    <div id="exam-ui" class="hidden max-w-xl mx-auto h-screen flex flex-col">
        <div class="flex justify-between items-center py-6">
            <p id="timer" class="text-xl font-mono font-bold">00:00</p>
            <button onclick="openSubmitModal()" class="bg-red-600/10 text-red-500 px-6 py-3 rounded-full text-[10px] font-black uppercase tracking-widest">End Exam</button>
        </div>

        <div id="subject-tabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-4"></div>

        <div class="flex-1 overflow-y-auto no-scrollbar space-y-6 pt-4" id="question-area">
            <div class="flex justify-between items-center">
                <span id="display-q-num" class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Question 1</span>
            </div>
            <p id="question-text" class="text-lg font-bold leading-relaxed"></p>
            <div id="options-container" class="space-y-3 pb-20">
                <div onclick="selectOpt('A')" id="card-A" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">A</span>
                    <p id="text-A" class="text-sm font-semibold"></p>
                </div>
                <div onclick="selectOpt('B')" id="card-B" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">B</span>
                    <p id="text-B" class="text-sm font-semibold"></p>
                </div>
                <div onclick="selectOpt('C')" id="card-C" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">C</span>
                    <p id="text-C" class="text-sm font-semibold"></p>
                </div>
                <div onclick="selectOpt('D')" id="card-D" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">D</span>
                    <p id="text-D" class="text-sm font-semibold"></p>
                </div>
            </div>
        </div>

        <div class="py-8 flex gap-3" id="nav-btns">
            <button id="btn-prev" onclick="prevQuestion()" class="flex-1 glass-panel py-5 rounded-[24px] text-[10px] font-black uppercase">Prev</button>
            <button id="btn-next" onclick="nextQuestion()" class="flex-[2] bg-white text-black py-5 rounded-[24px] font-black uppercase text-[10px] tracking-widest">Next</button>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 z-[400] bg-black hidden flex-col p-8 overflow-y-auto">
        <div class="max-w-md mx-auto w-full text-center pt-10">
            <h2 class="text-4xl font-black uppercase tracking-tighter mb-2">Final Verdict</h2>
            <p id="res-status" class="text-[10px] font-black uppercase tracking-[0.3em] text-gray-500 mb-8"></p>
            
            <div class="grid grid-cols-2 gap-4 mb-10">
                <div class="glass-panel p-6 rounded-[32px]">
                    <p class="text-[8px] text-gray-500 font-black mb-1 uppercase">Accuracy</p>
                    <p id="res-score" class="text-2xl font-black text-orange-500"></p>
                </div>
                <div class="glass-panel p-6 rounded-[32px]">
                    <p class="text-[8px] text-gray-500 font-black mb-1 uppercase">XP Shift</p>
                    <p id="res-xp" class="text-2xl font-black"></p>
                </div>
            </div>

            <h3 class="text-left text-[10px] font-black uppercase tracking-widest mb-4 text-gray-400">Battle Review</h3>
            <div id="review-list" class="space-y-4 text-left mb-10"></div>

            <button onclick="location.href='join.html'" class="w-full bg-white text-black py-6 rounded-3xl font-black text-[10px] uppercase tracking-widest mb-10">Exit Arena</button>
        </div>
    </div>

    <script>
        const _URL = "https://lgfyrlfjoazedwymjpfc.supabase.co";
        const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw";
        const sb = supabase.createClient(_URL, _KEY);

        const examId = localStorage.getItem('active_exam_id');
        const studentName = localStorage.getItem('student_name');
        
        let allQuestions = [];
        let filteredQuestions = [];
        let activeSub = "";
        let currentIndex = 0;
        let selectedAnswers = {}; 
        let timeLeft = 0;
        let timerInterval;

        async function initRoom() {
            const { data: { user } } = await sb.auth.getUser();
            if (!user || !examId) return window.location.href = 'join.html';

            const { data: existing } = await sb.from('cbt_results').select('id').eq('build_id', examId).eq('user_id', user.id).single();
            if (existing) {
                document.body.innerHTML = `<div class="h-screen flex items-center justify-center bg-black text-center p-10"><div class="glass-panel p-10 rounded-[40px] border-red-500/20"><h2 class="text-orange-500 font-black uppercase">Battle Already Fought</h2><p class="text-[10px] text-gray-500 mt-4 uppercase font-bold leading-relaxed">You have submitted this exam and cannot retake it.</p></div></div>`;
                return;
            }

            const { data: qs } = await sb.from('cbt_questions').select('*').eq('build_id', examId);
            allQuestions = qs;
            
            const subjects = [...new Set(qs.map(q => q.subject_tag))];
            renderTabs(subjects);
            switchSubject(subjects[0]);

            const examDuration = parseInt(localStorage.getItem('exam_duration')) * 60;
            const startTimeKey = `start_${examId}_${user.id}`;
            let savedStart = localStorage.getItem(startTimeKey);
            if (!savedStart) { savedStart = Date.now(); localStorage.setItem(startTimeKey, savedStart); }
            
            timeLeft = examDuration - Math.floor((Date.now() - savedStart) / 1000);
            if (timeLeft <= 0) return finishExam();

            startTimer();
            document.getElementById('exam-ui').classList.remove('hidden');
        }

        function renderTabs(subs) {
            document.getElementById('subject-tabs').innerHTML = subs.map(s => `<div id="tab-${s}" onclick="switchSubject('${s}')" class="subject-pill">${s}</div>`).join('');
        }

        function switchSubject(s) {
            activeSub = s;
            document.querySelectorAll('.subject-pill').forEach(p => p.classList.remove('subject-active'));
            document.getElementById(`tab-${s}`).classList.add('subject-active');
            filteredQuestions = allQuestions.filter(q => q.subject_tag === s);
            currentIndex = 0;
            renderQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
                document.getElementById('timer').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if (timeLeft < 60) document.getElementById('timer').classList.add('timer-low');
                if (timeLeft <= 0) finishExam();
            }, 1000);
        }

        function renderQuestion() {
            const q = filteredQuestions[currentIndex];
            document.getElementById('display-q-num').innerText = `Question ${currentIndex + 1} of ${filteredQuestions.length}`;
            document.getElementById('question-text').innerText = q.question_text;
            document.getElementById('text-A').innerText = q.option_a;
            document.getElementById('text-B').innerText = q.option_b;
            document.getElementById('text-C').innerText = q.option_c;
            document.getElementById('text-D').innerText = q.option_d;
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('option-selected'));
            if (selectedAnswers[q.id]) document.getElementById(`card-${selectedAnswers[q.id]}`).classList.add('option-selected');
        }

        function selectOpt(opt) {
            selectedAnswers[filteredQuestions[currentIndex].id] = opt;
            renderQuestion();
        }

        function nextQuestion() { if (currentIndex < filteredQuestions.length - 1) { currentIndex++; renderQuestion(); } }
        function prevQuestion() { if (currentIndex > 0) { currentIndex--; renderQuestion(); } }

        function openSubmitModal() { document.getElementById('submit-confirm-modal').classList.replace('hidden', 'flex'); }
        function closeSubmitModal() { document.getElementById('submit-confirm-modal').classList.replace('flex', 'hidden'); }

        async function finishExam() {
            clearInterval(timerInterval);
            const { data: { user } } = await sb.auth.getUser();
            
            let correctCount = 0;
            let missedCount = 0;
            let reviewHtml = "";

            allQuestions.forEach((q, idx) => {
                const userAns = selectedAnswers[q.id];
                const isCorrect = userAns === q.correct_answer;
                
                if (isCorrect) correctCount++; else missedCount++;

                reviewHtml += `
                    <div class="glass-panel p-5 rounded-2xl border-l-4 ${isCorrect ? 'border-l-green-500' : 'border-l-red-500'}">
                        <p class="text-[9px] font-black text-gray-500 uppercase mb-2">${q.subject_tag} - Q${idx+1}</p>
                        <p class="text-sm font-bold mb-3">${q.question_text}</p>
                        <div class="text-[10px] font-black uppercase">
                            <span class="${isCorrect ? 'text-green-500' : 'text-red-500'}">Your Ans: ${userAns || 'NONE'}</span>
                            ${!isCorrect ? `<span class="text-green-500 ml-4">Correct: ${q.correct_answer}</span>` : ''}
                        </div>
                    </div>`;
            });

            const netXp = (correctCount * 10) - (missedCount * 10);

            // Update Database
            await sb.from('cbt_results').insert([{ build_id: examId, user_id: user.id, username: studentName, score: correctCount, total_questions: allQuestions.length }]);
            
            const { data: profile } = await sb.from('profiles').select('xp').eq('id', user.id).single();
            await sb.from('profiles').update({ xp: Math.max(0, (profile?.xp || 0) + netXp) }).eq('id', user.id);

            // UI Finalize
            document.getElementById('exam-ui').classList.add('hidden');
            document.getElementById('res-score').innerText = `${correctCount}/${allQuestions.length}`;
            const xpEl = document.getElementById('res-xp');
            xpEl.innerText = (netXp >= 0 ? "+" : "") + netXp;
            xpEl.className = `text-2xl font-black ${netXp >= 0 ? 'text-green-500' : 'text-red-500'}`;
            document.getElementById('review-list').innerHTML = reviewHtml;
            document.getElementById('result-modal').classList.replace('hidden', 'flex');
            localStorage.removeItem(`start_${examId}_${user.id}`);
            closeSubmitModal();
        }

        initRoom();
    </script>
</body>
</html>
