<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Thesdel Secure Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; user-select: none; }
        .glass-panel { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .option-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 20px; transition: 0.2s; cursor: pointer; }
        .option-selected { border-color: #ff6600; background: rgba(255, 102, 0, 0.1); box-shadow: 0 0 15px rgba(255, 102, 0, 0.2); }
        .subject-pill { padding: 8px 16px; border-radius: 99px; font-size: 10px; font-weight: 800; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .subject-active { background: #ff6600; border-color: #ff6600; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-6">

    <script>
        // HISTORY KILLER
        history.pushState(null, null, location.href);
        window.onpopstate = function () { history.go(1); };
    </script>

    <div id="loading-gate" class="fixed inset-0 z-[999] bg-black flex items-center justify-center">
        <p class="text-[10px] font-black uppercase tracking-[0.5em] animate-pulse">Verifying Identity...</p>
    </div>

    <div id="exam-ui" class="hidden max-w-xl mx-auto h-screen flex flex-col">
        <div class="flex justify-between items-center py-6">
            <p id="timer" class="text-xl font-mono font-bold">00:00</p>
            <button onclick="openSubmitModal()" class="bg-red-600/10 text-red-500 px-6 py-3 rounded-full text-[10px] font-black uppercase tracking-widest">End Exam</button>
        </div>
        <div id="subject-tabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-4"></div>
        <div class="flex-1 overflow-y-auto no-scrollbar space-y-6 pt-4">
            <span id="display-q-num" class="text-[10px] font-black text-gray-500 uppercase">Question 1</span>
            <p id="question-text" class="text-lg font-bold leading-relaxed"></p>
            <div id="options-container" class="space-y-3 pb-20">
                <div onclick="selectOpt('A')" id="card-A" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">A</span>
                    <p id="text-A" class="text-sm font-semibold"></p>
                </div>
                <div onclick="selectOpt('B')" id="card-B" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">B</span>
                    <p id="text-B" class="text-sm font-semibold"></p>
                </div>
                <div onclick="selectOpt('C')" id="card-C" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">C</span>
                    <p id="text-C" class="text-sm font-semibold"></p>
                </div>
                <div onclick="selectOpt('D')" id="card-D" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">D</span>
                    <p id="text-D" class="text-sm font-semibold"></p>
                </div>
            </div>
        </div>
        <div class="py-8 flex gap-3">
            <button onclick="prevQuestion()" class="flex-1 glass-panel py-5 rounded-[24px] text-[10px] font-black uppercase">Prev</button>
            <button onclick="nextQuestion()" class="flex-[2] bg-white text-black py-5 rounded-[24px] font-black uppercase text-[10px]">Next</button>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 z-[400] bg-black hidden flex-col p-8 overflow-y-auto">
        <div class="max-w-md mx-auto w-full text-center pt-10">
            <h2 class="text-4xl font-black uppercase tracking-tighter mb-8">Scorecard</h2>
            <div class="grid grid-cols-2 gap-4 mb-10">
                <div class="glass-panel p-6 rounded-[32px] text-center"><p id="res-score" class="text-2xl font-black text-orange-500"></p></div>
                <div class="glass-panel p-6 rounded-[32px] text-center"><p id="res-xp" class="text-2xl font-black"></p></div>
            </div>
            <div id="review-list" class="space-y-4 text-left mb-10"></div>
            <button onclick="window.location.replace('/cbt/index.html')" class="w-full bg-white text-black py-6 rounded-3xl font-black text-[10px] uppercase">Exit Arena</button>
        </div>
    </div>

    <script>
        const _URL = "https://lgfyrlfjoazedwymjpfc.supabase.co";
        const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw";
        const sb = supabase.createClient(_URL, _KEY);

        const examId = localStorage.getItem('active_exam_id');
        let allQuestions = [], filteredQuestions = [], activeSub = "", currentIndex = 0, selectedAnswers = {}, timeLeft = 0, timerInterval;

        async function verifyAndLock() {
            const { data: { user } } = await sb.auth.getUser();
            
            // IF NO USER, KICK THEM OUT
            if (!user || !examId) return window.location.replace('/cbt/index.html');

            // THE REAL LOCK: Checking if THIS UUID exists for THIS EXAM in cbt_results
            const { data: check, error: checkErr } = await sb.from('cbt_results')
                .select('id')
                .eq('build_id', examId)
                .eq('user_id', user.id)
                .maybeSingle();

            if (check) {
                document.body.innerHTML = `<div class="h-screen flex items-center justify-center bg-black text-center p-10"><div class="glass-panel p-10 rounded-[40px] border-red-500/50"><h1 class="text-red-500 font-black uppercase text-xl">Access Denied</h1><p class="text-[10px] text-gray-500 mt-4 font-bold uppercase">Record already exists. No retakes.</p><button onclick="window.location.replace('/cbt/index.html')" class="mt-8 bg-white text-black px-10 py-4 rounded-2xl font-black text-[10px] uppercase">Back to Hub</button></div></div>`;
                return;
            }

            // Start everything only if we passed the check
            document.getElementById('loading-gate').remove();
            initRoom(user);
        }

        async function initRoom(user) {
            const { data: qs } = await sb.from('cbt_questions').select('*').eq('build_id', examId);
            allQuestions = qs;
            const subjects = [...new Set(qs.map(q => q.subject_tag))];
            renderTabs(subjects);
            switchSubject(subjects[0]);

            timeLeft = parseInt(localStorage.getItem('exam_duration')) * 60;
            startTimer();
            document.getElementById('exam-ui').classList.remove('hidden');
        }

        async function finishExam() {
            clearInterval(timerInterval);
            const { data: { user } } = await sb.auth.getUser();
            
            let correct = 0;
            allQuestions.forEach(q => { if (selectedAnswers[q.id] === q.correct_answer) correct++; });

            // 1. URGENT: ATTEMPT TO SAVE RESULT
            const { error: saveErr } = await sb.from('cbt_results').insert([{ 
                build_id: examId, 
                user_id: user.id, // IF THIS IS NULL, THE LOCK FAILS.
                username: localStorage.getItem('student_name'), 
                score: correct, 
                total_questions: allQuestions.length 
            }]);

            if (saveErr) {
                console.error("Critical Save Error:", saveErr);
                alert("Critical Error: Result not saved. Check console.");
                return;
            }

            // 2. CLEANUP & SHOW RESULTS
            localStorage.removeItem('active_exam_id');
            document.getElementById('exam-ui').classList.add('hidden');
            document.getElementById('res-score').innerText = `${correct}/${allQuestions.length}`;
            document.getElementById('result-modal').classList.replace('hidden', 'flex');
        }

        // ... Keep existing UI helper functions (renderTabs, switchSubject, selectOpt, etc.) ...

        verifyAndLock();
    </script>
</body>
                    </html>
    
