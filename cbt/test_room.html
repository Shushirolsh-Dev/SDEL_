<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Thesdel Secure Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; user-select: none; }
        .glass-panel { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .option-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 20px; transition: 0.2s; cursor: pointer; }
        .option-selected { border-color: #ff6600; background: rgba(255, 102, 0, 0.1); box-shadow: 0 0 15px rgba(255, 102, 0, 0.2); }
        .subject-pill { padding: 8px 16px; border-radius: 99px; font-size: 10px; font-weight: 800; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .subject-active { background: #ff6600; border-color: #ff6600; color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .timer-low { color: #ef4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .hidden { display: none; }
    </style>
</head>
<body class="p-6">

    <script>
        // BLOCK BACK BUTTON
        history.pushState(null, null, location.href);
        window.onpopstate = function () { history.go(1); };
    </script>

    <div id="loading-gate" class="fixed inset-0 z-[999] bg-black flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-orange-500/20 border-t-orange-500 rounded-full animate-spin mb-4"></div>
        <p class="text-[10px] font-black uppercase tracking-[0.4em] text-gray-500">Syncing Battle Data...</p>
    </div>

    <div id="submit-confirm-modal" class="fixed inset-0 z-[500] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass-panel p-8 rounded-[40px] w-full max-w-sm text-center border-orange-500/30">
            <h2 class="text-xl font-black uppercase tracking-tighter">End Battle?</h2>
            <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mt-2">Mistakes cost -10 XP. Submit now?</p>
            <div class="mt-8 flex flex-col gap-3">
                <button id="final-sub-btn" onclick="finishExam()" class="w-full bg-orange-600 text-white font-black py-5 rounded-2xl uppercase text-[10px] tracking-widest active:scale-95 transition">Submit Now</button>
                <button onclick="closeSubmitModal()" class="w-full bg-white/5 text-gray-400 font-black py-5 rounded-2xl uppercase text-[10px] tracking-widest">Reject</button>
            </div>
        </div>
    </div>

    <div id="exam-ui" class="hidden max-w-xl mx-auto h-screen flex flex-col">
        <div class="flex justify-between items-center py-6">
            <p id="timer" class="text-xl font-mono font-bold">00:00</p>
            <button onclick="openSubmitModal()" class="bg-red-600/10 text-red-500 px-6 py-3 rounded-full text-[10px] font-black uppercase tracking-widest">End Exam</button>
        </div>
        <div id="subject-tabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-4"></div>
        <div class="flex-1 overflow-y-auto no-scrollbar space-y-6 pt-4">
            <span id="display-q-num" class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Question 1</span>
            <p id="question-text" class="text-lg font-bold leading-relaxed"></p>
            <div id="options-container" class="space-y-3 pb-20">
                <div onclick="selectOpt('A')" id="card-A" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">A</span>
                    <p id="text-A" class="text-sm font-semibold"></p>
                </div>
                <div onclick="selectOpt('B')" id="card-B" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">B</span>
                    <p id="text-B" class="text-sm font-semibold"></p>
                </div>
                <div onclick="selectOpt('C')" id="card-C" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">C</span>
                    <p id="text-C" class="text-sm font-semibold"></p>
                </div>
                <div onclick="selectOpt('D')" id="card-D" class="option-card flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-black">D</span>
                    <p id="text-D" class="text-sm font-semibold"></p>
                </div>
            </div>
        </div>
        <div class="py-8 flex gap-3">
            <button onclick="prevQuestion()" class="flex-1 glass-panel py-5 rounded-[24px] text-[10px] font-black uppercase">Prev</button>
            <button onclick="nextQuestion()" class="flex-[2] bg-white text-black py-5 rounded-[24px] font-black uppercase text-[10px] tracking-widest">Next</button>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 z-[400] bg-black hidden flex-col p-8 overflow-y-auto">
        <div class="max-w-md mx-auto w-full text-center pt-10">
            <h2 class="text-4xl font-black uppercase tracking-tighter mb-8 italic">Battle Result</h2>
            <div class="grid grid-cols-2 gap-4 mb-10">
                <div class="glass-panel p-6 rounded-[32px] text-center">
                    <p class="text-[8px] text-gray-500 font-black mb-1">SCORE</p>
                    <p id="res-score" class="text-2xl font-black text-orange-500"></p>
                </div>
                <div class="glass-panel p-6 rounded-[32px] text-center">
                    <p class="text-[8px] text-gray-500 font-black mb-1">XP SHIFT</p>
                    <p id="res-xp" class="text-2xl font-black"></p>
                </div>
            </div>
            <div id="review-list" class="space-y-4 text-left mb-10"></div>
            <button onclick="window.location.replace('/cbt/index.html')" class="w-full bg-white text-black py-6 rounded-3xl font-black text-[10px] uppercase tracking-widest">Exit Arena</button>
        </div>
    </div>

    <script>
        const _URL = "https://lgfyrlfjoazedwymjpfc.supabase.co";
        const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw";
        const sb = supabase.createClient(_URL, _KEY);

        const examId = localStorage.getItem('active_exam_id');
        let allQuestions = [], filteredQuestions = [], activeSub = "", currentIndex = 0, selectedAnswers = {}, timeLeft = 0, timerInterval;

        // --- THE GATEKEEPER ---
        async function verifyAndLock() {
            try {
                const { data: { user } } = await sb.auth.getUser();
                if (!user || !examId) return window.location.replace('/cbt/index.html');

                const { data: check } = await sb.from('cbt_results')
                    .select('id')
                    .eq('build_id', examId)
                    .eq('user_id', user.id)
                    .maybeSingle();

                if (check) {
                    document.body.innerHTML = `
                    <div class="h-screen flex items-center justify-center bg-black text-center p-10">
                        <div class="glass-panel p-10 rounded-[40px] border-red-500/30">
                            <h1 class="text-red-500 font-black uppercase text-xl italic">Battle Recorded</h1>
                            <p class="text-[10px] text-gray-500 mt-4 font-bold uppercase tracking-widest leading-relaxed">Retakes are prohibited to maintain the leaderboards.</p>
                            <button onclick="window.location.replace('/cbt/index.html')" class="mt-8 bg-white text-black px-10 py-4 rounded-2xl font-black text-[10px] uppercase">Back to Base</button>
                        </div>
                    </div>`;
                    return;
                }

                const { data: qs } = await sb.from('cbt_questions').select('*').eq('build_id', examId);
                if (!qs || qs.length === 0) throw new Error("No Questions Found");
                
                allQuestions = qs;
                const subjects = [...new Set(qs.map(q => q.subject_tag))];
                renderTabs(subjects);
                switchSubject(subjects[0]);

                timeLeft = parseInt(localStorage.getItem('exam_duration')) * 60 || 1800;
                startTimer();

                document.getElementById('loading-gate').remove();
                document.getElementById('exam-ui').classList.remove('hidden');

            } catch (err) {
                alert("GATE ERROR: " + err.message);
                window.location.replace('/cbt/index.html');
            }
        }

        // --- CORE LOGIC ---
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                document.getElementById('timer').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if (timeLeft < 60) document.getElementById('timer').classList.add('timer-low');
                if (timeLeft <= 0) finishExam();
            }, 1000);
        }

        function renderTabs(subs) {
            document.getElementById('subject-tabs').innerHTML = subs.map(s => `<div id="tab-${s}" onclick="switchSubject('${s}')" class="subject-pill">${s}</div>`).join('');
        }

        function switchSubject(s) {
            activeSub = s;
            document.querySelectorAll('.subject-pill').forEach(p => p.classList.remove('subject-active'));
            document.getElementById(`tab-${s}`).classList.add('subject-active');
            filteredQuestions = allQuestions.filter(q => q.subject_tag === s);
            currentIndex = 0;
            renderQuestion();
        }

        function renderQuestion() {
            const q = filteredQuestions[currentIndex];
            document.getElementById('display-q-num').innerText = `Question ${currentIndex + 1} of ${filteredQuestions.length}`;
            document.getElementById('question-text').innerText = q.question_text;
            document.getElementById('text-A').innerText = q.option_a;
            document.getElementById('text-B').innerText = q.option_b;
            document.getElementById('text-C').innerText = q.option_c;
            document.getElementById('text-D').innerText = q.option_d;
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('option-selected'));
            if (selectedAnswers[q.id]) document.getElementById(`card-${selectedAnswers[q.id]}`).classList.add('option-selected');
        }

        function selectOpt(opt) { selectedAnswers[filteredQuestions[currentIndex].id] = opt; renderQuestion(); }
        function nextQuestion() { if (currentIndex < filteredQuestions.length - 1) { currentIndex++; renderQuestion(); } }
        function prevQuestion() { if (currentIndex > 0) { currentIndex--; renderQuestion(); } }
        function openSubmitModal() { document.getElementById('submit-confirm-modal').classList.replace('hidden', 'flex'); }
        function closeSubmitModal() { document.getElementById('submit-confirm-modal').classList.replace('flex', 'hidden'); }

        // --- THE FINISHER: XP + LOCK ---
        async function finishExam() {
            const btn = document.getElementById('final-sub-btn');
            btn.disabled = true;
            btn.innerText = "UPDATING PROFILE...";

            clearInterval(timerInterval);
            
            try {
                const { data: { user } } = await sb.auth.getUser();
                
                let correct = 0;
                let missed = 0;
                allQuestions.forEach(q => {
                    if (selectedAnswers[q.id] === q.correct_answer) correct++;
                    else missed++;
                });

                // Calculate Delta
                const xpDelta = (correct * 10) - (missed * 10);

                // 1. Fetch Current XP
                const { data: profile } = await sb.from('profile').select('xp').eq('id', user.id).single();
                const currentXp = parseInt(profile.xp) || 0;
                const newXp = Math.max(0, currentXp + xpDelta);

                // 2. Insert Score Record (The Lock)
                const { error: saveErr } = await sb.from('cbt_results').insert([{ 
                    user_id: user.id, 
                    build_id: examId, 
                    score: correct, 
                    total_questions: allQuestions.length 
                }]);

                if (saveErr) throw new Error("Could not save result: " + saveErr.message);

                // 3. Update XP in Profile
                await sb.from('profile').update({ xp: newXp }).eq('id', user.id);

                // 4. Wipe Local Storage
                localStorage.removeItem('active_exam_id');

                // 5. Update UI
                document.getElementById('exam-ui').classList.add('hidden');
                document.getElementById('res-score').innerText = `${correct}/${allQuestions.length}`;
                
                const xpDisplay = document.getElementById('res-xp');
                xpDisplay.innerText = (xpDelta >= 0 ? "+" : "") + xpDelta + " XP";
                xpDisplay.className = `text-2xl font-black ${xpDelta >= 0 ? 'text-green-500' : 'text-red-500'}`;

                document.getElementById('result-modal').classList.replace('hidden', 'flex');
                closeSubmitModal();

            } catch (err) {
                alert("SUBMIT ERROR: " + err.message);
                btn.disabled = false;
                btn.innerText = "Resubmit Battle";
            }
        }

        verifyAndLock();
    </script>
</body>
</html>
