<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thesdel Creator Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .glass-panel { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, textarea, select { background: rgba(255,255,255,0.05) !important; color: white !important; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; outline: none; }
        .hidden { display: none; }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .subject-pill { padding: 6px 12px; border-radius: 99px; font-size: 10px; font-weight: 800; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; }
        .subject-active { background: #ff6600; border-color: #ff6600; color: white; }
        .nav-link { color: #666; font-size: 9px; font-weight: 800; text-transform: uppercase; text-decoration: none; }
        .nav-active { color: #ff6600; }
        .copy-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #ff6600; padding: 10px 20px; border-radius: 12px; font-size: 10px; font-weight: 900; z-index: 1000; display: none; }
    </style>
</head>
<body class="p-5 pb-32">

    <div id="toast" class="copy-toast">CODE COPIED TO CLIPBOARD!</div>

    <div class="flex justify-between items-center mb-8">
        <h1 class="text-xl font-black tracking-tighter uppercase">Thesdel <span class="text-orange-500">Studio</span></h1>
        <div class="flex gap-4">
            <button onclick="showSection('create')" id="btn-create" class="text-[10px] font-black uppercase text-orange-500">Create</button>
            <button onclick="showSection('manage')" id="btn-manage" class="text-[10px] font-black uppercase text-gray-500">Vault</button>
        </div>
    </div>

    <div id="slide-config" class="slide-in">
        <div class="glass-panel p-6 rounded-[32px] space-y-5">
            <div>
                <label class="text-[9px] font-black text-gray-500 uppercase ml-1">Exam Title</label>
                <input type="text" id="exam-title" placeholder="e.g. 200L First Semester Finals" class="w-full p-4 mt-1">
            </div>

            <div>
                <label class="text-[9px] font-black text-gray-500 uppercase ml-1">Search & Add Subjects (Max 4)</label>
                <input type="text" id="subject-search" oninput="searchSubjects()" placeholder="Type subject (e.g. GST 101, Anatomy...)" class="w-full p-4 mt-1 mb-3">
                <div id="search-results" class="flex flex-wrap gap-2 mb-4"></div>
                
                <p class="text-[8px] font-black text-gray-500 uppercase mb-2">Selected Subjects:</p>
                <div id="selected-list" class="flex flex-wrap gap-2 min-h-[30px]"></div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[9px] font-black text-gray-500 uppercase ml-1">Time (Mins)</label>
                    <input type="number" id="exam-duration" value="30" class="w-full p-4 mt-1">
                </div>
                <button onclick="initiateBuild()" class="bg-orange-600 text-white font-black rounded-2xl mt-5 uppercase text-[10px]">Start Build</button>
            </div>
        </div>
    </div>

    <div id="slide-questions" class="hidden slide-in">
        <div id="subject-tabs" class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar"></div>
        
        <div class="glass-panel p-6 rounded-[32px] space-y-4">
            <div class="flex justify-between items-center">
                <span id="current-subject-label" class="text-orange-500 font-black text-xs uppercase"></span>
                <span id="q-count" class="text-gray-500 font-black text-[10px]">Q1</span>
            </div>
            
            <textarea id="q-text" placeholder="Question content..." class="w-full p-4 h-24 text-sm"></textarea>
            <div class="grid grid-cols-1 gap-2">
                <input type="text" id="opt-a" placeholder="Option A" class="p-4 text-sm">
                <input type="text" id="opt-b" placeholder="Option B" class="p-4 text-sm">
                <input type="text" id="opt-c" placeholder="Option C" class="p-4 text-sm">
                <input type="text" id="opt-d" placeholder="Option D" class="p-4 text-sm">
            </div>
            <select id="q-correct" class="w-full p-4 text-orange-500 font-bold text-xs uppercase">
                <option value="">Select Correct Answer</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
            </select>

            <div class="flex gap-2 pt-2">
                <button onclick="saveQuestion(false)" class="flex-1 bg-white/5 py-4 rounded-xl text-[10px] font-bold uppercase">Next Question</button>
                <button onclick="saveQuestion(true)" class="flex-1 bg-orange-600 py-4 rounded-xl text-[10px] font-black uppercase">Finish Exam</button>
            </div>
        </div>
    </div>

    <div id="view-vault" class="hidden slide-in space-y-4"></div>
    <div id="view-analytics" class="hidden slide-in">
        </div>

    <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] glass-panel rounded-full p-2 flex justify-between items-center z-50">
        <a href="index.html" class="flex-1 text-center nav-link">Home</a>
        <a href="build.html" class="flex-1 text-center nav-link nav-active">Build</a>
        <a href="index.html" class="relative -mt-12"><div class="bg-orange-600 h-14 w-14 rounded-full flex items-center justify-center border-4 border-black text-white text-2xl">+</div></a>
        <a href="join.html" class="flex-1 text-center nav-link">Tests</a>
        <a href="ranks.html" class="flex-1 text-center nav-link">Ranks</a>
    </nav>

    <script>
        const _URL = "https://lgfyrlfjoazedwymjpfc.supabase.co";
        const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw";
        const sb = supabase.createClient(_URL, _KEY);
        const userId = localStorage.getItem('thesdel_user_id');

        let selectedSubs = [];
        let activeSubject = "";
        let activeBuildId = null;
        let subjectQuestionCounts = {}; // Track Q1, Q2 per subject strictly

        const UNIVERSE_SUBJECTS = ["GST 101", "GST 102", "Anatomy", "Physiology", "Biochemistry", "MTH 101", "CHM 101", "PHY 101", "Computer Science", "Political Science", "Law of Tort", "Criminal Law", "Business Admin", "Accounting", "Mass Comm", "Microbiology", "Architecture", "Civil Engineering", "Philosophy", "Psychology"];

        function searchSubjects() {
            const query = document.getElementById('subject-search').value.toLowerCase();
            const results = document.getElementById('search-results');
            results.innerHTML = "";
            if (!query) return;

            const filtered = UNIVERSE_SUBJECTS.filter(s => s.toLowerCase().includes(query));
            filtered.forEach(s => {
                const p = document.createElement('div');
                p.className = "subject-pill";
                p.innerText = s;
                p.onclick = () => addSubject(s);
                results.appendChild(p);
            });
        }

        function addSubject(s) {
            if (selectedSubs.length >= 4 || selectedSubs.includes(s)) return;
            selectedSubs.push(s);
            subjectQuestionCounts[s] = 1;
            renderSelected();
            document.getElementById('subject-search').value = "";
            document.getElementById('search-results').innerHTML = "";
        }

        function renderSelected() {
            const list = document.getElementById('selected-list');
            list.innerHTML = selectedSubs.map(s => `<div class="subject-pill subject-active">${s}</div>`).join('');
        }

        async function initiateBuild() {
            const title = document.getElementById('exam-title').value;
            if (!title || selectedSubs.length === 0) return alert("Enter Title and at least 1 Subject");

            const code = `Thesdel-${Math.floor(100+Math.random()*900)}${Math.random().toString(36).substring(2, 6).toUpperCase()}`;
            const { data, error } = await sb.from('cbt_builds').insert([{
                creator_id: userId, build_name: title, subjects_list: selectedSubs,
                duration_mins: document.getElementById('exam-duration').value, join_code: code
            }]).select().single();

            if (!error) {
                activeBuildId = data.id;
                activeSubject = selectedSubs[0];
                setupTabs();
                document.getElementById('slide-config').classList.add('hidden');
                document.getElementById('slide-questions').classList.remove('hidden');
            }
        }

        function setupTabs() {
            const container = document.getElementById('subject-tabs');
            container.innerHTML = selectedSubs.map(s => `
                <div onclick="setSubject('${s}')" class="subject-pill whitespace-nowrap ${s === activeSubject ? 'subject-active' : ''}">${s}</div>
            `).join('');
            document.getElementById('current-subject-label').innerText = activeSubject;
            document.getElementById('q-count').innerText = `Q${subjectQuestionCounts[activeSubject]}`;
        }

        function setSubject(s) {
            activeSubject = s;
            setupTabs();
            // Clear inputs for the new subject view
            ['q-text','opt-a','opt-b','opt-c','opt-d','q-correct'].forEach(i => document.getElementById(i).value = "");
        }

        async function saveQuestion(isFinal) {
            const payload = {
                build_id: activeBuildId, 
                subject_tag: activeSubject, // STRICT ISOLATION
                question_text: document.getElementById('q-text').value,
                option_a: document.getElementById('opt-a').value,
                option_b: document.getElementById('opt-b').value,
                option_c: document.getElementById('opt-c').value,
                option_d: document.getElementById('opt-d').value,
                correct_answer: document.getElementById('q-correct').value
            };

            if(!payload.question_text || !payload.correct_answer) return alert("Fill question and set answer!");

            await sb.from('cbt_questions').insert([payload]);
            
            if (isFinal) { 
                alert("Exam Published Successfully!"); 
                location.reload(); 
            } else { 
                subjectQuestionCounts[activeSubject]++;
                document.getElementById('q-count').innerText = `Q${subjectQuestionCounts[activeSubject]}`;
                ['q-text','opt-a','opt-b','opt-c','opt-d','q-correct'].forEach(i => document.getElementById(i).value = "");
            }
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code);
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2000);
        }

        async function showSection(sec) {
            ['slide-config','slide-questions','view-vault','view-analytics'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById('btn-create').className = sec === 'create' ? 'text-[10px] font-black uppercase text-orange-500' : 'text-[10px] font-black uppercase text-gray-500';
            document.getElementById('btn-manage').className = sec === 'manage' ? 'text-[10px] font-black uppercase text-orange-500' : 'text-[10px] font-black uppercase text-gray-500';
            
            if (sec === 'create') document.getElementById('slide-config').classList.remove('hidden');
            if (sec === 'manage') loadVault();
        }

        async function loadVault() {
            const container = document.getElementById('view-vault');
            container.classList.remove('hidden');
            const { data } = await sb.from('cbt_builds').select('*').eq('creator_id', userId).order('created_at', {ascending: false});
            
            container.innerHTML = data.map(e => `
                <div class="glass-panel p-6 rounded-[32px] mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <p class="text-orange-500 font-black text-xs uppercase">${e.build_name}</p>
                            <p class="text-[8px] text-gray-400 font-bold uppercase mt-1">${e.subjects_list.join(' â€¢ ')}</p>
                        </div>
                        <div onclick="copyCode('${e.join_code}')" class="bg-white/5 border border-white/10 px-3 py-2 rounded-xl text-[10px] font-mono cursor-pointer active:scale-95 transition">
                            ${e.join_code}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="viewAnalytics('${e.id}', '${e.build_name}')" class="flex-1 bg-white/5 py-3 rounded-xl text-[9px] font-black uppercase">Analytics</button>
                        <button onclick="deleteExam('${e.id}')" class="bg-red-900/10 text-red-500 px-4 py-3 rounded-xl text-[9px] font-black uppercase">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteExam(id) {
            if (confirm("Permanently delete this exam?")) {
                await sb.from('cbt_builds').delete().eq('id', id);
                loadVault();
            }
        }
    </script>
</body>
</html>
