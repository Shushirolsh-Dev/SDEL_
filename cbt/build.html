<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Studio - Thesdel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #000000; color: #FFFFFF; font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass-panel { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input, textarea, select { background: rgba(255,255,255,0.05) !important; color: white !important; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; outline: none; }
        input:focus { border-color: #ff6600; }
        .hidden { display: none; }
        .nav-link { color: #666; font-size: 9px; font-weight: 800; text-transform: uppercase; }
        .nav-active { color: #ff6600; }
    </style>
</head>
<body class="p-5 pb-32">

    <div id="step-1" class="animate-fade">
        <h2 class="text-2xl font-black text-orange-500 uppercase mb-6">Creator Studio</h2>
        <div class="glass-panel p-6 rounded-3xl space-y-4 border-t-4 border-orange-600">
            <div>
                <label class="text-[10px] font-black text-gray-500 uppercase ml-1">Exam Title</label>
                <input type="text" id="build-name" placeholder="e.g. Physics Final" class="w-full p-4 mt-1">
            </div>
            <button onclick="initiateBuild()" class="w-full bg-orange-600 text-white font-black py-4 rounded-2xl uppercase text-xs tracking-widest">Create & Add Questions</button>
        </div>
    </div>

    <div id="step-2" class="hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black uppercase text-white" id="display-title"></h2>
            <span class="text-orange-500 font-black text-sm" id="q-counter">Q1</span>
        </div>
        
        <div class="glass-panel p-6 rounded-3xl space-y-3">
            <textarea id="q-text" placeholder="Enter Question" class="w-full p-4 h-28 text-sm"></textarea>
            <div class="grid grid-cols-1 gap-2">
                <input type="text" id="opt-a" placeholder="Option A" class="p-3 text-sm">
                <input type="text" id="opt-b" placeholder="Option B" class="p-3 text-sm">
                <input type="text" id="opt-c" placeholder="Option C" class="p-3 text-sm">
                <input type="text" id="opt-d" placeholder="Option D" class="p-3 text-sm">
            </div>
            <select id="correct-opt" class="w-full p-4 text-orange-500 font-bold uppercase text-xs">
                <option value="">Set Correct Answer</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
            </select>
            <div class="flex gap-2 pt-4">
                <button onclick="saveQuestion(false)" class="flex-1 bg-white/10 text-white font-bold py-4 rounded-xl text-[10px] uppercase">Next</button>
                <button onclick="saveQuestion(true)" class="flex-1 bg-orange-600 text-white font-black py-4 rounded-xl text-[10px] uppercase">Finish</button>
            </div>
        </div>
    </div>

    <div id="step-3" class="hidden text-center py-10">
        <div class="glass-panel p-8 rounded-[40px] border-2 border-orange-500/30 inline-block w-full">
            <p class="text-gray-500 text-[10px] font-black uppercase mb-4 tracking-widest">Your Join Code</p>
            <h3 class="text-3xl font-black text-white mb-6 select-all tracking-tighter" id="final-code"></h3>
            <button onclick="copyCode()" class="bg-white text-black px-8 py-3 rounded-full font-black text-[10px] uppercase">Copy Code</button>
        </div>
        <button onclick="window.location.href='index.html'" class="mt-10 text-orange-500 font-bold uppercase text-[10px]">Return to Dashboard</button>
    </div>

    <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] glass-panel rounded-full p-2 flex justify-between items-center z-50">
        <a href="index.html" class="flex-1 text-center nav-link">Home</a>
        <a href="build.html" class="flex-1 text-center nav-link nav-active">Build</a>
        <a href="index.html" class="relative -mt-12"><div class="bg-orange-600 h-14 w-14 rounded-full flex items-center justify-center border-4 border-black text-white text-2xl">+</div></a>
        <a href="join.html" class="flex-1 text-center nav-link">Tests</a>
        <a href="ranks.html" class="flex-1 text-center nav-link">Ranks</a>
    </nav>

    <script>
        const _URL = "https://lgfyrlfjoazedwymjpfc.supabase.co";
        const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw";
        const sb = supabase.createClient(_URL, _KEY);

        let activeBuildId = null;
        let qNum = 1;

        function generateCode() {
            const brand = "Thesdel-";
            const num = Math.floor(100 + Math.random() * 900);
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ";
            const u1 = chars.charAt(Math.floor(Math.random() * 26));
            const l1 = chars.toLowerCase().charAt(Math.floor(Math.random() * 26));
            const l2 = chars.toLowerCase().charAt(Math.floor(Math.random() * 26));
            const u2 = chars.charAt(Math.floor(Math.random() * 26));
            const rand = Math.random().toString(36).substring(2, 5);
            return `${brand}${num}${u1}${l1}${l2}${u2}${rand}`;
        }

        async function initiateBuild() {
            const name = document.getElementById('build-name').value;
            if(!name) return alert("Enter Title");
            const code = generateCode();
            const userId = localStorage.getItem('thesdel_user_id');

            const { data, error } = await sb.from('cbt_builds').insert([{
                creator_id: userId, build_name: name, join_code: code
            }]).select().single();

            if(!error) {
                activeBuildId = data.id;
                document.getElementById('display-title').innerText = name;
                document.getElementById('final-code').innerText = code;
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-2').classList.remove('hidden');
            }
        }

        async function saveQuestion(isFinal) {
            const payload = {
                build_id: activeBuildId,
                question_text: document.getElementById('q-text').value,
                option_a: document.getElementById('opt-a').value,
                option_b: document.getElementById('opt-b').value,
                option_c: document.getElementById('opt-c').value,
                option_d: document.getElementById('opt-d').value,
                correct_answer: document.getElementById('correct-opt').value
            };

            if(!payload.question_text || !payload.correct_answer) return alert("Fill everything!");

            const { error } = await sb.from('cbt_questions').insert([payload]);
            if(!error) {
                if(isFinal) {
                    document.getElementById('step-2').classList.add('hidden');
                    document.getElementById('step-3').classList.remove('hidden');
                } else {
                    qNum++;
                    document.getElementById('q-counter').innerText = `Q${qNum}`;
                    ['q-text','opt-a','opt-b','opt-c','opt-d','correct-opt'].forEach(id => document.getElementById(id).value = "");
                }
            }
        }

        function copyCode() {
            navigator.clipboard.writeText(document.getElementById('final-code').innerText);
            alert("Copied!");
        }
    </script>
</body>
</html>
