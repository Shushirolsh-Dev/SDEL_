<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Thesdel CBT Rating</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f9;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .card {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    width: 350px;
    text-align: center;
  }

  h2 {
    margin-bottom: 20px;
  }

  button {
    margin: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }

  .good { background: #28a745; color: white; }
  .bad { background: #dc3545; color: white; }
  .yes { background: #007bff; color: white; }
  .no { background: #6c757d; color: white; }

  .stats {
    margin-top: 20px;
    font-size: 14px;
  }

  .message {
    margin-top: 15px;
    font-weight: bold;
  }
</style>
</head>

<body>

<div class="card">
  <h2>Rate This CBT</h2>

  <button class="good" onclick="submitVote('good')">Good</button>
  <button class="bad" onclick="submitVote('bad')">Bad</button>
  <br/>
  <button class="yes" onclick="submitVote('yes')">Yes</button>
  <button class="no" onclick="submitVote('no')">No</button>

  <div class="message" id="message"></div>
  <div class="stats" id="stats"></div>
</div>

<script>
  // ================================
  // SUPABASE CLIENT (Dummy Credentials)
  // ================================
  const supabase = window.supabase.createClient(
    'https://lgfyrlfjoazedwymjpfc.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw'
  );

  const VALID_VOTES = ["good", "bad", "yes", "no"];
  const LOCAL_VOTE_KEY = "thesdel_cbt_vote";

  async function getUserIP() {
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      return data.ip;
    } catch {
      return null;
    }
  }

  async function submitVote(voteType) {
    const messageEl = document.getElementById("message");

    if (!VALID_VOTES.includes(voteType)) {
      messageEl.innerText = "Invalid vote.";
      return;
    }

    if (localStorage.getItem(LOCAL_VOTE_KEY)) {
      messageEl.innerText = "You have already voted.";
      return;
    }

    const userIP = await getUserIP();

    const { error } = await supabase
      .from("cbt_ratings")
      .insert([{ vote_type: voteType, user_ip: userIP }]);

    if (error) {
      messageEl.innerText = "Error submitting vote.";
      console.error(error);
      return;
    }

    localStorage.setItem(LOCAL_VOTE_KEY, voteType);
    messageEl.innerText = "Vote submitted successfully.";

    loadStats();
  }

  async function loadStats() {
    const statsEl = document.getElementById("stats");

    const { data, error } = await supabase
      .from("cbt_rating_stats")
      .select("*")
      .single();

    if (error || !data) {
      statsEl.innerHTML = "Unable to load statistics.";
      return;
    }

    statsEl.innerHTML = `
      Total Votes: ${data.total_votes}<br/>
      Good: ${data.good_votes} (${data.good_percentage || 0}%)<br/>
      Bad: ${data.bad_votes}<br/>
      Yes: ${data.yes_votes} (${data.yes_percentage || 0}%)<br/>
      No: ${data.no_votes}
    `;
  }

  loadStats();
</script>

</body>
</html>
