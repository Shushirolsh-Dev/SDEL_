<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel | Messages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #000; color: white; overflow-x: hidden; display: none; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-zinc { background: rgba(18, 18, 18, 0.7); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); position: relative; z-index: 10; }
        
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        .star { position: absolute; background-color: rgba(255,255,255,0.6); border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }

        .msg-bubble { border-left: 3px solid transparent; transition: all 0.3s ease; }
        .msg-bubble-general { border-left-color: #FF6600; }
        .msg-bubble-team { border-left-color: #3b82f6; }
    </style>
</head>
<body class="pb-10">

    <div class="stars" id="stars"></div>

    <nav class="p-6 flex items-center justify-between sticky top-0 bg-black/90 backdrop-blur-md z-50">
        <a href="dashboard.html" class="text-white"><i data-lucide="chevron-left"></i></a>
        <h1 class="text-lg font-black uppercase tracking-tighter">Inbox</h1>
        <div class="relative">
            <i data-lucide="bell" size="20"></i>
            <span id="msg-count" class="hidden absolute -top-1 -right-1 bg-sdel text-black text-[8px] font-black h-4 w-4 rounded-full flex items-center justify-center">0</span>
        </div>
    </nav>

    <main class="p-6 space-y-6 relative z-10">
        <div class="flex bg-zinc-900/50 p-1 rounded-2xl card-zinc">
            <button onclick="filterMsgs('general')" id="btn-gen" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase transition-all bg-sdel text-black">General</button>
            <button onclick="filterMsgs('team')" id="btn-team" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase transition-all text-gray-500">Personal</button>
        </div>

        <div id="message-container" class="space-y-4">
            <div class="animate-pulse space-y-4">
                <div class="h-24 bg-zinc-900 rounded-3xl w-full"></div>
                <div class="h-24 bg-zinc-900 rounded-3xl w-full"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let allMessages = [];
        let currentFilter = 'general';
        let currentUser = null;

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return window.location.href = 'login.html';
            currentUser = session.user;

            document.body.style.display = 'block';
            createStars();
            
            // On load, update General read status and load messages
            await markAsRead('general');
            await loadMessages();
        }

        async function markAsRead(type) {
            const column = type === 'general' ? 'last_read_general' : 'last_read_team';
            await supabase
                .from('profile')
                .update({ [column]: new Date().toISOString() })
                .eq('id', currentUser.id);
        }

        async function loadMessages() {
            const badge = document.getElementById('msg-count');
            
            // Get user's read timestamps
            const { data: profile } = await supabase
                .from('profile')
                .select('last_read_general, last_read_team')
                .eq('id', currentUser.id)
                .single();

            const lastGen = new Date(profile?.last_read_general || 0);
            const lastTeam = new Date(profile?.last_read_team || 0);

            // Fetch all relevant messages
            const { data, error } = await supabase
                .from('messages')
                .select('*')
                .or(`recipient_id.is.null,recipient_id.eq.${currentUser.id}`)
                .order('created_at', { ascending: false });

            if (!error && data) {
                allMessages = data;
                renderMessages();
                
                // DYNAMIC CALCULATION: Count messages created AFTER the respective timestamps
                const unreadGen = data.filter(m => m.type === 'general' && new Date(m.created_at) > lastGen).length;
                const unreadTeam = data.filter(m => m.type === 'team' && new Date(m.created_at) > lastTeam).length;
                
                const totalUnread = unreadGen + unreadTeam;

                if (totalUnread > 0) {
                    badge.innerText = totalUnread;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        window.filterMsgs = async (type) => {
            currentFilter = type;
            
            // If switching to team, mark team as read and refresh
            if (type === 'team') {
                await markAsRead('team');
                await loadMessages();
            }

            document.getElementById('btn-gen').className = type === 'general' ? 'flex-1 py-3 rounded-xl text-[10px] font-black uppercase bg-sdel text-black' : 'flex-1 py-3 rounded-xl text-[10px] font-black uppercase text-gray-500';
            document.getElementById('btn-team').className = type === 'team' ? 'flex-1 py-3 rounded-xl text-[10px] font-black uppercase bg-sdel text-black' : 'flex-1 py-3 rounded-xl text-[10px] font-black uppercase text-gray-500';
            renderMessages();
        };

        function renderMessages() {
            const container = document.getElementById('message-container');
            const filtered = allMessages.filter(m => m.type === currentFilter);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="py-20 text-center opacity-30 font-black uppercase text-[10px] tracking-widest">No ${currentFilter} messages</div>`;
                return;
            }

            container.innerHTML = filtered.map(m => `
                <div class="card-zinc p-6 rounded-[32px] msg-bubble ${m.type === 'general' ? 'msg-bubble-general' : 'msg-bubble-team'}">
                    <p class="text-xs text-gray-200 leading-relaxed font-medium">${m.content}</p>
                    <div class="mt-4 pt-4 border-t border-white/5 flex justify-between items-center">
                        <span class="text-[8px] font-black uppercase text-gray-500 tracking-widest">${formatSdelTime(m.created_at)}</span>
                        <i data-lucide="${m.type === 'general' ? 'megaphone' : 'user'}" size="12" class="text-gray-600"></i>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function formatSdelTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            const staticDate = date.toLocaleDateString('en-US', options);

            if (diff < 60) return `${staticDate} • just now`;
            if (diff < 3600) return `${staticDate} • ${Math.floor(diff/60)} min ago`;
            if (diff < 86400) return `${staticDate} • ${Math.floor(diff/3600)} hr ago`;
            if (diff < 2678400) return `${staticDate} • ${Math.floor(diff/86400)} day ago`;
            if (diff < 31536000) return `${staticDate} • ${Math.floor(diff/2592000)} mth ago`;
            return `${staticDate} • ${Math.floor(diff/31536000)} yr ago`;
        }

        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = star.style.height = (Math.random() * 2 + 1) + 'px';
                star.style.left = Math.random() * 100 + 'vw';
                if (i < 50) star.style.top = Math.random() * 100 + 'vh';
                else star.style.top = '-' + (Math.random() * 100) + 'vh';
                star.style.animationDuration = (Math.random() * 20 + 30) + 's'; 
                container.appendChild(star);
            }
        }

        init();
    </script>
</body>
</html>
