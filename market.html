<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'sunlight') {
                document.documentElement.classList.add('sunlight-mode');
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Market 2.0 üèÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #000; color: white; overflow-x: hidden; transition: background-color 0.3s; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-zinc { background: rgba(18, 18, 18, 0.7); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); position: relative; z-index: 10; }
        
        .category-pill { 
            transition: all 0.3s ease; 
            cursor: pointer; 
            border: 1px solid rgba(255,255,255,0.1); 
            position: relative; 
            z-index: 10; 
            color: #6b7280; 
            user-select: none; 
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        .category-pill.active { background-color: #FF6600; color: black !important; border-color: #FF6600; }
        .category-pill:active { transform: scale(0.95); }

        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        .star { position: absolute; background-color: rgba(255,255,255,0.6); border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Search View */
        #search-view { display: none; position: fixed; inset: 0; background: #000; z-index: 100; padding: 24px; }
        .search-item { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 15px 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

        /* Product Modal - Next Level */
        #product-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.98);
            z-index: 200;
            overflow-y: auto;
            padding: 16px;
            backdrop-filter: blur(20px);
        }
        .sunlight-mode #product-modal {
            background: rgba(255,255,255,0.98);
        }
        .modal-content {
            max-width: 800px;
            margin: 10px auto;
            border-radius: 40px;
            background: rgba(18, 18, 18, 0.98);
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        .sunlight-mode .modal-content {
            background: #ffffff;
            border-color: #e4e4e7;
        }

        /* Store Header with Level Glow */
        .store-header {
            position: relative;
            padding: 24px;
            border-radius: 32px;
            margin-bottom: 24px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .store-header.bronze { background: linear-gradient(135deg, #CD7F32, #B87333); }
        .store-header.silver { background: linear-gradient(135deg, #C0C0C0, #A8A9AD); }
        .store-header.gold { background: linear-gradient(135deg, #FFD700, #FBB917); }
        .store-header.platinum { 
            background: linear-gradient(135deg, #E5E4E2, #BCC6CC);
            animation: platinumGlow 2s infinite;
        }
        @keyframes platinumGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(229, 228, 226, 0.5); }
            50% { box-shadow: 0 0 40px rgba(229, 228, 226, 0.8); }
        }

        .store-avatar {
            width: 70px;
            height: 70px;
            border-radius: 24px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 900;
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
        }
        .verified-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: #3B82F6;
            border-radius: 50%;
            padding: 4px;
            border: 2px solid white;
        }

        /* Follow Button */
        .follow-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,102,0,0.3);
            color: white;
            padding: 10px 24px;
            border-radius: 40px;
            font-weight: 800;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        .follow-btn.following {
            background: #FF6600;
            color: black;
            border-color: #FF6600;
        }
        .follow-btn:active {
            transform: scale(0.95);
        }

        /* Stat Cards */
        .stat-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255,102,0,0.1);
        }
        .stat-value {
            font-size: 20px;
            font-weight: 900;
            color: #FF6600;
        }
        .stat-label {
            font-size: 8px;
            font-weight: 800;
            text-transform: uppercase;
            color: #9CA3AF;
        }

        /* Live Activity Ticker */
        .live-ticker {
            background: rgba(255,102,0,0.1);
            border: 1px solid rgba(255,102,0,0.2);
            border-radius: 40px;
            padding: 8px 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #FF6600;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Achievement Badges */
        .achievement-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
            margin-bottom: 16px;
        }
        .badge-item {
            background: rgba(255,255,255,0.05);
            border-radius: 30px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            border: 1px solid rgba(255,102,0,0.2);
            font-size: 9px;
            font-weight: 800;
        }
        .badge-item.platinum { background: linear-gradient(135deg, #E5E4E2, #BCC6CC); color: black; }
        .badge-item.gold { background: linear-gradient(135deg, #FFD700, #FBB917); color: black; }
        .badge-item.silver { background: linear-gradient(135deg, #C0C0C0, #A8A9AD); color: black; }
        .badge-item.bronze { background: linear-gradient(135deg, #CD7F32, #B87333); color: white; }

        /* Challenge Card */
        .challenge-card {
            background: linear-gradient(135deg, rgba(255,102,0,0.1), rgba(255,102,0,0.05));
            border: 1px solid rgba(255,102,0,0.3);
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .challenge-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #FF6600;
            transition: width 0.3s;
        }

        /* Similar Stores */
        .similar-store-card {
            min-width: 140px;
            background: rgba(255,255,255,0.03);
            border-radius: 24px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.2s;
        }
        .similar-store-card:hover {
            background: rgba(255,102,0,0.1);
            transform: scale(0.98);
        }

        /* Review Cards */
        .review-card {
            background: rgba(255,255,255,0.03);
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .star-rating {
            color: #FF6600;
            display: flex;
            gap: 2px;
        }

        /* Sunlight Mode */
        .sunlight-mode body { background-color: #ffffff; color: #121212; }
        .sunlight-mode .card-zinc { background: #f4f4f5; border-color: #e4e4e7; }
        .sunlight-mode .modal-content { background: #ffffff; }
        .sunlight-mode .stat-card { background: #f4f4f5; }
        .sunlight-mode .review-card { background: #f4f4f5; }
        .sunlight-mode .follow-btn { color: #121212; }
        
        /* Loading Skeleton */
        .skeleton-card {
            background: rgba(18, 18, 18, 0.7);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px;
            overflow: hidden;
            animation: skeletonPulse 1.5s ease-in-out infinite;
        }
        @keyframes skeletonPulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.4; }
        }

        /* Product Card */
        .product-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .product-card:active {
            transform: scale(0.98);
        }

        /* Share Button */
        .share-btn {
            background: rgba(255, 102, 0, 0.1);
            border: 1px solid rgba(255, 102, 0, 0.3);
            color: #FF6600;
            width: 40px;
            height: 40px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        .share-btn:active {
            background: #FF6600;
            color: black;
            transform: scale(0.9);
        }

        /* Stock Badge */
        .stock-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 11px;
            text-transform: uppercase;
        }
        .stock-high { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .stock-low { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .stock-medium { background: rgba(255, 102, 0, 0.15); color: #FF6600; }
        .stock-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .stock-dot.high { background: #22c55e; }
        .stock-dot.low { background: #ef4444; }
        .stock-dot.medium { background: #FF6600; }
    </style>
</head>
<body class="pb-24">
<script>
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0))) return false; }
</script>

<div class="stars" id="stars"></div>

<!-- Search View -->
<div id="search-view">
    <div class="flex items-center gap-4 mb-6">
        <button onclick="closeSearch()" class="text-gray-400"><i data-lucide="arrow-left"></i></button>
        <div class="flex-1 bg-zinc-900 rounded-2xl flex items-center px-4 border border-white/5">
            <i data-lucide="search" size="18" class="text-gray-500"></i>
            <input type="text" id="search-input" oninput="runSearch(this.value)" placeholder="Search products..." class="bg-transparent w-full p-4 text-sm font-bold outline-none text-white">
        </div>
    </div>
    <div id="search-results-list" class="overflow-y-auto h-[80vh] no-scrollbar"></div>
</div>

<!-- PRODUCT MODAL - THE BEAST üî• -->
<div id="product-modal">
    <div class="modal-content">
        <!-- Modal Header -->
        <div class="flex justify-between items-center mb-4">
            <button onclick="closeProductModal()" class="text-gray-400 p-2 hover:text-sdel transition">
                <i data-lucide="arrow-left" size="24"></i>
            </button>
            <h2 class="text-lg font-black uppercase tracking-tighter italic">Store <span class="text-sdel">Central</span></h2>
            <div class="w-10"></div>
        </div>

        <!-- Dynamic Modal Content Injected Here -->
        <div id="modal-product-detail"></div>
    </div>
</div>

<!-- Main Navigation -->
<nav class="p-6 flex items-center justify-between border-b border-white/10 sticky top-0 bg-black/90 backdrop-blur-md z-50">
    <div class="flex items-center gap-4">
        <a href="dashboard.html" class="text-white"><i data-lucide="chevron-left"></i></a>
        <button onclick="openSearch()" class="text-gray-400 p-1"><i data-lucide="search" size="20"></i></button>
    </div>
    <h1 class="text-lg font-black uppercase tracking-tighter italic">Campus <span class="text-sdel">Market 2.0</span></h1>
    <div onclick="window.location.href='cart.html'" class="relative cursor-pointer p-2">
        <i data-lucide="shopping-cart" class="text-gray-400"></i>
        <span id="cart-count" class="absolute top-0 right-0 bg-sdel text-black text-[9px] font-black px-1.5 py-0.5 rounded-full min-w-[18px] text-center border-2 border-black">0</span>
    </div>
</nav>

<!-- Category Tabs -->
<div class="p-6 flex space-x-3 overflow-x-auto no-scrollbar" id="category-tabs">
    <button onclick="filterProducts('All', event)" class="category-pill active px-4 py-2 rounded-2xl text-[10px] font-black uppercase whitespace-nowrap">All Items</button>
</div>

<!-- Product Grid -->
<main class="px-6 grid grid-cols-1 md:grid-cols-2 gap-6" id="product-list">
    <!-- Loading Skeletons -->
    <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-content">
            <div class="skeleton-line short"></div>
            <div class="skeleton-line medium"></div>
            <div class="skeleton-line long"></div>
            <div class="skeleton-button"></div>
        </div>
    </div>
    <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-content">
            <div class="skeleton-line short"></div>
            <div class="skeleton-line medium"></div>
            <div class="skeleton-line long"></div>
            <div class="skeleton-button"></div>
        </div>
    </div>
    <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-content">
            <div class="skeleton-line short"></div>
            <div class="skeleton-line medium"></div>
            <div class="skeleton-line long"></div>
            <div class="skeleton-button"></div>
        </div>
    </div>
    <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-content">
            <div class="skeleton-line short"></div>
            <div class="skeleton-line medium"></div>
            <div class="skeleton-line long"></div>
            <div class="skeleton-button"></div>
        </div>
    </div>
</main>

<!-- Toast Notification -->
<div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 -translate-y-20 bg-sdel text-black px-6 py-3 rounded-3xl font-black text-sm shadow-2xl z-[1000] transition-all duration-300"></div>

<script src="nav.js"></script>
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    // =============================================
    // SUPABASE INIT - LIGHTNING FAST ‚ö°
    // =============================================
    const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

    // =============================================
    // GLOBAL STATE - ALL IN ONE PLACE üéØ
    // =============================================
    let currentUserId = "GUEST_USER";
    let visitorSessionId = localStorage.getItem('visitor_session_id') || 'session_' + Math.random().toString(36).substring(2) + Date.now();
    localStorage.setItem('visitor_session_id', visitorSessionId);
    
    // Core Data
    let allProducts = [];
    let allProfiles = [];
    let userCart = {};
    
    // SINGLE TABLE SOCIAL DATA - This is the BEAST! üî•
    let storeSocial = {}; // Key: store_id, Value: { followers, badges, level, trust_score, etc }
    
    // =============================================
    // INIT - LOAD EVERYTHING AT ONCE ‚ö°
    // =============================================
    async function init() {
        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) currentUserId = session.user.id;
            
            // PARALLEL LOADING - FASTER THAN LIGHT! ‚ö°
            await Promise.all([
                fetchUserCart(),
                loadTabs(),
                loadProfiles(),
                loadProducts(),
                loadStoreSocial() // Single table load
            ]);
            
            createStars();
            lucide.createIcons();
        } catch (error) {
            console.error('Init error:', error);
        }
    }

    // =============================================
    // SINGLE TABLE LOAD - ONE CALL TO RULE THEM ALL üèÜ
    // =============================================
    async function loadStoreSocial() {
        try {
            const { data } = await supabase
                .from('store_social')
                .select('*');
            
            storeSocial = {};
            if (data) {
                data.forEach(store => {
                    storeSocial[store.store_id] = store;
                });
            }
        } catch (e) {
            console.log('Store social table not ready yet');
        }
    }

    // =============================================
    // UPDATE STORE SOCIAL - ATOMIC UPDATE ‚ö°
    // =============================================
    async function updateStoreSocial(storeId, updates) {
        try {
            const { data: existing } = await supabase
                .from('store_social')
                .select('*')
                .eq('store_id', storeId)
                .single();
            
            if (existing) {
                // Update existing
                const { data } = await supabase
                    .from('store_social')
                    .update({
                        ...updates,
                        last_updated: new Date().toISOString()
                    })
                    .eq('store_id', storeId)
                    .select()
                    .single();
                
                if (data) storeSocial[storeId] = data;
            } else {
                // Create new
                const { data } = await supabase
                    .from('store_social')
                    .insert([{
                        store_id: storeId,
                        followers: '[]',
                        follower_count: 0,
                        store_level: 'BRONZE',
                        badges: '[]',
                        trust_score: 0,
                        recent_activity: '[]',
                        ...updates
                    }])
                    .select()
                    .single();
                
                if (data) storeSocial[storeId] = data;
            }
        } catch (e) {
            console.error('Update store social error:', e);
        }
    }

    // =============================================
    // FOLLOW STORE - MAIN EVENT üî•
    // =============================================
    window.followStore = async (storeId) => {
        try {
            const followKey = currentUserId !== "GUEST_USER" ? currentUserId : visitorSessionId;
            let storeData = storeSocial[storeId];
            
            if (!storeData) {
                // Initialize if doesn't exist
                storeData = {
                    store_id: storeId,
                    followers: [],
                    follower_count: 0,
                    store_level: 'BRONZE',
                    badges: [],
                    recent_activity: []
                };
            }
            
            const followers = storeData.followers || [];
            const isFollowing = followers.some(f => f.id === followKey);
            
            if (isFollowing) {
                // UNFOLLOW
                const updatedFollowers = followers.filter(f => f.id !== followKey);
                await updateStoreSocial(storeId, {
                    followers: updatedFollowers,
                    follower_count: updatedFollowers.length,
                    recent_activity: [
                        {
                            type: 'unfollow',
                            user: currentUserId !== "GUEST_USER" ? 'member' : 'guest',
                            timestamp: new Date().toISOString()
                        },
                        ...(storeData.recent_activity || []).slice(0, 49)
                    ]
                });
                
                // Recalculate store level
                await recalculateStoreLevel(storeId, updatedFollowers.length);
                showToast("üëã Unfollowed store");
            } else {
                // FOLLOW
                const newFollower = {
                    id: followKey,
                    type: currentUserId !== "GUEST_USER" ? 'user' : 'guest',
                    followed_at: new Date().toISOString()
                };
                
                const updatedFollowers = [...followers, newFollower];
                await updateStoreSocial(storeId, {
                    followers: updatedFollowers,
                    follower_count: updatedFollowers.length,
                    recent_activity: [
                        {
                            type: 'follow',
                            user: currentUserId !== "GUEST_USER" ? 'member' : 'guest',
                            timestamp: new Date().toISOString()
                        },
                        ...(storeData.recent_activity || []).slice(0, 49)
                    ]
                });
                
                // Recalculate store level
                await recalculateStoreLevel(storeId, updatedFollowers.length);
                
                // Check for follow challenges
                await checkFollowChallenge(storeId, updatedFollowers.length);
                
                showToast("üî• Following store!");
            }
            
            // Refresh modal if open
            const modalProductId = document.getElementById('product-modal').getAttribute('data-current-product');
            if (modalProductId) {
                const product = allProducts.find(p => p.id === modalProductId);
                if (product) openProductModal(product);
            }
        } catch (e) {
            console.error('Follow error:', e);
            showToast("Error - try again");
        }
    };

    // =============================================
    // RECALCULATE STORE LEVEL - DYNAMIC BADGES üèÜ
    // =============================================
    async function recalculateStoreLevel(storeId, followerCount) {
        const storeData = storeSocial[storeId];
        if (!storeData) return;
        
        // Get total sold from products
        const storeProducts = allProducts.filter(p => p.vendor_id === storeId);
        const totalSold = storeProducts.reduce((sum, p) => sum + (p.sold_count || 0), 0);
        
        // Calculate level based on followers + sales
        const score = (followerCount * 2) + (totalSold * 0.5);
        
        let newLevel = 'BRONZE';
        let newBadges = storeData.badges || [];
        
        if (score > 1000) {
            newLevel = 'PLATINUM';
            if (!newBadges.find(b => b.name === 'PLATINUM')) {
                newBadges.push({ name: 'PLATINUM', icon: 'üíé', earned: new Date().toISOString() });
            }
        } else if (score > 500) {
            newLevel = 'GOLD';
            if (!newBadges.find(b => b.name === 'GOLD')) {
                newBadges.push({ name: 'GOLD', icon: 'ü•á', earned: new Date().toISOString() });
            }
        } else if (score > 100) {
            newLevel = 'SILVER';
            if (!newBadges.find(b => b.name === 'SILVER')) {
                newBadges.push({ name: 'SILVER', icon: 'ü•à', earned: new Date().toISOString() });
            }
        } else {
            newLevel = 'BRONZE';
            if (!newBadges.find(b => b.name === 'BRONZE')) {
                newBadges.push({ name: 'BRONZE', icon: 'ü•â', earned: new Date().toISOString() });
            }
        }
        
        // Calculate trust score
        const avgRating = storeProducts.reduce((sum, p) => sum + (p.avg_rating || 0), 0) / (storeProducts.length || 1);
        const trustScore = Math.min(100, Math.floor(
            (followerCount * 0.5) + 
            (totalSold * 0.2) + 
            (avgRating * 10)
        ));
        
        await updateStoreSocial(storeId, {
            store_level: newLevel,
            badges: newBadges,
            trust_score: trustScore,
            total_sold: totalSold,
            avg_rating: avgRating
        });
    }

    // =============================================
    // CHECK FOLLOW CHALLENGES - GAMIFICATION üéÆ
    // =============================================
    async function checkFollowChallenge(storeId, followerCount) {
        const storeData = storeSocial[storeId];
        if (!storeData || !storeData.active_challenge) return;
        
        const challenge = storeData.active_challenge;
        const progress = storeData.challenge_progress || [];
        const userProgress = progress.find(p => p.userId === currentUserId);
        
        // Milestone challenges
        const milestones = [10, 50, 100, 500, 1000];
        const reachedMilestones = milestones.filter(m => 
            followerCount >= m && 
            (!userProgress || !userProgress.milestones?.includes(m))
        );
        
        if (reachedMilestones.length > 0) {
            // Award badges/coupons
            const newBadges = reachedMilestones.map(m => ({
                name: `${m} FOLLOWER`,
                icon: m === 1000 ? 'üëë' : m === 500 ? '‚≠ê' : 'üî•',
                earned: new Date().toISOString()
            }));
            
            await updateStoreSocial(storeId, {
                badges: [...(storeData.badges || []), ...newBadges]
            });
            
            // Show celebration
            showToast(`üèÜ Store reached ${reachedMilestones.join(', ')} followers!`);
        }
    }
    // =============================================
// LOAD PROFILES & PRODUCTS - BASE DATA
// =============================================
async function loadProfiles() {
    const { data } = await supabase.from('profiles').select('*');
    allProfiles = data || [];
}

async function loadProducts() {
    const { data } = await supabase.from('products').select('*').order('created_at', { ascending: false });
    allProducts = data || [];
    window.renderProducts(allProducts);
}

async function fetchUserCart() {
    const { data } = await supabase.from('cart').select('product_id, quantity').eq('user_id', currentUserId);
    userCart = {};
    if (data) {
        data.forEach(item => userCart[item.product_id] = item.quantity);
    }
    updateCartCountDisplay();
}

async function loadTabs() {
    const { data } = await supabase.from('categories').select('*').order('name');
    const container = document.getElementById('category-tabs');
    if (data && data.length > 0) {
        container.innerHTML = `<button onclick="filterProducts('All', event)" class="category-pill active px-4 py-2 rounded-2xl text-[10px] font-black uppercase whitespace-nowrap">All Items</button>` + 
        data.map(cat => `<button onclick="filterProducts('${cat.name}', event)" class="category-pill px-4 py-2 rounded-2xl text-[10px] font-black uppercase whitespace-nowrap">${cat.name}</button>`).join('');
    }
}

function updateCartCountDisplay() {
    const totalItems = Object.keys(userCart).length;
    document.getElementById('cart-count').innerText = totalItems;
}

// =============================================
// TRACK PRODUCT VIEWS - ANALYTICS üìä
// =============================================
async function trackProductView(productId, vendorId) {
    try {
        if (!vendorId) return;
        await supabase
            .from('product_views')
            .insert([{
                product_id: productId,
                vendor_id: vendorId,
                viewer_id: currentUserId !== "GUEST_USER" ? currentUserId : null,
                session_id: visitorSessionId,
                viewed_at: new Date().toISOString()
            }]);
    } catch (e) {
        // Silent fail
    }
}

// =============================================
// ADD TO CART FUNCTIONS üõí
// =============================================
window.addToCart = async (id) => {
    const product = allProducts.find(p => p.id === id);
    if (!product || (product.stock || 0) < 1) {
        showToast("Out of stock!");
        return;
    }
    
    userCart[id] = 1;
    await supabase.from('cart').insert([{ user_id: currentUserId, product_id: id, quantity: 1 }]);
    
    updateCartCountDisplay();
    showToast("Added to cart!");
    window.renderProducts(allProducts);
};

window.addToCartFromModal = async (id) => {
    const product = allProducts.find(p => p.id === id);
    if (!product || (product.stock || 0) < 1) {
        showToast("Out of stock!");
        return;
    }
    
    userCart[id] = 1;
    await supabase.from('cart').insert([{ user_id: currentUserId, product_id: id, quantity: 1 }]);
    
    updateCartCountDisplay();
    showToast("Added to cart!");
    
    // Refresh modal
    const modalProductId = document.getElementById('product-modal').getAttribute('data-current-product');
    if (modalProductId) {
        const product = allProducts.find(p => p.id === modalProductId);
        if (product) openProductModal(product);
    }
};

window.updateQty = async (id, change) => {
    let newQty = (userCart[id] || 0) + change;
    if (newQty < 1) return;
    
    userCart[id] = newQty;
    await supabase.from('cart').update({ quantity: newQty }).eq('user_id', currentUserId).eq('product_id', id);
    
    window.renderProducts(allProducts);
};

// =============================================
// SHARE PRODUCT FUNCTIONALITY üì§
// =============================================
window.shareProduct = async (product) => {
    try {
        let files = [];
        
        if (product.image_url) {
            try {
                const response = await fetch(product.image_url);
                const blob = await response.blob();
                const fileName = product.image_url.split('/').pop() || 'product.jpg';
                const imageFile = new File([blob], fileName, { 
                    type: blob.type || 'image/jpeg' 
                });
                files = [imageFile];
            } catch (imgErr) {
                console.warn("Could not fetch product image:", imgErr);
            }
        }
        
        const shareData = {
            title: product.name,
            text: `Check out ${product.name} on Sdel Market! ${product.description || ''}`,
            url: `${window.location.origin}/market.html?id=${product.id}`
        };
        
        if (files.length > 0 && navigator.canShare && navigator.canShare({ files: files })) {
            shareData.files = files;
        }
        
        if (navigator.share) {
            try {
                await navigator.share(shareData);
                showToast("Shared with image!");
            } catch (err) {
                if (err.name !== 'AbortError') {
                    navigator.clipboard.writeText(shareData.url);
                    showToast("Link copied!");
                }
            }
        } else {
            navigator.clipboard.writeText(shareData.url);
            showToast("Link copied!");
        }
    } catch (error) {
        console.error("Share error:", error);
        navigator.clipboard.writeText(`${window.location.origin}/market.html?id=${product.id}`);
        showToast("Link copied!");
    }
};

// =============================================
// OPEN PRODUCT MODAL - THE MAIN EVENT üî•
// =============================================
window.openProductModal = async (product) => {
    const modal = document.getElementById('product-modal');
    const modalContent = document.getElementById('modal-product-detail');
    
    // Track view
    trackProductView(product.id, product.vendor_id);
    
    // Get vendor profile
    const vendor = allProfiles.find(p => p.id === product.vendor_id) || { 
        username: 'store', 
        full_name: 'Campus Store',
        avatar_url: null 
    };
    
    // Get ALL products from this vendor
    const vendorProducts = allProducts.filter(p => p.vendor_id === product.vendor_id);
    const otherProducts = vendorProducts.filter(p => p.id !== product.id).slice(0, 6);
    
    // Get store social data
    const social = storeSocial[product.vendor_id] || {
        followers: [],
        follower_count: 0,
        store_level: 'BRONZE',
        badges: [],
        trust_score: 85,
        recent_activity: [],
        active_challenge: null,
        similar_stores: []
    };
    
    // Check if current user follows this store
    const followKey = currentUserId !== "GUEST_USER" ? currentUserId : visitorSessionId;
    const userFollows = (social.followers || []).some(f => f.id === followKey);
    
    // Calculate store stats
    const totalSold = vendorProducts.reduce((sum, p) => sum + (p.sold_count || 0), 0);
    const avgRating = 4.5; // You'd calculate from reviews table
    
    // Get store level styling
    const levelClass = social.store_level?.toLowerCase() || 'bronze';
    
    // Get badges
    const badges = social.badges || [];
    
    // Calculate trust score color
    const trustColor = social.trust_score > 80 ? 'text-green-500' : 
                      social.trust_score > 50 ? 'text-yellow-500' : 'text-red-500';
    
    // Recent purchases for live ticker
    const recentPurchases = Math.floor(Math.random() * 10) + 1; // You'd get this from actual data
    
    // Generate similar stores (stores with similar categories)
    const similarStores = await getSimilarStores(product.vendor_id, product.category);
    
    // =============================================
    // RENDER THE MODAL HTML - BEAUTY IN CODE ‚ú®
    // =============================================
    modalContent.innerHTML = `
        <!-- STORE HEADER with Level Badge -->
        <div class="store-header ${levelClass}">
            <div class="absolute inset-0 bg-gradient-to-r from-black/40 to-transparent"></div>
            
            <div class="relative z-10 flex items-start justify-between">
                <div class="flex items-center gap-4">
                    <div class="store-avatar">
                        <span>${vendor.full_name ? vendor.full_name.charAt(0).toUpperCase() : 'S'}</span>
                        ${social.verified ? `
                            <div class="verified-badge">
                                <i data-lucide="check" size="12" color="white"></i>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h2 class="font-black text-xl">${vendor.full_name || 'Campus Store'}</h2>
                            <span class="text-[10px] bg-black/30 px-3 py-1 rounded-full font-black uppercase tracking-wider">
                                ${social.store_level} 
                                ${social.store_level === 'PLATINUM' ? 'üíé' : 
                                  social.store_level === 'GOLD' ? 'ü•á' : 
                                  social.store_level === 'SILVER' ? 'ü•à' : 'ü•â'}
                            </span>
                        </div>
                        <p class="text-sm opacity-80">@${vendor.username || 'store'}</p>
                        
                        <!-- Trust Score Bar -->
                        <div class="flex items-center gap-2 mt-2">
                            <div class="w-24 h-1.5 bg-black/30 rounded-full overflow-hidden">
                                <div class="h-full bg-white rounded-full" style="width: ${social.trust_score}%"></div>
                            </div>
                            <span class="text-[10px] font-black ${trustColor}">${social.trust_score}% Trust</span>
                        </div>
                    </div>
                </div>
                
                <!-- FOLLOW BUTTON -->
                <button class="follow-btn ${userFollows ? 'following' : ''}" onclick="followStore('${product.vendor_id}')">
                    <i data-lucide="users" size="16"></i>
                    <span>${userFollows ? 'Following' : 'Follow Store'}</span>
                </button>
            </div>
        </div>

        <!-- LIVE ACTIVITY TICKER -->
        <div class="live-ticker">
            <span class="pulse-dot"></span>
            <span class="text-[10px] font-black uppercase tracking-wider">
                üî• ${recentPurchases} people bought from this store in the last hour
            </span>
        </div>

        <!-- STORE STATS GRID -->
        <div class="grid grid-cols-4 gap-2 mb-6">
            <div class="stat-card">
                <i data-lucide="package" size="16" class="text-sdel mx-auto mb-1"></i>
                <div class="stat-value">${vendorProducts.length}</div>
                <div class="stat-label">Products</div>
            </div>
            <div class="stat-card">
                <i data-lucide="shopping-bag" size="16" class="text-sdel mx-auto mb-1"></i>
                <div class="stat-value">${totalSold}</div>
                <div class="stat-label">Sold</div>
            </div>
            <div class="stat-card">
                <i data-lucide="users" size="16" class="text-sdel mx-auto mb-1"></i>
                <div class="stat-value">${social.follower_count || 0}</div>
                <div class="stat-label">Followers</div>
            </div>
            <div class="stat-card">
                <i data-lucide="star" size="16" class="text-sdel mx-auto mb-1"></i>
                <div class="stat-value">${avgRating}</div>
                <div class="stat-label">Rating</div>
            </div>
        </div>

        <!-- ACHIEVEMENT BADGES -->
        ${badges.length > 0 ? `
            <div class="achievement-row">
                ${badges.map(badge => `
                    <div class="badge-item ${badge.name?.toLowerCase().includes('platinum') ? 'platinum' : 
                                            badge.name?.toLowerCase().includes('gold') ? 'gold' :
                                            badge.name?.toLowerCase().includes('silver') ? 'silver' : 'bronze'}">
                        ${badge.icon || 'üèÜ'} ${badge.name}
                    </div>
                `).join('')}
            </div>
        ` : ''}

        <!-- ACTIVE CHALLENGE -->
        ${social.active_challenge ? `
            <div class="challenge-card">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="font-black text-sm">üèÜ ${social.active_challenge.name}</p>
                        <p class="text-[10px] text-gray-400">${social.active_challenge.description}</p>
                    </div>
                    <span class="text-xs font-black text-sdel">${social.active_challenge.reward}</span>
                </div>
                <div class="relative h-1.5 bg-black/20 rounded-full overflow-hidden">
                    <div class="challenge-progress" style="width: ${social.active_challenge.progress || 0}%"></div>
                </div>
                <p class="text-[8px] text-right mt-1 font-bold">${social.active_challenge.progress || 0}% complete</p>
            </div>
        ` : ''}

        <!-- MAIN PRODUCT IMAGE -->
        <div class="relative mb-6">
            <img src="${product.image_url}" class="w-full h-72 object-cover rounded-3xl" onerror="this.src='https://placehold.co/400x400/121212/FF6600?text=No+Preview'">
            
            <!-- Product Badges -->
            <div class="absolute top-4 left-4 flex gap-2">
                <span class="bg-black/50 backdrop-blur-md px-4 py-2 rounded-2xl text-[10px] font-black border border-white/10">
                    ${product.category}
                </span>
                ${product.sold_count > 50 ? `
                    <span class="bg-sdel/90 text-black px-4 py-2 rounded-2xl text-[10px] font-black">
                        üî• Bestseller
                    </span>
                ` : ''}
            </div>
            
            <!-- Share Button -->
            <div class="absolute top-4 right-4">
                <button onclick="event.stopPropagation(); shareProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})" class="share-btn">
                    <i data-lucide="share-2" size="16"></i>
                </button>
            </div>
        </div>

        <!-- PRODUCT INFO -->
        <div class="mb-6">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h1 class="font-black text-2xl uppercase italic tracking-tighter">${product.name}</h1>
                    <p class="text-xs text-gray-500 mt-1">Product ID: #${product.id.slice(0,8)}</p>
                </div>
                <div class="text-right">
                    <p class="font-black text-3xl text-sdel">‚Ç¶${product.price.toLocaleString()}</p>
                    <p class="text-[10px] text-gray-500">${product.sold_count || 0} sold</p>
                </div>
            </div>
            
            <!-- Stock Status -->
            <div class="stock-badge ${product.stock > 10 ? 'stock-high' : product.stock > 0 ? 'stock-medium' : 'stock-low'} w-fit mb-4">
                <span class="stock-dot ${product.stock > 10 ? 'high' : product.stock > 0 ? 'medium' : 'low'}"></span>
                <span class="font-black">
                    ${product.stock > 10 ? `‚úÖ ${product.stock} in stock` : 
                      product.stock > 0 ? `‚ö†Ô∏è Only ${product.stock} left` : 
                      '‚ùå Out of Stock'}
                </span>
            </div>

            <!-- Description -->
            <p class="text-sm text-gray-400 leading-relaxed mb-4">${product.description || 'No description available.'}</p>

            <!-- Quick Actions -->
            <div class="flex gap-3 mb-4">
                <button class="flex-1 bg-white/5 border border-white/10 rounded-2xl py-3 text-xs font-black flex items-center justify-center gap-2">
                    <i data-lucide="message-circle" size="14"></i>
                    Message Store
                </button>
                <button class="flex-1 bg-white/5 border border-white/10 rounded-2xl py-3 text-xs font-black flex items-center justify-center gap-2">
                    <i data-lucide="shield" size="14"></i>
                    Return Policy
                </button>
            </div>
        </div>

        <!-- REVIEWS SECTION -->
        <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-sm uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="star" size="16" class="text-sdel"></i>
                    Reviews (${product.review_count || 0})
                </h3>
                <button class="text-[10px] font-black text-sdel border border-sdel/30 px-4 py-2 rounded-2xl">
                    Write Review
                </button>
            </div>

            <!-- Sample Reviews -->
            <div class="space-y-3 max-h-60 overflow-y-auto no-scrollbar">
                ${generateSampleReviews(product.id)}
            </div>
        </div>

        <!-- MORE FROM THIS STORE -->
        ${otherProducts.length > 0 ? `
            <div class="mb-6">
                <h3 class="font-black text-sm uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i data-lucide="store" size="16" class="text-sdel"></i>
                    More from ${vendor.full_name?.split(' ')[0] || 'this store'}
                </h3>
                
                <div class="grid grid-cols-3 gap-3">
                    ${otherProducts.map(p => `
                        <div class="cursor-pointer" onclick="openProductModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                            <div class="relative">
                                <img src="${p.image_url}" class="w-full h-24 object-cover rounded-2xl mb-2" onerror="this.src='https://placehold.co/200x200/121212/FF6600?text=No+Preview'">
                                ${p.sold_count > 20 ? '<span class="absolute top-1 right-1 text-[8px]">üî•</span>' : ''}
                            </div>
                            <p class="font-black text-xs truncate">${p.name}</p>
                            <p class="text-sdel font-black text-xs">‚Ç¶${p.price.toLocaleString()}</p>
                            <p class="text-[8px] text-gray-500">${p.sold_count || 0} sold</p>
                        </div>
                    `).join('')}
                </div>
                
                ${vendorProducts.length > 6 ? `
                    <button class="w-full mt-3 text-[10px] font-black text-sdel border border-sdel/30 py-3 rounded-2xl">
                        View All ${vendorProducts.length} Products ‚Üí
                    </button>
                ` : ''}
            </div>
        ` : ''}

         <!-- SIMILAR STORES -->
                ${similarStores.length > 0 ? `
                    <div class="mb-6">
                        <h3 class="font-black text-sm uppercase tracking-wider mb-4 flex items-center gap-2">
                            <i data-lucide="git-compare" size="16" class="text-sdel"></i>
                            Similar Stores You Might Like
                        </h3>
                        
                        <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                            ${similarStores.map(store => `
                                <div class="similar-store-card" onclick="exploreStore('${store.id}')">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-10 h-10 rounded-2xl bg-sdel/20 flex items-center justify-center font-black">
                                            ${store.name?.charAt(0) || 'S'}
                                        </div>
                                        <div>
                                            <p class="font-black text-xs">${store.name || 'Store'}</p>
                                            <p class="text-[8px] text-gray-500">${store.followers || 0} followers</p>
                                        </div>
                                    </div>
                                    <button class="w-full text-[8px] bg-sdel/10 text-sdel font-black py-2 rounded-xl border border-sdel/30">
                                        Follow +
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- ADD TO CART BUTTON -->
                ${product.stock > 0 ? `
                    <button onclick="addToCartFromModal('${product.id}')" class="w-full bg-sdel text-black py-5 rounded-2xl font-black uppercase text-sm tracking-widest active:scale-95 transition flex items-center justify-center gap-3">
                        <i data-lucide="shopping-cart" size="18"></i>
                        Add to Cart - ‚Ç¶${product.price.toLocaleString()}
                    </button>
                ` : `
                    <button disabled class="w-full bg-zinc-800 text-zinc-500 py-5 rounded-2xl font-black uppercase text-sm tracking-widest cursor-not-allowed flex items-center justify-center gap-3">
                        <i data-lucide="shopping-cart" size="18"></i>
                        Out of Stock
                    </button>
                `}
            `;

            modal.style.display = 'block';
            modal.setAttribute('data-current-product', product.id);
            lucide.createIcons();
        };
            // =============================================
        // GENERATE SAMPLE REVIEWS (Replace with real data)
        // =============================================
        function generateSampleReviews(productId) {
            const sampleReviews = [
                { user: "Mike O.", rating: 5, comment: "Absolute fire! üî• Best purchase ever!", date: "2 days ago", verified: true },
                { user: "Sarah J.", rating: 4, comment: "Good quality, fast shipping", date: "1 week ago", verified: true },
                { user: "David K.", rating: 5, comment: "Store is legit, will buy again", date: "2 weeks ago", verified: true },
                { user: "Chioma P.", rating: 5, comment: "Love it! Exactly as described", date: "3 weeks ago", verified: true }
            ];
            
            return sampleReviews.map(review => `
                <div class="review-card">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-sdel/20 flex items-center justify-center flex-shrink-0">
                            <span class="font-black text-sm">${review.user.charAt(0)}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <div>
                                    <span class="font-black text-sm">${review.user}</span>
                                    ${review.verified ? '<span class="ml-2 text-[8px] bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full">Verified ‚úì</span>' : ''}
                                </div>
                                <span class="text-[8px] text-gray-500">${review.date}</span>
                            </div>
                            <div class="star-rating mb-2">
                                ${[1,2,3,4,5].map(star => `
                                    <i data-lucide="star" size="12" fill="${star <= review.rating ? '#FF6600' : 'none'}" color="#FF6600"></i>
                                `).join('')}
                            </div>
                            <p class="text-xs font-medium">"${review.comment}"</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // =============================================
        // GET SIMILAR STORES - SMART RECOMMENDATIONS üß†
        // =============================================
        async function getSimilarStores(currentStoreId, category) {
            try {
                // Find stores with same category products
                const storesWithSameCategory = new Map();
                
                allProducts.forEach(product => {
                    if (product.vendor_id !== currentStoreId && product.category === category) {
                        const store = allProfiles.find(p => p.id === product.vendor_id);
                        if (store) {
                            const social = storeSocial[store.id] || { follower_count: 0 };
                            storesWithSameCategory.set(store.id, {
                                id: store.id,
                                name: store.full_name || store.username || 'Store',
                                followers: social.follower_count || 0,
                                category: product.category
                            });
                        }
                    }
                });
                
                return Array.from(storesWithSameCategory.values())
                    .sort((a, b) => b.followers - a.followers)
                    .slice(0, 5);
            } catch (e) {
                console.error('Similar stores error:', e);
                return [];
            }
        }

        // =============================================
        // EXPLORE STORE FUNCTION
        // =============================================
        window.exploreStore = (storeId) => {
            const storeProducts = allProducts.filter(p => p.vendor_id === storeId);
            if (storeProducts.length > 0) {
                openProductModal(storeProducts[0]);
            }
        };

        // =============================================
        // CLOSE MODAL
        // =============================================
        window.closeProductModal = () => {
            document.getElementById('product-modal').style.display = 'none';
        };

        // =============================================
        // TOAST NOTIFICATION
        // =============================================
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.transform = 'translateX(-50%) translateY(0)';
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(-100px)';
            }, 2000);
        }

        // =============================================
        // RENDER PRODUCTS GRID - MAIN MARKETPLACE VIEW
        // =============================================
        window.renderProducts = (items) => {
            const list = document.getElementById('product-list');
            if (items.length === 0) {
                list.innerHTML = `<div class="col-span-full text-center py-20 opacity-30"><p class="text-[10px] font-black uppercase tracking-widest text-zinc-500">No Items Found</p></div>`;
                return;
            }
            
            items.forEach(item => {
                setTimeout(() => {
                    trackProductView(item.id, item.vendor_id);
                }, 100);
            });
            
            list.innerHTML = items.map(item => {
                const inCart = userCart[item.id];
                const stock = item.stock || 0;
                let stockClass = 'stock-high';
                let stockText = 'In Stock';
                let dotClass = 'high';
                
                if (stock === 0) {
                    stockClass = 'stock-low';
                    stockText = 'Out of Stock';
                    dotClass = 'low';
                } else if (stock < 5) {
                    stockClass = 'stock-low';
                    stockText = 'üî• Low Stock - ' + stock + ' left';
                    dotClass = 'low';
                } else if (stock < 10) {
                    stockClass = 'stock-medium';
                    stockText = '‚ö†Ô∏è Only ' + stock + ' left';
                    dotClass = 'medium';
                } else {
                    stockText = '‚úÖ ' + stock + ' in stock';
                }
                
                // Get store social for this product
                const social = storeSocial[item.vendor_id] || {};
                const followerCount = social.follower_count || 0;
                
                return `
                <div class="card-zinc rounded-3xl overflow-hidden flex flex-col product-card" onclick="openProductModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <div class="h-56 bg-zinc-900 flex items-center justify-center relative">
                        <img src="${item.image_url}" class="object-cover h-full w-full" onerror="this.src='https://placehold.co/400x400/121212/FF6600?text=No+Preview'">
                        
                        <!-- Category Badge -->
                        <div class="absolute top-3 left-3 bg-black/50 backdrop-blur-md px-3 py-1.5 rounded-xl border border-white/10">
                            <p class="text-[8px] text-sdel font-black uppercase tracking-widest">${item.category}</p>
                        </div>
                        
                        <!-- Store Level Badge -->
                        ${social.store_level ? `
                            <div class="absolute top-3 right-12">
                                <span class="bg-black/50 backdrop-blur-md px-2 py-1 rounded-lg text-[8px] font-black 
                                    ${social.store_level === 'PLATINUM' ? 'text-purple-400' : 
                                      social.store_level === 'GOLD' ? 'text-yellow-400' : 
                                      social.store_level === 'SILVER' ? 'text-gray-400' : 'text-amber-600'}">
                                    ${social.store_level === 'PLATINUM' ? 'üíé' : 
                                      social.store_level === 'GOLD' ? 'ü•á' : 
                                      social.store_level === 'SILVER' ? 'ü•à' : 'ü•â'} 
                                    ${social.store_level}
                                </span>
                            </div>
                        ` : ''}
                        
                        <!-- Share button -->
                        <div class="absolute top-3 right-3" onclick="event.stopPropagation()">
                            <button onclick="shareProduct(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="share-btn">
                                <i data-lucide="share-2" size="16"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 space-y-2">
                        <div class="flex justify-between items-start">
                            <h3 class="font-black text-sm uppercase italic tracking-tighter truncate pr-2">${item.name}</h3>
                            <p class="font-black text-lg tracking-tighter text-white">‚Ç¶${item.price.toLocaleString()}</p>
                        </div>
                        
                        <!-- Store Info Mini -->
                        <div class="flex items-center gap-2 text-[8px] text-gray-500">
                            <i data-lucide="store" size="10"></i>
                            <span class="font-bold">${followerCount} followers</span>
                            <span>‚Ä¢</span>
                            <span class="font-bold">${item.sold_count || 0} sold</span>
                        </div>
                        
                        <p class="text-[10px] text-zinc-500 font-bold leading-relaxed line-clamp-2 h-8">${item.description || ''}</p>
                        
                        <!-- STOCK INDICATOR -->
                        <div class="stock-badge ${stockClass} w-full justify-center my-3">
                            <span class="stock-dot ${dotClass}"></span>
                            <span class="font-black">${stockText}</span>
                        </div>
                        
                        <!-- CART ACTIONS -->
                        <div class="mt-4 flex gap-2" onclick="event.stopPropagation()">
                            ${inCart ? `
                                <div class="flex items-center bg-zinc-900 rounded-2xl border border-white/10 overflow-hidden">
                                    <button onclick="updateQty('${item.id}', -1)" class="px-4 py-3 text-white hover:bg-white/5 transition"><i data-lucide="minus" size="14"></i></button>
                                    <span class="text-xs font-black w-8 text-center">${inCart}</span>
                                    <button onclick="updateQty('${item.id}', 1)" class="px-4 py-3 text-white hover:bg-white/5 transition"><i data-lucide="plus" size="14"></i></button>
                                </div>
                                <button onclick="window.location.href='cart.html'" class="flex-1 bg-sdel text-black py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest active:scale-95 transition">View Cart</button>
                            ` : `
                                ${stock > 0 ? `
                                    <button onclick="addToCart('${item.id}')" class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest active:scale-95 transition">Add to Cart</button>
                                ` : `
                                    <button disabled class="w-full bg-zinc-800 text-zinc-500 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest cursor-not-allowed">Out of Stock</button>
                                `}
                            `}
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            lucide.createIcons();
        };

        // =============================================
        // FILTER PRODUCTS BY CATEGORY
        // =============================================
        window.filterProducts = (cat, e) => {
            document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
            e.currentTarget.classList.add('active');
            const filtered = cat === 'All' ? allProducts : allProducts.filter(p => 
                String(p.category).trim().toLowerCase() === String(cat).trim().toLowerCase()
            );
            window.renderProducts(filtered);
        };

        // =============================================
        // SEARCH FUNCTIONALITY
        // =============================================
        window.openSearch = () => { 
            document.getElementById('search-view').style.display = 'block'; 
            document.getElementById('search-input').focus(); 
            lucide.createIcons();
        };

        window.closeSearch = () => { 
            document.getElementById('search-view').style.display = 'none'; 
        };

        window.runSearch = (val) => {
            const container = document.getElementById('search-results-list');
            if(!val.trim()) { container.innerHTML = ""; return; }
            
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(val.toLowerCase()) ||
                p.description?.toLowerCase().includes(val.toLowerCase())
            );
            
            container.innerHTML = filtered.map(item => {
                const social = storeSocial[item.vendor_id] || {};
                return `
                <div class="search-item" onclick="viewFromSearch('${item.id}')">
                    <div class="flex items-center gap-3">
                        <img src="${item.image_url}" class="w-14 h-14 object-cover rounded-2xl border border-white/5" onerror="this.src='https://placehold.co/100/100/121212/FF6600?text=x'">
                        <div>
                            <p class="font-black text-sm uppercase italic tracking-tighter">${item.name}</p>
                            <p class="text-[8px] text-gray-500 font-black uppercase flex items-center gap-1">
                                <span>${item.category}</span>
                                <span>‚Ä¢</span>
                                <span>${social.store_level || 'BRONZE'} Store</span>
                            </p>
                            <p class="text-[8px] text-gray-500">${item.sold_count || 0} sold ‚Ä¢ ${social.follower_count || 0} followers</p>
                        </div>
                    </div>
                    <p class="font-black text-sdel text-sm">‚Ç¶${item.price.toLocaleString()}</p>
                </div>`;
            }).join('');
            
            lucide.createIcons();
        };

        window.viewFromSearch = (id) => { 
            const product = allProducts.find(p => p.id === id);
            if (product) {
                trackProductView(product.id, product.vendor_id);
                openProductModal(product);
            }
            closeSearch(); 
        };

        // =============================================
        // CREATE STARS BACKGROUND
        // =============================================
        function createStars() {
            const container = document.getElementById('stars');
            container.innerHTML = '';
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div'); 
                star.classList.add('star');
                star.style.width = star.style.height = (Math.random() * 2 + 1) + 'px';
                star.style.left = (Math.random() * 100) + 'vw'; 
                star.style.top = (Math.random() * 100) + 'vh';
                star.style.animationDuration = (Math.random() * 20 + 20) + 's'; 
                container.appendChild(star);
            }
        }

        // =============================================
        // CLICK OUTSIDE MODAL TO CLOSE
        // =============================================
        window.onclick = function(event) {
            const modal = document.getElementById('product-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // =============================================
        // INITIALIZE EVERYTHING! LET'S GO! üöÄ
        // =============================================
        init();

        // Refresh store levels periodically
        setInterval(() => {
            Object.keys(storeSocial).forEach(storeId => {
                const store = storeSocial[storeId];
                if (store) {
                    recalculateStoreLevel(storeId, store.follower_count || 0);
                }
            });
        }, 60000); // Every minute
    </script>
</body>
</html>
