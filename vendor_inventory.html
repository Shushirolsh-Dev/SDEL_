<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'sunlight') document.documentElement.classList.add('sunlight-mode');
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel | Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root { --bg: #000; --surface: #0a0a0a; --card: #121212; --border: rgba(255,255,255,0.08); --text: #fff; --dim: #71717a; }
        .sunlight-mode { --bg: #fff; --surface: #f4f4f5; --card: #ffffff; --border: #e4e4e7; --text: #09090b; --dim: #71717a; }
        
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; }
        .glass-card { background: var(--card); border: 1px solid var(--border); border-radius: 2rem; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .inventory-card { background: var(--card); border: 1px solid var(--border); border-radius: 1.5rem; padding: 1.5rem; }
        
        .stock-badge {
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }
        .stock-high { background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.2); }
        .stock-medium { background: rgba(255, 102, 0, 0.1); color: #FF6600; border: 1px solid rgba(255, 102, 0, 0.2); }
        .stock-low { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
        
        .edit-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="p-6 pb-28">

    <!-- Edit Modal -->
    <div id="editModal" class="edit-modal" onclick="if(event.target===this) hideEditModal()">
        <div class="glass-card p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-black text-sm uppercase tracking-wider">Edit Stock</h2>
                <button onclick="hideEditModal()" class="p-2 hover:bg-zinc-800 rounded-full">
                    <i data-lucide="x" size="16"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-[var(--dim)]">Product Name</label>
                    <p id="editProductName" class="font-black text-lg"></p>
                </div>
                
                <div>
                    <label class="text-[10px] font-black uppercase text-[var(--dim)]">Current Stock</label>
                    <p id="editCurrentStock" class="font-black text-2xl text-sdel"></p>
                </div>
                
                <div>
                    <label class="text-[10px] font-black uppercase text-[var(--dim)]">Update Stock</label>
                    <div class="flex items-center gap-3 mt-2">
                        <button onclick="adjustStock(-1)" class="w-12 h-12 bg-zinc-900 rounded-2xl flex items-center justify-center border border-[var(--border)]">
                            <i data-lucide="minus" size="20"></i>
                        </button>
                        <input type="number" id="stockInput" value="0" min="0" class="flex-1 p-4 bg-zinc-900 rounded-2xl border border-[var(--border)] text-center font-black text-xl">
                        <button onclick="adjustStock(1)" class="w-12 h-12 bg-zinc-900 rounded-2xl flex items-center justify-center border border-[var(--border)]">
                            <i data-lucide="plus" size="20"></i>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button onclick="setStock('set')" class="p-4 bg-sdel text-black rounded-2xl font-black text-[10px] uppercase tracking-wider">
                        Set Stock
                    </button>
                    <button onclick="setStock('add')" class="p-4 bg-green-500 text-black rounded-2xl font-black text-[10px] uppercase tracking-wider">
                        Add Stock
                    </button>
                </div>
                
                <button onclick="setStock('remove')" class="w-full p-4 bg-red-500/10 text-red-500 rounded-2xl font-black text-[10px] uppercase tracking-wider border border-red-500/20">
                    Remove Stock
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <nav class="flex items-center justify-between mb-8">
        <button onclick="window.location.href='vendor_dashboard.html'" class="p-3 bg-zinc-900/10 rounded-2xl border border-[var(--border)]">
            <i data-lucide="arrow-left" size="20"></i>
        </button>
        <h1 class="text-[10px] font-black uppercase tracking-[0.3em]">INVENTORY</h1>
        <button onclick="window.location.href='vendor_add_product.html'" class="p-3 bg-sdel/20 text-sdel rounded-2xl border border-sdel/30">
            <i data-lucide="plus" size="20"></i>
        </button>
    </nav>

    <!-- Stats Summary -->
    <div class="grid grid-cols-3 gap-3 mb-8">
        <div class="glass-card p-4 text-center">
            <p class="text-[8px] font-black uppercase text-[var(--dim)]">Total Items</p>
            <p class="text-2xl font-black" id="totalItems">0</p>
        </div>
        <div class="glass-card p-4 text-center">
            <p class="text-[8px] font-black uppercase text-[var(--dim)]">In Stock</p>
            <p class="text-2xl font-black text-green-500" id="totalStock">0</p>
        </div>
        <div class="glass-card p-4 text-center">
            <p class="text-[8px] font-black uppercase text-[var(--dim)]">Low Stock</p>
            <p class="text-2xl font-black text-red-500" id="lowStock">0</p>
        </div>
    </div>

    <!-- Inventory List -->
    <div class="space-y-3" id="inventoryList">
        <!-- Items load here -->
    </div>

    <!-- Quick Actions -->
    <div class="fixed bottom-24 left-6 right-6">
        <button onclick="window.loadInventory()" class="w-full glass-card p-4 text-sdel font-black text-xs uppercase tracking-wider flex items-center justify-center gap-2">
            <i data-lucide="refresh-cw" size="16"></i>
            Refresh Inventory
        </button>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let currentVendorId = null;
        let currentProduct = null;

        window.loadInventory = async function() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }

                // Get vendor record
                const { data: vendor } = await supabase
                    .from('vendors')
                    .select('id')
                    .eq('user_id', session.user.id)
                    .single();

                if (!vendor) {
                    document.getElementById('inventoryList').innerHTML = `
                        <div class="glass-card p-8 text-center">
                            <p class="text-sm">You need to be a verified vendor</p>
                            <button onclick="window.location.href='merchant_hub.html'" class="mt-4 px-6 py-3 bg-sdel text-black rounded-xl text-xs font-black">Become a Vendor</button>
                        </div>
                    `;
                    return;
                }

                currentVendorId = vendor.id;

                // Fetch products - using vendor_id from products table
                const { data: products } = await supabase
                    .from('products')
                    .select('*')
                    .eq('vendor_id', session.user.id)
                    .order('created_at', { ascending: false });

                if (!products || products.length === 0) {
                    document.getElementById('inventoryList').innerHTML = `
                        <div class="glass-card p-12 text-center space-y-4">
                            <i data-lucide="package" size="40" class="mx-auto text-[var(--dim)]"></i>
                            <p class="text-sm text-[var(--dim)]">No products yet</p>
                            <button onclick="window.location.href='vendor_add_product.html'" class="px-6 py-3 bg-sdel text-black rounded-xl text-xs font-black inline-block">Add Product</button>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Calculate stats
                const totalItems = products.length;
                const totalStock = products.reduce((sum, p) => sum + (p.stock || 0), 0);
                const lowStockItems = products.filter(p => (p.stock || 0) < 10).length;

                document.getElementById('totalItems').innerText = totalItems;
                document.getElementById('totalStock').innerText = totalStock;
                document.getElementById('lowStock').innerText = lowStockItems;

                // Render inventory
                const list = document.getElementById('inventoryList');
                list.innerHTML = products.map(product => {
                    const stock = product.stock || 0;
                    let stockClass = 'stock-high';
                    let stockText = 'In Stock';
                    
                    if (stock === 0) {
                        stockClass = 'stock-low';
                        stockText = 'Out of Stock';
                    } else if (stock < 5) {
                        stockClass = 'stock-low';
                        stockText = 'Critical';
                    } else if (stock < 10) {
                        stockClass = 'stock-medium';
                        stockText = 'Low Stock';
                    } else if (stock < 20) {
                        stockClass = 'stock-medium';
                        stockText = 'Medium Stock';
                    }

                    return `
                        <div class="glass-card p-5">
                            <div class="flex gap-4">
                                <img src="${product.image_url || 'https://placehold.co/100x100/121212/FF6600?text=No+Image'}" 
                                     class="w-20 h-20 object-cover rounded-2xl border border-[var(--border)]"
                                     onerror="this.src='https://placehold.co/100x100/121212/FF6600?text=No+Image'">
                                
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="font-black text-sm uppercase tracking-tighter">${product.name}</h3>
                                            <p class="text-[8px] text-[var(--dim)] uppercase mt-1">${product.category || 'Uncategorized'}</p>
                                        </div>
                                        <p class="font-black text-sdel">â‚¦${product.price?.toLocaleString() || '0'}</p>
                                    </div>
                                    
                                    <div class="flex items-center justify-between mt-3">
                                        <div>
                                            <span class="stock-badge ${stockClass}">${stockText}</span>
                                            <span class="ml-2 text-xs font-black">${stock} units</span>
                                        </div>
                                        
                                        <button onclick="openEditModal(${JSON.stringify(product).replace(/"/g, '&quot;')})" 
                                                class="p-2 bg-zinc-900 rounded-xl border border-[var(--border)]">
                                            <i data-lucide="edit-2" size="16" class="text-sdel"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                lucide.createIcons();

            } catch (error) {
                console.error('Error:', error);
            }
        };

        // Modal functions
        window.openEditModal = (product) => {
            currentProduct = product;
            document.getElementById('editProductName').innerText = product.name;
            document.getElementById('editCurrentStock').innerText = product.stock || 0;
            document.getElementById('stockInput').value = product.stock || 0;
            document.getElementById('editModal').style.display = 'flex';
            lucide.createIcons();
        };

        window.hideEditModal = () => {
            document.getElementById('editModal').style.display = 'none';
            currentProduct = null;
        };

        window.adjustStock = (delta) => {
            const input = document.getElementById('stockInput');
            let val = parseInt(input.value) || 0;
            val = Math.max(0, val + delta);
            input.value = val;
        };

        window.setStock = async (action) => {
            if (!currentProduct) return;
            
            const inputVal = parseInt(document.getElementById('stockInput').value) || 0;
            let newStock = inputVal;
            
            if (action === 'add') {
                newStock = (currentProduct.stock || 0) + inputVal;
            } else if (action === 'remove') {
                newStock = Math.max(0, (currentProduct.stock || 0) - inputVal);
            }
            
            const { error } = await supabase
                .from('products')
                .update({ stock: newStock })
                .eq('id', currentProduct.id);
                
            if (!error) {
                hideEditModal();
                window.loadInventory();
                showToast(`Stock updated to ${newStock} units`);
            }
        };

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#FF6600;color:black;padding:12px 24px;border-radius:30px;font-weight:600;z-index:2000;';
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Load inventory
        window.loadInventory();
        
        // Real-time updates
        setInterval(() => window.loadInventory(), 10000);
    </script>
</body>
</html>
