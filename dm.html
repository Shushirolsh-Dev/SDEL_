<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sdel | Ghost DM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000; color: white; overflow: hidden; height: 100vh; display: flex; flex-direction: column; position: fixed; width: 100%; }
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .star { position: absolute; background-color: white; border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { 0% { transform: translateY(-10vh); opacity: 0; } 20% { opacity: 0.6; } 80% { opacity: 0.6; } 100% { transform: translateY(110vh); opacity: 0; } }
        
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        
        /* Bubble Refinement */
        .msg-received { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(15px); border-radius: 24px 24px 24px 6px; align-self: flex-start; border: 1px solid rgba(255,255,255,0.05); }
        .msg-sent { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(15px); border-radius: 24px 24px 6px 24px; align-self: flex-end; border: 1px solid rgba(255,102,0,0.15); }
        
        /* Reaction Badges */
        .react-wrap { display: flex; gap: 4px; position: absolute; bottom: -12px; z-index: 20; }
        .react-badge { background: #000; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 2px 8px; font-size: 11px; box-shadow: 0 4px 15px rgba(0,0,0,0.8); }

        /* Animation for 24hr Timer */
        .rotate-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #send-btn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(0); opacity: 0; }
        #send-btn.active { transform: scale(1); opacity: 1; }
        
        /* Glass Pill */
        .glass-pill { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <nav class="flex-none flex justify-between items-center p-5 bg-black/80 backdrop-blur-xl border-b border-white/5 z-50">
        <div class="flex items-center space-x-4">
            <button onclick="location.href='homies.html'" class="text-zinc-500 active:scale-75 transition"><i data-lucide="chevron-left" size="24"></i></button>
            <div class="relative">
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center font-black text-xs border border-white/10">?</div>
                <div id="online-indicator" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-zinc-700 rounded-full border-2 border-black"></div>
            </div>
            <div>
                <h2 id="chat-name" class="text-xs font-black uppercase tracking-widest">Secure Line</h2>
                <p id="chat-status" class="text-[7px] text-zinc-600 font-bold uppercase tracking-[0.3em]">Encrypted Node</p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <button onclick="toggleSoon()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-sdel/5 text-sdel border border-sdel/10 active:scale-90 transition">
                <i data-lucide="bot" size="18"></i>
            </button>
            <button onclick="toggleSoon()" class="text-zinc-500"><i data-lucide="layout-grid" size="18"></i></button>
        </div>
    </nav>

    <div class="flex justify-center -mt-4 mb-2 z-10">
        <div class="glass-pill px-4 py-1.5 rounded-full flex items-center space-x-2 animate-pulse">
            <i data-lucide="clock" size="10" class="text-sdel rotate-slow"></i>
            <span class="text-[8px] font-black uppercase tracking-widest text-zinc-400">Messages auto-purge after 24hrs</span>
        </div>
    </div>

    <main id="chat-content" class="flex-1 overflow-y-auto p-5 flex flex-col space-y-10 scrollbar-hide"></main>

    <div class="flex-none px-4 bg-black/95 backdrop-blur-md border-t border-white/5 pb-[calc(20px+env(safe-area-inset-bottom))]">
        <div id="whatsapp-reply-ui" class="mx-2 hidden bg-zinc-900/50 rounded-t-2xl border-l-2 border-sdel p-3 mb-[-10px]">
            <div class="flex justify-between">
                <div>
                    <p id="reply-ui-name" class="text-[9px] font-black text-sdel uppercase"></p>
                    <p id="reply-ui-text" class="text-[11px] text-zinc-400 truncate"></p>
                </div>
                <button onclick="cancelReply()" class="text-zinc-600"><i data-lucide="x" size="14"></i></button>
            </div>
        </div>

        <div class="mt-4 flex items-end bg-zinc-900/40 rounded-[2rem] border border-white/5 px-2 focus-within:border-sdel/50 transition-all">
            <button onclick="toggleStealth()" id="stealth-btn" class="p-4 text-zinc-700 hover:text-sdel transition-colors"><i data-lucide="eye-off" size="18"></i></button>
            <textarea id="msg-input" oninput="handleInput(this)" rows="1" placeholder="Type encrypted message..." class="bg-transparent flex-1 text-[14px] py-4 px-2 focus:outline-none placeholder:text-zinc-800 font-bold text-white"></textarea>
            <div class="pb-2">
                <button id="send-btn" onclick="sendMsg()" class="bg-sdel text-black h-11 w-11 rounded-full flex items-center justify-center shadow-lg shadow-sdel/20">
                    <i id="send-icon" data-lucide="arrow-up" size="20" style="stroke-width: 3px;"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="action-sheet" class="fixed inset-0 bg-black/80 z-[200] hidden items-end" onclick="closeMenu()">
        <div class="sheet-content w-full bg-[#0a0a0a] rounded-t-[2.5rem] p-6 border-t border-white/10" onclick="event.stopPropagation()">
            <div class="flex justify-around mb-8 p-4 bg-zinc-900/50 rounded-3xl">
                <button class="text-2xl active:scale-150 transition" onclick="react('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="text-2xl active:scale-150 transition" onclick="react('üòÇ')">üòÇ</button>
                <button class="text-2xl active:scale-150 transition" onclick="react('üî•')">üî•</button>
                <button class="text-2xl active:scale-150 transition" onclick="react('üëç')">üëç</button>
                <button class="text-2xl active:scale-150 transition" onclick="react('‚ÄºÔ∏è')">‚ÄºÔ∏è</button>
            </div>
            <div class="space-y-3">
                <button class="w-full p-5 bg-zinc-900 rounded-2xl flex items-center space-x-4 font-black text-xs uppercase" onclick="handleReplyAction()"><i data-lucide="reply" size="18"></i> <span>Reply</span></button>
                <button class="w-full p-5 bg-zinc-900 rounded-2xl flex items-center space-x-4 font-black text-xs uppercase" onclick="copyToClipboard()"><i data-lucide="copy" size="18"></i> <span>Copy</span></button>
                <button id="delete-btn-opt" class="w-full p-5 bg-red-500/10 text-red-500 rounded-2xl flex items-center space-x-4 font-black text-xs uppercase" onclick="deleteMsg()"><i data-lucide="trash-2" size="18"></i> <span>Purge Message</span></button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://lgfyrlfjoazedwymjpfc.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const homieId = urlParams.get('id'); 
        let myId, myName, theirName, selectedId, selectedText, selectedIsMe;

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return; myId = session.user.id;
            loadHomieProfile(); 
            fetchMessages();
            supabaseClient.channel('dm_sync').on('postgres_changes', { event: '*', schema: 'public', table: 'dm_table' }, () => fetchMessages()).subscribe();
            createStars(); lucide.createIcons();
        }

        async function loadHomieProfile() {
            const { data: p } = await supabaseClient.from('profile').select('*').eq('id', homieId).single();
            if (p) {
                theirName = p.first_name || p.username;
                document.getElementById('chat-name').innerText = theirName;
                document.getElementById('user-avatar').innerText = theirName[0].toUpperCase();
                if (p.is_online) {
                    document.getElementById('online-indicator').classList.replace('bg-zinc-700', 'bg-green-500');
                    document.getElementById('chat-status').innerText = "Active Now";
                }
            }
        }

        function renderChat(messages) {
            const container = document.getElementById('chat-content');
            container.innerHTML = '';
            const now = new Date();

            messages.forEach(msg => {
                const isMe = msg.sender_id === myId;
                const msgTime = new Date(msg.created_at);
                const diffMins = Math.floor((now - msgTime) / 60000);
                
                // IGNORED LOGIC: Seen but > 30 mins old without a reply/reaction
                let statusText = msg.is_read ? 'Seen' : 'Sent';
                let statusClass = msg.is_read ? 'text-green-500' : 'text-zinc-600';
                
                if (isMe && msg.is_read && diffMins > 30) {
                    statusText = 'Ignored';
                    statusClass = 'text-zinc-500';
                }

                const bubble = document.createElement('div');
                bubble.className = `${isMe ? 'msg-sent' : 'msg-received'} p-4 relative min-w-[80px] max-w-[85%]`;
                bubble.onclick = () => openMenu(msg.id, msg.content, isMe);

                bubble.innerHTML = `
                    <p class="text-[13px] font-bold leading-relaxed">${msg.content.includes('¬ª') ? msg.content.split('¬ª')[1] : msg.content}</p>
                    <div class="mt-2 flex items-center justify-between space-x-4">
                        <span class="text-[7px] text-zinc-700 font-black uppercase">${msgTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        ${isMe ? `<span class="text-[7px] font-black uppercase tracking-widest ${statusClass}">${statusText}</span>` : ''}
                    </div>
                `;

                if (msg.reaction_me || msg.reaction_them) {
                    const reactHtml = `
                        <div class="react-wrap ${isMe ? 'right-2' : 'left-2'}">
                            ${msg.reaction_me ? `<div class="react-badge">${msg.reaction_me}</div>` : ''}
                            ${msg.reaction_them ? `<div class="react-badge">${msg.reaction_them}</div>` : ''}
                        </div>`;
                    bubble.innerHTML += reactHtml;
                }

                container.appendChild(bubble);
            });
            container.scrollTop = container.scrollHeight;
        }

        async function react(emoji) {
            const { data: msg } = await supabaseClient.from('dm_table').select('*').eq('id', selectedId).single();
            const isMe = msg.sender_id === myId;
            
            // UNDO LOGIC: If the reaction is the same, set to null
            let update = {};
            if (isMe) {
                update.reaction_me = (msg.reaction_me === emoji) ? null : emoji;
            } else {
                update.reaction_them = (msg.reaction_them === emoji) ? null : emoji;
            }

            await supabaseClient.from('dm_table').update(update).eq('id', selectedId);
            closeMenu();
        }

        async function fetchMessages() {
            const { data } = await supabaseClient.from('dm_table').select('*').or(`and(sender_id.eq.${myId},receiver_id.eq.${homieId}),and(sender_id.eq.${homieId},receiver_id.eq.${myId})`).order('created_at', { ascending: true });
            if (data) renderChat(data);
        }

        function handleInput(el) {
            el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px';
            const btn = document.getElementById('send-btn');
            el.value.length > 0 ? btn.classList.add('active') : btn.classList.remove('active');
        }

        function openMenu(id, text, isMe) {
            selectedId = id; selectedText = text; selectedIsMe = isMe;
            const sheet = document.getElementById('action-sheet');
            sheet.classList.replace('hidden', 'flex');
            lucide.createIcons();
        }

        function closeMenu() { document.getElementById('action-sheet').classList.replace('flex', 'hidden'); }

        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = star.style.height = `${Math.random() * 2}px`;
                star.style.left = `${Math.random() * 100}vw`;
                star.style.animationDuration = `${Math.random() * 5 + 5}s`;
                container.appendChild(star);
            }
        }

        function toggleStealth() {
            const btn = document.getElementById('stealth-btn');
            btn.classList.toggle('text-sdel');
            // Logic for stealth: hide chat content or blur
            document.getElementById('chat-content').classList.toggle('blur-xl');
        }

        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const val = input.value.trim();
            if (!val) return;
            await supabaseClient.from('dm_table').insert({ sender_id: myId, receiver_id: homieId, content: val });
            input.value = ''; handleInput(input);
        }

        init();
    </script>
</body>
</html>
