<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // ANTI-FLICKER: Apply theme immediately from global setting
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'sunlight') {
                document.documentElement.classList.add('sunlight-mode');
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel | Secure Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #000; color: white; overflow-x: hidden; transition: background-color 0.3s; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-zinc { background: rgba(18, 18, 18, 0.7); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        .star { position: absolute; background-color: rgba(255,255,255,0.6); border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }
        
        input, select { background: rgba(255,255,255,0.03) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; }
        input:focus { border-color: #FF6600 !important; outline: none; }
        .method-card { border: 2px solid transparent; transition: all 0.3s; cursor: pointer; }
        .method-card.active { border-color: #FF6600; background: rgba(255, 102, 0, 0.05); }

        .phone-box { display: flex; align-items: center; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; overflow: hidden; }
        .phone-box:focus-within { border-color: #FF6600; }
        .phone-prefix { padding: 0 12px 0 16px; color: #888; font-weight: 900; font-size: 14px; border-right: 1px solid rgba(255,255,255,0.1); }
        .phone-input { background: transparent !important; border: none !important; padding: 16px 12px !important; width: 100%; }

        #custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 9999; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: #0a0a0a; border: 1px solid #222; border-radius: 30px; padding: 40px 20px; width: 100%; max-width: 350px; text-align: center; }
        
        .order-id-badge { background: rgba(255, 102, 0, 0.1); border: 1px dashed #FF6600; color: #FF6600; font-family: monospace; }

        /* Sunlight Mode Overrides */
        .sunlight-mode body { background-color: #ffffff; color: #121212; }
        .sunlight-mode nav { background-color: rgba(255, 255, 255, 0.9); border-color: #e4e4e7; }
        .sunlight-mode .text-white { color: #121212; }
        .sunlight-mode .card-zinc { background: #f4f4f5; border-color: #e4e4e7; }
        .sunlight-mode input, .sunlight-mode .phone-box { background: #f4f4f5 !important; border-color: #d4d4d8 !important; color: #121212 !important; }
        .sunlight-mode .phone-prefix { border-color: #d4d4d8; }
        .sunlight-mode #pay-btn { background-color: #121212; color: #ffffff; }
        .sunlight-mode .star { background-color: rgba(0,0,0,0.1); }
        .sunlight-mode .modal-card { background: #ffffff; border-color: #e4e4e7; color: #121212; }
    </style>
</head>
<body class="pb-10">
    <div class="stars" id="stars"></div>

    <div id="custom-modal">
        <div class="modal-card">
            <div id="modal-icon" class="mb-4 flex justify-center"></div>
            <h3 id="modal-title" class="text-xl font-black italic uppercase tracking-tighter mb-2"></h3>
            <div id="order-id-display" class="hidden mb-4 p-2 rounded-lg order-id-badge text-xs font-bold"></div>
            <p id="modal-desc" class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-8 px-4"></p>
            <button onclick="closeModal()" class="w-full bg-white text-black py-4 rounded-xl font-black uppercase text-[10px] tracking-widest">Continue</button>
        </div>
    </div>

    <nav class="p-6 flex items-center justify-between border-b border-white/10 sticky top-0 bg-black/90 backdrop-blur-md z-50">
        <a href="cart.html" class="text-white"><i data-lucide="chevron-left"></i></a>
        <h1 class="text-lg font-black uppercase tracking-tighter italic">Secure <span class="text-sdel">Checkout</span></h1>
        <div></div>
    </nav>

    <main class="p-6 max-w-xl mx-auto space-y-8 relative z-10">
        <section class="space-y-4">
            <h2 class="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500">Delivery Information</h2>
            <div class="space-y-3">
                <input type="text" id="cust-name" placeholder="Full Name" class="w-full p-4 rounded-2xl text-sm font-bold">
                <input type="text" id="cust-address" placeholder="Hostel / Building / Apartment" class="w-full p-4 rounded-2xl text-sm font-bold">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="cust-room" placeholder="Room/Floor" class="w-full p-4 rounded-2xl text-sm font-bold">
                    <div class="phone-box">
                        <span class="phone-prefix">+234</span>
                        <input type="tel" id="cust-phone" placeholder="801234..." maxlength="10" class="phone-input font-bold text-sm" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                </div>
            </div>
        </section>

        <section class="space-y-4">
            <h2 class="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500">Payment Method</h2>
            <div class="grid grid-cols-1 gap-3">
                <div onclick="setMethod('wallet')" id="method-wallet" class="method-card card-zinc p-5 rounded-3xl flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-zinc-900 rounded-2xl text-sdel"><i data-lucide="wallet"></i></div>
                        <div>
                            <p class="text-xs font-black uppercase">Sdel Wallet</p>
                            <p class="text-[10px] text-zinc-500 font-bold">Balance: â‚¦0.00</p>
                        </div>
                    </div>
                    <div class="text-[10px] font-black text-zinc-600 italic">Insufficient</div>
                </div>
                
                <div onclick="setMethod('pod')" id="method-pod" class="method-card active card-zinc p-5 rounded-3xl flex items-center gap-4">
                    <div class="p-3 bg-zinc-900 rounded-2xl text-white"><i data-lucide="truck"></i></div>
                    <div>
                        <p class="text-xs font-black uppercase">Pay on Delivery / Transfer</p>
                        <p class="text-[10px] text-zinc-500 font-bold">Manual verification required</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="card-zinc p-6 rounded-[2.5rem] space-y-4 border border-white/5">
            <h2 class="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500">Order Summary</h2>
            <div id="summary-items" class="space-y-3"></div>
            <div class="pt-4 border-t border-white/10 space-y-2">
                <div class="flex justify-between text-zinc-400 text-xs font-bold">
                    <span>Subtotal</span>
                    <span id="subtotal">â‚¦0</span>
                </div>
                <div class="flex justify-between text-zinc-400 text-xs font-bold">
                    <span>Delivery Fee</span>
                    <span id="delivery-fee-display">â‚¦0</span>
                </div>
                <div class="flex justify-between text-white text-lg font-black italic">
                    <span>TOTAL</span>
                    <span id="final-total" class="text-sdel">â‚¦0</span>
                </div>
            </div>
        </section>

        <button onclick="confirmOrder()" id="pay-btn" class="w-full bg-white text-black py-5 rounded-2xl font-black uppercase text-xs tracking-[0.2em] active:scale-95 transition">
            Confirm Order
        </button>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // Initialize Supabase client
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        // Get checkout items from localStorage
        let checkoutItems = JSON.parse(localStorage.getItem('checkout_items')) || [];
        let selectedMethod = 'pod';
        let userFirstName = '';
        let deliveryFee = 0;
        let deliveryType = 'free';
        let deliveryValue = 0;

        // Modal functions
        window.showAlert = (title, desc, type = 'error', orderCode = null) => {
            const modal = document.getElementById('custom-modal');
            const icon = document.getElementById('modal-icon');
            const idDisplay = document.getElementById('order-id-display');
            
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            
            if(orderCode) {
                idDisplay.innerText = `ORDER ID: ${orderCode}`;
                idDisplay.classList.remove('hidden');
            } else {
                idDisplay.classList.add('hidden');
            }

            icon.innerHTML = type === 'success' 
                ? '<div class="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center text-green-500"><i data-lucide="check-circle" size="32"></i></div>'
                : '<div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center text-red-500"><i data-lucide="alert-circle" size="32"></i></div>';
            
            modal.style.display = 'flex';
            lucide.createIcons();
        };

        window.closeModal = () => {
            document.getElementById('custom-modal').style.display = 'none';
        };

        // Load delivery settings from app_config
        async function loadDeliverySettings() {
            // Get delivery type
            const { data: typeData, error: typeError } = await supabase
                .from('app_config')
                .select('price')
                .eq('id', 'delivery_type')
                .maybeSingle();
            
            // Get delivery value
            const { data: valueData, error: valueError } = await supabase
                .from('app_config')
                .select('price')
                .eq('id', 'delivery_value')
                .maybeSingle();
            
            // Set values (with defaults)
            deliveryType = typeData?.price === 1 ? 'flat' : typeData?.price === 2 ? 'percentage' : 'free';
            deliveryValue = valueData?.price || 0;
            
            // Calculate delivery fee based on type
            const subtotal = checkoutItems.reduce((sum, i) => sum + (i.products.price * i.quantity), 0);
            
            if (deliveryType === 'free') {
                deliveryFee = 0;
            } else if (deliveryType === 'flat') {
                deliveryFee = deliveryValue;
            } else if (deliveryType === 'percentage') {
                deliveryFee = (subtotal * deliveryValue) / 100;
            }
            
            document.getElementById('delivery-fee-display').innerText = `â‚¦${deliveryFee.toLocaleString()}`;
            updateTotal();
        }

        // Update total with delivery fee
        function updateTotal() {
            const subtotal = checkoutItems.reduce((sum, i) => sum + (i.products.price * i.quantity), 0);
            const total = subtotal + deliveryFee;
            document.getElementById('final-total').innerText = `â‚¦${total.toLocaleString()}`;
        }

        // Initialize page
        async function init() {
            if(checkoutItems.length === 0) {
                window.location.href = 'market.html';
                return;
            }
            
            // Check if user is authenticated
            const { data: { user }, error } = await supabase.auth.getUser();
            if (error || !user) {
                showAlert("Authentication Required", "Please log in to continue with checkout");
                setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                return;
            }
            
            // Get user's first name from profile table
            const { data: profile } = await supabase
                .from('profiles')
                .select('first_name')
                .eq('id', user.id)
                .single();
            
            userFirstName = profile?.first_name || 'Customer';
            
            // Pre-fill name if available
            if (userFirstName !== 'Customer') {
                document.getElementById('cust-name').value = userFirstName;
            }
            
            // Load delivery settings first
            await loadDeliverySettings();
            renderSummary();
            createStars();
            lucide.createIcons();
        }

        // Render order summary
        function renderSummary() {
            const container = document.getElementById('summary-items');
            const subtotal = checkoutItems.reduce((sum, i) => sum + (i.products.price * i.quantity), 0);
            
            container.innerHTML = checkoutItems.map(item => {
                const price = item.products.price * item.quantity;
                return `
                    <div class="flex justify-between items-center">
                        <p class="text-xs font-bold text-zinc-300">${item.products.name} <span class="text-zinc-600">x${item.quantity}</span></p>
                        <p class="text-xs font-black">â‚¦${price.toLocaleString()}</p>
                    </div>
                `;
            }).join('');

            document.getElementById('subtotal').innerText = `â‚¦${subtotal.toLocaleString()}`;
            updateTotal();
        }

        // Set payment method
        window.setMethod = (m) => {
            if(m === 'wallet') return; // Disable wallet for now
            selectedMethod = m;
            document.querySelectorAll('.method-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`method-${m}`).classList.add('active');
        };

        // Function to check and deduct stock
        async function checkAndDeductStock(items) {
            // First check if all items have sufficient stock
            for (const item of items) {
                const { data: product, error } = await supabase
                    .from('products')
                    .select('stock, name')
                    .eq('id', item.id)
                    .single();
                
                if (error || !product) {
                    throw new Error(`Product ${item.name} not found`);
                }
                
                if (product.stock < item.quantity) {
                    throw new Error(`Only ${product.stock} ${product.name} left in stock`);
                }
            }
            
            // If all checks pass, deduct stock
            for (const item of items) {
                const { data: product } = await supabase
                    .from('products')
                    .select('stock')
                    .eq('id', item.id)
                    .single();
                
                const newStock = product.stock - item.quantity;
                
                const { error } = await supabase
                    .from('products')
                    .update({ stock: newStock })
                    .eq('id', item.id);
                
                if (error) {
                    throw new Error(`Failed to update stock for ${item.name}`);
                }
            }
        }

        // Confirm order function
        window.confirmOrder = async () => {
            const btn = document.getElementById('pay-btn');
            const name = document.getElementById('cust-name').value.trim();
            const phone = document.getElementById('cust-phone').value.trim();
            const address = document.getElementById('cust-address').value.trim();
            const room = document.getElementById('cust-room').value.trim();
            
            // Validate inputs
            if(!name) { 
                showAlert("Missing Info", "Please enter your full name"); 
                return; 
            }
            
            if(phone.length !== 10) { 
                showAlert("Missing Info", "Please enter a valid 10-digit phone number"); 
                return; 
            }
            
            if(!address) { 
                showAlert("Missing Info", "Please enter your delivery address"); 
                return; 
            }

            btn.disabled = true;
            btn.innerText = "Processing Order...";

            try {
                // Get the current authenticated user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    throw new Error("Please log in to place an order");
                }

                // Prepare order items
                const orderItems = checkoutItems.map(item => ({
                    id: item.products.id,
                    name: item.products.name,
                    price: item.products.price,
                    quantity: item.quantity
                }));

                // Calculate total with delivery fee
                const subtotal = checkoutItems.reduce((sum, i) => sum + (i.products.price * i.quantity), 0);
                const totalAmount = subtotal + deliveryFee;

                // CHECK AND DEDUCT STOCK BEFORE CREATING ORDER
                await checkAndDeductStock(orderItems);

                // Insert order with dynamic delivery fee
                const { data, error } = await supabase
                    .from('orders')
                    .insert([{
                        user_id: user.id,
                        total_amount: totalAmount,
                        delivery_fee: deliveryFee,
                        items: orderItems,
                        status: 'pending',
                        payment_method: selectedMethod,
                        item_name: orderItems[0]?.name || 'Order',
                        delivery_info: {
                            name, 
                            phone: "+234" + phone,
                            address: address,
                            room: room || 'Not specified'
                        }
                    }])
                    .select('order_code'); 

                if(error) throw error;

                // Clear cart items
                const idsToRemove = checkoutItems.map(i => i.id).filter(id => id);
                if(idsToRemove.length > 0) {
                    await supabase.from('cart').delete().in('id', idsToRemove);
                }
                
                // Clear localStorage
                localStorage.removeItem('checkout_items');
                
                // Professional thank you message with first name
                const generatedCode = data[0]?.order_code || 'N/A';
                const thankYouMessage = `Thank you ${userFirstName}! Your order has been received and is being processed. We'll notify you once it's confirmed. We appreciate your business and look forward to serving you again! ðŸ§¡`;
                
                showAlert("Order Confirmed!", thankYouMessage, "success", generatedCode);
                
                // Redirect after delay
                setTimeout(() => { 
                    window.location.href = 'dashboard.html'; 
                }, 8000);

            } catch (err) {
                console.error('Order Error:', err);
                showAlert("Order Failed", err.message || "Database error occurred");
                btn.disabled = false;
                btn.innerText = "Confirm Order";
            }
        };

        // Create falling stars effect
        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = star.style.height = (Math.random() * 2 + 1) + 'px';
                star.style.left = (Math.random() * 100) + 'vw';
                star.style.top = (Math.random() * 100) + 'vh';
                star.style.animationDuration = (Math.random() * 20 + 20) + 's';
                container.appendChild(star);
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>
