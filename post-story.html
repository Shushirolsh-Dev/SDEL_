<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Share Story</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        async function checkUser() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) window.location.replace('login.html');
        }

        window.uploadStory = async () => {
            const fileInput = document.getElementById('story-file');
            const btn = document.getElementById('post-btn');
            const file = fileInput.files[0];

            if (!file) return alert("Please select a photo first, homie.");
            
            if (file.type.includes('video')) {
                alert("Videos are not allowed yet. Images only!");
                return;
            }

            btn.innerText = "POSTING...";
            btn.disabled = true;

            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}.${fileExt}`;

            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('story-uploads')
                .upload(fileName, file);

            if (uploadError) {
                alert("Upload failed: " + uploadError.message);
                btn.innerText = "TRY AGAIN";
                btn.disabled = false;
                return;
            }

            const { data: { publicUrl } } = supabase.storage.from('story-uploads').getPublicUrl(fileName);

            const { data: { session } } = await supabase.auth.getSession();
            const { error: dbError } = await supabase.from('stories').insert([{
                author_id: session.user.id,
                media_url: publicUrl,
                caption: document.getElementById('caption').value
            }]);

            if (dbError) {
                alert("Database error: " + dbError.message);
            } else {
                await supabase.rpc('increment_xp', { user_id: session.user.id, x: 50 });
                window.location.href = 'dashboard.html';
            }
        };

        window.previewImage = (event) => {
            const file = event.target.files[0];
            if (file.type.includes('video')) {
                alert("Videos are not supported.");
                event.target.value = "";
                return;
            }
            const reader = new FileReader();
            reader.onload = function(){
                const output = document.getElementById('img-preview');
                output.src = reader.result;
                output.classList.remove('hidden');
                document.getElementById('placeholder-icon').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        };

        checkUser();
    </script>
    <style>
        * { -webkit-tap-highlight-color: transparent; font-family: 'Poppins', sans-serif; }
        body { background-color: #000; color: #FFFFFF; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-high-contrast { background: #111111; border: 2px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body class="text-white">

    <div class="max-w-md mx-auto p-6 min-h-screen flex flex-col">
        <nav class="flex justify-between items-center mb-8">
            <button onclick="window.location.href='dashboard.html'" class="text-white font-black text-[11px] uppercase border-b-2 border-white/20 pb-1">‚Üê Close</button>
            <h1 class="text-sm font-black uppercase italic tracking-[0.2em] text-sdel">New Gist</h1>
            <div class="w-10"></div>
        </nav>

        <div class="flex flex-col items-center space-y-6 flex-1">
            <div class="relative w-64 h-64 card-high-contrast rounded-[2.5rem] flex items-center justify-center overflow-hidden shadow-2xl shadow-sdel/10">
                <input type="file" id="story-file" accept="image/*" class="absolute inset-0 opacity-0 z-10 cursor-pointer" onchange="previewImage(event)">
                
                <div id="placeholder-icon" class="text-center p-4">
                    <div class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-3 border border-white/20">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FF6600" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    </div>
                    <p class="text-[10px] font-black uppercase text-white tracking-widest">Tap to select</p>
                </div>

                <img id="img-preview" class="hidden w-full h-full object-cover">
            </div>

            <div class="w-full space-y-2">
                <p class="text-[10px] font-black uppercase text-white ml-2">Add a Caption</p>
                <textarea id="caption" rows="2" placeholder="Write something..." 
                    class="w-full bg-[#111111] border-2 border-white/10 rounded-2xl p-4 text-[13px] font-bold text-white outline-none focus:border-sdel transition resize-none placeholder:text-white/30"></textarea>
            </div>
        </div>

        <div class="pt-6">
            <div class="flex items-center justify-center space-x-2 mb-6">
                <span class="h-px bg-white/20 flex-1"></span>
                <span class="text-[10px] font-black text-sdel uppercase tracking-[0.2em]">Earn +50 XP</span>
                <span class="h-px bg-white/20 flex-1"></span>
            </div>
            <button id="post-btn" onclick="uploadStory()" 
                class="w-full bg-sdel text-black py-5 rounded-[2rem] font-black uppercase italic tracking-[0.1em] text-[12px] shadow-xl shadow-sdel/20 active:scale-95 transition">
                Share to Circle
            </button>
        </div>
    </div>

</body>
</html>
