<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Global Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000; color: #fff; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-glass { background: #111; border: 1px solid rgba(255,255,255,0.15); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* RING STYLES */
        .ring-sdel-new { border: 3px solid #fbbf24; animation: gold-glow 2s infinite; }
        .ring-sdel-watched { border: 3px solid #22c55e; } /* Green */
        .ring-me { border: 3px solid #3f3f46; } /* Ash */
        .ring-homie-watched { border: 3px solid #3f3f46; } /* Ash */
        
        /* BLUE ROTATING RING */
        .ring-homie-new {
            position: relative;
            padding: 3px;
            background: #000;
            border-radius: 50%;
        }
        .ring-homie-new::before {
            content: "";
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            padding: 3px;
            background: conic-gradient(#3b82f6, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate { to { transform: rotate(360deg); } }
        @keyframes gold-glow { 0%, 100% { box-shadow: 0 0 5px #fbbf24; } 50% { box-shadow: 0 0 15px #fbbf24; } }
    </style>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let currentUserId = null;

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return window.location.href = 'login.html';
            currentUserId = session.user.id;

            const { data: profile } = await supabase.from('profile').select('*').eq('id', currentUserId).single();
            document.getElementById('user-name').innerText = profile?.first_name || session.user.user_metadata?.first_name || "CHAMP";
            
            if(profile) {
                document.getElementById('wallet-pill').innerText = `₦${(profile.wallet_balance || 0).toLocaleString()}`;
                if (profile.avatar_url) document.getElementById('user-avatar').src = profile.avatar_url;
                updatePrestige(profile.xp || 0);
            }

            loadStories();
            loadFeed();
            loadAds(); 
        }

        async function loadStories() {
            const now = new Date().toISOString();
            
            // 1. Get Homies
            const { data: follows } = await supabase.from('followers').select('following_id').eq('follower_id', currentUserId);
            const homieIds = follows ? follows.map(f => f.following_id) : [];

            // 2. Get Viewed Stories
            const { data: viewed } = await supabase.from('story_views').select('story_id').eq('user_id', currentUserId);
            const viewedSet = new Set(viewed?.map(v => v.story_id));

            // 3. Fetch Stories
            const { data: stories } = await supabase
                .from('stories')
                .select('*, profile:profile(first_name, is_official)')
                .gt('expires_at', now)
                .or(`is_official_post.eq.true,author_id.eq.${currentUserId},author_id.in.(${homieIds.join(',') || '00000000-0000-0000-0000-000000000000'})`);

            if (!stories) return;

            // Group by user (only show latest story per person)
            const userLatestMap = new Map();
            stories.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(s => {
                if(!userLatestMap.has(s.author_id)) userLatestMap.set(s.author_id, s);
            });
            let uniqueStories = Array.from(userLatestMap.values());

            // 4. SORTING LOGIC
            const sorted = uniqueStories.sort((a, b) => {
                const aIsSdel = a.is_official_post || a.profile?.is_official;
                const bIsSdel = b.is_official_post || b.profile?.is_official;
                const aWatched = viewedSet.has(a.id);
                const bWatched = viewedSet.has(b.id);
                const aIsMe = a.author_id === currentUserId;
                const bIsMe = b.author_id === currentUserId;

                // Priority 1: SDEL
                if (aIsSdel && !bIsSdel) return -1;
                if (!aIsSdel && bIsSdel) return 1;

                // Priority 2: Me (if SDEL exists, Me is 2nd)
                if (aIsMe && !bIsMe) return -1;
                if (!aIsMe && bIsMe) return 1;

                // Priority 3: Unwatched vs Watched
                if (!aWatched && bWatched) return -1;
                if (aWatched && !bWatched) return 1;

                // Priority 4: Latest first
                return new Date(b.created_at) - new Date(a.created_at);
            });

            const rail = document.getElementById('story-rail-content');
            rail.innerHTML = sorted.map(s => {
                const isSdel = s.is_official_post || s.profile?.is_official;
                const isMe = s.author_id === currentUserId;
                const isWatched = viewedSet.has(s.id);
                
                let ringClass = "";
                if (isSdel) ringClass = isWatched ? "ring-sdel-watched" : "ring-sdel-new";
                else if (isMe) ringClass = "ring-me";
                else ringClass = isWatched ? "ring-homie-watched" : "ring-homie-new";

                return `
                    <div class="flex-shrink-0 flex flex-col items-center space-y-2" onclick="watchStory('${s.id}')">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center ${ringClass}">
                            <img src="${s.media_url}" class="w-[58px] h-[58px] rounded-full object-cover bg-zinc-900">
                        </div>
                        <span class="text-[9px] font-black uppercase ${isSdel ? 'text-yellow-400' : 'text-white'} truncate w-16 text-center">
                            ${isSdel ? 'SDEL' : (s.profile?.first_name || 'HOMIE')}
                        </span>
                    </div>`;
            }).join('');
        }

        window.watchStory = async (id) => {
            // Log the view
            await supabase.from('story_views').upsert({ user_id: currentUserId, story_id: id });
            location.href = `view-story.html?id=${id}`;
        };

        // ... Keep existing loadAds, updatePrestige, loadFeed functions from previous code ...
        
        init();
    </script>
</head>
<body class="pb-24">
    <nav class="p-5 flex justify-between items-center sticky top-0 bg-black/90 z-50 border-b border-white/10 backdrop-blur-xl">
        <div class="flex items-center space-x-3">
            <div class="w-12 h-12 rounded-full border-2 border-white overflow-hidden shadow-lg shadow-white/10">
                <img id="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Lucky" class="w-full h-full object-cover">
            </div>
            <div>
                <p class="font-black text-lg italic uppercase">HI, <span id="user-name" class="text-sdel">...</span></p>
                <span id="wallet-pill" class="bg-white text-black text-[9px] font-black px-2 py-0.5 rounded italic">₦0.00</span>
            </div>
        </div>
        <div class="flex items-center space-x-5">
            <i data-lucide="search" size="24" onclick="location.href='circle.html'"></i>
            <i data-lucide="bell" size="24" onclick="location.href='messages.html'"></i>
        </div>
    </nav>

    <section class="p-4 border-b border-white/5">
        <div class="flex space-x-4 overflow-x-auto no-scrollbar py-2">
            <div class="flex-shrink-0 flex flex-col items-center space-y-2" onclick="location.href='post-story.html'">
                <div class="w-16 h-16 rounded-full bg-zinc-900 border-2 border-dashed border-white/40 flex items-center justify-center">
                    <i data-lucide="plus" size="24"></i>
                </div>
                <span class="text-[9px] font-black uppercase">Post</span>
            </div>
            <div id="story-rail-content" class="flex space-x-4"></div>
        </div>
    </section>

    <main id="global-feed" class="p-4 space-y-6"></main>

    <nav class="fixed bottom-0 inset-x-0 p-5 flex justify-around items-center bg-black/95 border-t border-white/10 z-50">
        <i data-lucide="home" class="text-sdel" size="28"></i>
        <i data-lucide="compass" class="text-white" size="28" onclick="location.href='explore.html'"></i>
        <div class="bg-sdel h-14 w-14 rounded-2xl flex items-center justify-center -mt-12 shadow-2xl border-4 border-black active:scale-90 transition" onclick="location.href='post-story.html'">
            <i data-lucide="camera" class="text-black" size="28"></i>
        </div>
        <i data-lucide="shopping-cart" class="text-white" size="28" onclick="location.href='market.html'"></i>
        <i data-lucide="user" class="text-white" size="28" onclick="location.href='profile.html'"></i>
    </nav>

    <script>lucide.createIcons();</script>
</body>
</html>
