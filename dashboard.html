<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Command Center</title>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');
        window.supabase = supabase;

        function getTier(xp) {
            if (xp >= 50000) return { name: 'SUPREME', color: '#A855F7', next: 100000 };
            if (xp >= 25000) return { name: 'GRANDMASTER', color: '#FF6600', next: 50000 };
            if (xp >= 12000) return { name: 'EXECUTIVE', color: '#EAB308', next: 25000 };
            if (xp >= 6000) return { name: 'ELITE', color: '#3B82F6', next: 12000 };
            if (xp >= 2500) return { name: 'STALWART', color: '#CD7F32', next: 6000 };
            if (xp >= 1000) return { name: 'NOVICE II', color: '#E2E8F0', next: 2500 };
            return { name: 'NOVICE I', color: '#CBD5E1', next: 1000 };
        }

        async function gatekeeper() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.replace('login.html'); return; }

            const { data: profile } = await supabase.from('profile').select('*').eq('id', session.user.id).single();
            if (profile?.account_status === 'banned') { window.location.replace('login.html'); return; }

            document.documentElement.style.opacity = "1";
            
            const firstName = profile.first_name || "Scholar";
            const tier = getTier(profile.xp || 0);

            document.getElementById('js-name').innerText = firstName;
            document.getElementById('rank-badge').innerText = tier.name;
            document.getElementById('rank-badge').style.backgroundColor = tier.color;
            document.getElementById('user-xp').innerText = `${(profile.xp || 0).toLocaleString()} XP`;
            document.getElementById('wallet-balance').innerText = `₦${(profile.wallet_balance || 0).toLocaleString()}`;
            
            const progress = ((profile.xp || 0) / tier.next) * 100;
            document.getElementById('xp-bar').style.width = `${Math.min(progress, 100)}%`;

            loadStories();
            loadShouts();
        }

        async function loadStories() {
            const { data: stories } = await supabase.from('stories').select('*, profile(first_name)').gt('expires_at', new Date().toISOString());
            const container = document.getElementById('story-rail-content');
            if (stories?.length > 0) {
                container.innerHTML = stories.map(s => `
                    <div class="flex-shrink-0 flex flex-col items-center space-y-1">
                        <div class="w-14 h-14 rounded-full border-2 border-sdel p-[2px]">
                            <img src="${s.media_url}" class="w-full h-full rounded-full object-cover bg-zinc-800">
                        </div>
                        <span class="text-[8px] font-bold uppercase text-white">${s.profile?.first_name || 'User'}</span>
                    </div>
                `).join('');
            }
        }

        async function loadShouts() {
            const { data: shouts } = await supabase.from('posts').select('*, profile(first_name)').order('created_at', {ascending: false}).limit(10);
            const feed = document.getElementById('shout-feed');
            if(shouts?.length > 0) {
                feed.innerHTML = shouts.map(s => `
                    <div class="card-high-contrast p-4 rounded-3xl border-white/10 mb-3">
                        <p class="text-[10px] font-black text-sdel mb-1 uppercase italic">@${s.profile?.first_name || 'Scholar'}</p>
                        <p class="text-[12px] text-white font-medium leading-relaxed">"${s.content}"</p>
                    </div>
                `).join('');
            }
        }

        window.postShout = async () => {
            const input = document.getElementById('shout-input');
            if (!input.value) return;
            const { data: { session } } = await supabase.auth.getSession();
            await supabase.from('posts').insert([{ user_id: session.user.id, content: input.value }]);
            input.value = '';
            loadShouts();
        };

        gatekeeper();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        html { opacity: 0; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000; color: #FFFFFF; overflow-x: hidden; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        /* High Contrast Cards */
        .card-high-contrast { background: #111111; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-28">

    <nav class="p-5 flex justify-between items-center sticky top-0 bg-black/95 z-50 border-b border-white/10 backdrop-blur-md">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-full bg-zinc-900 border border-sdel/50 flex items-center justify-center font-black text-sdel">S</div>
            <div>
                <p class="text-[11px] font-black italic text-white uppercase tracking-wider">Mighty <span id="js-name" class="text-sdel"></span></p>
                <div class="flex items-center space-x-2">
                    <span id="rank-badge" class="text-black text-[8px] font-black px-2 py-0.5 rounded italic uppercase">LOADING</span>
                    <span id="user-xp" class="text-[8px] text-white font-bold uppercase tracking-widest">0 XP</span>
                </div>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <i data-lucide="bell" size="22" class="text-white"></i>
            <i data-lucide="search" size="22" class="text-white" onclick="window.location.href='search.html'"></i>
        </div>
    </nav>

    <main class="p-4 space-y-8">

        <section id="story-rail" class="flex space-x-4 overflow-x-auto no-scrollbar py-2">
            <div class="flex-shrink-0 flex flex-col items-center space-y-1" onclick="window.location.href='post-story.html'">
                <div class="w-14 h-14 rounded-full bg-zinc-900 border-2 border-dashed border-white/30 flex items-center justify-center">
                    <i data-lucide="plus" size="20" class="text-white"></i>
                </div>
                <span class="text-[8px] font-black uppercase text-white">Post</span>
            </div>
            <div id="story-rail-content" class="flex space-x-4"></div>
        </section>

        <section class="card-high-contrast p-6 rounded-[2.5rem] border-t-4 border-sdel shadow-2xl">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <p class="text-[9px] font-black uppercase text-white/60 tracking-widest mb-1">Total Balance</p>
                    <p id="wallet-balance" class="text-3xl font-black italic tracking-tighter text-white">₦0.00</p>
                </div>
                <button onclick="window.location.href='fund.html'" class="bg-sdel text-black px-5 py-2.5 rounded-2xl font-black text-[10px] uppercase italic active:scale-90 transition">Fund Vault</button>
            </div>
            <div class="space-y-1.5">
                <div class="flex justify-between text-[8px] font-black uppercase text-white italic">
                    <span>Rank Progress</span>
                </div>
                <div class="w-full h-1.5 bg-black rounded-full overflow-hidden border border-white/5">
                    <div id="xp-bar" class="bg-sdel h-full shadow-[0_0_15px_#FF6600]" style="width: 0%"></div>
                </div>
            </div>
        </section>

        <section class="space-y-4">
            <div class="flex justify-between items-center px-1">
                <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-white italic">The Shoutbox</h3>
                <span class="text-[8px] font-black text-sdel uppercase border-b border-sdel">Live Feed</span>
            </div>

            <div class="card-high-contrast p-2 rounded-2xl flex items-center space-x-3">
                <input type="text" id="shout-input" placeholder="Gist with the campus..." 
                    class="bg-transparent flex-1 px-3 text-[12px] font-semibold text-white outline-none placeholder:text-white/30">
                <button onclick="postShout()" class="bg-sdel text-black px-5 py-2.5 rounded-xl font-black text-[9px] uppercase italic">Shout</button>
            </div>

            <div id="shout-feed" class="animate-in pb-4">
                <p class="text-center text-[10px] text-white/40 font-bold py-6 uppercase tracking-widest">Listening for shouts...</p>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 inset-x-0 p-5 flex justify-around items-center bg-black border-t border-white/10 z-50">
        <i data-lucide="home" class="text-sdel" size="24"></i>
        <i data-lucide="shopping-bag" class="text-white" size="24" onclick="window.location.href='market.html'"></i>
        <div onclick="window.location.href='ai.html'" class="bg-sdel h-14 w-14 rounded-2xl flex items-center justify-center -mt-10 shadow-2xl shadow-sdel/40 border-4 border-black active:scale-95 transition">
            <i data-lucide="zap" fill="black" class="text-black" size="28"></i>
        </div>
        <i data-lucide="book-open" class="text-white" size="24" onclick="window.location.href='pqs.html'"></i>
        <i data-lucide="user" class="text-white" size="24" onclick="window.location.href='profile.html'"></i>
    </nav>

    <script>lucide.createIcons();</script>
</body>
</html>
