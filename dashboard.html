<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Story Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let allUserStories = [];
        let currentIndex = 0;
        let progress = 0;
        let isPaused = false;
        let timer;

        async function loadStorySequence() {
            const params = new URLSearchParams(window.location.search);
            const initialId = params.get('id');
            const { data: first } = await supabase.from('stories').select('author_id').eq('id', initialId).single();
            if (!first) return window.location.href = 'index.html';

            const { data: stories } = await supabase.from('stories').select('*').eq('author_id', first.author_id).gt('expires_at', new Date().toISOString()).order('created_at', { ascending: true });
            const { data: profile } = await supabase.from('profile').select('first_name, is_official').eq('id', first.author_id).single();

            allUserStories = stories;
            currentIndex = stories.findIndex(s => s.id === initialId);
            
            const isSdel = stories[currentIndex].is_official_post || profile?.is_official;
            document.getElementById('author-name').innerText = isSdel ? "SDEL OFFICIAL" : (profile?.first_name || "MEMBER");
            if (isSdel) {
                document.getElementById('author-name').classList.add('text-yellow-400');
                document.getElementById('reply-section').classList.add('hidden');
            }
            renderStory();
        }

        function renderStory() {
            isPaused = false;
            progress = 0;
            const story = allUserStories[currentIndex];
            document.getElementById('story-img').src = story.media_url;
            document.getElementById('pause-icon').setAttribute('data-lucide', 'pause');
            lucide.createIcons();
            
            document.getElementById('story-img').onload = () => {
                document.getElementById('loading-spinner').classList.add('hidden');
                startTimer();
            };
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                if (!isPaused) {
                    progress += 1;
                    document.getElementById('progress-fill').style.width = progress + '%';
                    if (progress >= 100) nextStory();
                }
            }, 60); 
        }

        window.togglePause = (e) => {
            if(e) e.stopPropagation();
            isPaused = !isPaused;
            const icon = document.getElementById('pause-icon');
            icon.setAttribute('data-lucide', isPaused ? 'play' : 'pause');
            lucide.createIcons();
        };

        window.nextStory = () => {
            if (currentIndex < allUserStories.length - 1) {
                currentIndex++;
                renderStory();
            } else { window.location.href = 'index.html'; }
        };

        window.handleScreenTap = (e) => {
            const x = e.clientX;
            const width = window.innerWidth;
            if (x < width / 3) { // Left tap
                if (currentIndex > 0) { currentIndex--; renderStory(); }
                else { window.location.href = 'index.html'; }
            } else { nextStory(); } // Right tap
        };

        loadStorySequence();
    </script>

    <style>
        * { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-input { background: rgba(255,255,255,0.1); backdrop-blur: 10px; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body class="h-screen w-full flex flex-col bg-black text-white overflow-hidden">

    <div class="fixed top-0 inset-x-0 p-4 z-50 bg-gradient-to-b from-black/80 to-transparent">
        <div class="h-1 w-full bg-white/20 rounded-full overflow-hidden">
            <div id="progress-fill" class="h-full bg-white w-0"></div>
        </div>
        <div class="flex justify-between items-center mt-4">
            <div class="flex items-center space-x-3">
                <p id="author-name" class="font-black text-xs uppercase tracking-widest">Loading...</p>
            </div>
            <div class="flex items-center space-x-6">
                <button onclick="togglePause(event)"><i id="pause-icon" data-lucide="pause" size="20"></i></button>
                <i data-lucide="x" size="24" onclick="window.location.href='index.html'"></i>
            </div>
        </div>
    </div>

    <div class="flex-1 flex items-center justify-center relative" onclick="handleScreenTap(event)">
        <div id="loading-spinner" class="absolute flex items-center justify-center">
            <div class="w-10 h-10 border-4 border-white/20 border-t-white rounded-full animate-spin"></div>
        </div>
        <img id="story-img" class="max-h-full w-full object-contain">
    </div>

    <div id="reply-section" class="p-6 pb-10 bg-gradient-to-t from-black to-transparent">
        <div class="flex items-center space-x-4">
            <div class="flex-1 glass-input rounded-full px-5 py-3 flex items-center">
                <input type="text" placeholder="Send a message..." class="bg-transparent border-none outline-none text-sm w-full placeholder:text-white/40">
            </div>
            <button class="w-12 h-12 flex items-center justify-center bg-white rounded-full">
                <i data-lucide="heart" class="text-black fill-black" size="20"></i>
            </button>
        </div>
    </div>

    <script>lucide.createIcons();</script>
</body>
</html>
