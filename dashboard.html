<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Global Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let currentUserId = null;
        let activeAds = [];
        let currentAdIndex = 0;
        let allOrdersData = [];

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return window.location.href = 'login.html';
            currentUserId = session.user.id;

            const { data: profile } = await supabase.from('profile').select('*').eq('id', currentUserId).single();
            
            // FIX: Name priority (Profile Table > Metadata > CHAMP)
            const displayName = profile?.first_name || session.user.user_metadata?.first_name || "CHAMP";
            document.getElementById('user-name').innerText = displayName;

            if(profile) {
                document.getElementById('wallet-pill').innerText = `₦${(profile.wallet_balance || 0).toLocaleString()}`;
                if (profile.avatar_url) document.getElementById('user-avatar').src = profile.avatar_url;
                document.getElementById('xp-count').innerText = profile.xp || 0;
                updatePrestige(profile.xp || 0);
            }

            loadStories();
            loadFeed();
            loadAds(); 
            loadOrders();
            getUnreadCount(); 
        }

        async function loadStories() {
            const now = new Date().toISOString();
            
            // 1. Get Homies (Followers)
            const { data: follows } = await supabase.from('followers').select('following_id').eq('follower_id', currentUserId);
            const homieIds = follows ? follows.map(f => f.following_id) : [];

            // 2. Get Viewed History
            const { data: viewed } = await supabase.from('story_views').select('story_id').eq('user_id', currentUserId);
            const viewedSet = new Set(viewed?.map(v => v.story_id));

            // 3. Fetch Stories (Official + Me + Homies)
            const { data: stories } = await supabase
                .from('stories')
                .select('*, profile:profile(first_name, is_official)')
                .gt('expires_at', now)
                .or(`is_official_post.eq.true,author_id.eq.${currentUserId},author_id.in.(${homieIds.join(',') || '00000000-0000-0000-0000-000000000000'})`);

            const rail = document.getElementById('story-rail-content');
            if (stories) {
                // Group by user
                const userLatestMap = new Map();
                stories.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(s => {
                    if(!userLatestMap.has(s.author_id)) userLatestMap.set(s.author_id, s);
                });
                let uniqueStories = Array.from(userLatestMap.values());

                // 4. SMART SORTING
                uniqueStories.sort((a, b) => {
                    const aIsSdel = a.is_official_post || a.profile?.is_official;
                    const bIsSdel = b.is_official_post || b.profile?.is_official;
                    const aIsMe = a.author_id === currentUserId;
                    const bIsMe = b.author_id === currentUserId;
                    const aWatched = viewedSet.has(a.id);
                    const bWatched = viewedSet.has(b.id);

                    if (aIsSdel && !bIsSdel) return -1; if (!aIsSdel && bIsSdel) return 1;
                    if (aIsMe && !bIsMe) return -1; if (!aIsMe && bIsMe) return 1;
                    if (!aWatched && bWatched) return -1; if (aWatched && !bWatched) return 1;
                    return new Date(b.created_at) - new Date(a.created_at);
                });

                rail.innerHTML = uniqueStories.map(s => {
                    const isSdel = s.is_official_post || s.profile?.is_official;
                    const isMe = s.author_id === currentUserId;
                    const isWatched = viewedSet.has(s.id);
                    
                    let ringStyle = "";
                    if (isSdel) ringStyle = isWatched ? "border-green-500" : "border-yellow-400 sdel-pulse";
                    else if (isMe) ringStyle = "border-zinc-600";
                    else ringStyle = isWatched ? "border-zinc-600" : "ring-blue-rotate";

                    return `
                        <div class="flex-shrink-0 flex flex-col items-center space-y-2" onclick="watchStory('${s.id}')">
                            <div class="w-16 h-16 p-[2px] border-2 ${ringStyle} rounded-full flex items-center justify-center">
                                <img src="${s.media_url}" class="w-full h-full rounded-full object-cover bg-zinc-900">
                            </div>
                            <span class="text-[9px] font-black uppercase ${isSdel ? 'text-yellow-400' : 'text-white'} truncate w-16 text-center">
                                ${isSdel ? 'SDEL' : (s.profile?.first_name || 'HOMIE')}
                            </span>
                        </div>`;
                }).join('');
            }
        }

        window.watchStory = async (id) => {
            await supabase.from('story_views').upsert({ user_id: currentUserId, story_id: id });
            location.href = `view-story.html?id=${id}`;
        };

        async function getUnreadCount() {
            if (!currentUserId) return;
            const { data: profile } = await supabase.from('profile').select('last_read_general, last_read_team').eq('id', currentUserId).single();
            const lastGen = new Date(profile?.last_read_general || 0);
            const lastTeam = new Date(profile?.last_read_team || 0);
            const { data: messages } = await supabase.from('messages').select('type, created_at').or(`recipient_id.is.null,recipient_id.eq.${currentUserId}`);
            if (!messages) return;
            const unreadGen = messages.filter(m => m.type === 'general' && new Date(m.created_at) > lastGen).length;
            const unreadTeam = messages.filter(m => m.type === 'team' && new Date(m.created_at) > lastTeam).length;
            const totalUnread = unreadGen + unreadTeam;
            const badge = document.getElementById('notif-badge');
            if (totalUnread > 0) {
                badge.innerText = totalUnread > 9 ? '9+' : totalUnread;
                badge.classList.remove('hidden');
                badge.style.display = 'flex';
            } else {
                badge.classList.add('hidden');
                badge.style.display = 'none';
            }
        }

        async function loadAds() {
            const { data: ads, error } = await supabase.from('promoted_ads').select('*').eq('active', true);
            if (error || !ads || ads.length === 0) return;
            let weightedAds = [];
            ads.forEach(ad => {
                const weight = Math.max(1, Math.floor((ad.price || 0) / 100)); 
                for(let i=0; i<weight; i++) { weightedAds.push(ad); }
            });
            activeAds = weightedAds.sort(() => Math.random() - 0.5);
            displayNextAd();
            setInterval(displayNextAd, 5000);
        }

        function displayNextAd() {
            if (activeAds.length === 0) return;
            const ad = activeAds[currentAdIndex];
            const banner = document.getElementById('ad-banner');
            const adLink = document.getElementById('ad-link');
            banner.classList.add('opacity-0');
            setTimeout(() => {
                banner.style.backgroundImage = `url(${ad.media_url})`;
                document.getElementById('ad-text').innerText = ad.title;
                adLink.href = ad.link_url || '#';
                banner.classList.remove('opacity-0');
                banner.style.display = 'flex';
            }, 300);
            currentAdIndex = (currentAdIndex + 1) % activeAds.length;
        }

        async function loadOrders() {
            const { data: orders } = await supabase.from('orders').select('*').eq('user_id', currentUserId).order('created_at', { ascending: false });
            if (!orders) return;
            allOrdersData = orders;
            renderOrderList(orders.slice(0, 3), 'order-history-list');
        }

        function renderOrderList(data, targetId) {
            const container = document.getElementById(targetId);
            container.innerHTML = data.map(o => {
                const displayId = o.order_code || `ID: ${o.id.slice(0,8)}`;
                const itemNames = o.items ? JSON.parse(JSON.stringify(o.items)).map(i => i.name).join(', ') : 'Market Item';
                let statusColor = 'bg-zinc-500/20 text-zinc-400';
                if(o.status === 'accepted') statusColor = 'bg-emerald-500/20 text-emerald-500';
                if(o.status === 'rejected') statusColor = 'bg-red-500/20 text-red-500';
                return `<div class="flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/10"><div class="max-w-[70%]"><p class="text-[9px] font-black text-white/50 uppercase">${displayId}</p><p class="text-[11px] font-bold text-white truncate">${itemNames}</p></div><span class="px-2 py-1 rounded text-[8px] font-black uppercase ${statusColor}">${o.status}</span></div>`;
            }).join('');
        }

        window.toggleAllOrders = (show) => {
            const modal = document.getElementById('all-orders-modal');
            if(show) { renderOrderList(allOrdersData, 'full-order-list'); modal.classList.remove('hidden'); }
            else { modal.classList.add('hidden'); }
        }

        function updatePrestige(xp) {
            const badge = document.getElementById('rank-badge');
            const progress = document.getElementById('xp-progress-bar');
            let rank = { n: "CITIZEN", c: "bg-zinc-700", p: (xp/500)*100 };
            if (xp >= 10000) rank = { n: "OVERLORD", c: "bg-gradient-to-r from-red-600 to-black animate-pulse", p: 100 };
            else if (xp >= 5000) rank = { n: "MYTHIC", c: "bg-purple-600", p: (xp/10000)*100 };
            else if (xp >= 2500) rank = { n: "ELITE", c: "bg-blue-600", p: (xp/5000)*100 };
            else if (xp >= 1000) rank = { n: "WRAITH", c: "bg-emerald-600", p: (xp/2500)*100 };
            else if (xp >= 500) rank = { n: "SCOUT", c: "bg-orange-600", p: (xp/1000)*100 };
            badge.innerText = rank.n;
            badge.className = `px-3 py-1 rounded text-[10px] font-black italic text-white ${rank.c}`;
            progress.style.width = `${rank.p}%`;
        }

        async function loadFeed() {
            const { data: posts } = await supabase.from('posts').select('*, profile(first_name, avatar_url, xp)').order('created_at', { ascending: false });
            const feed = document.getElementById('global-feed');
            if (posts?.length > 0) {
                feed.innerHTML = posts.map(p => `
                    <div class="card-glass rounded-[2.5rem] overflow-hidden mb-6">
                        <div class="p-4 flex justify-between items-center border-b border-white/5">
                            <div class="flex items-center space-x-3">
                                <img src="${p.profile?.avatar_url || 'https://api.dicebear.com/7.x/initials/svg?seed='+p.profile?.first_name}" class="w-8 h-8 rounded-full border border-white/20">
                                <div><p class="header-text text-[11px]">${p.profile?.first_name || 'Scholar'}</p></div>
                            </div>
                        </div>
                        ${p.media_url ? `<img src="${p.media_url}" class="w-full object-cover">` : ''}
                        <div class="p-5"><p class="text-[13px] text-white font-bold leading-snug">${p.content}</p></div>
                    </div>`).join('');
                lucide.createIcons();
            }
        }
        init();
    </script>
    
    <style>
        * { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000; color: #fff; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-glass { background: #111; border: 1px solid rgba(255,255,255,0.15); }
        .header-text { font-weight: 900; color: #FFFFFF; text-transform: uppercase; letter-spacing: -0.02em; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Story Specific styles */
        .ring-blue-rotate { border-color: transparent !important; background: linear-gradient(#000, #000) padding-box, conic-gradient(#3b82f6, transparent) border-box; border: 2px solid transparent; animation: spin 2s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes gold-glow { 0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); } 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); } }
        .sdel-pulse { animation: gold-glow 2s infinite; }
    </style>
</head>
<body class="pb-24">
    <nav class="p-5 flex justify-between items-center sticky top-0 bg-black/90 z-50 border-b border-white/10 backdrop-blur-xl">
        <div class="flex items-center space-x-3">
            <div class="w-12 h-12 rounded-full border-2 border-white overflow-hidden shadow-lg shadow-white/10">
                <img id="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Lucky" class="w-full h-full object-cover">
            </div>
            <div>
                <p class="header-text text-lg italic">HI, <span id="user-name" class="text-sdel">...</span></p>
                <span id="wallet-pill" class="bg-white text-black text-[9px] font-black px-2 py-0.5 rounded italic">₦0.00</span>
            </div>
        </div>
        <div class="flex items-center space-x-5">
            <i data-lucide="refresh-cw" size="24" onclick="location.href='homies.html'"></i>
            <div class="relative cursor-pointer" onclick="location.href='messages.html'">
                <i data-lucide="bell" size="24"></i>
                <span id="notif-badge" class="hidden absolute -top-1 -right-1 bg-red-600 text-[8px] font-black text-white w-4 h-4 rounded-full flex items-center justify-center border border-black z-10" style="display: none;">0</span>
            </div>
        </div>
    </nav>

    <section class="p-4 border-b border-white/5">
        <div class="flex space-x-4 overflow-x-auto no-scrollbar py-2">
            <div class="flex-shrink-0 flex flex-col items-center space-y-2" onclick="location.href='post-story.html'">
                <div class="w-16 h-16 rounded-full bg-zinc-900 border-2 border-dashed border-white/40 flex items-center justify-center">
                    <i data-lucide="plus" size="24"></i>
                </div>
                <span class="text-[9px] font-black uppercase">Post</span>
            </div>
            <div id="story-rail-content" class="flex space-x-4"></div>
        </div>
    </section>

    <section class="p-4">
        <a id="ad-link" href="#" target="_blank" class="block w-full">
            <div id="ad-banner" class="w-full h-[400px] rounded-[2.5rem] bg-zinc-900 bg-cover bg-center flex items-end p-6 border border-white/10 transition-opacity duration-500" style="display: none;">
                <div class="bg-black/70 backdrop-blur-md p-4 rounded-2xl w-full border border-white/5">
                    <span class="text-[8px] bg-white text-black px-2 py-0.5 font-black rounded mb-2 inline-block">SPONSORED</span>
                    <p id="ad-text" class="text-sm font-bold text-white uppercase italic">Loading...</p>
                </div>
            </div>
        </a>
    </section>

    <section class="p-4">
        <div class="card-glass rounded-[2rem] p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="header-text text-[10px] text-white/50 italic">Order History</h3>
                <button onclick="toggleAllOrders(true)" class="text-[9px] font-black text-sdel uppercase italic">Show All</button>
            </div>
            <div id="order-history-list" class="space-y-3"></div>
        </div>
    </section>

    <div id="all-orders-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md hidden p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="header-text text-xl italic">Full History</h2>
            <i data-lucide="x" class="text-white" onclick="toggleAllOrders(false)"></i>
        </div>
        <div id="full-order-list" class="space-y-4"></div>
    </div>

    <section class="p-4">
        <div class="card-glass rounded-[2rem] p-5">
            <div class="flex justify-between items-center mb-4">
                <div><p class="text-[8px] font-black text-white/40 uppercase mb-1">Status</p><div id="rank-badge">...</div></div>
                <div class="text-right"><p class="header-text text-xl italic" id="xp-count">0</p><p class="text-[8px] font-black text-sdel uppercase">XP</p></div>
            </div>
            <div class="h-1 w-full bg-white/5 rounded-full overflow-hidden"><div id="xp-progress-bar" class="h-full bg-sdel transition-all duration-1000" style="width: 0%"></div></div>
        </div>
    </section>

    <main id="global-feed" class="p-4"></main>

    <nav class="fixed bottom-0 inset-x-0 p-5 flex justify-around items-center bg-black/95 border-t border-white/10 z-50">
        <i data-lucide="home" class="text-sdel" size="28"></i>
        <i data-lucide="compass" class="text-white" size="28" onclick="location.href='explore.html'"></i>
        <div class="bg-sdel h-14 w-14 rounded-2xl flex items-center justify-center -mt-12 shadow-2xl border-4 border-black active:scale-90 transition" onclick="location.href='post-story.html'">
            <i data-lucide="camera" class="text-black" size="28"></i>
        </div>
        <i data-lucide="shopping-cart" class="text-white" size="28" onclick="location.href='market.html'"></i>
        <i data-lucide="user" class="text-white" size="28" onclick="location.href='profile.html'"></i>
    </nav>
    <script>lucide.createIcons();</script>
</body>
</html>
