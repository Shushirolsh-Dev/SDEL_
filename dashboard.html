<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Sovereign Dashboard</title>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');
        window.supabase = supabase;

        // --- 7 TIER RANK LOGIC ---
        function getTier(xp) {
            if (xp >= 50000) return { name: 'SUPREME', color: '#A855F7', next: 100000 };
            if (xp >= 25000) return { name: 'GRANDMASTER', color: '#FF6600', next: 50000 };
            if (xp >= 12000) return { name: 'EXECUTIVE', color: '#EAB308', next: 25000 };
            if (xp >= 6000) return { name: 'ELITE', color: '#3B82F6', next: 12000 };
            if (xp >= 2500) return { name: 'STALWART', color: '#CD7F32', next: 6000 };
            if (xp >= 1000) return { name: 'NOVICE II', color: '#94A3B8', next: 2500 };
            return { name: 'NOVICE I', color: '#52525B', next: 1000 };
        }

        async function gatekeeper() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.replace('login.html'); return; }

            const { data: profile } = await supabase.from('profile').select('*').eq('id', session.user.id).single();

            if (profile && (profile.account_status === 'banned' || profile.account_status === 'suspended')) {
                await supabase.auth.signOut();
                window.location.replace('login.html');
                return;
            }

            document.documentElement.style.opacity = "1";
            initializeApp(session.user, profile);
            listenForMessages(session.user.id); 
            loadDynamicAds(); 
            subscribeToBalance(session.user.id);
            loadStories(); // LIVE ONLY
            loadShouts();  // LIVE ONLY
        }

        async function initializeApp(user, profile) {
            const firstName = profile.first_name || user.user_metadata?.first_name || "Scholar";
            const xp = profile.xp || 0;
            const tier = getTier(xp);

            document.getElementById('js-name').innerText = firstName;
            document.getElementById('user-initials').innerText = firstName.charAt(0).toUpperCase();
            
            // Rank UI
            const badge = document.getElementById('rank-badge');
            badge.innerText = tier.name;
            badge.style.backgroundColor = tier.color;
            document.getElementById('user-xp-val').innerText = `${xp.toLocaleString()} XP`;
            const progress = (xp / tier.next) * 100;
            document.getElementById('xp-progress').style.width = `${Math.min(progress, 100)}%`;

            document.getElementById('wallet-balance').innerText = `₦${(profile.wallet_balance || 0).toLocaleString()}`;
            loadActivity(user.id);
        }

        // --- LIVE SOCIAL ENGINE ---
        async function loadStories() {
            const now = new Date().toISOString();
            const { data: stories } = await supabase.from('stories').select('*, profile(first_name, avatar_url)').gt('expires_at', now);
            const container = document.getElementById('story-rail');
            
            if (stories && stories.length > 0) {
                container.innerHTML = stories.map(s => `
                    <div class="flex-shrink-0 flex flex-col items-center space-y-1">
                        <div class="w-14 h-14 rounded-full border-2 border-sdel p-[2px]">
                            <img src="${s.media_url}" class="w-full h-full rounded-full object-cover bg-zinc-800 shadow-lg shadow-sdel/20">
                        </div>
                        <span class="text-[7px] font-black uppercase text-zinc-400 tracking-tighter">${s.profile?.first_name || 'Scholar'}</span>
                    </div>
                `).join('');
            }
        }

        async function loadShouts() {
            const { data: shouts } = await supabase.from('posts').select('*, profile(first_name, rank)').order('created_at', {ascending: false}).limit(10);
            const feed = document.getElementById('shout-feed');
            if (shouts && shouts.length > 0) {
                feed.innerHTML = shouts.map(s => `
                    <div class="card-zinc p-4 rounded-3xl border-white/5 animate-in mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] font-black text-sdel uppercase">@${s.profile?.first_name || 'User'}</span>
                            <span class="text-[7px] bg-zinc-800 px-1.5 py-0.5 rounded text-zinc-500 font-bold">${s.profile?.rank || 'NOVICE'}</span>
                        </div>
                        <p class="text-[11px] font-medium leading-relaxed italic">"${s.content}"</p>
                    </div>
                `).join('');
            }
        }

        window.postShout = async () => {
            const content = document.getElementById('shout-input').value;
            if(!content) return;
            const { data: { session } } = await supabase.auth.getSession();
            const { error } = await supabase.from('posts').insert([{ user_id: session.user.id, content }]);
            if(!error) {
                document.getElementById('shout-input').value = '';
                loadShouts();
            }
        }

        // --- EXISTING LOGIC (PERSISTED) ---
        function subscribeToBalance(userId) {
            supabase.channel('sync').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profile', filter: `id=eq.${userId}` }, 
            payload => { location.reload(); }).subscribe();
        }

        async function loadDynamicAds() {
            const adContainer = document.getElementById('promoted-ads-feed');
            const { data: ads } = await supabase.from('promoted_ads').select('*').eq('active', true);
            if (ads && ads.length > 0) {
                adContainer.innerHTML = ads.map((ad, i) => `
                    <div class="ad-slide ${i === 0 ? 'block' : 'hidden'} w-full h-32 relative overflow-hidden rounded-3xl">
                        <img src="${ad.media_url}" class="w-full h-full object-cover opacity-70">
                        <div class="absolute inset-0 bg-gradient-to-t from-black p-4 flex flex-col justify-end">
                            <h4 class="font-black text-[10px] uppercase italic text-sdel">${ad.title}</h4>
                        </div>
                    </div>`).join('');
            }
        }

        async function loadActivity(userId) {
            const { data: orders } = await supabase.from('orders').select('*').eq('user_id', userId).order('created_at', { ascending: false }).limit(2);
            const feed = document.getElementById('activity-feed');
            if (orders?.length > 0) {
                feed.innerHTML = orders.map(order => `
                    <div class="flex justify-between items-center bg-white/5 p-3 rounded-2xl border border-white/5">
                        <p class="text-[9px] font-black uppercase italic">${order.item_name}</p>
                        <span class="text-[8px] font-black text-sdel uppercase px-2 py-0.5 bg-sdel/10 rounded">${order.status}</span>
                    </div>`).join('');
            }
        }

        gatekeeper();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        html { opacity: 0; transition: opacity 0.5s ease; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000; color: white; overflow-x: hidden; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-zinc { background: rgba(15, 15, 15, 0.8); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="pb-32">

    <nav class="p-5 flex justify-between items-center sticky top-0 bg-black/90 backdrop-blur-md z-50 border-b border-white/5">
        <div class="flex items-center space-x-3">
            <div id="user-initials" class="w-10 h-10 rounded-full bg-zinc-900 border border-sdel/30 flex items-center justify-center font-black text-sdel text-xs"></div>
            <div>
                <p class="text-[10px] font-black italic text-zinc-500 uppercase">MIGHTY <span id="js-name" class="text-white"></span></p>
                <div class="flex items-center space-x-2">
                    <span id="rank-badge" class="text-black text-[7px] font-black px-1.5 py-0.5 rounded italic uppercase">...</span>
                    <span id="user-xp-val" class="text-[7px] text-zinc-600 font-bold uppercase">0 XP</span>
                </div>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <div onclick="window.location.href='messages.html'" class="relative">
                <i data-lucide="bell" size="20" class="text-zinc-500"></i>
                <span id="msg-badge" class="hidden absolute -top-1 -right-1 bg-sdel h-3 w-3 rounded-full border-2 border-black"></span>
            </div>
            <i data-lucide="search" size="20" class="text-zinc-500"></i>
        </div>
    </nav>

    <main class="p-4 space-y-6">
        
        <section id="story-rail" class="flex space-x-4 overflow-x-auto no-scrollbar py-2">
            <div class="flex-shrink-0 flex flex-col items-center space-y-1" onclick="window.location.href='post-story.html'">
                <div class="w-14 h-14 rounded-full bg-zinc-900 border-2 border-dashed border-zinc-800 flex items-center justify-center">
                    <i data-lucide="plus" size="18" class="text-zinc-700"></i>
                </div>
                <span class="text-[7px] font-black uppercase text-zinc-600">Story</span>
            </div>
        </section>

        <section class="card-zinc p-5 rounded-[2.5rem] border-t-2 border-sdel/20">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <p class="text-[8px] font-black uppercase text-zinc-500 tracking-widest">Personal Vault</p>
                    <p id="wallet-balance" class="text-2xl font-black italic tracking-tighter">₦0.00</p>
                </div>
                <button onclick="window.location.href='fund.html'" class="bg-white text-black px-4 py-2 rounded-xl text-[10px] font-black uppercase italic">Top Up</button>
            </div>
            <div class="w-full h-1 bg-black rounded-full overflow-hidden">
                <div id="xp-progress" class="bg-sdel h-full shadow-[0_0_10px_#FF6600]" style="width: 0%"></div>
            </div>
        </section>

        <section id="promoted-ads-feed" class="space-y-4"></section>

        <section class="space-y-4">
            <div class="flex justify-between items-center px-1">
                <h3 class="text-[9px] font-black uppercase tracking-[0.3em] text-zinc-600 italic">Live Shoutbox</h3>
                <span class="text-[8px] font-black text-sdel uppercase">Feed</span>
            </div>
            
            <div class="card-zinc p-2 rounded-2xl flex items-center space-x-3 border-white/10">
                <input type="text" id="shout-input" placeholder="What's happening?" class="bg-transparent flex-1 px-2 text-[10px] font-medium outline-none">
                <button onclick="postShout()" class="bg-sdel text-black px-4 py-2 rounded-xl font-black text-[9px] uppercase italic">Shout</button>
            </div>

            <div id="shout-feed" class="animate-in">
                <p class="text-center text-[8px] text-zinc-700 font-black uppercase py-4">Waiting for the first shout...</p>
            </div>
        </section>

        <section class="space-y-3">
            <h3 class="text-[9px] font-black uppercase tracking-[0.3em] text-zinc-600 px-1">Active Missions</h3>
            <div id="activity-feed" class="space-y-2"></div>
        </section>

    </main>

    <nav class="fixed bottom-0 inset-x-0 p-4 flex justify-around items-center bg-black/95 border-t border-white/5 z-50">
        <i data-lucide="home" class="text-sdel" size="22"></i>
        <i data-lucide="shopping-bag" class="text-zinc-600" size="22" onclick="window.location.href='market.html'"></i>
        <div onclick="window.location.href='ai.html'" class="bg-sdel h-12 w-12 rounded-2xl flex items-center justify-center -mt-10 shadow-xl shadow-sdel/30 border-4 border-black active:scale-95 transition">
            <i data-lucide="zap" fill="black" class="text-black" size="24"></i>
        </div>
        <i data-lucide="book-open" class="text-zinc-600" size="22" onclick="window.location.href='pqs.html'"></i>
        <i data-lucide="user" class="text-zinc-600" size="22" onclick="window.location.href='profile.html'"></i>
    </nav>

    <script>lucide.createIcons();</script>
</body>
</html>
