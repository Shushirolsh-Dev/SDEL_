<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel | Dashboard</title>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');
        window.supabase = supabase;

        async function gatekeeper() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.replace('login.html');
                return;
            }

            const { data: profile } = await supabase
                .from('profile')
                .select('account_status')
                .eq('id', session.user.id)
                .single();

            if (profile && (profile.account_status === 'banned' || profile.account_status === 'suspended')) {
                alert(`STRICT ACCESS DENIED: Account ${profile.account_status.toUpperCase()}.`);
                await supabase.auth.signOut();
                window.location.replace('login.html');
                return;
            }

            document.documentElement.style.opacity = "1";
            initializeApp(session.user);
            listenForMessages(session.user.id); 
            loadDynamicAds(); 
            subscribeToBalance(session.user.id);
        }

        async function initializeApp(user) {
            const { data: profile } = await supabase.from('profile').select('first_name, last_name, wallet_balance').eq('id', user.id).single();
            const hour = new Date().getHours();
            let greet = (hour < 12) ? "Good morning" : (hour < 17) ? "Good afternoon" : "Good evening";
            
            document.getElementById('js-greet').innerText = greet;
            let fName = profile?.first_name || "Scholar";
            document.getElementById('js-name').innerText = fName;
            document.getElementById('user-initials').innerText = (fName[0] + (profile?.last_name?.[0] || "")).toUpperCase();
            document.getElementById('wallet-balance').innerText = `₦${(profile?.wallet_balance || 0).toLocaleString()}`;

            loadActivity(user.id);
        }

        function subscribeToBalance(userId) {
            supabase.channel('wallet-sync')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profile', filter: `id=eq.${userId}` }, 
                payload => {
                    document.getElementById('wallet-balance').innerText = `₦${(payload.new.wallet_balance || 0).toLocaleString()}`;
                }).subscribe();
        }

        async function loadDynamicAds() {
            const adContainer = document.getElementById('promoted-ads-feed');
            const now = new Date().toISOString();
            const { data: ads } = await supabase.from('promoted_ads').select('*').eq('active', true).or(`expires_at.gt.${now},expires_at.is.null`);
            
            if (ads && ads.length > 0) {
                adContainer.classList.add('h-48'); 
                let weightedAds = [];
                ads.forEach(ad => {
                    const weight = ad.appearance_count || 1;
                    for (let i = 0; i < weight; i++) { weightedAds.push(ad); }
                });
                weightedAds.sort(() => Math.random() - 0.5);

                let adHtml = '';
                weightedAds.forEach((ad, index) => {
                    adHtml += `
                        <div class="ad-slide ${index === 0 ? 'block' : 'hidden'} w-full h-full relative overflow-hidden rounded-3xl cursor-pointer" 
                             onclick="openAdDetails('${ad.id}', '${ad.title}', '${ad.description}', '${ad.media_url}', '${ad.user_id}')">
                            <img src="${ad.media_url}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent p-4 flex flex-col justify-end">
                                <span class="bg-sdel text-black text-[7px] font-black px-2 py-0.5 rounded w-fit uppercase mb-1">Sponsored</span>
                                <h4 class="font-black text-sm uppercase italic">${ad.title}</h4>
                            </div>
                        </div>`;
                });
                adContainer.innerHTML = adHtml;
                startSlideshow();
            }
        }

        function startSlideshow() {
            const slides = document.querySelectorAll('.ad-slide');
            if (slides.length <= 1) return;
            let current = 0;
            setInterval(() => {
                slides[current].classList.replace('block', 'hidden');
                current = (current + 1) % slides.length;
                slides[current].classList.replace('hidden', 'block');
            }, 5000);
        }

        window.openAdDetails = (id, title, desc, media, sellerId) => {
            const modal = document.getElementById('ad-modal');
            modal.innerHTML = `
                <div class="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-6 backdrop-blur-md">
                    <div class="card-zinc w-full max-w-sm rounded-3xl overflow-hidden border-sdel/30 animate-in">
                        <img src="${media}" class="w-full aspect-square object-cover">
                        <div class="p-6">
                            <h2 class="text-xl font-black uppercase italic text-sdel mb-2">${title}</h2>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-6">${desc}</p>
                            <div class="flex gap-3">
                                <button onclick="window.location.href='dm.html?id=${sellerId}'" class="flex-1 bg-sdel py-4 rounded-xl text-black font-black uppercase italic text-[10px]">Message Seller</button>
                                <button onclick="closeAdModal()" class="px-6 bg-zinc-800 rounded-xl font-black text-[10px] uppercase">Close</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        };

        window.closeAdModal = () => document.getElementById('ad-modal').innerHTML = '';

        // --- CLEAR UNREAD MESSAGES LOGIC ---
        window.clearMessages = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await supabase.from('profile').update({ last_read_at: new Date().toISOString() }).eq('id', session.user.id);
            }
            window.location.href = 'messages.html';
        }

        async function listenForMessages(userId) {
            const updateCount = async () => {
                const { data: profile } = await supabase.from('profile').select('last_read_at').eq('id', userId).single();
                const { data } = await supabase.from('messages').select('id').or(`recipient_id.is.null,recipient_id.eq.${userId}`).gt('created_at', profile?.last_read_at || '1970-01-01T00:00:00Z');
                const badge = document.getElementById('msg-badge');
                if (data?.length > 0) { badge.innerText = data.length; badge.classList.remove('hidden'); }
                else { badge.classList.add('hidden'); }
            };
            updateCount(); 
            supabase.channel('live-msgs').on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => updateCount()).subscribe();
        }

        async function loadActivity(userId) {
            const { data: orders } = await supabase.from('orders').select('*').eq('user_id', userId).order('created_at', { ascending: false }).limit(3);
            const feed = document.getElementById('activity-feed');
            if (orders?.length > 0) {
                feed.innerHTML = orders.map(order => `
                    <div class="card-zinc p-4 rounded-3xl flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-zinc-800 rounded-full flex items-center justify-center ${order.status === 'completed' ? 'text-green-500' : 'text-sdel'}">
                                <i data-lucide="${order.status === 'completed' ? 'check-circle' : 'clock'}" size="18"></i>
                            </div>
                            <div><p class="font-black text-sm uppercase">${order.item_name}</p><p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Status: ${order.status_message || 'Processing'}</p></div>
                        </div>
                        <span class="text-[9px] font-black uppercase">${order.status}</span>
                    </div>`).join('');
                lucide.createIcons();
            } else {
                feed.innerHTML = '<p class="text-center text-[10px] text-gray-600 font-black uppercase py-4">No recent activity</p>';
            }
        }
        gatekeeper();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        html { opacity: 0; transition: opacity 0.5s ease; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #000; color: white; overflow-x: hidden; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-zinc { background: rgba(18, 18, 18, 0.7); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        .star { position: absolute; background-color: rgba(255,255,255,0.8); border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-black text-white">

    <div class="stars fixed inset-0 z-[-1]" id="stars"></div>
    <div id="ad-modal"></div>

    <nav class="flex justify-between items-center p-6 border-b border-white/10 sticky top-0 bg-black z-50">
        <div class="flex items-center space-x-2">
            <span class="text-2xl font-black uppercase tracking-tighter">S<span class="text-sdel">del</span></span>
            <span class="bg-sdel/10 text-sdel text-[10px] px-2 py-0.5 rounded font-black border border-sdel/20 uppercase">Dashboard</span>
        </div>
        <div class="flex items-center space-x-4">
            <a href="javascript:void(0)" onclick="clearMessages()" class="relative text-gray-400">
                <i data-lucide="bell" size="22"></i>
                <span id="msg-badge" class="hidden absolute -top-1 -right-1 bg-sdel text-black text-[8px] font-black h-4 w-4 rounded-full flex items-center justify-center border-2 border-black">0</span>
            </a>
            <div id="user-initials" class="w-10 h-10 rounded-full bg-zinc-800 border-2 border-zinc-700 flex items-center justify-center font-black text-sdel uppercase text-sm"></div>
        </div>
    </nav>

    <main class="p-6 max-w-6xl mx-auto space-y-8 pb-32">
        <header>
            <h1 class="text-3xl font-black uppercase italic tracking-tighter">
                <span id="js-greet"></span>, <span id="js-name" class="text-sdel"></span>
            </h1>
            <p class="text-gray-500 font-bold text-sm tracking-widest uppercase italic">The Campus Command Center</p>
            
            <div class="mt-6 bg-zinc-900 border-2 border-zinc-800 rounded-3xl p-5 card-zinc">
                <p class="text-[10px] font-black uppercase text-gray-400 mb-1 tracking-tighter">Live Account Balance</p>
                <div class="flex justify-between items-center">
                    <span id="wallet-balance" class="text-2xl font-black tracking-tight">₦0.00</span>
                    <button onclick="window.location.href='fund.html'" class="bg-sdel text-black p-2 rounded-xl active:scale-95 transition"><i data-lucide="plus" size="18"></i></button>
                </div>
            </div>
        </header>

        <section class="space-y-4">
            <div class="flex justify-between items-center px-2">
                <h3 class="text-xs font-black uppercase tracking-widest text-gray-500">Promoted Services</h3>
                <a href="ad-studio.html" class="text-[8px] font-black uppercase text-sdel border-b border-sdel/30">Advertise here</a>
            </div>
            <div id="promoted-ads-feed" class="flex flex-col gap-4 no-scrollbar pb-2 transition-all">
                <div class="card-zinc p-4 rounded-3xl min-w-full border-zinc-700/50">
                    <h4 class="font-black text-xs uppercase italic">Your Ad Here</h4>
                    <p class="text-[9px] text-gray-400 font-bold uppercase mt-1">Reach 1000+ students daily.</p>
                </div>
            </div>
        </section>

        <section class="card-zinc rounded-3xl p-6 border-sdel/30 border-2" onclick="window.location.href='request.html'">
            <div class="relative z-10 space-y-4">
                <div class="flex items-center space-x-2 text-sdel">
                    <i data-lucide="sparkles" size="18"></i>
                    <span class="font-black text-[10px] uppercase tracking-widest">Sourcing Agent Active</span>
                </div>
                <h2 class="text-2xl font-black uppercase italic leading-none">Find Anything in Great Ife.</h2>
                <button class="bg-sdel text-black px-8 py-3 rounded-2xl font-black uppercase text-[10px] tracking-widest">New Request</button>
            </div>
        </section>

        <section class="grid grid-cols-2 gap-4">
            <div onclick="window.location.href='pqs.html'" class="card-zinc p-6 rounded-3xl text-center space-y-2 cursor-pointer">
                <i data-lucide="book-open" class="mx-auto text-sdel"></i>
                <p class="font-black uppercase text-[10px] tracking-widest">PQs</p>
            </div>
            <div onclick="window.location.href='market.html'" class="card-zinc p-6 rounded-3xl text-center space-y-2 cursor-pointer">
                <i data-lucide="shopping-bag" class="mx-auto text-green-500"></i>
                <p class="font-black uppercase text-[10px] tracking-widest">Market</p>
            </div>
        </section>

        <section class="space-y-4">
            <h3 class="text-xs font-black uppercase tracking-widest text-gray-500 px-2">Live Order Status</h3>
            <div id="activity-feed" class="space-y-3"></div>
        </section>
    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-black/90 border-t border-white/10 p-4 flex justify-around items-center z-50">
        <a href="dashboard.html" class="text-sdel flex flex-col items-center"><i data-lucide="home"></i></a>
        <a href="market.html" class="text-gray-500 flex flex-col items-center"><i data-lucide="shopping-bag"></i></a>
        <a href="search.html" class="text-gray-500 flex flex-col items-center"><i data-lucide="search"></i></a>
        <button id="logout-btn" class="text-gray-500 flex flex-col items-center"><i data-lucide="log-out"></i></button>
    </div>

    <script>
        lucide.createIcons();
        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 40; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = star.style.height = (Math.random() * 2 + 1) + 'px';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.animationDuration = (Math.random() * 60 + 40) + 's';
                container.appendChild(star);
            }
        }
        createStars();
        document.getElementById('logout-btn').addEventListener('click', async () => {
            if(confirm("Logout?")) { await window.supabase.auth.signOut(); window.location.replace('login.html'); }
        });
    </script>
</body>
</html>
