<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Sdel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #000; color: white; overflow-x: hidden; position: relative; }
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .star { position: absolute; background-color: white; border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }
        .btn-primary { background-color: #FF6600; transition: all 0.3s ease; }
        .btn-primary:hover { background-color: #e55c00; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,102,0,0.4); }
        .form-input { background-color: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; }
        .form-input:focus { border-color: #FF6600; box-shadow: 0 0 0 2px rgba(255,102,0,0.2); outline: none; }
        .error-alert { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: #ff4444; 
            color: white; 
            padding: 15px 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(255,68,68,0.3);
            z-index: 9999;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <section class="min-h-screen flex items-center justify-center py-12 px-4">
        <div class="container max-w-md mx-auto">
            <div class="bg-gray-900 rounded-2xl p-8 border border-gray-800">
                <div class="text-center mb-8">
                    <i data-lucide="mail" class="w-12 h-12 text-orange-500 mx-auto mb-4"></i>
                    <h1 class="text-3xl font-bold mb-2 uppercase tracking-tighter">Forgot Password</h1>
                    <p class="text-gray-400">Enter your email to receive a reset link.</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Email Address</label>
                        <input type="email" id="email" placeholder="your@email.com" 
                               class="w-full px-4 py-3 rounded-lg form-input text-white" required>
                    </div>
                    
                    <button id="reset-btn" class="w-full px-6 py-3 btn-primary rounded-lg text-white font-semibold flex items-center justify-center">
                        <span id="btn-text">Send Reset Link</span>
                        <div id="btn-spinner" class="hidden ml-2">
                            <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    </button>
                </div>

                <div class="mt-6 text-center">
                    <a href="login.html" class="text-orange-500 hover:text-orange-400 text-sm">Back to Login</a>
                </div>

                <div id="message" class="mt-6 text-center text-sm hidden"></div>
            </div>
        </div>
    </section>

    <!-- Error Alert Container -->
    <div id="errorAlert" class="hidden"></div>

    <script>
        // Error alert function
        function showErrorAlert(title, message, details = '') {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'error-alert';
            alertDiv.innerHTML = `
                <div class="font-bold text-lg mb-2">‚ö†Ô∏è ${title}</div>
                <div class="text-sm mb-2">${message}</div>
                ${details ? `<div class="text-xs bg-red-600 p-2 rounded mt-2 font-mono">${details}</div>` : ''}
                <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-white hover:text-gray-200">‚úï</button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 10000);
        }

        // Test Supabase initialization
        console.log('Starting Supabase initialization...');
        let supabase;
        
        try {
            supabase = window.supabase.createClient(
                'https://crasacrormxxombnaklt.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyYXNhY3Jvcm14eG9tYm5ha2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjg1NTAsImV4cCI6MjA3OTg0NDU1MH0.q_apkDBu_QVwebbfjRqZ7QwrsNm9xQysRoNhayNyfLU'
            );
            console.log('‚úÖ Supabase initialized successfully');
            showErrorAlert('Success', 'Supabase connected successfully', 'Ready to send reset emails');
        } catch (error) {
            console.error('‚ùå Supabase initialization failed:', error);
            showErrorAlert('Supabase Init Failed', error.message, 'Check if Supabase URL and key are correct');
        }

        // Initialize Lucide icons
        lucide.createIcons();
        
        // Create stars background
        createStars();

        function createStars() {
            const starsContainer = document.getElementById('stars');
            if (!starsContainer) return;
            
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const size = Math.random() * 2 + 1;
                star.style.width = star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}vw`;
                star.style.top = `${Math.random() * -100}vh`;
                star.style.animationDuration = `${Math.random() * 100 + 50}s`;
                star.style.animationDelay = `${Math.random() * 50}s`;
                starsContainer.appendChild(star);
            }
        }

        function showMessage(text, type = 'error') {
            const msg = document.getElementById('message');
            if (!msg) return;
            
            msg.textContent = text;
            msg.className = `mt-6 text-center text-sm p-3 rounded-lg ${type === 'success' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`;
            msg.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    msg.classList.add('hidden');
                }, 5000);
            }
        }

        // Test Supabase connection on load
        (async function testConnection() {
            try {
                console.log('Testing Supabase connection...');
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('‚ùå Supabase connection test failed:', error);
                    showErrorAlert('Connection Test Failed', error.message, JSON.stringify(error, null, 2));
                } else {
                    console.log('‚úÖ Supabase connection test passed');
                    console.log('Session data:', data);
                }
            } catch (err) {
                console.error('‚ùå Connection test error:', err);
                showErrorAlert('Connection Error', err.message, 'Check network connection and Supabase URL');
            }
        })();

        // Main reset password function
        async function handleResetPassword() {
            console.log('üìß Reset password function triggered');
            
            const email = document.getElementById('email').value.trim();
            const btn = document.getElementById('reset-btn');
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            
            // Step 1: Check if email is entered
            if (!email) {
                console.log('‚ùå No email entered');
                showErrorAlert('Validation Error', 'Please enter your email address');
                showMessage('Please enter your email');
                return;
            }

            // Step 2: Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                console.log('‚ùå Invalid email format:', email);
                showErrorAlert('Validation Error', 'Please enter a valid email address', `Email entered: ${email}`);
                showMessage('Please enter a valid email address');
                return;
            }

            console.log('‚úÖ Email validation passed:', email);

            // Disable button
            btn.disabled = true;
            btnText.textContent = 'Sending...';
            btnSpinner.classList.remove('hidden');

            try {
                // Step 3: Prepare redirect URL
                const redirectTo = window.location.origin + '/reset-password.html';
                console.log('üîó Redirect URL:', redirectTo);

                // Step 4: Attempt to send reset email
                console.log('üì§ Sending reset password request to Supabase...');
                showErrorAlert('Processing', 'Sending reset email...', `Email: ${email}\nRedirect: ${redirectTo}`);
                
                const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: redirectTo
                });
                
                // Step 5: Check for errors
                if (error) {
                    console.error('‚ùå Supabase error:', error);
                    
                    // Detailed error analysis
                    let errorDetails = `Error Code: ${error.status || 'N/A'}\n`;
                    errorDetails += `Error Name: ${error.name || 'N/A'}\n`;
                    errorDetails += `Message: ${error.message}\n`;
                    
                    if (error.message.includes('rate limit')) {
                        showErrorAlert('Rate Limit Exceeded', 'Too many requests. Please wait a few minutes.', errorDetails);
                    } else if (error.message.includes('email')) {
                        showErrorAlert('Email Error', 'Problem with email service. Check SMTP settings.', errorDetails);
                    } else if (error.message.includes('network')) {
                        showErrorAlert('Network Error', 'Cannot connect to Supabase. Check your internet.', errorDetails);
                    } else {
                        showErrorAlert('Supabase Error', error.message, errorDetails);
                    }
                    
                    throw error;
                }

                // Step 6: Success!
                console.log('‚úÖ Reset email sent successfully!');
                console.log('Response data:', data);
                
                showErrorAlert(
                    '‚úÖ SUCCESS!', 
                    'Reset email sent successfully!', 
                    `Email sent to: ${email}\nCheck your inbox (and spam folder)`
                );
                
                showMessage('‚úì Reset link sent! Check your email.', 'success');
                
                // Clear email field
                document.getElementById('email').value = '';
                
                // Update button text
                btnText.textContent = 'Email Sent!';
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    btn.disabled = false;
                    btnText.textContent = 'Send Reset Link';
                    btnSpinner.classList.add('hidden');
                }, 3000);
                
            } catch (err) {
                console.error('‚ùå Catch block error:', err);
                
                // Ensure button is re-enabled
                btn.disabled = false;
                btnText.textContent = 'Send Reset Link';
                btnSpinner.classList.add('hidden');
                
                // Don't show duplicate alerts for Supabase errors (already shown above)
                if (!err.message || !err.message.includes('Supabase')) {
                    showErrorAlert('Unexpected Error', err.message || 'An unknown error occurred', err.stack || '');
                }
            }
        }

        // Add event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded, attaching event listeners');
            
            const resetBtn = document.getElementById('reset-btn');
            const emailInput = document.getElementById('email');
            
            if (!resetBtn) {
                console.error('‚ùå Reset button not found!');
                showErrorAlert('Critical Error', 'Reset button element not found in DOM');
                return;
            }
            
            if (!emailInput) {
                console.error('‚ùå Email input not found!');
                showErrorAlert('Critical Error', 'Email input element not found in DOM');
                return;
            }
            
            console.log('‚úÖ Elements found, attaching click handler');
            resetBtn.addEventListener('click', handleResetPassword);
            
            emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log('‚èé Enter key pressed');
                    handleResetPassword();
                }
            });
            
            console.log('‚úÖ Event listeners attached successfully');
        });

        // Log when script finishes loading
        console.log('üì¶ Script loaded and ready');
    </script>
</body>
</html>
