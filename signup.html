<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel - Join</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: white; font-family: 'Poppins', sans-serif; margin: 0; overflow: hidden; }
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { 0% { transform: translateY(-10vh); } 100% { transform: translateY(110vh); } }
        .login-card { background: #0a0a0a; border: 1px solid #222; border-radius: 28px; padding: 35px; width: 95%; max-width: 450px; z-index: 10; position: relative; max-height: 95vh; overflow-y: auto; }
        .sdel-input { background: #161616; border: 1px solid #333; border-radius: 14px; padding: 16px; width: 100%; color: white; outline: none; font-size: 16px; }
        .btn-orange { background: #FF6600; color: black; font-weight: 900; width: 100%; padding: 18px; border-radius: 14px; text-transform: uppercase; cursor: pointer; border: none; font-size: 16px; letter-spacing: 1px; }
        .btn-orange:disabled { background: #555; cursor: not-allowed; }
        .eye-box { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; z-index: 100; padding: 10px; }
        .hidden { display: none !important; }
        .phone-container { display: flex; align-items: center; background: #161616; border: 1px solid #333; border-radius: 14px; overflow: hidden; }
        .prefix { padding-left: 16px; color: #888; font-weight: 900; font-size: 16px; }
        .phone-input { background: transparent; border: none; padding: 16px 12px; width: 100%; color: white; outline: none; font-size: 16px; }
        
        .criteria-item { font-size: 15px; font-weight: 900; text-transform: uppercase; margin-right: 15px; transition: color 0.3s; }
        .valid { color: #22c55e; } 
        .invalid { color: #ffffff33; }
        
        .login-card::-webkit-scrollbar { width: 5px; }
        .login-card::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .live-msg { text-transform: uppercase; font-size: 10px; font-weight: 900; margin-top: 4px; padding-left: 5px; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake-error { animation: shake 0.2s ease-in-out 2; }

        #school-results { position: absolute; left: 0; right: 0; background: #111; border: 1px solid #333; border-radius: 14px; mt: 5px; z-index: 1000; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .uni-item { padding: 15px; font-size: 11px; font-weight: 900; text-transform: uppercase; border-bottom: 1px solid #222; cursor: pointer; }
        .uni-item:hover { background: #FF6600; color: black; }
        
        /* Honeypot styles - invisible to users */
        .honeypot {
            position: absolute;
            left: -9999px;
            top: -9999px;
            opacity: 0;
            height: 0;
            width: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: -9999;
        }
        .honeypot-field {
            position: absolute;
            opacity: 0;
            height: 0;
            width: 0;
            padding: 0;
            margin: 0;
            border: none;
            pointer-events: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="stars" id="star-field"></div>
    <div class="login-card">
        <a href="index.html" class="text-[12px] font-black text-white hover:text-[#FF6600] uppercase tracking-[0.4em] transition block mb-6">‚Üê Back</a>
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black italic uppercase tracking-tighter">S<span class="text-[#FF6600]">DEL</span> JOIN</h1>
            <p class="text-[12px] font-bold text-gray-400 uppercase tracking-[0.2em] mt-3">Create your account</p>
        </div>
        <div id="msg" class="hidden p-4 mb-5 rounded text-sm font-black text-center uppercase"></div>
        
        <!-- HONEYPOT SECTION 1: Hidden container with invisible fields -->
        <div class="honeypot">
            <input type="text" id="website" name="website" autocomplete="off" tabindex="-1">
            <input type="checkbox" id="confirm_age" name="confirm_age" tabindex="-1" checked>
            <input type="text" id="middle_name" name="middle_name" value="leave_blank" tabindex="-1">
            <input type="text" id="favorite_color" name="favorite_color" value="" tabindex="-1">
        </div>
        
        <!-- HONEYPOT SECTION 2: Decoy fields that look real but are hidden via CSS -->
        <div class="honeypot-field">
            <input type="email" id="alt_email" placeholder="Alternate Email" tabindex="-1">
            <input type="text" id="confirm_username" placeholder="Confirm Username" tabindex="-1">
        </div>
        
        <!-- HONEYPOT SECTION 3: Timestamp trap to detect bots -->
        <input type="hidden" id="form_load_time" value="">
        <input type="hidden" id="form_interaction_time" value="">
        
        <div class="space-y-4">
            <div class="flex gap-3">
                <input type="text" id="fname" placeholder="FIRST NAME" class="sdel-input w-1/2">
                <input type="text" id="lname" placeholder="LAST NAME" class="sdel-input w-1/2">
            </div>

            <div class="relative" id="school-container">
                <input type="text" id="school-search" placeholder="SELECT CAMPUS (E.G. OAU)" class="sdel-input" autocomplete="off">
                <div id="school-results" class="hidden"></div>
            </div>
            
            <div>
                <input type="text" id="uname" placeholder="USERNAME" class="sdel-input" oninput="this.value = this.value.toLowerCase(); validateUsername(this); trackFieldInteraction('uname')" onblur="liveCheck('username', this.value, 'u-msg')" onfocus="startFieldTimer('uname')">
                <p id="u-msg" class="live-msg hidden"></p>
            </div>

            <div>
                <div class="phone-container">
                    <span class="prefix">+234</span>
                    <input type="tel" id="ph" placeholder="8012345678" maxlength="10" class="phone-input" oninput="this.value = this.value.replace(/[^0-9]/g, ''); trackFieldInteraction('ph')" onblur="liveCheck('phone', '+234'+this.value, 'p-msg')" onfocus="startFieldTimer('ph')">
                </div>
                <p id="p-msg" class="live-msg hidden"></p>
            </div>

            <div>
                <input type="email" id="em" placeholder="EMAIL ADDRESS" class="sdel-input" oninput="trackFieldInteraction('em')" onblur="liveCheck('email', this.value, 'e-msg')" onfocus="startFieldTimer('em')">
                <p id="e-msg" class="live-msg hidden"></p>
            </div>

            <div class="relative">
                <input type="password" id="pw" placeholder="PASSWORD" class="sdel-input pr-14" oninput="validatePassword(); checkMatch(); trackFieldInteraction('pw')" onfocus="startFieldTimer('pw')">
                <div class="eye-box" onclick="toggleView('pw', 'on1', 'off1')">
                    <svg id="on1" class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    <svg id="off1" class="w-5 h-5 text-gray-500 hidden" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                </div>
            </div>
            <div id="criteria-box" class="flex flex-wrap px-1 gap-y-2">
                <span id="c-len" class="criteria-item invalid">6+ Digits</span>
                <span id="c-up" class="criteria-item invalid">Uppercase</span>
                <span id="c-low" class="criteria-item invalid">Lowercase</span>
                <span id="c-sym" class="criteria-item invalid">Symbol</span>
            </div>
            <div class="relative">
                <input type="password" id="rpw" placeholder="RE-ENTER PASSWORD" class="sdel-input pr-14" oninput="checkMatch(); trackFieldInteraction('rpw')" onfocus="startFieldTimer('rpw')">
                <div class="eye-box" onclick="toggleView('rpw', 'on2', 'off2')">
                    <svg id="on2" class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    <svg id="off2" class="w-5 h-5 text-gray-500 hidden" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                </div>
            </div>
            <div id="match-text" class="text-[12px] font-black uppercase text-center hidden">Match Status</div>
            
            <!-- DECOY TOGGLE - Looks interactive but does nothing -->
            <div class="flex items-center gap-3 px-2 py-2 border border-gray-800 rounded-lg">
                <label class="text-[11px] font-bold text-gray-400 uppercase tracking-wide">Receive updates?</label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-1">
                        <input type="radio" name="updates" value="yes" class="accent-[#FF6600]"> 
                        <span class="text-white text-xs">Yes</span>
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="radio" name="updates" value="no" class="accent-[#FF6600]" checked> 
                        <span class="text-white text-xs">No</span>
                    </label>
                </div>
            </div>
            
            <div class="flex items-center gap-3 px-2 py-2">
                <input type="checkbox" id="agree" class="w-5 h-5 accent-[#FF6600]">
                <label for="agree" class="text-[11px] font-bold text-gray-400 uppercase tracking-wide">I agree to the <a href="terms.html" class="text-white underline">Terms</a> & <a href="privacy.html" class="text-white underline">Privacy</a></label>
            </div>
            
            <!-- HONEYPOT SECTION 4: Fake submit button (bots might click this) -->
            <div class="honeypot">
                <button type="button" onclick="triggerHoneypot()" id="fake_submit">FAKE SUBMIT</button>
            </div>
            
            <!-- HONEYPOT SECTION 5: Trap checkbox that must remain unchecked -->
            <div class="honeypot">
                <input type="checkbox" id="trap_checkbox" checked>
            </div>
            
            <button onclick="signUp()" id="s-btn" class="btn-orange mt-2">Create Account</button>
        </div>
    </div>
    
    <script>
        // =============================================
        // ADVANCED BOT DETECTION SYSTEM
        // =============================================
        
        // Track user behavior
        let suspicionScore = 0;
        let fieldTimers = {};
        let fieldInteractions = [];
        let touchEvents = 0;
        let scrollEvents = 0;
        let startTime = Date.now();
        let fieldOrder = [];
        let keystrokeTimings = [];
        
        // Track field focus times
        function startFieldTimer(fieldId) {
            fieldTimers[fieldId] = Date.now();
        }
        
        // Track field interactions
        function trackFieldInteraction(fieldId) {
            if (!fieldOrder.includes(fieldId)) {
                fieldOrder.push(fieldId);
            }
            
            if (fieldTimers[fieldId]) {
                const timeSpent = Date.now() - fieldTimers[fieldId];
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    const charCount = field.value.length;
                    if (charCount > 0) {
                        const msPerChar = timeSpent / charCount;
                        fieldInteractions.push({
                            field: fieldId,
                            timeSpent,
                            charCount,
                            msPerChar,
                            timestamp: Date.now()
                        });
                    }
                }
            }
        }
        
        // Track keystrokes
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') {
                keystrokeTimings.push({
                    field: e.target.id,
                    time: Date.now(),
                    key: e.key
                });
            }
        });
        
        // Track touch events (mobile)
        document.addEventListener('touchstart', () => {
            touchEvents++;
        });
        
        // Track scroll events
        document.addEventListener('scroll', () => {
            scrollEvents++;
        });
        
        // Track if user left the page (tab switching)
        let leftPage = 0;
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                leftPage++;
            }
        });
        
        // Calculate bot score
        function calculateBotScore() {
            let score = 0;
            const totalTime = Date.now() - startTime;
            
            // 1. Time-based detection
            if (totalTime < 5000) { // Less than 5 seconds total
                score += 30;
                console.log('Suspicion: Form filled too fast');
            }
            
            // 2. Per-field typing speed detection
            let suspiciousTyping = 0;
            fieldInteractions.forEach(interaction => {
                // Humans: 200-800ms per character
                // Bots/autofill: <50ms per character
                if (interaction.msPerChar < 50 && interaction.charCount > 3) {
                    suspiciousTyping++;
                    score += 15;
                    console.log(`Suspicion: Too fast typing on ${interaction.field}: ${interaction.msPerChar}ms/char`);
                }
            });
            
            // 3. Perfect field order detection
            const expectedOrder = ['fname', 'lname', 'uname', 'ph', 'em', 'pw', 'rpw'];
            let matchesExpected = 0;
            fieldOrder.forEach((field, index) => {
                if (field === expectedOrder[index]) {
                    matchesExpected++;
                }
            });
            
            if (matchesExpected === fieldOrder.length && fieldOrder.length > 3) {
                score += 20;
                console.log('Suspicion: Perfect field order');
            }
            
            // 4. No scrolling on mobile
            if (window.innerWidth < 768 && scrollEvents === 0) {
                score += 15;
                console.log('Suspicion: No scrolling on mobile');
            }
            
            // 5. No touch events on mobile
            if (window.innerWidth < 768 && touchEvents < 3) {
                score += 15;
                console.log('Suspicion: Not enough touch interactions');
            }
            
            // 6. Keystroke pattern analysis
            if (keystrokeTimings.length > 5) {
                let intervals = [];
                for (let i = 1; i < keystrokeTimings.length; i++) {
                    intervals.push(keystrokeTimings[i].time - keystrokeTimings[i-1].time);
                }
                
                // Check if all intervals are exactly the same (bot behavior)
                const allSame = intervals.every(val => Math.abs(val - intervals[0]) < 5);
                if (allSame) {
                    score += 25;
                    console.log('Suspicion: Perfect keystroke timing');
                }
            }
            
            // 7. Tab switching detection (bots don't switch tabs)
            if (leftPage > 0) {
                score -= 10; // Human behavior, reduce suspicion
            }
            
            // 8. Form load time check (already in honeypots)
            const loadTime = document.getElementById('form_load_time').value;
            if (loadTime) {
                const timeSinceLoad = Date.now() - parseInt(loadTime);
                if (timeSinceLoad < 3000) { // Less than 3 seconds
                    score += 40;
                    console.log('Suspicion: Form submitted too quickly after load');
                }
            }
            
            return score;
        }
        
        // =============================================
        // BAN SYSTEM WITH 30-DAY AUTO-UNBAN
        // =============================================
        
        // Check if ban is expired
        function isBanExpired(banData) {
            if (!banData) return true;
            try {
                const data = typeof banData === 'string' ? JSON.parse(banData) : banData;
                return Date.now() > data.unbanTime;
            } catch (e) {
                return true;
            }
        }
        
        // Check if device is banned (with expiry check)
        function isDeviceBanned() {
            function checkBan(banData) {
                if (!banData) return false;
                try {
                    const data = typeof banData === 'string' ? JSON.parse(banData) : banData;
                    if (Date.now() > data.unbanTime) return false;
                    return data.banned === true;
                } catch (e) {
                    return false;
                }
            }
            
            // Check all storage locations
            const localBan = localStorage.getItem('sdel_ban');
            if (checkBan(localBan)) return true;
            
            const sessionBan = sessionStorage.getItem('sdel_ban');
            if (checkBan(sessionBan)) return true;
            
            const cookieMatch = document.cookie.match(/sdel_ban=([^;]+)/);
            if (cookieMatch) {
                const cookieBan = decodeURIComponent(cookieMatch[1]);
                if (checkBan(cookieBan)) return true;
            }
            
            return false;
        }
        
        // Permanent ban function - 30 days
        function permanentlyBanDevice(reason = 'Honeypot triggered') {
            const banData = {
                banned: true,
                reason: reason,
                timestamp: Date.now(),
                unbanTime: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 days
            };
            
            const banString = JSON.stringify(banData);
            
            // Store everywhere
            localStorage.setItem('sdel_ban', banString);
            sessionStorage.setItem('sdel_ban', banString);
            document.cookie = `sdel_ban=${encodeURIComponent(banString)}; max-age=${60*60*24*30}; path=/; SameSite=Strict`;
            
            // Also store in IndexedDB if available
            try {
                const request = indexedDB.open('SdelBanDB', 1);
                request.onupgradeneeded = function(e) {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('bans')) {
                        db.createObjectStore('bans', { keyPath: 'id' });
                    }
                };
                request.onsuccess = function(e) {
                    const db = e.target.result;
                    const transaction = db.transaction(['bans'], 'readwrite');
                    const store = transaction.objectStore('bans');
                    store.put({ id: 'ban_data', ...banData });
                };
            } catch (e) {
                console.log('IndexedDB not available');
            }
            
            window.location.href = 'banned.html';
        }
        
        // Simple onload with expiry check
        (function simpleOnLoad() {
            // Function to clean expired bans
            function cleanExpiredBan(storage, key) {
                const ban = storage.getItem(key);
                if (ban && isBanExpired(ban)) {
                    storage.removeItem(key);
                }
                return ban;
            }
            
            // Check and clean localStorage
            const localBan = cleanExpiredBan(localStorage, 'sdel_ban');
            if (localBan && !isBanExpired(localBan)) {
                window.location.href = 'banned.html';
                return;
            }
            
            // Check and clean sessionStorage
            const sessionBan = cleanExpiredBan(sessionStorage, 'sdel_ban');
            if (sessionBan && !isBanExpired(sessionBan)) {
                window.location.href = 'banned.html';
                return;
            }
            
            // Check cookie
            const cookieMatch = document.cookie.match(/sdel_ban=([^;]+)/);
            if (cookieMatch) {
                const cookieBan = decodeURIComponent(cookieMatch[1]);
                if (!isBanExpired(cookieBan)) {
                    window.location.href = 'banned.html';
                    return;
                } else {
                    document.cookie = "sdel_ban=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                }
            }
            
            // Set timestamps
            const now = Date.now();
            const loadTimeField = document.getElementById('form_load_time');
            if (loadTimeField) {
                loadTimeField.value = now.toString();
            }
            
            // Track when user first interacts
            document.addEventListener('touchstart', () => {
                document.getElementById('form_interaction_time').value = Date.now().toString();
            }, { once: true });
            
            document.addEventListener('mousemove', () => {
                document.getElementById('form_interaction_time').value = Date.now().toString();
            }, { once: true });
        })();
        
        // Honeypot trigger function
        function triggerHoneypot() {
            permanentlyBanDevice('Fake submit clicked');
        }
        
        // Enhanced honeypot detection
        function checkHoneypots() {
            // Honeypot 1: Hidden fields should be empty
            const website = document.getElementById('website').value;
            if (website && website.trim() !== '') {
                console.log('Honeypot triggered: website field filled');
                return true;
            }
            
            // Honeypot 2: Middle name should be "leave_blank"
            const middleName = document.getElementById('middle_name').value;
            if (middleName !== 'leave_blank') {
                console.log('Honeypot triggered: middle name changed');
                return true;
            }
            
            // Honeypot 3: Favorite color should be empty
            const favColor = document.getElementById('favorite_color').value;
            if (favColor && favColor.trim() !== '') {
                console.log('Honeypot triggered: favorite color filled');
                return true;
            }
            
            // Honeypot 4: Alt email should be empty
            const altEmail = document.getElementById('alt_email').value;
            if (altEmail && altEmail.trim() !== '') {
                console.log('Honeypot triggered: alt email filled');
                return true;
            }
            
            // Honeypot 5: Confirm username should be empty
            const confirmUsername = document.getElementById('confirm_username').value;
            if (confirmUsername && confirmUsername.trim() !== '') {
                console.log('Honeypot triggered: confirm username filled');
                return true;
            }
            
            // Honeypot 6: Trap checkbox should remain checked
            const trapCheckbox = document.getElementById('trap_checkbox');
            if (trapCheckbox && !trapCheckbox.checked) {
                console.log('Honeypot triggered: trap checkbox unchecked');
                return true;
            }
            
            return false;
        }
        
        // Validate username - no spaces, block weird patterns
        function validateUsername(input) {
            const username = input.value;
            
            if (username.includes(' ')) {
                input.value = username.replace(/\s/g, '');
                showUsernameError("SPACES NOT ALLOWED", input);
            }
            
            const weirdPatternRegex = /[;`^|\\<>{}[\]$%#@!~&*+=?]/;
            const hasWeirdPattern = weirdPatternRegex.test(username);
            
            if (hasWeirdPattern) {
                input.value = username.replace(weirdPatternRegex, '');
                showUsernameError("INVALID CHARACTERS REMOVED", input);
            }
            
            const consecutiveSpecialRegex = /[._]{2,}|[^a-zA-Z0-9._]{2,}/;
            if (consecutiveSpecialRegex.test(username)) {
                input.value = username.replace(/[^a-zA-Z0-9._]/g, '');
                showUsernameError("INVALID PATTERN DETECTED", input);
            }
            
            const validUsernameRegex = /^[a-zA-Z0-9][a-zA-Z0-9._]*[a-zA-Z0-9]$|^[a-zA-Z0-9]$/;
            if (username && !validUsernameRegex.test(username)) {
                let cleaned = username.replace(/[^a-zA-Z0-9._]/g, '');
                cleaned = cleaned.replace(/^[._]+|[._]+$/g, '');
                if (cleaned) {
                    input.value = cleaned;
                }
                showUsernameError("USERNAME MUST START/END WITH LETTER OR NUMBER", input);
            }
        }
        
        function showUsernameError(message, input) {
            const msgEl = document.getElementById('u-msg');
            msgEl.classList.remove('hidden');
            msgEl.innerText = message;
            msgEl.style.color = "#FF6600";
            input.classList.add('shake-error');
            setTimeout(() => input.classList.remove('shake-error'), 400);
        }
        
        function isUsernameValid(username) {
            if (!username) return false;
            if (username.includes(' ')) return false;
            if (!/^[a-zA-Z0-9]/.test(username)) return false;
            if (!/[a-zA-Z0-9]$/.test(username)) return false;
            if (!/^[a-zA-Z0-9._]+$/.test(username)) return false;
            if (/[._]{2,}/.test(username)) return false;
            
            const weirdPatterns = ['^^', '``', ';;', '||', '\\\\', '//', '##', '$$', '%%', '&&', '**', '++', '==', '??', '>', '<'];
            for (let pattern of weirdPatterns) {
                if (username.includes(pattern)) return false;
            }
            
            return true;
        }
    </script>
    
    <script>
        // Stars animation
        const f = document.getElementById('star-field');
        for(let i=0; i<80; i++) {
            const s = document.createElement('div'); s.className = 'star';
            s.style.width = s.style.height = (Math.random()*2+1.5)+'px';
            s.style.left = Math.random()*100+'vw'; s.style.animationDuration = (Math.random()*20+25)+'s';
            f.appendChild(s);
        }

        // Supabase setup
        const sb = window.supabase.createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        // University list (keeping your existing list)
        const nigerianUniversities = ["Obafemi Awolowo University (OAU)", "University of Lagos (UNILAG)", "University of Ibadan (UI)", "University of Ilorin (UNILORIN)", "University of Benin (UNIBEN)", "University of Nigeria, Nsukka (UNN)", "Ahmadu Bello University (ABU)", "Bayero University (BUK)", "Federal University of Technology, Akure (FUTA)", "Federal University of Technology, Minna (FUTMINNA)", "Federal University of Technology, Owerri (FUTO)", "University of Port Harcourt (UNIPORT)", "University of Abuja (UNIABUJA)", "University of Jos (UNIJOS)", "University of Maiduguri (UNIMAID)", "University of Uyo (UNIUYO)", "University of Calabar (UNICAL)", "Nnamdi Azikiwe University (UNIZIK)", "Lagos State University (LASU)", "Ladoke Akintola University (LAUTECH)", "Olabisi Onabanjo University (OOU)", "Ekiti State University (EKSU)", "Kwara State University (KWASU)", "Delta State University (DELSU)", "Rivers State University (RSU)", "Ambrose Alli University (AAU)", "Covenant University", "Babcock University", "Afe Babalola University (ABUAD)", "Bowen University", "Pan-Atlantic University", "Nile University of Nigeria", "Baze University", "American University of Nigeria (AUN)", "Landmark University", "Redeemer's University", "Bells University of Technology", "Mountain Top University", "Veritas University", "Benson Idahosa University", "Igbinedion University", "Lead City University", "Adeleke University", "Bingham University", "Caleb University", "Ajayi Crowther University", "Anchor University", "Augustine University", "Chrisland University", "Christopher University", "Coal City University", "Dominion University", "Edusoko University", "Edwin Clark University", "Elizade University", "Evangel University", "Fountain University", "Godfrey Okoye University", "Greenfield University", "Gregory University", "Hallmark University", "Hezekiah University", "Kings University", "Kwararafa University", "Legacy University", "McPherson University", "Mewar International University", "Novena University", "Oduduwa University", "PAMO University of Medical Sciences", "Paul University", "Philomath University", "Precious Cornerstone University", "Renaissance University", "Rhema University", "Ritman University", "Salem University", "Sam Maris University", "Skyline University Nigeria", "Southwestern University", "Spiritan University", "Summit University", "Tansian University", "Topfaith University", "Trinity University", "Wellspring University", "Wesley University", "Western Delta University", "Wigwe University", "Abia State University", "Adamawa State University", "Akwa Ibom State University", "Bauchi State University", "Benue State University", "Borno State University", "Chukwuemeka Odumegwu Ojukwu University", "Cross River University of Technology", "Ebonyi State University", "Edo State University", "Enugu State University of Science and Technology", "Gombe State University", "Ibrahim Badamasi Babangida University", "Ignatius Ajuru University", "Imo State University", "Kaduna State University", "Kano University of Science and Technology", "Kebbi State University of Science and Technology", "Kogi State University", "Maitama Sule University", "Nasarawa State University", "Niger Delta University", "Osun State University", "Plateau State University", "Sokoto State University", "Tai Solarin University of Education", "Taraba State University", "Umaru Musa Yar'Adua University", "Yobe State University", "Zamfara State University", "Maritime University, Okerenkoko", "Nigeria Police Academy, Wudil", "Nigerian Defence Academy (NDA)", "Air Force Institute of Technology", "CUNY LC New York", "Federal University, Birnin Kebbi", "Federal University, Dutse", "Federal University, Dutsin-Ma", "Federal University, Gashua", "Federal University, Gusau", "Federal University, Kashere", "Federal University, Lafia", "Federal University, Lokoja", "Federal University, Otuoke", "Federal University, Oye-Ekiti", "Federal University, Wukari", "Other / Not Listed"];
        // School search (unchanged)
        const schoolInp = document.getElementById('school-search');
        const schoolRes = document.getElementById('school-results');

        schoolInp.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            schoolRes.innerHTML = '';
            if(!val) { schoolRes.classList.add('hidden'); return; }
            const filtered = nigerianUniversities.filter(u => u.toLowerCase().includes(val));
            if(filtered.length > 0) {
                schoolRes.classList.remove('hidden');
                filtered.forEach(u => {
                    const d = document.createElement('div'); d.className = 'uni-item'; d.innerText = u;
                    d.onclick = () => { schoolInp.value = u; schoolRes.classList.add('hidden'); };
                    schoolRes.appendChild(d);
                });
            } else { schoolRes.classList.add('hidden'); }
        });

        document.addEventListener('click', (e) => { if(!document.getElementById('school-container').contains(e.target)) schoolRes.classList.add('hidden'); });

        // Live checks (unchanged)
        let isUnique = { username: true, phone: true, email: true };

        async function liveCheck(col, val, msgId) {
            const msgEl = document.getElementById(msgId);
            if (!val || val.length < 3) { msgEl.classList.add('hidden'); return; }
            const { data } = await sb.from('profile').select(col).eq(col, val).maybeSingle();
            msgEl.classList.remove('hidden');
            if (data) {
                msgEl.innerText = col + " already taken";
                msgEl.style.color = "#ef4444";
                isUnique[col] = false;
            } else {
                msgEl.innerText = col + " available";
                msgEl.style.color = "#22c55e";
                isUnique[col] = true;
            }
        }

        // Password validation (unchanged)
        function validatePassword() {
            const p = document.getElementById('pw').value;
            const len = p.length >= 6;
            const up = /[A-Z]/.test(p);
            const low = /[a-z]/.test(p);
            const sym = /[^A-Za-z0-9]/.test(p);
            document.getElementById('c-len').className = `criteria-item ${len ? 'valid' : 'invalid'}`;
            document.getElementById('c-up').className = `criteria-item ${up ? 'valid' : 'invalid'}`;
            document.getElementById('c-low').className = `criteria-item ${low ? 'valid' : 'invalid'}`;
            document.getElementById('c-sym').className = `criteria-item ${sym ? 'valid' : 'invalid'}`;
            return { all: (len && up && low && sym), len, up, low, sym };
        }

        function checkMatch() {
            const p1 = document.getElementById('pw').value;
            const p2 = document.getElementById('rpw').value;
            const mt = document.getElementById('match-text');
            if(!p2) { mt.classList.add('hidden'); return; }
            mt.classList.remove('hidden');
            if(p1 === p2) { mt.innerText = "PASSWORDS MATCH"; mt.style.color = "#22c55e"; } 
            else { mt.innerText = "PASSWORDS DO NOT MATCH"; mt.style.color = "#ef4444"; }
        }

        function toggleView(inputId, onId, offId) {
            const p = document.getElementById(inputId);
            const on = document.getElementById(onId);
            const off = document.getElementById(offId);
            if (p.type === 'password') { p.type = 'text'; on.classList.add('hidden'); off.classList.remove('hidden'); }
            else { p.type = 'password'; on.classList.remove('hidden'); off.classList.add('hidden'); }
        }

        // Main signup function with bot detection
        async function signUp() {
            // Check for device ban first
            if (isDeviceBanned()) {
                window.location.href = 'banned.html';
                return;
            }
            
            // Check honeypots
            if (checkHoneypots()) {
                permanentlyBanDevice('Honeypot triggered');
                return;
            }
            
            // Calculate bot score
            const botScore = calculateBotScore();
            console.log('Bot score:', botScore);
            
            // If score is too high, ban
            if (botScore > 50) {
                permanentlyBanDevice(`Bot detected (score: ${botScore})`);
                return;
            }
            
            // If score is medium, show CAPTCHA or just warn
            if (botScore > 30) {
                showMsg("SUSPICIOUS ACTIVITY DETECTED. PLEASE TRY AGAIN.", "red");
                return;
            }
            
            const fn = document.getElementById('fname').value;
            const ln = document.getElementById('lname').value;
            const un = document.getElementById('uname').value;
            const sc = document.getElementById('school-search').value;
            const ph = document.getElementById('ph').value;
            const em = document.getElementById('em').value;
            const pw = document.getElementById('pw').value;
            const rpw = document.getElementById('rpw').value;
            const agree = document.getElementById('agree').checked;
            const btn = document.getElementById('s-btn');

            if(!fn || !ln || !un || !sc || !ph || !em || !pw || !rpw) return showMsg("FILL ALL FIELDS", "red");
            
            if (!isUsernameValid(un)) {
                showMsg("INVALID USERNAME: Use letters, numbers, . or _ only", "red");
                return;
            }
            
            if(!isUnique.username || !isUnique.phone || !isUnique.email) return showMsg("SOME DATA IS ALREADY REGISTERED", "red");
            if(ph.length !== 10) return showMsg("PHONE MUST BE 10 DIGITS", "red");
            
            const pCheck = validatePassword();
            if(!pCheck.all) {
                let missing = [];
                if(!pCheck.len) missing.push("6+ DIGITS");
                if(!pCheck.up) missing.push("UPPERCASE");
                if(!pCheck.low) missing.push("LOWERCASE");
                if(!pCheck.sym) missing.push("SYMBOL");
                const cBox = document.getElementById('criteria-box');
                cBox.classList.add('shake-error');
                setTimeout(() => cBox.classList.remove('shake-error'), 400);
                return showMsg("MISSING: " + missing.join(", "), "red");
            }

            if(pw !== rpw) return showMsg("PASSWORDS MUST MATCH", "red");
            if(!agree) return showMsg("AGREE TO TERMS FIRST", "red");

            btn.innerText = "PROCESSING..."; btn.disabled = true;
            
            const { data, error } = await sb.auth.signUp({
                email: em, password: pw,
                options: { data: { first_name: fn, last_name: ln, username: un, phone: "+234"+ph, school_name: sc } }
            });

            if (error) { 
                console.error("DEBUG:", error);
                showMsg(error.message + (error.status ? " (Status: "+error.status+")" : ""), "red"); 
                btn.innerText = "CREATE ACCOUNT"; btn.disabled = false; 
            } else { 
                showMsg("SUCCESS! REDIRECTING...", "green");
                setTimeout(() => { window.location.href = 'dashboard.html'; }, 1500);
            }
        }

        function showMsg(t, type) {
            const m = document.getElementById('msg');
            m.innerText = t.toUpperCase();
            m.className = `p-4 mb-5 rounded border text-sm font-black text-center uppercase block ${type === 'red' ? 'bg-red-900/20 text-red-500 border-red-500/30' : 'bg-green-900/20 text-green-500 border-green-500/30'}`;
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.add('hidden'); }, 4000);
        }
    </script>
</body>
</html>
