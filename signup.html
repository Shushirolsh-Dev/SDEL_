<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel - Join</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: white; font-family: 'Poppins', sans-serif; margin: 0; overflow: hidden; }
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { 0% { transform: translateY(-10vh); } 100% { transform: translateY(110vh); } }
        .login-card { background: #0a0a0a; border: 1px solid #222; border-radius: 28px; padding: 35px; width: 95%; max-width: 450px; z-index: 10; position: relative; max-height: 95vh; overflow-y: auto; }
        .sdel-input { background: #161616; border: 1px solid #333; border-radius: 14px; padding: 16px; width: 100%; color: white; outline: none; font-size: 16px; }
        .btn-orange { background: #FF6600; color: black; font-weight: 900; width: 100%; padding: 18px; border-radius: 14px; text-transform: uppercase; cursor: pointer; border: none; font-size: 16px; letter-spacing: 1px; }
        .btn-orange:disabled { background: #555; cursor: not-allowed; }
        .eye-box { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; z-index: 100; padding: 10px; }
        .hidden { display: none !important; }
        .phone-container { display: flex; align-items: center; background: #161616; border: 1px solid #333; border-radius: 14px; overflow: hidden; }
        .prefix { padding-left: 16px; color: #888; font-weight: 900; font-size: 16px; }
        .phone-input { background: transparent; border: none; padding: 16px 12px; width: 100%; color: white; outline: none; font-size: 16px; }
        
        .criteria-item { font-size: 15px; font-weight: 900; text-transform: uppercase; margin-right: 15px; transition: color 0.3s; }
        .valid { color: #22c55e; } 
        .invalid { color: #ffffff33; }
        
        .login-card::-webkit-scrollbar { width: 5px; }
        .login-card::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .live-msg { text-transform: uppercase; font-size: 10px; font-weight: 900; margin-top: 4px; padding-left: 5px; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake-error { animation: shake 0.2s ease-in-out 2; }

        #school-results { position: absolute; left: 0; right: 0; background: #111; border: 1px solid #333; border-radius: 14px; mt: 5px; z-index: 1000; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .uni-item { padding: 15px; font-size: 11px; font-weight: 900; text-transform: uppercase; border-bottom: 1px solid #222; cursor: pointer; }
        .uni-item:hover { background: #FF6600; color: black; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="stars" id="star-field"></div>
    <div class="login-card">
        <a href="index.html" class="text-[12px] font-black text-white hover:text-[#FF6600] uppercase tracking-[0.4em] transition block mb-6">‚Üê Back</a>
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black italic uppercase tracking-tighter">S<span class="text-[#FF6600]">DEL</span> JOIN</h1>
            <p class="text-[12px] font-bold text-gray-400 uppercase tracking-[0.2em] mt-3">Create your account</p>
        </div>
        <div id="msg" class="hidden p-4 mb-5 rounded text-sm font-black text-center uppercase"></div>
        <div class="space-y-4">
            <div class="flex gap-3">
                <input type="text" id="fname" placeholder="FIRST NAME" class="sdel-input w-1/2">
                <input type="text" id="lname" placeholder="LAST NAME" class="sdel-input w-1/2">
            </div>

            <div class="relative" id="school-container">
                <input type="text" id="school-search" placeholder="SELECT CAMPUS (E.G. OAU)" class="sdel-input" autocomplete="off">
                <div id="school-results" class="hidden"></div>
            </div>
            
            <div>
                <input type="text" id="uname" placeholder="USERNAME" class="sdel-input" oninput="this.value = this.value.toLowerCase()" onblur="liveCheck('username', this.value, 'u-msg')">
                <p id="u-msg" class="live-msg hidden"></p>
            </div>

            <div>
                <div class="phone-container">
                    <span class="prefix">+234</span>
                    <input type="tel" id="ph" placeholder="8012345678" maxlength="10" class="phone-input" oninput="this.value = this.value.replace(/[^0-9]/g, '')" onblur="liveCheck('phone', '+234'+this.value, 'p-msg')">
                </div>
                <p id="p-msg" class="live-msg hidden"></p>
            </div>

            <div>
                <input type="email" id="em" placeholder="EMAIL ADDRESS" class="sdel-input" onblur="liveCheck('email', this.value, 'e-msg')">
                <p id="e-msg" class="live-msg hidden"></p>
            </div>

            <div class="relative">
                <input type="password" id="pw" placeholder="PASSWORD" class="sdel-input pr-14" oninput="validatePassword(); checkMatch();">
                <div class="eye-box" onclick="toggleView('pw', 'on1', 'off1')">
                    <svg id="on1" class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    <svg id="off1" class="w-5 h-5 text-gray-500 hidden" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                </div>
            </div>
            <div id="criteria-box" class="flex flex-wrap px-1 gap-y-2">
                <span id="c-len" class="criteria-item invalid">6+ Digits</span>
                <span id="c-up" class="criteria-item invalid">Uppercase</span>
                <span id="c-low" class="criteria-item invalid">Lowercase</span>
                <span id="c-sym" class="criteria-item invalid">Symbol</span>
            </div>
            <div class="relative">
                <input type="password" id="rpw" placeholder="RE-ENTER PASSWORD" class="sdel-input pr-14" oninput="checkMatch()">
                <div class="eye-box" onclick="toggleView('rpw', 'on2', 'off2')">
                    <svg id="on2" class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    <svg id="off2" class="w-5 h-5 text-gray-500 hidden" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                </div>
            </div>
            <div id="match-text" class="text-[12px] font-black uppercase text-center hidden">Match Status</div>
            <div class="flex items-center gap-3 px-2 py-2">
                <input type="checkbox" id="agree" class="w-5 h-5 accent-[#FF6600]">
                <label for="agree" class="text-[11px] font-bold text-gray-400 uppercase tracking-wide">I agree to the <a href="terms.html" class="text-white underline">Terms</a> & <a href="privacy.html" class="text-white underline">Privacy</a></label>
            </div>
            <button onclick="signUp()" id="s-btn" class="btn-orange mt-2">Create Account</button>
        </div>
    </div>
    <script>
        const f = document.getElementById('star-field');
        for(let i=0; i<80; i++) {
            const s = document.createElement('div'); s.className = 'star';
            s.style.width = s.style.height = (Math.random()*2+1.5)+'px';
            s.style.left = Math.random()*100+'vw'; s.style.animationDuration = (Math.random()*20+25)+'s';
            f.appendChild(s);
        }

        const sb = window.supabase.createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        const nigerianUniversities = ["Obafemi Awolowo University (OAU)", "University of Lagos (UNILAG)", "University of Ibadan (UI)", "University of Ilorin (UNILORIN)", "University of Benin (UNIBEN)", "University of Nigeria, Nsukka (UNN)", "Ahmadu Bello University (ABU)", "Bayero University (BUK)", "Federal University of Technology, Akure (FUTA)", "Federal University of Technology, Minna (FUTMINNA)", "Federal University of Technology, Owerri (FUTO)", "University of Port Harcourt (UNIPORT)", "University of Abuja (UNIABUJA)", "University of Jos (UNIJOS)", "University of Maiduguri (UNIMAID)", "University of Uyo (UNIUYO)", "University of Calabar (UNICAL)", "Nnamdi Azikiwe University (UNIZIK)", "Lagos State University (LASU)", "Ladoke Akintola University (LAUTECH)", "Olabisi Onabanjo University (OOU)", "Ekiti State University (EKSU)", "Kwara State University (KWASU)", "Delta State University (DELSU)", "Rivers State University (RSU)", "Ambrose Alli University (AAU)", "Covenant University", "Babcock University", "Afe Babalola University (ABUAD)", "Bowen University", "Pan-Atlantic University", "Nile University of Nigeria", "Baze University", "American University of Nigeria (AUN)", "Landmark University", "Redeemer's University", "Bells University of Technology", "Mountain Top University", "Veritas University", "Benson Idahosa University", "Igbinedion University", "Lead City University", "Adeleke University", "Bingham University", "Caleb University", "Ajayi Crowther University", "Anchor University", "Augustine University", "Chrisland University", "Christopher University", "Coal City University", "Dominion University", "Edusoko University", "Edwin Clark University", "Elizade University", "Evangel University", "Fountain University", "Godfrey Okoye University", "Greenfield University", "Gregory University", "Hallmark University", "Hezekiah University", "Kings University", "Kwararafa University", "Legacy University", "McPherson University", "Mewar International University", "Novena University", "Oduduwa University", "PAMO University of Medical Sciences", "Paul University", "Philomath University", "Precious Cornerstone University", "Renaissance University", "Rhema University", "Ritman University", "Salem University", "Sam Maris University", "Skyline University Nigeria", "Southwestern University", "Spiritan University", "Summit University", "Tansian University", "Topfaith University", "Trinity University", "Wellspring University", "Wesley University", "Western Delta University", "Wigwe University", "Abia State University", "Adamawa State University", "Akwa Ibom State University", "Bauchi State University", "Benue State University", "Borno State University", "Chukwuemeka Odumegwu Ojukwu University", "Cross River University of Technology", "Ebonyi State University", "Edo State University", "Enugu State University of Science and Technology", "Gombe State University", "Ibrahim Badamasi Babangida University", "Ignatius Ajuru University", "Imo State University", "Kaduna State University", "Kano University of Science and Technology", "Kebbi State University of Science and Technology", "Kogi State University", "Maitama Sule University", "Nasarawa State University", "Niger Delta University", "Osun State University", "Plateau State University", "Sokoto State University", "Tai Solarin University of Education", "Taraba State University", "Umaru Musa Yar'Adua University", "Yobe State University", "Zamfara State University", "Maritime University, Okerenkoko", "Nigeria Police Academy, Wudil", "Nigerian Defence Academy (NDA)", "Air Force Institute of Technology", "Federal University, Birnin Kebbi", "Federal University, Dutse", "Federal University, Dutsin-Ma", "Federal University, Gashua", "Federal University, Gusau", "Federal University, Kashere", "Federal University, Lafia", "Federal University, Lokoja", "Federal University, Otuoke", "Federal University, Oye-Ekiti", "Federal University, Wukari", "Other / Not Listed"];

        const schoolInp = document.getElementById('school-search');
        const schoolRes = document.getElementById('school-results');

        schoolInp.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            schoolRes.innerHTML = '';
            if(!val) { schoolRes.classList.add('hidden'); return; }
            const filtered = nigerianUniversities.filter(u => u.toLowerCase().includes(val));
            if(filtered.length > 0) {
                schoolRes.classList.remove('hidden');
                filtered.forEach(u => {
                    const d = document.createElement('div'); d.className = 'uni-item'; d.innerText = u;
                    d.onclick = () => { schoolInp.value = u; schoolRes.classList.add('hidden'); };
                    schoolRes.appendChild(d);
                });
            } else { schoolRes.classList.add('hidden'); }
        });

        document.addEventListener('click', (e) => { if(!document.getElementById('school-container').contains(e.target)) schoolRes.classList.add('hidden'); });

        let isUnique = { username: true, phone: true, email: true };

        async function liveCheck(col, val, msgId) {
            const msgEl = document.getElementById(msgId);
            if (!val || val.length < 3) { msgEl.classList.add('hidden'); return; }
            const { data } = await sb.from('profile').select(col).eq(col, val).maybeSingle();
            msgEl.classList.remove('hidden');
            if (data) {
                msgEl.innerText = col + " already taken";
                msgEl.style.color = "#ef4444";
                isUnique[col] = false;
            } else {
                msgEl.innerText = col + " available";
                msgEl.style.color = "#22c55e";
                isUnique[col] = true;
            }
        }

        function validatePassword() {
            const p = document.getElementById('pw').value;
            const len = p.length >= 6;
            const up = /[A-Z]/.test(p);
            const low = /[a-z]/.test(p);
            const sym = /[^A-Za-z0-9]/.test(p);
            document.getElementById('c-len').className = `criteria-item ${len ? 'valid' : 'invalid'}`;
            document.getElementById('c-up').className = `criteria-item ${up ? 'valid' : 'invalid'}`;
            document.getElementById('c-low').className = `criteria-item ${low ? 'valid' : 'invalid'}`;
            document.getElementById('c-sym').className = `criteria-item ${sym ? 'valid' : 'invalid'}`;
            return { all: (len && up && low && sym), len, up, low, sym };
        }

        function checkMatch() {
            const p1 = document.getElementById('pw').value;
            const p2 = document.getElementById('rpw').value;
            const mt = document.getElementById('match-text');
            if(!p2) { mt.classList.add('hidden'); return; }
            mt.classList.remove('hidden');
            if(p1 === p2) { mt.innerText = "PASSWORDS MATCH"; mt.style.color = "#22c55e"; } 
            else { mt.innerText = "PASSWORDS DO NOT MATCH"; mt.style.color = "#ef4444"; }
        }

        function toggleView(inputId, onId, offId) {
            const p = document.getElementById(inputId);
            const on = document.getElementById(onId);
            const off = document.getElementById(offId);
            if (p.type === 'password') { p.type = 'text'; on.classList.add('hidden'); off.classList.remove('hidden'); }
            else { p.type = 'password'; on.classList.remove('hidden'); off.classList.add('hidden'); }
        }

        async function signUp() {
            const fn = document.getElementById('fname').value;
            const ln = document.getElementById('lname').value;
            const un = document.getElementById('uname').value;
            const sc = document.getElementById('school-search').value;
            const ph = document.getElementById('ph').value;
            const em = document.getElementById('em').value;
            const pw = document.getElementById('pw').value;
            const rpw = document.getElementById('rpw').value;
            const agree = document.getElementById('agree').checked;
            const btn = document.getElementById('s-btn');

            if(!fn || !ln || !un || !sc || !ph || !em || !pw || !rpw) return showMsg("FILL ALL FIELDS", "red");
            if(!isUnique.username || !isUnique.phone || !isUnique.email) return showMsg("SOME DATA IS ALREADY REGISTERED", "red");
            if(ph.length !== 10) return showMsg("PHONE MUST BE 10 DIGITS", "red");
            
            const pCheck = validatePassword();
            if(!pCheck.all) {
                let missing = [];
                if(!pCheck.len) missing.push("6+ DIGITS");
                if(!pCheck.up) missing.push("UPPERCASE");
                if(!pCheck.low) missing.push("LOWERCASE");
                if(!pCheck.sym) missing.push("SYMBOL");
                const cBox = document.getElementById('criteria-box');
                cBox.classList.add('shake-error');
                setTimeout(() => cBox.classList.remove('shake-error'), 400);
                return showMsg("MISSING: " + missing.join(", "), "red");
            }

            if(pw !== rpw) return showMsg("PASSWORDS MUST MATCH", "red");
            if(!agree) return showMsg("AGREE TO TERMS FIRST", "red");

            btn.innerText = "PROCESSING..."; btn.disabled = true;
            
            const { data, error } = await sb.auth.signUp({
                email: em, password: pw,
                options: { data: { first_name: fn, last_name: ln, username: un, phone: "+234"+ph, school_name: sc } }
            });

            if (error) { 
                // DIAGNOSTIC ALERT: Shows the RAW error so we know EXACTLY what Postgres is saying.
                console.error("DEBUG:", error);
                showMsg(error.message + (error.status ? " (Status: "+error.status+")" : ""), "red"); 
                btn.innerText = "CREATE ACCOUNT"; btn.disabled = false; 
            } else { 
                showMsg("SUCCESS! REDIRECTING...", "green");
                setTimeout(() => { window.location.href = 'dashboard.html'; }, 1500);
            }
        }

        function showMsg(t, type) {
            const m = document.getElementById('msg');
            m.innerText = t.toUpperCase();
            m.className = `p-4 mb-5 rounded border text-sm font-black text-center uppercase block ${type === 'red' ? 'bg-red-900/20 text-red-500 border-red-500/30' : 'bg-green-900/20 text-green-500 border-green-500/30'}`;
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.add('hidden'); }, 4000);
        }
    </script>
</body>
</html>
