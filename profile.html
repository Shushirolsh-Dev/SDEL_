<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel | Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        /* REMOVED html { opacity: 0; } to prevent blank white screen */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #000; color: white; overflow-x: hidden; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-zinc { background: rgba(18, 18, 18, 0.7); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); position: relative; z-index: 10; }
        
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 250; pointer-events: none; }
        .star { position: absolute; background-color: rgba(255,255,255,0.6); border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }

        .modal-overlay { backdrop-filter: blur(25px); z-index: 200; position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; padding: 24px; overflow-y: auto; }
        .input-zinc { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; width: 100%; padding: 16px; border-radius: 16px; font-size: 14px; outline: none; }
        .input-zinc:focus { border-color: #FF6600; }

        .spinner { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24">

    <div class="stars" id="stars"></div>

    <nav class="p-6 flex items-center justify-between sticky top-0 bg-black/90 backdrop-blur-md z-50">
        <a href="dashboard.html" class="text-white"><i data-lucide="chevron-left"></i></a>
        <h1 class="text-lg font-black uppercase tracking-tighter">My <span class="text-sdel">Account</span></h1>
        <button id="logout-btn-top" class="text-gray-500"><i data-lucide="log-out" size="20"></i></button>
    </nav>

    <main class="p-6 space-y-8">
        <div class="flex flex-col items-center text-center space-y-4">
            <div id="p-initials" class="w-24 h-24 rounded-full bg-zinc-900 border-4 border-zinc-800 flex items-center justify-center text-3xl font-black text-sdel uppercase">--</div>
            <div>
                <h2 id="p-full-name" class="text-2xl font-black uppercase tracking-tight italic text-white">Loading...</h2>
                <p id="p-email" class="text-gray-500 text-xs font-bold uppercase tracking-widest">---</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="card-zinc p-5 rounded-3xl text-center">
                <p class="text-[9px] font-black uppercase text-gray-500 mb-1">Balance</p>
                <p id="p-balance" class="text-xl font-black italic">₦0</p>
            </div>
            <div class="card-zinc p-5 rounded-3xl text-center">
                <p class="text-[9px] font-black uppercase text-gray-500 mb-1">Status</p>
                <p class="text-xl font-black italic text-green-500">Active</p>
            </div>
        </div>

        <div class="space-y-3">
            <h3 class="text-[10px] font-black uppercase text-gray-500 tracking-widest px-2">Settings</h3>
            
            <div onclick="openModal('edit-modal')" class="card-zinc p-4 rounded-3xl flex items-center justify-between cursor-pointer">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-zinc-900 rounded-full flex items-center justify-center text-sdel"><i data-lucide="user" size="18"></i></div>
                    <span class="text-sm font-bold uppercase">Personal Info</span>
                </div>
                <i data-lucide="chevron-right" class="text-gray-600"></i>
            </div>

            <div onclick="openModal('security-modal')" class="card-zinc p-4 rounded-3xl flex items-center justify-between cursor-pointer">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-zinc-900 rounded-full flex items-center justify-center text-blue-500"><i data-lucide="shield-check" size="18"></i></div>
                    <span class="text-sm font-bold uppercase">Security</span>
                </div>
                <i data-lucide="chevron-right" class="text-gray-600"></i>
            </div>
        </div>

        <button id="logout-btn" class="w-full bg-zinc-900 text-red-500 py-4 rounded-3xl font-black uppercase text-[10px] tracking-widest border border-red-500/20">Sign Out</button>
    </main>

    <div id="edit-modal" class="modal-overlay">
        <div class="flex justify-between items-center mb-8 relative z-10">
            <h2 class="text-xl font-black uppercase italic">Edit <span class="text-sdel">Profile</span></h2>
            <button onclick="closeModal('edit-modal')" class="text-white"><i data-lucide="x"></i></button>
        </div>
        <div class="space-y-4 relative z-10">
            <input id="edit-fname" type="text" class="input-zinc" placeholder="First Name">
            <input id="edit-lname" type="text" class="input-zinc" placeholder="Last Name">
            <input id="edit-phone" type="text" class="input-zinc" placeholder="Phone Number">
            <button onclick="saveProfileUpdates()" id="save-btn" class="w-full bg-sdel text-black py-4 rounded-2xl font-black uppercase text-xs tracking-widest flex items-center justify-center">
                <span id="save-text">Save Changes</span>
            </button>
        </div>
    </div>

    <div id="security-modal" class="modal-overlay">
        <div class="flex justify-between items-center mb-8 relative z-10">
            <h2 class="text-xl font-black uppercase italic">Update <span class="text-sdel">Security</span></h2>
            <button onclick="closeModal('security-modal')" class="text-white"><i data-lucide="x"></i></button>
        </div>
        <div class="space-y-4 relative z-10">
            <input id="new-pass" type="password" class="input-zinc" placeholder="New Password">
            <input id="confirm-pass" type="password" class="input-zinc" placeholder="Confirm New Password">
            <p id="pass-msg" class="text-[10px] font-bold uppercase text-center"></p>
            <button onclick="updatePassword()" id="pass-btn" class="w-full bg-sdel text-black py-4 rounded-2xl font-black uppercase text-xs tracking-widest">
                <span id="pass-text">Update Password</span>
            </button>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-black/90 backdrop-blur-xl border-t border-white/10 p-4 flex justify-around items-center z-50">
        <a href="dashboard.html" class="text-gray-500"><i data-lucide="home"></i></a>
        <a href="products.html" class="text-gray-500"><i data-lucide="grid"></i></a>
        <a href="#" class="text-gray-500"><i data-lucide="search"></i></a>
        <a href="#" class="text-sdel"><i data-lucide="user"></i></a>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let currentUser = null;

        async function checkSession() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (!session || error) { 
                window.location.replace('login.html'); 
            } else { 
                currentUser = session.user;
                loadProfile(); 
            }
        }

        async function loadProfile() {
            const { data: profile, error } = await supabase.from('profile').select('*').eq('id', currentUser.id).single();
            if (error) return;

            const fn = profile?.first_name || "";
            const ln = profile?.last_name || "";
            const un = profile?.username || "User";

            // Update UI
            document.getElementById('p-full-name').innerText = (fn || ln) ? `${fn} ${ln}`.trim() : un;
            document.getElementById('p-email').innerText = currentUser.email;
            document.getElementById('p-balance').innerText = `₦${(profile?.wallet_balance || 0).toLocaleString()}`;
            
            // Update Initials
            const i1 = fn ? fn[0] : un[0];
            const i2 = ln ? ln[0] : "";
            document.getElementById('p-initials').innerText = (i1 + i2).toUpperCase();
            
            // PRE-FILL INPUTS (Your correction)
            document.getElementById('edit-fname').value = fn;
            document.getElementById('edit-lname').value = ln;
            document.getElementById('edit-phone').value = profile?.phone || "";
        }

        window.openModal = (id) => document.getElementById(id).style.display = 'block';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        window.saveProfileUpdates = async () => {
            const text = document.getElementById('save-text');
            text.innerHTML = '<i data-lucide="loader-2" class="spinner"></i>';
            lucide.createIcons();
            
            const { error } = await supabase.from('profile').update({
                first_name: document.getElementById('edit-fname').value,
                last_name: document.getElementById('edit-lname').value,
                phone: document.getElementById('edit-phone').value
            }).eq('id', currentUser.id);

            if (error) { alert(error.message); text.innerText = "Save Changes"; }
            else { location.reload(); }
        };

        window.updatePassword = async () => {
            const p = document.getElementById('new-pass').value;
            const cp = document.getElementById('confirm-pass').value;
            if (p !== cp) { alert("Passwords match error"); return; }
            const { error } = await supabase.auth.updateUser({ password: p });
            if (error) alert(error.message); else alert("Updated!");
        }

        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = star.style.height = (Math.random() * 2 + 1) + 'px';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100
        
