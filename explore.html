<!DOCTYPE html><html lang="en"><head><script>(function(){const savedTheme=localStorage.getItem('theme');if(savedTheme==='sunlight'){document.documentElement.classList.add('sunlight-mode')}})();</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><title>Sdel|Explore</title><script src="https://cdn.tailwindcss.com"></script><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet"><script src="https://unpkg.com/lucide@latest"></script><style>html,body{user-select:none;-webkit-user-select:none}*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;-webkit-tap-highlight-color:transparent}body{background-color:#000;color:#fff;overflow-x:hidden;transition:background-color .3s}.text-sdel{color:#FF6600}.bg-sdel{background-color:#FF6600}.post-card{background:rgba(15,15,15,.4);border-bottom:1px solid rgba(255,255,255,.08);transition:background .2s}.post-card:active{background:rgba(255,102,0,.05)}.tab-btn{transition:all .3s ease;border-bottom:3px solid transparent;opacity:.5;font-weight:900;text-transform:uppercase;font-size:10px;letter-spacing:.1em}.tab-active{color:#FF6600;border-bottom:3px solid #FF6600;opacity:1}#post-input{resize:none;background:transparent;border:none;outline:0;width:100%;color:#fff;font-size:15px;transition:min-height .2s}.composer-expanded{background:rgba(255,102,0,.05)!important;border:1px solid rgba(255,102,0,.2)!important;border-radius:16px;padding:16px!important}#mention-list{position:absolute;background:#0a0a0a;border:1px solid #222;border-radius:16px;width:220px;z-index:5000;display:none;box-shadow:0 15px 40px rgba(0,0,0,.6);overflow:hidden}.mention-item{padding:14px 18px;border-bottom:1px solid #1a1a1a;font-size:12px;font-weight:800;text-transform:uppercase;cursor:pointer;transition:.2s;color:#fff}.mention-item:hover{background:#FF6600;color:#000}.sunlight-mode body{background-color:#fff;color:#121212}.sunlight-mode nav,.sunlight-mode .sticky{background-color:rgba(255,255,255,.95)!important;border-color:#f0f0f0!important}.sunlight-mode .fixed.bottom-0{background-color:rgba(255,255,255,.9)!important;border-color:#e4e4e7!important}.sunlight-mode .post-card{background:#fff;border-color:#f0f0f0}.sunlight-mode .post-card:active{background:#f9f9f9}.sunlight-mode #post-input{color:#121212}.sunlight-mode .text-zinc-200{color:#27272a!important}.sunlight-mode .text-zinc-500{color:#71717a!important}.sunlight-mode #mention-list{background:#fff;border-color:#eee;box-shadow:0 10px 30px rgba(0,0,0,.1)}.sunlight-mode .mention-item{color:#121212;border-color:#f5f5f5}.sunlight-mode .composer-expanded{background:#fff7f2!important;border-color:#ffd6ba!important}.sunlight-mode .modal-content{background:#fff;border-color:#eee;color:#121212}.sunlight-mode .bg-zinc-900{background-color:#f4f4f5}.sunlight-mode .action-sheet{background:#fff;border-color:#eee}.sunlight-mode .search-container{background:#f4f4f5;border-color:#e4e4e7}.sunlight-mode .search-container input{color:#121212;background:#f4f4f5}.sunlight-mode .search-container input::placeholder{color:#71717a}.sunlight-mode .text-white{color:#121212}.sunlight-mode .text-white\/60{color:#71717a}.sunlight-mode .text-sdel{color:#FF6600}#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:#FF6600;color:#000;padding:12px 24px;border-radius:12px;font-weight:900;font-size:12px;text-transform:uppercase;transition:transform .4s cubic-bezier(.175,.885,.32,1.275);z-index:9999}#toast.show{transform:translateX(-50%) translateY(0)}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(12px);padding:20px}.modal-content{background:#111;width:100%;max-width:400px;border-radius:28px;padding:30px;border:1px solid #222;text-align:center}.inline-link{color:#FF6600;font-weight:600;cursor:pointer;display:inline;background:0 0;border:none;padding:0;margin:0;font-size:inherit;text-decoration:none}.inline-link:hover{text-decoration:underline}.action-sheet{position:fixed;bottom:0;left:0;right:0;background:#0a0a0a;border-top:1px solid #222;border-radius:24px 24px 0 0;padding:20px;z-index:3000;transform:translateY(100%);transition:transform .3s ease}.action-sheet.open{transform:translateY(0)}.search-container{margin:8px 16px;padding:8px 12px;background:#111;border:1px solid #222;border-radius:12px;display:none;align-items:center;gap:8px}.search-container input{flex:1;background:transparent;border:none;outline:0;color:#fff;font-size:13px;font-weight:500}.search-container input::placeholder{color:#555;font-weight:400}.search-container .close-search{color:#FF6600;cursor:pointer}#search-results{position:absolute;top:100%;left:0;right:0;background:#000;z-index:90;max-height:300px;overflow-y:auto;display:none;border-bottom:1px solid rgba(255,255,255,.1)}.sunlight-mode #search-results{background:#fff;border-color:#eee}.link-warning{color:#FF6600;font-size:11px;font-weight:800;margin-top:4px}#post-modal{display:none}.post-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:2000;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(20px)}.post-modal-content{background:#111;width:100%;max-width:600px;border-radius:32px 32px 0 0;padding:24px;border:1px solid #222;border-bottom:none;animation:slideUp .3s ease}.sunlight-mode .post-modal-content{background:#fff;border-color:#eee}@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}#modal-post-input{width:100%;background:#000;border:1px solid #333;border-radius:20px;color:#fff;padding:20px;font-size:18px;margin:20px 0;resize:none;outline:0;min-height:200px}.sunlight-mode #modal-post-input{background:#f4f4f5;color:#121212;border-color:#e4e4e7}.post-modal-footer{position:sticky;bottom:0;background:#111;padding:16px 0 0;border-top:1px solid #222;margin-top:16px}.sunlight-mode .post-modal-footer{background:#fff;border-color:#eee}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.modal-close{font-size:28px;cursor:pointer;color:#FF6600}.skeleton-card{background:rgba(15,15,15,.4);border-bottom:1px solid rgba(255,255,255,.08);padding:16px;animation:pulse 1.5s ease-in-out infinite}.sunlight-mode .skeleton-card{background:#f0f0f0;border-color:#e0e0e0}.skeleton-avatar{width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.1)}.sunlight-mode .skeleton-avatar{background:#ddd}.skeleton-line{height:16px;background:rgba(255,255,255,.1);border-radius:8px;margin-bottom:8px}.sunlight-mode .skeleton-line{background:#ddd}.skeleton-line.short{width:60%}.skeleton-line.medium{width:80%}.skeleton-line.long{width:100%}.skeleton-actions{display:flex;gap:24px;margin-top:16px}.skeleton-action{width:24px;height:24px;background:rgba(255,255,255,.1);border-radius:4px}.sunlight-mode .skeleton-action{background:#ddd}@keyframes pulse{0%,100%{opacity:.7}50%{opacity:.4}}nav,.fixed.bottom-0{visibility:visible!important}</style></head><body class="pb-32" ontouchstart="closeActionSheetOnTouch(event)"><div id="toast">Gist Published!</div><div id="mention-list"></div><div id="post-modal" class="post-modal-overlay" onclick="closePostModal()"><div class="post-modal-content" onclick="event.stopPropagation()"><div class="modal-header"><h3 id="post-modal-title" class="text-xl font-black uppercase text-sdel">Create Gist</h3><span class="modal-close" onclick="closePostModal()">✕</span></div><textarea id="modal-post-input" placeholder="What's happening, homie?" rows="6" maxlength="500"></textarea><div class="post-modal-footer"><div class="flex gap-3"><button onclick="closePostModal()" class="flex-1 py-4 bg-zinc-900 rounded-2xl font-bold uppercase text-sm">Cancel</button><button id="modal-post-btn" onclick="submitPostFromModal()" class="flex-1 py-4 bg-sdel text-black rounded-2xl font-black uppercase text-sm">Post</button></div></div></div></div><div id="security-modal" class="modal-overlay"><div class="modal-content border-red-900/50"><i data-lucide="shield-alert" class="text-red-600 mx-auto mb-4" size="48"></i><h3 class="text-red-500 font-black uppercase mb-2">Security Warning</h3><p id="security-msg" class="text-xs text-zinc-400 font-bold leading-relaxed mb-6 uppercase">Unauthorized script detected. Your account status has been updated.</p><button onclick="document.getElementById('security-modal').style.display='none'" class="w-full py-4 bg-zinc-900 rounded-2xl font-black text-xs uppercase">I Understand</button></div></div><div id="action-sheet" class="action-sheet"><div class="w-12 h-1.5 bg-zinc-800 rounded-full mx-auto mb-6"></div><div id="action-options" class="space-y-3"></div><button onclick="closeActions()" class="w-full mt-4 py-4 text-zinc-500 font-black uppercase text-xs">Cancel</button></div><div id="redirect-modal" class="modal-overlay"><div class="modal-content"><h3 class="text-lg font-black uppercase mb-2">⚠️ Leaving Sdel</h3><div id="raw-link-display" class="bg-black p-4 rounded-xl border border-zinc-800 text-sdel text-[10px] break-all mb-4 font-bold"></div><p class="text-[9px] text-red-500 font-black uppercase mb-2">This link leads to an external website.</p><p class="text-[9px] text-zinc-500 font-bold uppercase mb-6">Sdel is not responsible for external content.</p><div class="flex gap-3"><button onclick="closeRedirect()" class="flex-1 py-4 bg-zinc-900 rounded-2xl font-bold uppercase text-xs">Abort</button><button id="confirm-redirect-btn" class="flex-1 py-4 bg-sdel text-black rounded-2xl font-black uppercase text-xs">Proceed</button></div></div></div><nav class="sticky top-0 bg-black/90 backdrop-blur-xl z-[100] border-b border-white/5 pt-env(safe-area-inset-top)"><div class="p-6 pb-2 flex items-center justify-between"><h1 class="text-2xl font-black tracking-tighter uppercase">S<span class="text-sdel">del</span> Explore</h1><div class="flex items-center space-x-5"><i data-lucide="search" size="22" onclick="toggleSearch()" style="cursor:pointer"></i><i data-lucide="bell" size="22" onclick="location.href='messages.html'" style="cursor:pointer"></i><i data-lucide="message-square" size="22" onclick="location.href='homies.html'" style="cursor:pointer"></i></div></div><div id="search-container" class="search-container"><i data-lucide="search" size="16" class="text-zinc-500"></i><input type="text" id="search-input" placeholder="Search by name or @username..." oninput="handleSearch(this.value)"><i data-lucide="x" size="16" class="close-search" onclick="toggleSearch()"></i></div><div id="search-results"></div><div class="flex justify-around mt-2"><button id="tab-campus" onclick="switchTab('campus')" class="tab-btn tab-active px-6 py-4">The Campus</button><button id="tab-universe" onclick="switchTab('universe')" class="tab-btn px-6 py-4">Universe</button></div></nav><div id="composer-card" class="m-4 p-4 border border-white/5 flex flex-col relative transition-all"><div class="flex space-x-3"><div id="my-avatar" class="w-10 h-10 rounded-full bg-zinc-900 flex-shrink-0 flex items-center justify-center font-bold text-xs border border-white/10 uppercase text-sdel">H</div><div class="flex-1"><textarea id="post-input" placeholder="What's happening, homie?" rows="1" oninput="toggleActions(this)"></textarea><div id="composer-actions" class="mt-3 flex justify-between items-center hidden"><span class="text-[10px] text-zinc-600 font-bold uppercase">Public Gist</span><button onclick="openPostModal()" class="bg-sdel text-black px-4 py-1.5 rounded-full text-[11px] font-black uppercase">Post</button></div></div></div></div><main id="feed-container"><div class="skeleton-card"><div class="flex space-x-3"><div class="skeleton-avatar"></div><div class="flex-1"><div class="skeleton-line short"></div><div class="skeleton-line medium mt-2"></div><div class="skeleton-line long"></div><div class="skeleton-actions"><div class="skeleton-action"></div><div class="skeleton-action"></div><div class="skeleton-action"></div></div></div></div></div><div class="skeleton-card"><div class="flex space-x-3"><div class="skeleton-avatar"></div><div class="flex-1"><div class="skeleton-line short"></div><div class="skeleton-line medium mt-2"></div><div class="skeleton-line long"></div><div class="skeleton-actions"><div class="skeleton-action"></div><div class="skeleton-action"></div><div class="skeleton-action"></div></div></div></div></div><div class="skeleton-card"><div class="flex space-x-3"><div class="skeleton-avatar"></div><div class="flex-1"><div class="skeleton-line short"></div><div class="skeleton-line medium mt-2"></div><div class="skeleton-line long"></div><div class="skeleton-actions"><div class="skeleton-action"></div><div class="skeleton-action"></div><div class="skeleton-action"></div></div></div></div></div></main><nav class="fixed bottom-0 inset-x-0 p-5 flex justify-around items-center bg-black/95 border-t border-white/10 z-[100]"><i data-lucide="home" class="text-white/60" size="28" onclick="location.href='dashboard.html'"></i><i data-lucide="compass" class="text-sdel" size="28" onclick="location.href='explore.html'"></i><div class="bg-sdel h-14 w-14 rounded-2xl flex items-center justify-center -mt-12 border-4 border-black" onclick="openPostModal()"><i data-lucide="plus" class="text-black" stroke-width="3" size="28"></i></div><i data-lucide="shopping-cart" class="text-white/60" size="28" onclick="location.href='market.html'"></i><i data-lucide="user" class="text-white/60" size="28" onclick="location.href='profile.html'"></i></nav><script type="module">import{createClient}from'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';const supabase=createClient('https://lgfyrlfjoazedwymjpfc.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');let userProfile=null;let currentMode='campus';let securityViolationCount=0;let pressTimer=null;let searchQuery='';let currentEditPostId=null;let repostedPosts=new Set();let mentionTimeout=null;Object.assign(window,{publishPost,switchTab,safeRedirect,closeRedirect,handleLike,toggleActions,toggleReadMore,handleShare,handleRepost,closeActions,burnGist,banUser,selectMention,toggleSearch,handleSearch,startPress,endPress,editGist,openPostModal,closePostModal,submitPostFromModal});function formatNum(num){if(!num)return 0;if(num>=1e9)return(num/1e9).toFixed(1)+'B';if(num>=1e6)return(num/1e6).toFixed(1)+'M';if(num>=1e3)return(num/1e3).toFixed(1)+'K';return num}async function init(){const{data:{session}}=await supabase.auth.getSession();if(!session)return window.location.replace('login.html');const{data:profile}=await supabase.from('profile').select('*').eq('id',session.user.id).single();userProfile=profile;if(userProfile?.is_banned||userProfile?.banned)location.replace('banned.html');document.getElementById('my-avatar').innerText=userProfile?.username?.charAt(0)||'H';const{data:myReposts}=await supabase.from('interactions').select('post_id').eq('user_id',userProfile.id).eq('interaction_type','repost');if(myReposts){repostedPosts=new Set(myReposts.map(r=>r.post_id))}loadFeed()}function closeActionSheetOnTouch(event){const sheet=document.getElementById('action-sheet');if(sheet.classList.contains('open')&&!event.target.closest('.action-sheet')){closeActions()}}async function handleSearch(val){searchQuery=val.toLowerCase();const resultsDiv=document.getElementById('search-results');if(searchQuery.length>1){const{data:users}=await supabase.from('profile').select('username, first_name, last_name, is_verified').or(`username.ilike.%${searchQuery}%,first_name.ilike.%${searchQuery}%,last_name.ilike.%${searchQuery}%`).limit(5);if(users?.length>0){resultsDiv.innerHTML=users.map(u=>{const fullName=[u.first_name,u.last_name].filter(Boolean).join(' ')||u.username;return `<div class="p-4 border-b border-white/5 flex items-center justify-between" onclick="location.href='profile.html?u=${u.username}'"><div><span class="text-xs font-black uppercase block">@${u.username}</span><span class="text-[10px] text-zinc-500">${fullName}</span></div><i data-lucide="chevron-right" size="14" class="text-zinc-600"></i></div>`}).join('');resultsDiv.style.display='block';lucide.createIcons()}else{resultsDiv.style.display='none'}}else{resultsDiv.style.display='none'}loadFeed()}function toggleSearch(){const container=document.getElementById('search-container');const results=document.getElementById('search-results');container.style.display=container.style.display==='none'?'flex':'none';if(container.style.display==='flex'){document.getElementById('search-input').focus()}else{searchQuery='';results.style.display='none';loadFeed()}lucide.createIcons()}function startPress(e,post){pressTimer=setTimeout(()=>{showActionSheet(post)},800)}function endPress(){clearTimeout(pressTimer)}async function handleMentions(input){const text=input.value;const cursor=input.selectionStart;const lastAt=text.lastIndexOf('@',cursor-1);const mentionList=document.getElementById('mention-list');if(mentionTimeout)clearTimeout(mentionTimeout);if(lastAt===-1||text.slice(lastAt,cursor).includes(' ')){mentionList.style.display='none';return}const query=text.slice(lastAt+1,cursor);if(query.length===0){mentionList.style.display='none';return}mentionTimeout=setTimeout(async()=>{try{const{data:users}=await supabase.from('profile').select('username, first_name, last_name').ilike('username',`${query}%`).limit(5);if(users&&users.length>0){mentionList.innerHTML=users.map(u=>{const displayName=[u.first_name,u.last_name].filter(Boolean).join(' ');return `<div class="mention-item" onclick="selectMention('${u.username}',${lastAt},${cursor})"><span class="font-black">@${u.username}</span>${displayName?`<span class="text-[9px] text-zinc-400 block">${displayName}</span>`:''}</div>`}).join('');const rect=input.getBoundingClientRect();mentionList.style.top=(rect.bottom+window.scrollY+5)+'px';mentionList.style.left=rect.left+'px';mentionList.style.display='block'}else{mentionList.style.display='none'}}catch(error){console.error("Mention search error:",error);mentionList.style.display='none'}},300)}function selectMention(name,start,end){const input=document.getElementById('post-input');const text=input.value;input.value=text.slice(0,start)+'@'+name+' '+text.slice(end);document.getElementById('mention-list').style.display='none';input.focus();input.dispatchEvent(new Event('input'))}function showActionSheet(post){const sheet=document.getElementById('action-sheet');const options=document.getElementById('action-options');const isOwner=post.user_id===userProfile.id;const canEdit=isOwner&&(new Date()-new Date(post.created_at)<15*60*1000);let html='';if(isOwner){html+=`<button onclick="burnGist('${post.id}')" class="w-full py-4 bg-red-950/30 text-red-500 rounded-2xl font-black uppercase text-xs flex items-center justify-center gap-2"><i data-lucide="flame" size="16"></i> Burn Gist</button>`;if(canEdit)html+=`<button onclick="editGist('${post.id}', \`${post.content.replace(/`/g,'\\`')}\`)" class="w-full py-4 bg-zinc-900 text-white rounded-2xl font-black uppercase text-xs">Edit Gist</button>`}if(userProfile?.is_official&&!isOwner){html+=`<button onclick="banUser('${post.user_id}')" class="w-full py-4 bg-red-600 text-black rounded-2xl font-black uppercase text-xs">Ban User</button>`}options.innerHTML=html||'<p class="text-zinc-500 text-xs font-bold uppercase text-center">No actions available</p>';sheet.classList.add('open');lucide.createIcons()}function closeActions(){document.getElementById('action-sheet').classList.remove('open')}async function burnGist(id){const{error}=await supabase.from('posts').delete().eq('id',id);if(!error){showToast("Gist Burned!");loadFeed();closeActions()}}async function banUser(userId){await supabase.from('profile').update({is_banned:true,banned:true}).eq('id',userId);showToast("User Banned!");closeActions()}function editGist(id,content){currentEditPostId=id;document.getElementById('post-modal-title').innerText='Edit Gist';document.getElementById('modal-post-input').value=content;document.getElementById('modal-post-btn').innerText='Update';openPostModal();closeActions()}function openPostModal(){if(!currentEditPostId){document.getElementById('post-modal-title').innerText='Create Gist';document.getElementById('modal-post-input').value=document.getElementById('post-input').value;document.getElementById('modal-post-btn').innerText='Post'}document.getElementById('post-modal').style.display='flex';document.getElementById('modal-post-input').focus()}function closePostModal(){document.getElementById('post-modal').style.display='none';currentEditPostId=null}const harmfulPatterns=[/porn/i,/xxx/i,/adult/i,/sex/i,/nude/i,/onlyfans/i,/fansly/i,/gambling/i,/casino/i,/bet/i,/betting/i,/poker/i,/slot/i,/crypto/i,/bitcoin/i,/eth/i,/investment/i,/forex/i,/drug/i,/weed/i,/cannabis/i,/marijuana/i,/cocaine/i,/hack/i,/cheat/i,/exploit/i,/crack/i,/keygen/i,/violence/i,/gore/i,/kill/i,/death/i,/pharmacy/i,/viagra/i,/cialis/i,/prescription/i];function scanContentForHarmfulLinks(content){const urlRegex=/(https?:\/\/[^\s<>"']+)|(www\.[^\s<>"']+\.[^\s<>"']+)|([a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}[^\s<>"']*)/gi;const urls=content.match(urlRegex)||[];if(urls.length>5)return{safe:false,reason:"Too many links (max 5)"};for(const url of urls){const lowerUrl=url.toLowerCase();for(const pattern of harmfulPatterns){if(pattern.test(lowerUrl))return{safe:false,reason:"Harmful content detected",url}}}return{safe:true}}function cleanHarmfulContent(content){const urlRegex=/(https?:\/\/[^\s<>"']+)|(www\.[^\s<>"']+\.[^\s<>"']+)|([a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}[^\s<>"']*)/gi;return content.replace(urlRegex,(url)=>{const lowerUrl=url.toLowerCase();for(const pattern of harmfulPatterns){if(pattern.test(lowerUrl))return"[Link Unavailable]"}return url})}async function submitPostFromModal(){let content=document.getElementById('modal-post-input').value.trim();if(!content)return;const scanResult=scanContentForHarmfulLinks(content);if(!scanResult.safe){if(scanResult.reason==="Too many links (max 5)"){showToast("Maximum 5 links allowed per post!");return}else{content=cleanHarmfulContent(content);showToast("Some links were removed for safety")}}if(/<[^>]*>|javascript:|onerror|onload|eval|alert|document\.|window\.|fetch|XMLHttpRequest|onclick|onmouseover|onfocus|onblur|onchange|onsubmit|onreset|onselect|onkeydown|onkeypress|onkeyup/i.test(content)){document.getElementById('modal-post-input').value='';securityViolationCount++;if(securityViolationCount>=3){await supabase.from('profile').update({is_banned:true,banned:true}).eq('id',userProfile.id);location.replace('banned.html')}else{closePostModal();document.getElementById('security-modal').style.display='flex';setTimeout(()=>location.reload(),3000)}return}if(currentEditPostId){const{error}=await supabase.from('posts').update({content}).eq('id',currentEditPostId);if(!error){showToast("Gist Updated!");closePostModal();loadFeed()}else{console.error("Edit error:",error);showToast("Error updating post")}}else{const{error}=await supabase.from('posts').insert({user_id:userProfile.id,content,school_name:userProfile.school_name||'Global',post_type:'post',likes_count:0,comments_count:0,reposts_count:0,shares_count:0});if(!error){showToast("Gist Published!");document.getElementById('post-input').value='';toggleActions(document.getElementById('post-input'));closePostModal();loadFeed()}else{console.error("Insert error:",error);showToast("Error: "+error.message)}}}async function publishPost(){openPostModal()}function escapeHTML(str){const div=document.createElement('div');div.textContent=str;return div.innerHTML}async function formatContent(text,postId){let safe=text;safe=escapeHTML(safe);if(safe.length>280){safe=`<span id="short-${postId}">${safe.substring(0,250)}... <button onclick="toggleReadMore('${postId}')" class="text-sdel font-bold uppercase text-[10px]">Read More</button></span><span id="full-${postId}" class="hidden">${safe}</span>`}const repostMatches=[...safe.matchAll(/Reposted from @(\w+):/g)];for(const match of repostMatches){const username=match[1];const{data:user}=await supabase.from('profile').select('username').eq('username',username).maybeSingle();if(user){safe=safe.replace(`Reposted from @${username}:`,`Reposted from <a href="profile.html?u=${username}" class="text-sdel font-bold no-underline hover:underline">@${username}</a>:`)}}const mentionMatches=[...safe.matchAll(/@(\w+)/g)];for(const match of mentionMatches){const username=match[1];if(safe.includes(`Reposted from <a`))continue;const{data:user}=await supabase.from('profile').select('username').eq('username',username).maybeSingle();if(user){safe=safe.replace(new RegExp(`@${username}\\b`),`<a href="profile.html?u=${username}" class="text-sdel font-bold no-underline hover:underline">@${username}</a>`)}}const urlRegex=/(https?:\/\/[^\s<>"']+)|(www\.[^\s<>"']+\.[^\s<>"']+)|([a-zA-Z0-9][a-zA-Z0-9-]*\.[a-zA-Z]{2,}[^\s<>"']*)/gi;safe=safe.replace(urlRegex,(url)=>{if(url.includes('">')||url.includes('&quot;')||url.includes('profile.html'))return url;if(url.includes('@'))return url;let fullUrl=url;if(!fullUrl.startsWith('http')){fullUrl='https://'+fullUrl}const escapedUrl=escapeHTML(fullUrl);const displayUrl=url.length>50?url.substring(0,50)+'...':url;if(fullUrl.includes('profile.html')||fullUrl.includes('messages.html')||fullUrl.includes('homies.html')||fullUrl.includes('gist.html')||fullUrl.includes('dashboard.html')||fullUrl.includes('market.html')||fullUrl.includes('explore.html')){return `<a href="${escapedUrl.replace(/'/g,"\\'")}" class="inline-link">${displayUrl}</a>`}if(fullUrl.includes('tiktok.com')||fullUrl.includes('whatsapp.com')||fullUrl.includes('wa.me')||fullUrl.includes('thesdel.com')){return `<a href="${escapedUrl.replace(/'/g,"\\'")}" target="_blank" class="inline-link">${displayUrl}</a>`}return `<a href="#" onclick="event.stopPropagation(); safeRedirect('${escapedUrl.replace(/'/g,"\\'")}'); return false;" class="inline-link">${displayUrl}</a>`});return safe}async function loadFeed(){const container=document.getElementById('feed-container');container.innerHTML=`<div class="skeleton-card"><div class="flex space-x-3"><div class="skeleton-avatar"></div><div class="flex-1"><div class="skeleton-line short"></div><div class="skeleton-line medium mt-2"></div><div class="skeleton-line long"></div><div class="skeleton-actions"><div class="skeleton-action"></div><div class="skeleton-action"></div><div class="skeleton-action"></div></div></div></div></div><div class="skeleton-card"><div class="flex space-x-3"><div class="skeleton-avatar"></div><div class="flex-1"><div class="skeleton-line short"></div><div class="skeleton-line medium mt-2"></div><div class="skeleton-line long"></div><div class="skeleton-actions"><div class="skeleton-action"></div><div class="skeleton-action"></div><div class="skeleton-action"></div></div></div></div></div><div class="skeleton-card"><div class="flex space-x-3"><div class="skeleton-avatar"></div><div class="flex-1"><div class="skeleton-line short"></div><div class="skeleton-line medium mt-2"></div><div class="skeleton-line long"></div><div class="skeleton-actions"><div class="skeleton-action"></div><div class="skeleton-action"></div><div class="skeleton-action"></div></div></div></div></div>`;let query=supabase.from('posts').select('*, profile:user_id(username, is_official, is_verified)').eq('post_type','post').order('created_at',{ascending:false}).limit(40);if(currentMode==='campus'){query=query.eq('school_name',userProfile.school_name)}const{data:posts}=await query;const{data:myLikes}=await supabase.from('interactions').select('post_id').eq('user_id',userProfile.id).eq('interaction_type','like');let filteredPosts=posts||[];if(searchQuery){filteredPosts=posts.filter(post=>post.content.toLowerCase().includes(searchQuery)||post.profile?.username?.toLowerCase().includes(searchQuery))}if(filteredPosts.length===0){container.innerHTML='<div class="text-center py-20 text-zinc-500 font-bold uppercase">No posts yet</div>';return}const processedPosts=await Promise.all(filteredPosts.map(async(post)=>{const formattedContent=await formatContent(post.content,post.id);return{...post,formattedContent}}));container.innerHTML=processedPosts.map(post=>{const username=post.profile?.username||'homie';const isLiked=myLikes?.some(l=>l.post_id===post.id);const hasReposted=repostedPosts.has(post.id);let badge=post.profile?.is_official?`<div class="bg-sdel rounded-full p-[2px] w-[14px] h-[14px] flex items-center justify-center"><i data-lucide="check" class="text-white" size="10" stroke-width="4"></i></div>`:(post.profile?.is_verified?`<div class="bg-zinc-500 rounded-full p-[2px] w-[14px] h-[14px] flex items-center justify-center"><i data-lucide="check" class="text-white" size="10" stroke-width="4"></i></div>`:'');return `<div class="post-card p-4" data-post-id="${post.id}" onmousedown="startPress(event,${JSON.stringify(post).replace(/"/g,'&quot;')})" onmouseup="endPress()" ontouchstart="startPress(event,${JSON.stringify(post).replace(/"/g,'&quot;')})" ontouchend="endPress()"><div class="flex space-x-3"><div onclick="location.href='profile.html?u=${escapeHTML(username)}'" class="w-11 h-11 rounded-full bg-zinc-900 flex-shrink-0 flex items-center justify-center font-black text-sdel text-sm border border-white/10 uppercase cursor-pointer">${escapeHTML(username[0])}</div><div class="flex-1"><div class="flex items-center gap-1.5 mb-1"><span onclick="location.href='profile.html?u=${escapeHTML(username)}'" class="text-[14px] font-black uppercase tracking-tighter cursor-pointer">@${escapeHTML(username)}</span>${badge}${currentMode==='universe'?`<span class="ml-auto text-[9px] text-zinc-500 font-bold uppercase">${escapeHTML(post.school_name||'')}</span>`:''}</div><div class="text-[14px] text-zinc-200 leading-snug break-words mb-3">${post.formattedContent}</div><div class="flex items-center justify-between mt-4 text-zinc-500 pr-4"><button onclick="handleLike('${post.id}')" class="flex items-center gap-2 ${isLiked?'text-sdel':''}"><i data-lucide="heart" size="18" fill="${isLiked?'#FF6600':'none'}"></i><span class="text-xs font-bold">${formatNum(post.likes_count||0)}</span></button><button onclick="location.href='gist.html?id=${post.id}'" class="flex items-center gap-2"><i data-lucide="message-circle" size="18"></i><span class="text-xs font-bold">${formatNum(post.comments_count||0)}</span></button><button onclick="handleRepost('${post.id}','${escapeHTML(username)}',\`${escapeHTML(post.content)}\`)" class="flex items-center gap-2 ${hasReposted?'text-green-500 opacity-50':''}"><i data-lucide="repeat" size="18"></i><span class="text-xs font-bold">${formatNum(post.reposts_count||0)}</span></button><button onclick="handleShare('${post.id}',\`${escapeHTML(post.content)}\`)"><i data-lucide="upload" size="18"></i></button></div></div></div></div>`}).join('');lucide.createIcons()}async function handleLike(postId){const{data:existing}=await supabase.from('interactions').select('*').eq('user_id',userProfile.id).eq('post_id',postId).eq('interaction_type','like').single();if(existing){await supabase.from('interactions').delete().eq('id',existing.id);await supabase.rpc('decrement_stat',{post_id:postId,field:'likes_count'})}else{await supabase.from('interactions').insert({user_id:userProfile.id,post_id:postId,interaction_type:'like'});await supabase.rpc('increment_stat',{post_id:postId,field:'likes_count'})}loadFeed()}async function handleRepost(originalPostId,originalAuthor,originalContent){if(originalAuthor===userProfile.username){showToast("Cannot repost your own gist!");return}if(repostedPosts.has(originalPostId)){showToast("Already Reposted!");return}const{data:user}=await supabase.from('profile').select('username').eq('username',originalAuthor).maybeSingle();if(!user){showToast("User not found!");return}let contentToRepost=originalContent;if(contentToRepost.includes('Reposted from @')){const lastColonIndex=contentToRepost.lastIndexOf(':');if(lastColonIndex!==-1){contentToRepost=contentToRepost.substring(lastColonIndex+1).trim()}}const newContent=`Reposted from @${originalAuthor}: ${contentToRepost}`;const{error}=await supabase.from('posts').insert({user_id:userProfile.id,content:newContent,school_name:userProfile.school_name||'Global',post_type:'repost',likes_count:0,comments_count:0,reposts_count:0,shares_count:0});if(!error){await supabase.from('interactions').insert({user_id:userProfile.id,post_id:originalPostId,interaction_type:'repost'});repostedPosts.add(originalPostId);await supabase.rpc('increment_stat',{post_id:originalPostId,field:'reposts_count'});showToast("Reposted!");loadFeed()}}async function handleShare(postId,content){const url=`${window.location.origin}/gist.html?id=${postId}`;if(navigator.share)navigator.share({title:'Sdel',text:content,url});else{navigator.clipboard.writeText(url);showToast("Link copied!")}}function safeRedirect(url){if(url.includes('profile.html')||url.includes('messages.html')||url.includes('homies.html')||url.includes('gist.html')||url.includes('dashboard.html')||url.includes('market.html')||url.includes('explore.html')){location.href=url;return}document.getElementById('raw-link-display').innerText=url;document.getElementById('redirect-modal').style.display='flex';document.getElementById('confirm-redirect-btn').onclick=()=>{window.open(url,'_blank');closeRedirect()}}function closeRedirect(){document.getElementById('redirect-modal').style.display='none'}function switchTab(mode){currentMode=mode;document.getElementById('tab-campus').classList.toggle('tab-active',mode==='campus');document.getElementById('tab-universe').classList.toggle('tab-active',mode==='universe');loadFeed()}function toggleActions(el){const card=document.getElementById('composer-card');el.style.height='auto';el.style.height=el.scrollHeight+'px';card.classList.toggle('composer-expanded',el.value.length>50);document.getElementById('composer-actions').classList.toggle('hidden',el.value.length===0);handleMentions(el);setTimeout(()=>{el.scrollTop=el.scrollHeight},10)}function toggleReadMore(id){document.getElementById(`short-${id}`).classList.add('hidden');document.getElementById(`full-${id}`).classList.remove('hidden')}function showToast(msg){const t=document.getElementById('toast');t.innerText=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}init();</script></body></html>
