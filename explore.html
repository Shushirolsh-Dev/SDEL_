<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'sunlight') document.documentElement.classList.add('sunlight-mode');
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sdel | Explore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000; color: white; overflow-x: hidden; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .post-card { background: rgba(15, 15, 15, 0.4); border-bottom: 1px solid rgba(255,255,255,0.08); }
        #post-input { resize: none; background: transparent; border: none; outline: none; width: 100%; color: white; font-size: 15px; }
        .link-btn { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,102,0,0.1); color: #FF6600; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; margin: 5px 0; border: 1px solid rgba(255,102,0,0.2); }
        #mention-results { position: absolute; background: #111; border: 1px solid #222; border-radius: 12px; z-index: 2000; display: none; width: 220px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .mention-item { padding: 12px; font-size: 12px; border-bottom: 1px solid #222; cursor: pointer; }
        .sunlight-mode body { background-color: #fff; color: #121212; }
        .sunlight-mode .post-card { border-color: #f4f4f5; }
        .sunlight-mode #post-input { color: #121212; }
    </style>
</head>
<body class="pb-32">
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-sdel text-black px-6 py-3 rounded-full font-black text-xs uppercase hidden z-[9999]">Gist Published</div>
    <div id="mention-results"></div>

    <nav class="sticky top-0 bg-black/95 backdrop-blur-xl z-[100] border-b border-white/5 p-6">
        <h1 class="text-2xl font-black tracking-tighter uppercase">S<span class="text-sdel">del</span> Explore</h1>
        <div class="flex justify-around mt-4">
            <button id="tab-campus" onclick="switchTab('campus')" class="text-[10px] font-black uppercase tracking-widest text-sdel border-b-2 border-sdel pb-2">Campus</button>
            <button id="tab-universe" onclick="switchTab('universe')" class="text-[10px] font-black uppercase tracking-widest opacity-50 pb-2">Universe</button>
        </div>
    </nav>

    <div class="p-4 border-b border-white/5 flex space-x-3 relative">
        <div id="my-avatar" class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center font-bold text-sdel border border-white/10 uppercase">H</div>
        <div class="flex-1">
            <textarea id="post-input" placeholder="What's happening, homie?" rows="1" oninput="handleTyping(this)"></textarea>
            <div id="composer-actions" class="mt-3 flex justify-between items-center hidden">
                <span class="text-[9px] text-zinc-600 font-bold uppercase">Public Gist</span>
                <button onclick="publishPost()" class="bg-sdel text-black px-5 py-2 rounded-full text-[10px] font-black uppercase">Post</button>
            </div>
        </div>
    </div>

    <main id="feed-container" class="flex flex-col"></main>

    <nav class="fixed bottom-0 inset-x-0 p-5 flex justify-around items-center bg-black/95 border-t border-white/10 z-[100]">
        <i data-lucide="home" class="text-white/60" size="26" onclick="location.href='dashboard.html'"></i>
        <i data-lucide="compass" class="text-sdel" size="26"></i>
        <div class="bg-sdel h-14 w-14 rounded-2xl flex items-center justify-center -mt-12 shadow-2xl border-4 border-black" onclick="document.getElementById('post-input').focus()">
            <i data-lucide="plus" class="text-black" stroke-width="3" size="28"></i>
        </div>
        <i data-lucide="shopping-cart" class="text-white/60" size="26" onclick="location.href='market.html'"></i>
        <i data-lucide="user" class="text-white/60" size="26" onclick="location.href='profile.html'"></i>
    </nav>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { Aether } from './aether.js';

        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');
        let userProfile = null;
        let currentMode = 'campus';

        Object.assign(window, { switchTab, publishPost, handleTyping, insertMention, safeRedirect });

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return location.replace('login.html');
            const { data: profile } = await supabase.from('profile').select('*').eq('id', session.user.id).single();
            userProfile = profile;
            document.getElementById('my-avatar').innerText = profile.username[0];
            loadFeed();
        }

        async function loadFeed() {
            const container = document.getElementById('feed-container');
            const cutoff = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            
            let query = supabase.from('posts').select('*, profile:user_id(username, is_verified)').gte('created_at', cutoff).order('created_at', { ascending: false });
            if (currentMode === 'campus') query = query.eq('school_name', userProfile.school_name);
            
            const { data: posts } = await query;

            if (!posts || posts.length === 0) {
                container.innerHTML = Aether.getEmptyState();
            } else {
                container.innerHTML = posts.map(p => `
                    <div class="post-card p-4 flex space-x-3">
                        <div class="w-10 h-10 rounded-full bg-zinc-900 flex items-center justify-center font-bold text-sdel text-xs uppercase">${p.profile.username[0]}</div>
                        <div class="flex-1">
                            <span class="text-[13px] font-black uppercase">@${p.profile.username}</span>
                            <div class="text-[14px] text-zinc-200 mt-1">${Aether.formatLinks(p.content.replace(/@(\w+)/g, '<span class="text-sdel font-bold">@$1</span>'))}</div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        async function publishPost() {
            const raw = document.getElementById('post-input').value.trim();
            const result = Aether.scrub(raw);
            
            if (result.action === 'ban') {
                await supabase.from('profile').update({ is_banned: true }).eq('id', userProfile.id);
                return location.replace('banned.html');
            }

            const { error } = await supabase.from('posts').insert({ user_id: userProfile.id, content: result.content, school_name: userProfile.school_name });
            if (!error) {
                document.getElementById('post-input').value = '';
                loadFeed();
                showToast("Gist Published");
            }
        }

        function handleTyping(el) {
            document.getElementById('composer-actions').classList.toggle('hidden', el.value.length === 0);
            const last = el.value.split(' ').pop();
            const drop = document.getElementById('mention-results');
            if (last.startsWith('@') && last.length > 1) {
                supabase.from('profile').select('username').ilike('username', `${last.slice(1)}%`).limit(5).then(({data}) => {
                    if (data?.length) {
                        drop.innerHTML = data.map(u => `<div class="mention-item" onclick="insertMention('${u.username}')">@${u.username}</div>`).join('');
                        drop.style.display = 'block';
                        drop.style.bottom = '100px'; 
                    } else drop.style.display = 'none';
                });
            } else drop.style.display = 'none';
        }

        function insertMention(name) {
            const input = document.getElementById('post-input');
            const words = input.value.split(' '); words.pop();
            input.value = words.join(' ') + (words.length ? ' ' : '') + '@' + name + ' ';
            document.getElementById('mention-results').style.display = 'none';
            input.focus();
        }

        function safeRedirect(url) {
            const isLegit = ['whatsapp.com', 'jw.org', 'tiktok.com', 'instagram.com'].some(d => url.includes(d));
            if (isLegit) { if (confirm("Redirect to verified link?")) window.open(url, '_blank'); }
            else { alert("Aether: External Redirect Blocked. Proceed at your own risk."); window.open(url, '_blank'); }
        }

        function switchTab(m) { currentMode = m; loadFeed(); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 2000); }

        init();
    </script>
</body>
</html>
