<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Explore | Sdel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap');
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .sdel-gradient {
            background: linear-gradient(135deg, #FF5C00 0%, #FF2E00 100%);
        }

        .glass-nav {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .post-card {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .post-card:active {
            background: rgba(255, 255, 255, 0.02);
        }

        .tab-active {
            color: #fff;
            border-bottom: 3px solid #FF5C00;
        }

        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-20">

    <nav class="sticky top-0 z-50 glass-nav">
        <div class="flex items-center justify-between px-4 py-3">
            <h1 class="font-black italic text-xl tracking-tighter uppercase">Sdel</h1>
            <div id="user-status" class="w-8 h-8 rounded-full bg-zinc-900 border border-white/10 flex items-center justify-center text-[10px] font-bold">...</div>
        </div>
        <div class="flex border-b border-white/5">
            <button id="tab-universe" onclick="switchTab('universe')" class="flex-1 py-3 text-xs font-black uppercase tracking-widest text-zinc-500 tab-active">Universe</button>
            <button id="tab-campus" onclick="switchTab('campus')" class="flex-1 py-3 text-xs font-black uppercase tracking-widest text-zinc-500">Campus</button>
        </div>
    </nav>

    <div id="post-input-container" class="p-4 border-b border-white/5">
        </div>

    <div id="feed-container" class="flex flex-col">
        <div class="flex justify-center py-20">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-orange-500"></div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass-nav border-t border-white/5 flex justify-around py-3">
        <i data-lucide="home" class="text-white"></i>
        <i data-lucide="search" class="text-zinc-500"></i>
        <i data-lucide="bell" class="text-zinc-500"></i>
        <i data-lucide="mail" class="text-zinc-500"></i>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentMode = 'universe'; // or 'campus'

        // --- AUTH & PROFILE INIT ---
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = '/login.html';
                return;
            }

            const { data: profile } = await supabase
                .from('profile')
                .select('*')
                .eq('id', user.id)
                .single();

            currentUser = profile;
            document.getElementById('user-status').innerText = profile.username.charAt(0).toUpperCase();
            
            renderInputArea();
            loadFeed();
        }

        // --- UI RENDERING ---
        function renderInputArea() {
            const container = document.getElementById('post-input-container');
            
            if (currentUser.is_banned) {
                container.innerHTML = `
                    <div class="bg-red-500/10 border border-red-500/20 p-3 rounded-lg text-center">
                        <span class="text-[10px] font-black text-red-500 uppercase tracking-tighter">Account Restricted by Official</span>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-zinc-900 flex-shrink-0"></div>
                    <div class="flex-1">
                        <textarea id="gist-content" class="w-full bg-transparent border-none text-[15px] focus:ring-0 placeholder-zinc-700 resize-none" placeholder="What's the gist?" rows="2"></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <div class="flex gap-4 text-orange-500">
                                <i data-lucide="image" size="18"></i>
                                <i data-lucide="map-pin" size="18"></i>
                            </div>
                            <button onclick="publishGist()" class="sdel-gradient px-5 py-1.5 rounded-full text-xs font-black uppercase">Post</button>
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        async function loadFeed() {
            const container = document.getElementById('feed-container');
            
            let query = supabase.from('posts').select(`
                *,
                profile:user_id (username, is_official, school_name, is_banned)
            `);

            // 72-Hour Expiry Logic
            query = query.gt('expires_at', new Date().toISOString());

            // Campus Filter
            if (currentMode === 'campus') {
                query = query.eq('school_name', currentUser.school_name);
            }

            const { data: posts, error } = await query.order('created_at', { ascending: false });

            if (!posts || posts.length === 0) {
                container.innerHTML = `<div class="p-20 text-center text-zinc-600 text-[10px] font-black uppercase italic tracking-widest">No gists found.</div>`;
                return;
            }

            container.innerHTML = posts.map(post => {
                const isOwner = post.user_id === currentUser.id;
                const isAdmin = currentUser.is_official;
                const canEdit = isOwner && (new Date() - new Date(post.created_at) < 900000); // 15 mins

                return `
                <div class="post-card p-4">
                    <div class="flex gap-3">
                        <div class="w-10 h-10 rounded-full bg-zinc-900 border border-white/5 flex items-center justify-center font-black text-orange-500 text-xs uppercase">
                            ${post.profile.username.charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-1">
                                    <span class="text-[13px] font-black italic tracking-tighter uppercase">@${post.profile.username}</span>
                                    ${post.profile.is_official ? `<i data-lucide="badge-check" class="text-blue-400 fill-blue-400/20" size="14"></i>` : ''}
                                    <span class="text-[10px] text-zinc-600 ml-1">â€¢ ${post.school_name}</span>
                                </div>
                                <div class="flex gap-3 items-center">
                                    ${isAdmin && !isOwner ? `<button onclick="banUser('${post.user_id}')" class="text-[8px] border border-red-900 px-1 rounded text-red-900 font-bold">BAN</button>` : ''}
                                    ${isAdmin || isOwner ? `<button onclick="deleteGist('${post.id}')"><i data-lucide="trash-2" class="text-zinc-800" size="14"></i></button>` : ''}
                                </div>
                            </div>
                            <p class="text-[14px] text-zinc-200 mt-1 mb-3">${post.content}</p>
                            <div class="flex justify-between text-zinc-600">
                                <div class="flex gap-5">
                                    <button class="flex items-center gap-1.5"><i data-lucide="heart" size="16"></i> <span class="text-[10px] font-bold">${post.likes_count}</span></button>
                                    <button class="flex items-center gap-1.5"><i data-lucide="message-circle" size="16"></i> <span class="text-[10px] font-bold">${post.comments_count}</span></button>
                                    <button class="flex items-center gap-1.5"><i data-lucide="repeat" size="16"></i> <span class="text-[10px] font-bold">${post.reshare_count}</span></button>
                                </div>
                                <span class="text-[9px] font-bold">${post.view_count} views</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- CORE ACTIONS ---
        async function publishGist() {
            const content = document.getElementById('gist-content').value;
            if (!content) return;

            const { error } = await supabase.from('posts').insert({
                user_id: currentUser.id,
                content: content,
                school_name: currentUser.school_name
            });

            if (!error) {
                document.getElementById('gist-content').value = '';
                loadFeed();
            }
        }

        async function deleteGist(id) {
            if (!confirm("Delete this gist, homie?")) return;
            await supabase.from('posts').delete().eq('id', id);
            loadFeed();
        }

        async function banUser(targetId) {
            if (!confirm("Banning this user from posting. Proceed?")) return;
            const { error } = await supabase.rpc('ban_user', { target_uid: targetId, reason_text: 'Moderator removal' });
            if (error) alert(error.message);
            loadFeed();
        }

        function switchTab(mode) {
            currentMode = mode;
            document.getElementById('tab-universe').classList.toggle('tab-active', mode === 'universe');
            document.getElementById('tab-campus').classList.toggle('tab-active', mode === 'campus');
            loadFeed();
        }

        init();
    </script>
</body>
</html>
