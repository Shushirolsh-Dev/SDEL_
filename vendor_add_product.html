<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel Merchant | Market Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: 'Poppins', sans-serif; }
        .input-box { background: #121212; border: 1px solid #262626; border-radius: 15px; padding: 15px; width: 100%; outline: none; color: white; font-weight: bold; font-size: 13px; transition: 0.3s; }
        .input-box:focus { border-color: #FF6600; box-shadow: 0 0 10px rgba(255,102,0,0.1); }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background: #FF6600; }
        .card-zinc { background: rgba(18, 18, 18, 0.7); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        
        /* Preview Styling */
        #image-preview-container { display: none; width: 100%; height: 200px; border-radius: 20px; overflow: hidden; margin-bottom: 15px; border: 1px solid #262626; position: relative; }
        #image-preview { width: 100%; height: 100%; object-fit: cover; }
        .remove-img { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 50%; color: white; cursor: pointer; z-index: 10; }

        #inventory-list:empty::after { content: "YOUR SHOP IS EMPTY"; display: block; text-align: center; padding: 40px; font-size: 10px; font-weight: 900; color: #262626; letter-spacing: 0.2em; }
    </style>
</head>
<body class="p-6 pb-24">

    <nav class="flex items-center justify-between mb-8">
        <button onclick="window.location.href='vendor_dashboard.html'" class="bg-zinc-900 p-3 rounded-xl text-gray-400">
            <i data-lucide="chevron-left" size="20"></i>
        </button>
        <h1 class="text-xl font-black uppercase italic tracking-tighter">Inventory <span class="text-sdel">Manager</span></h1>
        <div class="w-10"></div>
    </nav>

    <section class="space-y-6 mb-12" id="form-section">
        <h2 id="form-title" class="text-[10px] font-black uppercase text-zinc-500 tracking-widest ml-1">List New Item</h2>
        
        <div id="image-preview-container">
            <div class="remove-img" onclick="clearImage()"><i data-lucide="x" size="16"></i></div>
            <img id="image-preview" src="" alt="Preview">
        </div>

        <div class="space-y-4">
            <input type="hidden" id="edit-id">
            <input type="text" id="p-name" placeholder="Product Name" class="input-box">
            <div class="grid grid-cols-2 gap-4">
                <input type="number" id="p-price" placeholder="Price (â‚¦)" class="input-box">
                <select id="p-category" class="input-box text-zinc-400"><option value="">Loading Categories...</option></select>
            </div>
            <textarea id="p-desc" placeholder="Product details..." class="input-box h-20"></textarea>
            
            <div class="flex items-center gap-4">
                <input type="file" id="p-image" class="hidden" accept="image/*">
                <button onclick="document.getElementById('p-image').click()" id="upload-trigger" class="flex-1 bg-zinc-900 py-4 rounded-2xl border border-dashed border-zinc-700 font-bold text-[10px] uppercase text-zinc-400 transition hover:border-sdel">
                    <i data-lucide="camera" class="inline mr-2" size="16"></i> <span id="file-status">Snap Photo</span>
                </button>
                <button onclick="saveProduct()" id="save-btn" class="flex-1 bg-sdel py-4 rounded-2xl font-black uppercase text-[10px] italic text-black tracking-widest shadow-lg shadow-orange-600/20">Launch</button>
            </div>
            <button id="cancel-edit" onclick="resetForm()" class="hidden w-full text-[9px] font-black uppercase text-zinc-500 text-center mt-2">Discard Changes</button>
        </div>
    </section>

    <section>
        <h2 class="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-4 ml-1">My Active Items</h2>
        <div id="inventory-list" class="space-y-3"></div>
    </section>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let inventoryData = [];
        let currentUserId = null;

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            currentUserId = session.user.id;
            loadCategories();
            loadInventory();
            lucide.createIcons();
        }

        window.loadCategories = async () => {
            const { data } = await supabase.from('categories').select('*').order('name');
            const selector = document.getElementById('p-category');
            if (data) {
                selector.innerHTML = '<option value="">Select Category</option>' + data.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            }
        };

        // PREVIEW LOGIC
        document.getElementById('p-image').onchange = function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('image-preview').src = event.target.result;
                    document.getElementById('image-preview-container').style.display = 'block';
                    document.getElementById('file-status').innerText = "Image Selected";
                }
                reader.readAsDataURL(file);
            }
        };

        window.clearImage = () => {
            document.getElementById('p-image').value = "";
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('file-status').innerText = "Snap Photo";
        };

        // --- SIGHTENGINE AI PROTOCOL ---
        async function runAIScan(file) {
            const formData = new FormData();
            formData.append('media', file);
            formData.append('models', 'nudity-2.0,wad,offensive'); // wad covers Weapons, Alcohol, Drugs
            formData.append('api_user', '351772232'); 
            formData.append('api_secret', 'XpUucJxcrXRGGGWWpM7Akh6jAi8vAwKZ');

            try {
                const response = await fetch('https://api.sightengine.com/1.0/check.json', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.status === 'failure') return { safe: false, error: result.error.message };

                // Define triggers
                const weapon = result.weapon > 0.5;
                const drugs = result.drugs > 0.5;
                const explicit = result.nudity.sexual_explicit > 0.5;

                if (weapon || drugs || explicit) {
                    return { safe: false, error: weapon ? "Weapons detected" : drugs ? "Illegal items detected" : "Explicit content detected" };
                }
                return { safe: true };
            } catch (err) {
                console.error("AI Scan Error:", err);
                return { safe: true }; // Fallback to allow if API fails, or set to false for max safety
            }
        }

        window.saveProduct = async () => {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const category = document.getElementById('p-category').value;
            const desc = document.getElementById('p-desc').value;
            const file = document.getElementById('p-image').files[0];
            const editId = document.getElementById('edit-id').value;

            if(!name || !price || !category) return alert("Fill Name, Price & Category!");

            const btn = document.getElementById('save-btn');
            btn.disabled = true; 
            btn.innerText = "AI SCANNING...";

            // 1. AI Safety Scan (Only for new files)
            if (file) {
                const scan = await runAIScan(file);
                if (!scan.safe) {
                    alert(`ðŸš¨ BLOCKED: ${scan.error}. Sdel does not allow these items.`);
                    btn.disabled = false;
                    btn.innerText = "Launch";
                    return;
                }
            }

            btn.innerText = "UPLOADING...";

            let productPayload = { 
                name, 
                price: parseFloat(price), 
                category, 
                description: desc,
                vendor_id: currentUserId 
            };

            // 2. Storage Upload
            if(file) {
                const fileName = `${currentUserId}/${Date.now()}.jpg`;
                const { data, error: uploadError } = await supabase.storage.from('market-assets').upload(fileName, file);
                
                if(!uploadError) {
                    productPayload.image_url = `https://lgfyrlfjoazedwymjpfc.supabase.co/storage/v1/object/public/market-assets/${fileName}`;
                    productPayload.image_path = fileName;
                } else {
                    alert("System Error: Storage Policy Blocked.");
                    btn.disabled = false; btn.innerText = "Launch";
                    return;
                }
            }

            // 3. Database Save
            const action = editId ? 
                supabase.from('products').update(productPayload).eq('id', editId).eq('vendor_id', currentUserId) : 
                supabase.from('products').insert([productPayload]);

            const { error } = await action;
            if(!error) {
                alert("Shop Updated, Homie!");
                location.reload();
            } else { 
                alert("Permission Denied: Only verified vendors can post.");
                btn.disabled = false; btn.innerText = "Launch";
            }
        };

        window.loadInventory = async () => {
            const { data } = await supabase.from('products').select('*').eq('vendor_id', currentUserId).order('created_at', { ascending: false });
            inventoryData = data || [];
            const list = document.getElementById('inventory-list');
            list.innerHTML = inventoryData.map(p => `
                <div class="card-zinc p-4 rounded-2xl flex items-center justify-between border-white/5">
                    <div class="flex items-center gap-3">
                        <img src="${p.image_url}" class="w-12 h-12 object-cover rounded-xl border border-white/10">
                        <div>
                            <h4 class="text-[11px] font-black uppercase italic text-white">${p.name}</h4>
                            <p class="text-[8px] text-zinc-500 font-bold uppercase tracking-widest">â‚¦${p.price.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editProduct('${p.id}')" class="text-zinc-600 hover:text-sdel transition p-2"><i data-lucide="edit-3" size="16"></i></button>
                        <button onclick="deleteItem('${p.id}', '${p.image_path}')" class="text-zinc-600 hover:text-red-500 transition p-2"><i data-lucide="trash-2" size="16"></i></button>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        };

        window.editProduct = (id) => {
            const p = inventoryData.find(x => x.id === id);
            if(!p) return;
            document.getElementById('edit-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-category').value = p.category;
            document.getElementById('p-desc').value = p.description;
            if(p.image_url) {
                document.getElementById('image-preview').src = p.image_url;
                document.getElementById('image-preview-container').style.display = 'block';
            }
            document.getElementById('form-title').innerText = "Update Item";
            document.getElementById('save-btn').innerText = "Update";
            document.getElementById('cancel-edit').classList.remove('hidden');
            document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
        };

        window.deleteItem = async (id, path) => {
            if(!confirm("Delete forever?")) return;
            const { error } = await supabase.from('products').delete().eq('id', id).eq('vendor_id', currentUserId);
            if(!error) {
                if(path) await supabase.storage.from('market-assets').remove([path]);
                loadInventory();
            }
        };

        window.resetForm = () => { location.reload(); };
        init();
    </script>
</body>
</html>
