<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel | Vendor Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: #000; color: white; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-dark { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 24px; }
        .glass { background: rgba(10,10,10,0.95); backdrop-filter: blur(8px); border: 1px solid #222; }
        .live-badge { display: inline-flex; align-items: center; gap: 6px; background: #1a1a1a; padding: 4px 12px; border-radius: 100px; border: 1px solid #FF6600; }
        .live-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .order-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 13px; }
        .order-row:last-child { border-bottom: none; }
        .show-more-btn { background: #1a1a1a; border: 1px solid #333; color: #aaa; padding: 10px; width: 100%; border-radius: 40px; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 12px; }
        .show-more-btn:hover { border-color: #FF6600; color: #FF6600; }
        .hidden-content { display: none; }
        .hidden-content.show { display: block; }
        .stat-value { font-size: 2rem; font-weight: 700; line-height: 1.2; }
        .stat-label { font-size: 0.75rem; color: #71717a; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    </style>
</head>
<body class="p-5 max-w-5xl mx-auto pb-24">

    <!-- Live status bar -->
    <div class="glass fixed top-0 left-0 right-0 z-50 border-b border-zinc-800 py-2 px-5 flex items-center justify-between">
        <div class="live-badge">
            <span class="live-dot"></span>
            <span class="text-[10px] font-bold text-white uppercase tracking-wider">LIVE DATA</span>
        </div>
        <span class="text-[10px] text-zinc-500" id="lastUpdated">updating...</span>
    </div>

    <!-- Main content (padding for fixed bar) -->
    <div class="pt-16">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-2xl font-bold tracking-tight" id="businessName">Vendor <span class="text-sdel">Analytics</span></h1>
                <p class="text-xs text-zinc-500 font-medium mt-1" id="vendorStatus">Loading your data...</p>
            </div>
            <button onclick="hardRefresh()" class="bg-zinc-900 p-3 rounded-2xl border border-zinc-800">
                <i data-lucide="refresh-cw" size="18" class="text-zinc-400"></i>
            </button>
        </div>

        <!-- MAIN ANALYTICS CARDS - LIVE DATA -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- Gross revenue card -->
            <div class="card-dark p-6">
                <div class="stat-label mb-2">Gross revenue</div>
                <div class="stat-value text-white" id="grossAmount">₦0</div>
                <div class="text-xs text-zinc-600 mt-1">from accepted orders</div>
            </div>

            <!-- Platform fee (10% shown separately) -->
            <div class="card-dark p-6">
                <div class="stat-label mb-2">Platform fee (10%)</div>
                <div class="stat-value text-zinc-300" id="feeAmount">₦0</div>
                <div class="text-xs text-zinc-600 mt-1">deducted from gross</div>
            </div>

            <!-- Net revenue (your actual profit) -->
            <div class="card-dark p-6 bg-gradient-to-br from-zinc-900 to-black border-sdel/20">
                <div class="stat-label mb-2">Your net revenue</div>
                <div class="stat-value text-sdel" id="netAmount">₦0</div>
                <div class="text-xs text-zinc-500 mt-1">after platform fee</div>
            </div>
        </div>

        <!-- Secondary row: pending revenue + queue -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="card-dark p-6">
                <div class="stat-label mb-1">Pending revenue</div>
                <div class="text-2xl font-bold text-white" id="pendingRevenue">₦0</div>
                <div class="text-xs text-zinc-600">not yet accepted</div>
            </div>
            <div class="card-dark p-6">
                <div class="stat-label mb-1">Queue size</div>
                <div class="text-2xl font-bold text-white" id="queueSize">0</div>
                <div class="text-xs text-zinc-600">pending orders</div>
            </div>
        </div>

        <!-- Accepted orders list with Show more -->
        <div class="card-dark p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <i data-lucide="check-circle" size="18" class="text-sdel"></i>
                    <span class="font-bold text-sm uppercase">Accepted orders</span>
                </div>
                <span class="text-xs bg-zinc-800 px-3 py-1 rounded-full text-zinc-300" id="acceptedCount">0</span>
            </div>

            <!-- Compact view (first 3) -->
            <div id="acceptedCompact" class="space-y-1"></div>

            <!-- Full hidden view -->
            <div id="acceptedFull" class="hidden-content mt-3 space-y-1"></div>

            <!-- Show more button -->
            <button id="toggleAccepted" class="show-more-btn" onclick="toggleList('accepted')">Show more</button>
        </div>

        <!-- Pending orders quick preview -->
        <div class="card-dark p-6">
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="clock" size="18" class="text-zinc-500"></i>
                <span class="font-bold text-sm uppercase">Pending orders</span>
            </div>
            <div id="pendingCompact" class="space-y-1"></div>
            <div id="pendingFull" class="hidden-content mt-3 space-y-1"></div>
            <button id="togglePending" class="show-more-btn" onclick="toggleList('pending')">Show more</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const supabase = createClient(
            'https://lgfyrlfjoazedwymjpfc.supabase.co', 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw'
        );

        let currentUser = null;
        let allOrders = [];
        let showAcceptedFull = false;
        let showPendingFull = false;

        // Toggle show more/less
        window.toggleList = (type) => {
            if (type === 'accepted') {
                showAcceptedFull = !showAcceptedFull;
                document.getElementById('acceptedFull').classList.toggle('show', showAcceptedFull);
                document.getElementById('toggleAccepted').innerText = showAcceptedFull ? 'Show less' : 'Show more';
            } else {
                showPendingFull = !showPendingFull;
                document.getElementById('pendingFull').classList.toggle('show', showPendingFull);
                document.getElementById('togglePending').innerText = showPendingFull ? 'Show less' : 'Show more';
            }
        };

        // Get vendor identity (same working pattern)
        async function getVendorIdentity() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                document.getElementById('vendorStatus').innerText = 'Please log in';
                return;
            }

            currentUser = user;

            // Get vendor business name for display
            const { data: vendor } = await supabase
                .from('vendors')
                .select('business_name')
                .eq('user_id', user.id)
                .single();

            if (vendor) {
                document.getElementById('businessName').innerHTML = `${vendor.business_name} <span class="text-sdel">Analytics</span>`;
                document.getElementById('vendorStatus').innerText = 'Live data streaming';
            }

            loadVendorData();
        }

        // Load ALL vendor orders (same working filter)
        async function loadVendorData() {
            if (!currentUser) return;

            document.getElementById('lastUpdated').innerText = `updating: ${new Date().toLocaleTimeString()}`;

            // FETCH ALL orders for this vendor - USING USER.ID
            const { data: orders, error } = await supabase
                .from('orders')
                .select('*')
                .eq('vendor_id', currentUser.id)  // ← SAME WORKING PATTERN
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading orders:', error);
                return;
            }

            allOrders = orders || [];
            
            // Update all displays
            updateAnalytics();
            renderAcceptedList();
            renderPendingList();
        }

        // Calculate and display financials
        function updateAnalytics() {
            const accepted = allOrders.filter(o => o.status === 'accepted');
            const pending = allOrders.filter(o => o.status === 'pending');

            // Calculate totals
            const gross = accepted.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);
            const fee = gross * 0.10;
            const net = gross - fee;
            const pendingRev = pending.reduce((sum, o) => sum + (Number(o.total_amount) || 0), 0);

            // Update DOM
            document.getElementById('grossAmount').innerText = `₦${gross.toLocaleString()}`;
            document.getElementById('feeAmount').innerText = `₦${fee.toLocaleString()}`;
            document.getElementById('netAmount').innerText = `₦${net.toLocaleString()}`;
            document.getElementById('pendingRevenue').innerText = `₦${pendingRev.toLocaleString()}`;
            document.getElementById('queueSize').innerText = pending.length;
            document.getElementById('acceptedCount').innerText = accepted.length;
        }

        // Render accepted orders
        function renderAcceptedList() {
            const accepted = allOrders.filter(o => o.status === 'accepted');
            const compactDiv = document.getElementById('acceptedCompact');
            const fullDiv = document.getElementById('acceptedFull');
            const toggleBtn = document.getElementById('toggleAccepted');

            if (accepted.length === 0) {
                compactDiv.innerHTML = '<div class="text-zinc-600 text-sm py-4">No accepted orders yet</div>';
                fullDiv.innerHTML = '';
                toggleBtn.style.display = 'none';
                return;
            }

            toggleBtn.style.display = 'block';

            // Compact (first 3)
            const firstFew = accepted.slice(0, 3);
            compactDiv.innerHTML = firstFew.map(o => `
                <div class="order-row">
                    <span class="text-zinc-400">${o.order_code || 'ORD-' + o.id.slice(0,6)}</span>
                    <span class="font-semibold text-white">₦${(Number(o.total_amount) || 0).toLocaleString()}</span>
                </div>
            `).join('');

            // Full (all)
            fullDiv.innerHTML = accepted.map(o => `
                <div class="order-row">
                    <span class="text-zinc-400">${o.order_code || 'ORD-' + o.id.slice(0,6)}</span>
                    <span class="font-semibold text-white">₦${(Number(o.total_amount) || 0).toLocaleString()}</span>
                </div>
            `).join('');

            fullDiv.classList.toggle('show', showAcceptedFull);
            document.getElementById('toggleAccepted').innerText = showAcceptedFull ? 'Show less' : 'Show more';
        }

        // Render pending orders
        function renderPendingList() {
            const pending = allOrders.filter(o => o.status === 'pending');
            const compactDiv = document.getElementById('pendingCompact');
            const fullDiv = document.getElementById('pendingFull');
            const toggleBtn = document.getElementById('togglePending');

            if (pending.length === 0) {
                compactDiv.innerHTML = '<div class="text-zinc-600 text-sm py-4">No pending orders</div>';
                fullDiv.innerHTML = '';
                toggleBtn.style.display = 'none';
                return;
            }

            toggleBtn.style.display = 'block';

            const firstFew = pending.slice(0, 3);
            compactDiv.innerHTML = firstFew.map(o => `
                <div class="order-row">
                    <span class="text-zinc-400">${o.order_code || 'ORD-' + o.id.slice(0,6)}</span>
                    <span class="font-semibold text-white">₦${(Number(o.total_amount) || 0).toLocaleString()}</span>
                </div>
            `).join('');

            fullDiv.innerHTML = pending.map(o => `
                <div class="order-row">
                    <span class="text-zinc-400">${o.order_code || 'ORD-' + o.id.slice(0,6)}</span>
                    <span class="font-semibold text-white">₦${(Number(o.total_amount) || 0).toLocaleString()}</span>
                </div>
            `).join('');

            fullDiv.classList.toggle('show', showPendingFull);
            document.getElementById('togglePending').innerText = showPendingFull ? 'Show less' : 'Show more';
        }

        // Hard refresh
        window.hardRefresh = async () => {
            await loadVendorData();
        };

        // REAL-TIME SUBSCRIPTION - LIVE UPDATES
        supabase
            .channel('vendor-live-analytics')
            .on('postgres_changes', { 
                event: '*', 
                schema: 'public', 
                table: 'orders',
                filter: `vendor_id=eq.${currentUser?.id}`
            }, () => {
                loadVendorData();
            })
            .subscribe();

        // Initialize
        getVendorIdentity();
        lucide.createIcons();

        // Auto-refresh every 15 seconds
        setInterval(() => {
            if (currentUser) loadVendorData();
        }, 15000);
    </script>
</body>
</html>
