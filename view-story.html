<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Story Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let allUserStories = [];
        let currentIndex = 0;
        let progress = 0;
        let isPaused = false;
        let timer;

        async function loadStorySequence() {
            const params = new URLSearchParams(window.location.search);
            const initialId = params.get('id');
            
            const { data: first } = await supabase.from('stories').select('author_id').eq('id', initialId).single();
            if (!first) return window.location.href = 'dashboard.html';

            const { data: stories } = await supabase.from('stories')
                .select('*')
                .eq('author_id', first.author_id)
                .gt('expires_at', new Date().toISOString())
                .order('created_at', { ascending: true });

            const { data: profile } = await supabase.from('profile').select('first_name, is_official').eq('id', first.author_id).single();

            allUserStories = stories;
            currentIndex = stories.findIndex(s => s.id === initialId);
            if (currentIndex === -1) currentIndex = 0;
            
            const isSdel = stories[currentIndex].is_official_post || profile?.is_official;
            document.getElementById('author-name').innerText = isSdel ? "SDEL OFFICIAL" : (profile?.first_name || "MEMBER");
            
            if (isSdel) {
                document.getElementById('author-name').classList.add('text-yellow-400');
                document.getElementById('reply-section').style.display = 'none';
            }
            renderStory();
        }

        function renderStory() {
            isPaused = false;
            progress = 0;
            const story = allUserStories[currentIndex];
            const img = document.getElementById('story-img');
            const captionBox = document.getElementById('story-caption');
            
            document.getElementById('loading-spinner').classList.remove('hidden');
            img.src = story.media_url;

            // Updated to use the 'caption' column from your upload file
            if (story.caption && story.caption.trim() !== "") {
                captionBox.innerText = story.caption;
                captionBox.parentElement.classList.remove('hidden');
            } else {
                captionBox.parentElement.classList.add('hidden');
            }
            
            const icon = document.getElementById('pause-icon');
            icon.setAttribute('data-lucide', 'pause');
            lucide.createIcons();
            
            img.onload = () => {
                document.getElementById('loading-spinner').classList.add('hidden');
                startTimer();
            };
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                if (!isPaused) {
                    progress += 1;
                    document.getElementById('progress-fill').style.width = progress + '%';
                    if (progress >= 100) nextStory();
                }
            }, 50); 
        }

        window.togglePause = (e) => {
            if(e) e.stopPropagation();
            isPaused = !isPaused;
            const icon = document.getElementById('pause-icon');
            icon.setAttribute('data-lucide', isPaused ? 'play' : 'pause');
            lucide.createIcons();
        };

        window.nextStory = () => {
            if (currentIndex < allUserStories.length - 1) {
                currentIndex++;
                renderStory();
            } else { 
                window.location.href = 'dashboard.html'; 
            }
        };

        window.handleScreenTap = (e) => {
            const x = e.clientX;
            const width = window.innerWidth;
            if (x < width / 3) {
                if (currentIndex > 0) { currentIndex--; renderStory(); }
                else { window.location.href = 'dashboard.html'; }
            } else { nextStory(); }
        };

        loadStorySequence();
    </script>

    <style>
        * { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-input { background: rgba(255,255,255,0.1); backdrop-blur: 15px; border: 1px solid rgba(255,255,255,0.2); }
        .text-shadow { text-shadow: 0 2px 8px rgba(0,0,0,0.9); }
    </style>
</head>
<body class="h-screen w-full flex flex-col bg-black text-white overflow-hidden select-none">

    <div class="fixed top-0 inset-x-0 p-4 z-50 bg-gradient-to-b from-black/80 to-transparent">
        <div class="h-1 w-full bg-white/20 rounded-full overflow-hidden">
            <div id="progress-fill" class="h-full bg-white w-0 transition-all duration-75 linear"></div>
        </div>
        
        <div class="flex justify-between items-center mt-4 px-2">
            <div class="flex items-center space-x-3">
                <p id="author-name" class="font-black text-[10px] uppercase tracking-[0.2em]">Loading...</p>
            </div>
            <div class="flex items-center space-x-6">
                <button onclick="togglePause(event)"><i id="pause-icon" data-lucide="pause" size="18"></i></button>
                <i data-lucide="x" size="22" onclick="window.location.href='dashboard.html'" class="cursor-pointer"></i>
            </div>
        </div>
    </div>

    <div class="flex-1 flex items-center justify-center relative bg-black" onclick="handleScreenTap(event)">
        <div id="loading-spinner" class="absolute flex items-center justify-center z-10">
            <div class="w-10 h-10 border-[3px] border-white/10 border-t-white rounded-full animate-spin"></div>
        </div>
        <img id="story-img" class="max-h-screen w-full object-contain pointer-events-none">

        <div class="absolute bottom-32 inset-x-0 px-8 py-6 bg-gradient-to-t from-black/80 via-black/40 to-transparent text-center">
            <p id="story-caption" class="text-[15px] font-bold text-white text-shadow leading-relaxed"></p>
        </div>
    </div>

    <div id="reply-section" class="fixed bottom-0 inset-x-0 p-6 pb-10 bg-black/60 backdrop-blur-md">
        <div class="flex items-center space-x-3">
            <div class="flex-1 glass-input rounded-full px-5 py-3 flex items-center">
                <input type="text" placeholder="Reply to gist..." class="bg-transparent border-none outline-none text-[13px] w-full placeholder:text-white/40 font-medium">
            </div>
            <button class="w-11 h-11 flex items-center justify-center bg-white rounded-full active:scale-90 transition">
                <i data-lucide="heart" class="text-black fill-black" size="18"></i>
            </button>
        </div>
    </div>

    <script>lucide.createIcons();</script>
</body>
</html>
