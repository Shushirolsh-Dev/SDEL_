<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Story Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let allUserStories = [];
        let currentIndex = 0;
        let progress = 0;
        let isPaused = false;
        let timer;
        let currentUser = null;

        window.exitViewer = () => {
            if (window.history.length > 1) window.history.back();
            else window.location.replace('dashboard.html');
        };

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;
            loadStorySequence();
        }

        async function loadStorySequence() {
            const params = new URLSearchParams(window.location.search);
            const initialId = params.get('id');
            
            const { data: first } = await supabase.from('stories').select('author_id').eq('id', initialId).single();
            if (!first) return window.exitViewer();

            const { data: stories } = await supabase.from('stories')
                .select('*')
                .eq('author_id', first.author_id)
                .gt('expires_at', new Date().toISOString())
                .order('created_at', { ascending: true });

            const { data: profile } = await supabase.from('profile').select('first_name, is_official').eq('id', first.author_id).single();

            allUserStories = stories;
            currentIndex = stories.findIndex(s => s.id === initialId);
            if (currentIndex === -1) currentIndex = 0;
            
            // Logic to hide reply section if official
            if (profile?.is_official || stories[currentIndex].is_official_post) {
                document.getElementById('reply-section-container').classList.add('hidden');
            } else {
                document.getElementById('reply-section-container').classList.remove('hidden');
            }

            renderStory();
        }

        function renderStory() {
            clearInterval(timer); 
            isPaused = false;
            progress = 0;
            const story = allUserStories[currentIndex];
            const img = document.getElementById('story-img');
            const captionBox = document.getElementById('story-caption');
            const captionContainer = document.getElementById('caption-container');
            
            document.getElementById('loading-spinner').classList.remove('hidden');
            img.src = story.media_url;

            document.getElementById('author-name').innerText = story.is_official_post ? "SDEL OFFICIAL" : "MEMBER";

            // Strict height control for long text
            if (story.caption && story.caption.trim() !== "") {
                captionBox.innerText = story.caption;
                captionContainer.classList.remove('hidden');
            } else {
                captionContainer.classList.add('hidden');
            }
            
            startTimer();
            img.onload = () => document.getElementById('loading-spinner').classList.add('hidden');
            lucide.createIcons();
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                if (!isPaused) {
                    progress += 1.25; 
                    document.getElementById('progress-fill').style.width = Math.min(progress, 100) + '%';
                    if (progress >= 100) {
                        clearInterval(timer);
                        nextStory();
                    }
                }
            }, 100); 
        }

        window.sendReply = async () => {
            const input = document.getElementById('reply-input');
            const text = input.value.trim();
            if (!text || !currentUser) return;

            const story = allUserStories[currentIndex];
            const storyLink = window.location.href;
            const fullMessage = `${text}\n\n[Replied to story: ${storyLink}]`;

            // Pausing for the send process
            isPaused = true;

            const { error } = await supabase.from('messages').insert([
                { 
                    sender_id: currentUser.id, 
                    receiver_id: story.author_id, 
                    content: fullMessage 
                }
            ]);

            if (!error) {
                window.location.href = `dm.html?id=${story.author_id}`;
            } else {
                isPaused = false;
                alert("Failed to send. Try again.");
            }
        };

        window.togglePause = (e, manualState) => {
            if(e) e.stopPropagation();
            isPaused = manualState !== undefined ? manualState : !isPaused;
            const icon = document.getElementById('pause-icon');
            icon.setAttribute('data-lucide', isPaused ? 'play' : 'pause');
            lucide.createIcons();
        };

        window.nextStory = () => {
            if (currentIndex < allUserStories.length - 1) {
                currentIndex++;
                renderStory();
            } else { 
                window.exitViewer(); 
            }
        };

        window.handleScreenTap = (e) => {
            const x = e.clientX;
            const width = window.innerWidth;
            if (x < width / 3) {
                if (currentIndex > 0) { currentIndex--; renderStory(); }
                else { window.exitViewer(); }
            } else { 
                nextStory(); 
            }
        };

        init();
    </script>

    <style>
        * { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-nav { background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%); }
        .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.9); }
        .custom-scrollbar::-webkit-scrollbar { width: 0px; }
        /* Prevent long captions from covering screen */
        #caption-container { max-height: 15vh; overflow-y: auto; }
    </style>
</head>
<body class="h-screen w-full flex flex-col bg-black text-white overflow-hidden select-none">

    <div class="fixed top-0 inset-x-0 z-50 glass-nav pt-4 pb-12 px-4 pointer-events-none">
        <div class="h-1.5 w-full bg-white/20 rounded-full overflow-hidden mb-4 pointer-events-auto">
            <div id="progress-fill" class="h-full bg-white w-0 transition-all duration-100 linear"></div>
        </div>
        
        <div class="flex justify-between items-center pointer-events-auto">
            <p id="author-name" class="font-black text-[12px] uppercase tracking-[0.2em] text-shadow">Loading...</p>
            <div class="flex items-center space-x-6">
                <button onclick="togglePause(event)"><i id="pause-icon" data-lucide="pause" size="20"></i></button>
                <button onclick="window.exitViewer()"><i data-lucide="x" size="28"></i></button>
            </div>
        </div>
    </div>

    <div class="flex-1 flex items-center justify-center relative bg-black" onclick="handleScreenTap(event)">
        <div id="loading-spinner" class="absolute flex items-center justify-center z-10">
            <div class="w-10 h-10 border-[3px] border-white/10 border-t-white rounded-full animate-spin"></div>
        </div>
        <img id="story-img" class="max-h-screen w-full object-contain pointer-events-none">
    </div>

    <div class="fixed bottom-0 inset-x-0 z-50 bg-gradient-to-t from-black via-black/80 to-transparent pb-10 pt-24 px-6">
        <div id="caption-container" class="mb-6 hidden px-2 custom-scrollbar">
            <p id="story-caption" class="text-[14px] font-semibold text-white text-center text-shadow leading-relaxed"></p>
        </div>

        <div id="reply-section-container" class="flex items-center space-x-3">
            <input id="reply-input" type="text" placeholder="Reply to gist..." 
                   class="flex-1 bg-white/10 backdrop-blur-md rounded-full px-5 py-3 border border-white/10 text-[13px] outline-none"
                   onfocus="togglePause(null, true)" onblur="togglePause(null, false)">
            <button onclick="window.sendReply()" class="w-12 h-12 flex items-center justify-center bg-white rounded-full active:scale-90 transition">
                <i data-lucide="send" class="text-black ml-1" size="20"></i>
            </button>
        </div>
    </div>

    <script>lucide.createIcons();</script>
</body>
</html>
