<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'sunlight') document.documentElement.classList.add('sunlight-mode');
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel | Merchant Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root { --bg: #000; --surface: #0a0a0a; --card: #121212; --border: rgba(255,255,255,0.08); --text: #fff; --dim: #71717a; }
        .sunlight-mode { --bg: #fff; --surface: #f4f4f5; --card: #ffffff; --border: #e4e4e7; --text: #09090b; --dim: #71717a; }
        
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; transition: 0.3s; }
        .glass-card { background: var(--card); border: 1px solid var(--border); border-radius: 2.5rem; }
        .text-sdel { color: #FF6600; }
        .input-zinc { background: rgba(120,120,120,0.05); border: 1px solid var(--border); color: var(--text); padding: 16px; border-radius: 16px; font-size: 13px; font-weight: 600; outline: none; width: 100%; }
        .input-zinc:focus { border-color: #FF6600; }
        
        .plan-card { border: 2px solid var(--border); transition: 0.3s; cursor: pointer; border-radius: 20px; }
        .plan-card.active { border-color: #FF6600; background: rgba(255,102,0,0.05); }

        #custom-alert { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; min-width: 300px; animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideDown { from { top: -100px; opacity: 0; } to { top: 20px; opacity: 1; } }

        * { font-style: normal !important; }
    </style>
</head>
<body class="p-6 pb-20">

    <div id="custom-alert" class="glass-card p-5 shadow-2xl flex items-center gap-4">
        <div class="p-2 bg-sdel/20 rounded-lg text-sdel"><i data-lucide="bell" size="20"></i></div>
        <p id="alert-msg" class="text-xs font-black uppercase tracking-tight"></p>
    </div>

    <nav class="flex items-center justify-between mb-10">
        <button onclick="window.history.back()" class="p-3 bg-zinc-900/10 rounded-2xl border border-[var(--border)]">
            <i data-lucide="arrow-left" size="20"></i>
        </button>
        <h1 class="text-[10px] font-black uppercase tracking-[0.3em]">Merchant Hub</h1>
        <div class="w-10"></div>
    </nav>

    <div id="main-content" class="space-y-8">
        <div class="glass-card p-6 flex items-center gap-4">
            <div id="shopIcon" class="w-16 h-16 rounded-2xl bg-sdel/10 flex items-center justify-center text-sdel border border-sdel/20">
                <i data-lucide="store" size="28"></i>
            </div>
            <div>
                <h3 id="previewName" class="font-black uppercase text-sm tracking-tight">Your Business Name</h3>
                <p id="previewCat" class="text-[10px] text-[var(--dim)] font-bold uppercase tracking-widest">Select Category</p>
            </div>
        </div>

        <div id="reg-form" class="space-y-4">
            <div>
                <label class="text-[8px] font-black uppercase text-[var(--dim)] ml-2 mb-1 block">Business Identity</label>
                <input type="text" id="bizName" placeholder="Shop Name" class="input-zinc" oninput="updatePreview()">
            </div>
            <div>
                <label class="text-[8px] font-black uppercase text-[var(--dim)] ml-2 mb-1 block">Category</label>
                <select id="bizCat" class="input-zinc appearance-none" onchange="handleCategoryChange()">
                    <option value="">Select Niche</option>
                    <option value="Fashion">Fashion & Style</option>
                    <option value="Electronics">Tech & Gadgets</option>
                    <option value="Food">Food & Groceries</option>
                    <option value="Services">Professional Services</option>
                    <option value="Health">Health & Beauty</option>
                    <option value="Home">Home & Decor</option>
                    <option value="Education">Educational Materials</option>
                    <option value="Other">Other (Type below)</option>
                </select>
            </div>
            <div id="customCatDiv" class="hidden">
                <input type="text" id="customCat" placeholder="Type your category..." class="input-zinc" oninput="updatePreview()">
            </div>
            <div class="space-y-3">
                <label class="text-[8px] font-black uppercase text-[var(--dim)] ml-2 block">Choose Merchant Plan</label>
                <div id="plan-container" class="grid grid-cols-1 gap-3">
                    <p class="text-xs opacity-50 p-4 font-bold uppercase">Fetching rates...</p>
                </div>
            </div>
            <button onclick="registerVendor()" id="regBtn" class="w-full bg-[#FF6600] text-white py-6 rounded-[2rem] font-black uppercase text-xs tracking-[0.2em] shadow-2xl shadow-sdel/30 active:scale-95 transition-all mt-6">
                Launch My Shop
            </button>
        </div>

        <div id="status-view" class="hidden text-center space-y-6">
            <div id="status-card" class="glass-card p-10 space-y-4">
                <div id="status-icon-div" class="w-20 h-20 bg-sdel/10 rounded-full flex items-center justify-center mx-auto text-sdel">
                    <i id="status-icon" data-lucide="clock-4" size="40"></i>
                </div>
                <h2 id="status-title" class="text-2xl font-black uppercase tracking-tighter">Under Review</h2>
                <p id="status-desc" class="text-xs text-[var(--dim)] font-bold uppercase tracking-widest leading-relaxed">
                    We'll review the details and get back to you shortly, homie.
                </p>
            </div>
            <button id="startSellingBtn" class="w-full bg-zinc-800 text-[var(--dim)] py-6 rounded-[2rem] font-black uppercase text-xs tracking-[0.2em] cursor-not-allowed opacity-50">
                Start Selling (Verification Pending)
            </button>
            <button id="retryBtn" onclick="reapply()" class="hidden w-full border border-sdel text-sdel py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest">
                Try Again
            </button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let selectedPrice = 0;
        let selectedTierId = "";

        async function checkVendorStatus() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return;

            const { data: vendor } = await supabase.from('vendors').select('*').eq('user_id', session.user.id).single();

            if (vendor) {
                document.getElementById('reg-form').classList.add('hidden');
                document.getElementById('status-view').classList.remove('hidden');

                if (vendor.status === 'verified') {
                    // Success View
                    document.getElementById('status-icon-div').className = "w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mx-auto text-green-500";
                    document.getElementById('status-icon').setAttribute('data-lucide', 'check-circle');
                    document.getElementById('status-title').innerText = "Verified!";
                    document.getElementById('status-desc').innerText = "Your shop is live and ready for business. Let's make some money!";
                    
                    const btn = document.getElementById('startSellingBtn');
                    btn.classList.remove('bg-zinc-800', 'cursor-not-allowed', 'opacity-50');
                    btn.classList.add('bg-sdel', 'text-white');
                    btn.innerText = "Enter Shop Dashboard";
                    btn.onclick = () => window.location.href = 'vendor_dashboard.html';
                    
                    lucide.createIcons();
                } else if (vendor.status === 'declined') {
                    // Declined View
                    document.getElementById('status-icon-div').className = "w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto text-red-500";
                    document.getElementById('status-icon').setAttribute('data-lucide', 'x-circle');
                    document.getElementById('status-title').innerText = "Shop Rejected";
                    document.getElementById('status-desc').innerText = "Your application was declined. Please review your details and try again.";
                    document.getElementById('retryBtn').classList.remove('hidden');
                    document.getElementById('startSellingBtn').classList.add('hidden');
                    lucide.createIcons();
                }
            }
        }

        window.reapply = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            const { error } = await supabase.from('vendors').delete().eq('user_id', session.user.id).eq('status', 'declined');
            if (!error) location.reload();
            else showAlert("Action failed. Try again later.");
        }

        async function loadPlans() {
            const { data: configs } = await supabase.from('app_config').select('*').filter('id', 'ilike', 'vendor_%').order('price', { ascending: true });
            const cont = document.getElementById('plan-container');
            if (configs && configs.length > 0) {
                cont.innerHTML = configs.map(c => `
                    <div class="plan-card p-5 flex justify-between items-center" id="card-${c.id}" onclick="selectPlan('${c.id}', ${c.price})">
                        <div><p class="font-black uppercase text-xs tracking-tight">${c.description}</p></div>
                        <p class="text-sdel font-black text-sm">â‚¦${c.price.toLocaleString()}</p>
                    </div>
                `).join('');
                selectPlan(configs[0].id, configs[0].price);
            }
        }

        window.showAlert = (msg) => {
            const box = document.getElementById('custom-alert');
            document.getElementById('alert-msg').innerText = msg;
            box.style.display = 'flex';
            setTimeout(() => { box.style.display = 'none'; }, 3500);
        }

        window.handleCategoryChange = () => {
            const val = document.getElementById('bizCat').value;
            const customDiv = document.getElementById('customCatDiv');
            if (val === 'Other') customDiv.classList.remove('hidden');
            else customDiv.classList.add('hidden');
            updatePreview();
        }

        window.selectPlan = (id, price) => {
            selectedPrice = price;
            selectedTierId = id;
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${id}`).classList.add('active');
        }

        window.updatePreview = () => {
            document.getElementById('previewName').innerText = document.getElementById('bizName').value || "Your Business Name";
            const mainCat = document.getElementById('bizCat').value;
            const customCat = document.getElementById('customCat').value;
            document.getElementById('previewCat').innerText = (mainCat === 'Other' ? customCat : mainCat) || "Select Category";
        }

        window.registerVendor = async () => {
            const btn = document.getElementById('regBtn');
            const biz = document.getElementById('bizName').value;
            let cat = document.getElementById('bizCat').value;
            if(cat === 'Other') cat = document.getElementById('customCat').value;
            if(!biz || !cat) return showAlert("Missing shop details, homie!");
            btn.disabled = true;
            btn.innerText = "Connecting...";
            const { data: { session } } = await supabase.auth.getSession();
            if(!session) return window.location.href = 'login.html';
            const { error } = await supabase.from('vendors').insert({
                user_id: session.user.id,
                business_name: biz,
                category: cat,
                tier_id: selectedTierId,
                fee_paid: selectedPrice,
                status: 'pending'
            });
            if(!error) {
                showAlert("Application Sent Successfully");
                setTimeout(() => location.reload(), 1500);
            } else {
                if(error.code === '23505') showAlert("You already have a shop registered!");
                else showAlert(error.message);
                btn.disabled = false;
                btn.innerText = "Launch My Shop";
            }
        };

        init();
        async function init() {
            await loadPlans();
            await checkVendorStatus();
            lucide.createIcons();
        }
    </script>
</body>
</html>
