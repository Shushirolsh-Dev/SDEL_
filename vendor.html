<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'sunlight') document.documentElement.classList.add('sunlight-mode');
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel | Merchant Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root { --bg: #000; --surface: #0a0a0a; --card: #121212; --border: rgba(255,255,255,0.08); --text: #fff; --dim: #71717a; }
        .sunlight-mode { --bg: #fff; --surface: #f4f4f5; --card: #ffffff; --border: #e4e4e7; --text: #09090b; --dim: #71717a; }
        
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; transition: 0.3s; }
        .glass-card { background: var(--card); border: 1px solid var(--border); border-radius: 2.5rem; }
        .text-sdel { color: #FF6600; }
        .input-zinc { background: rgba(120,120,120,0.05); border: 1px solid var(--border); color: var(--text); padding: 16px; border-radius: 16px; font-size: 13px; font-weight: 600; outline: none; width: 100%; }
        .input-zinc:focus { border-color: #FF6600; }
        
        .plan-card { border: 2px solid var(--border); transition: 0.3s; cursor: pointer; border-radius: 20px; }
        .plan-card.active { border-color: #FF6600; background: rgba(255,102,0,0.05); }

        #custom-alert { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; min-width: 300px; animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideDown { from { top: -100px; opacity: 0; } to { top: 20px; opacity: 1; } }

        /* Violation message styles */
        .violation-card {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 1.5rem;
            padding: 1.5rem;
            text-align: center;
        }
        .violation-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }
        .fraud-icon { background: #8b5cf620; color: #8b5cf6; }
        .suspended-icon { background: #ef444420; color: #ef4444; }
        .deleted-icon { background: #ef444420; color: #ef4444; }
        .violation-title {
            font-size: 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -0.05em;
            margin-bottom: 0.5rem;
        }
        .violation-message {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--dim);
            margin-bottom: 1.5rem;
        }
        .rules-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #FF6600;
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            text-decoration: underline;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        * { font-style: normal !important; }
    </style>
</head>
<body class="p-6 pb-20">

    <div id="custom-alert" class="glass-card p-5 shadow-2xl flex items-center gap-4">
        <div class="p-2 bg-sdel/20 rounded-lg text-sdel"><i data-lucide="bell" size="20"></i></div>
        <p id="alert-msg" class="text-xs font-black uppercase tracking-tight"></p>
    </div>

    <!-- Rules Modal -->
    <div id="rulesModal" class="fixed inset-0 bg-black/90 flex items-center justify-center p-6 z-50 hidden">
        <div class="glass-card p-8 max-w-md w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-sm font-black uppercase text-sdel">Marketplace Rules</h2>
                <button onclick="hideRulesModal()" class="text-[var(--dim)]"><i data-lucide="x" size="20"></i></button>
            </div>
            <div class="space-y-4 text-[10px] font-medium">
                <p class="text-sdel font-black">1. VALID PAYMENT REFERENCES</p>
                <p>Submitting fake or invalid payment references will result in immediate suspension and fraud labeling.</p>
                
                <p class="text-sdel font-black mt-4">2. PROHIBITED PRODUCTS</p>
                <p>No counterfeit, illegal, or harmful products. Violations lead to permanent deletion.</p>
                
                <p class="text-sdel font-black mt-4">3. SHOP SUSPENSION</p>
                <p>Shops can be suspended for policy violations. Contact support for review.</p>
                
                <p class="text-sdel font-black mt-4">4. FRAUD PENALTIES</p>
                <p>Fraudulent activity results in permanent fraud status. Must create new shop after review.</p>
                
                <p class="text-sdel font-black mt-4">5. PAYMENT TIMELY</p>
                <p>Monthly fees must be paid on time. Overdue shops are locked until payment is reset.</p>
                
                <div class="mt-6 pt-4 border-t border-[var(--border)]">
                    <label class="flex items-center gap-3">
                        <input type="checkbox" id="agreeRules" class="w-4 h-4 accent-sdel">
                        <span class="text-[9px] font-bold">I have read and agree to the rules</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <nav class="flex items-center justify-between mb-10">
        <button onclick="window.history.back()" class="p-3 bg-zinc-900/10 rounded-2xl border border-[var(--border)]">
            <i data-lucide="arrow-left" size="20"></i>
        </button>
        <h1 class="text-[10px] font-black uppercase tracking-[0.3em]">Merchant Hub</h1>
        <div class="w-10"></div>
    </nav>

    <div id="main-content" class="space-y-8">
        <div class="glass-card p-6 flex items-center gap-4">
            <div id="shopIcon" class="w-16 h-16 rounded-2xl bg-sdel/10 flex items-center justify-center text-sdel border border-sdel/20">
                <i data-lucide="store" size="28"></i>
            </div>
            <div>
                <h3 id="previewName" class="font-black uppercase text-sm tracking-tight">Your Business Name</h3>
                <p id="previewCat" class="text-[10px] text-[var(--dim)] font-bold uppercase tracking-widest">Select Category</p>
            </div>
        </div>

        <!-- Rules Link Card (for new users) -->
        <div class="glass-card p-4 flex items-center justify-between cursor-pointer" onclick="showRulesModal()">
            <div class="flex items-center gap-3">
                <i data-lucide="scroll-text" size="20" class="text-sdel"></i>
                <span class="text-[10px] font-black uppercase">Marketplace Rules & Guidelines</span>
            </div>
            <i data-lucide="chevron-right" size="16" class="text-[var(--dim)]"></i>
        </div>

        <!-- Registration Form (shown only for new/pending/declined) -->
        <div id="reg-form" class="space-y-4">
            <!-- ... existing form fields ... -->
            <div>
                <label class="text-[8px] font-black uppercase text-[var(--dim)] ml-2 mb-1 block">Business Identity</label>
                <input type="text" id="bizName" placeholder="Shop Name" class="input-zinc" oninput="updatePreview()">
            </div>
            <div>
                <label class="text-[8px] font-black uppercase text-[var(--dim)] ml-2 mb-1 block">Category</label>
                <select id="bizCat" class="input-zinc appearance-none" onchange="handleCategoryChange()">
                    <option value="">Select Niche</option>
                    <option value="Fashion">Fashion & Style</option>
                    <option value="Electronics">Tech & Gadgets</option>
                    <option value="Food">Food & Groceries</option>
                    <option value="Services">Professional Services</option>
                    <option value="Health">Health & Beauty</option>
                    <option value="Home">Home & Decor</option>
                    <option value="Education">Educational Materials</option>
                    <option value="Other">Other (Type below)</option>
                </select>
            </div>
            <div id="customCatDiv" class="hidden">
                <input type="text" id="customCat" placeholder="Type your category..." class="input-zinc" oninput="updatePreview()">
            </div>
            <div class="space-y-3">
                <label class="text-[8px] font-black uppercase text-[var(--dim)] ml-2 block">Choose Merchant Plan</label>
                <div id="plan-container" class="grid grid-cols-1 gap-3">
                    <p class="text-xs opacity-50 p-4 font-bold uppercase">Fetching rates...</p>
                </div>
            </div>

            <!-- MANUAL PAYMENT METHOD -->
            <div class="glass-card p-6 space-y-4 mt-4">
                <div class="flex items-center gap-3 border-b border-[var(--border)] pb-3">
                    <i data-lucide="credit-card" size="18" class="text-sdel"></i>
                    <span class="font-black uppercase text-xs">Manual Payment (OPay)</span>
                </div>
                <div class="bg-black/20 p-4 rounded-2xl border border-[var(--border)] space-y-2">
                    <p class="text-sm font-bold flex justify-between"><span>Account name:</span> <span class="text-sdel">PETER PHILIP</span></p>
                    <p class="text-sm font-bold flex justify-between"><span>Account number:</span> <span class="text-sdel">7084174994</span></p>
                    <p class="text-sm font-bold flex justify-between"><span>Bank name:</span> <span class="text-sdel">OPay</span></p>
                    <p class="text-sm font-bold flex justify-between"><span>Amount:</span> <span class="text-sdel" id="displayAmount">₦0</span></p>
                </div>

                <!-- Payment ID field -->
                <div>
                    <label class="text-[8px] font-black uppercase text-[var(--dim)] ml-2 mb-1 block">Payment ID / Reference</label>
                    <input type="text" id="paymentRef" placeholder="e.g., OPay transaction ID" class="input-zinc">
                </div>

                <!-- Confirmation checkbox -->
                <label class="flex items-center gap-3 cursor-pointer mt-2">
                    <input type="checkbox" id="payConfirmCheck" class="w-5 h-5 accent-sdel">
                    <span class="text-xs font-bold uppercase">I confirm that I have paid</span>
                </label>

                <!-- Button to open banking app -->
                <button onclick="openBankingApp()" class="w-full bg-[#0A5CFF] text-white py-4 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg flex items-center justify-center gap-2">
                    <i data-lucide="smartphone" size="16"></i> Pay with Bank
                </button>
            </div>

            <button onclick="registerVendor()" id="regBtn" class="w-full bg-[#FF6600] text-white py-6 rounded-[2rem] font-black uppercase text-xs tracking-[0.2em] shadow-2xl shadow-sdel/30 active:scale-95 transition-all mt-6">
                Launch My Shop
            </button>
        </div>

        <!-- Status View (shown when user has a shop) -->
        <div id="status-view" class="hidden space-y-6">
            <!-- This will be dynamically filled based on status -->
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let selectedPrice = 0;
        let selectedTierId = "";

        // Rules Modal Functions
        window.showRulesModal = () => {
            document.getElementById('rulesModal').classList.remove('hidden');
            lucide.createIcons();
        }

        window.hideRulesModal = () => {
            document.getElementById('rulesModal').classList.add('hidden');
        }

        // GLOBAL FUNCTION TO OPEN BANKING APP
        window.openBankingApp = () => {
            const amount = selectedPrice || 0;
            if (amount === 0) {
                showAlert("Please select a plan first");
                return;
            }
            const account = "7084174994";
            const accountName = "PETER PHILIP";
            const bank = "OPay";
            const note = encodeURIComponent("Sdel merchant fee payment");
            
            const deepLink = `intent://pay?account=${account}&amount=${amount}&bank=${bank}&note=${note}#Intent;scheme=bank;package=com.opay.agent;end;`;
            
            navigator.clipboard.writeText(`Account Name: PETER PHILIP\nAccount: 7084174994\nAmount: ₦${amount}\nBank: OPay`).then(() => {
                showAlert("Account details copied! Opening banking apps...");
            }).catch(() => {});

            window.location.href = deepLink;
            
            setTimeout(() => {
                showAlert("If bank app didn't open, paste details manually.");
            }, 500);
        };

        // CHECK VENDOR STATUS AND SHOW APPROPRIATE MESSAGE
        async function checkVendorStatus() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                return false;
            }

            const { data: vendor } = await supabase.from('vendors').select('*').eq('user_id', session.user.id).single();

            if (vendor) {
                // Hide form
                document.getElementById('reg-form').classList.add('hidden');
                
                const statusView = document.getElementById('status-view');
                statusView.classList.remove('hidden');

            // Clear and set appropriate status message
                if (vendor.status === 'verified') {
                    statusView.innerHTML = `
                        <div class="glass-card p-10 space-y-4">
                            <div class="w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mx-auto text-green-500">
                                <i data-lucide="check-circle" size="40"></i>
                            </div>
                            <h2 class="text-2xl font-black uppercase tracking-tighter">Verified!</h2>
                            <p class="text-xs text-[var(--dim)] font-bold uppercase tracking-widest leading-relaxed">
                                Your shop is live! Redirecting to dashboard...
                            </p>
                        </div>
                    `;
                    lucide.createIcons();
                    setTimeout(() => {
                        window.location.href = 'vendor_dashboard.html';
                    }, 1500);
                    
                } else if (vendor.status === 'fraud') {
                    statusView.innerHTML = `
                        <div class="violation-card">
                            <div class="violation-icon fraud-icon">
                                <i data-lucide="alert-octagon" size="30"></i>
                            </div>
                            <h2 class="violation-title">Fraud Detected</h2>
                            <p class="violation-message">You've been penalized for submitting an invalid payment reference.</p>
                            <div onclick="showRulesModal()" class="rules-link">
                                <i data-lucide="scroll-text" size="14"></i>
                                <span>View Marketplace Rules</span>
                            </div>
                            <button onclick="location.reload()" class="w-full bg-sdel/10 text-sdel py-4 rounded-2xl font-black uppercase text-xs">
                                Contact Support
                            </button>
                        </div>
                    `;
                    
                } else if (vendor.status === 'suspended') {
                    statusView.innerHTML = `
                        <div class="violation-card">
                            <div class="violation-icon suspended-icon">
                                <i data-lucide="alert-circle" size="30"></i>
                            </div>
                            <h2 class="violation-title">Shop Suspended</h2>
                            <p class="violation-message">Your shop has been suspended for violating marketplace rules.</p>
                            <div onclick="showRulesModal()" class="rules-link">
                                <i data-lucide="scroll-text" size="14"></i>
                                <span>View Violation Details</span>
                            </div>
                            <button onclick="location.reload()" class="w-full bg-sdel/10 text-sdel py-4 rounded-2xl font-black uppercase text-xs">
                                Appeal Suspension
                            </button>
                        </div>
                    `;
                    
                } else if (vendor.status === 'deleted_permanently') {
                    statusView.innerHTML = `
                        <div class="violation-card">
                            <div class="violation-icon deleted-icon">
                                <i data-lucide="trash-2" size="30"></i>
                            </div>
                            <h2 class="violation-title">Shop Deleted</h2>
                            <p class="violation-message">Your shop violated our terms and has been permanently removed.</p>
                            <div onclick="showRulesModal()" class="rules-link">
                                <i data-lucide="scroll-text" size="14"></i>
                                <span>Read Terms & Conditions</span>
                            </div>
                            <button onclick="reapply()" class="w-full bg-sdel text-white py-4 rounded-2xl font-black uppercase text-xs mt-4">
                                Apply for New Shop
                            </button>
                        </div>
                    `;
                    
                } else if (vendor.status === 'declined') {
                    statusView.innerHTML = `
                        <div class="glass-card p-10 space-y-4">
                            <div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto text-red-500">
                                <i data-lucide="x-circle" size="40"></i>
                            </div>
                            <h2 class="text-2xl font-black uppercase tracking-tighter">Shop Rejected</h2>
                            <p class="text-xs text-[var(--dim)] font-bold uppercase tracking-widest leading-relaxed">
                                Your application was declined. Please review your details and try again.
                            </p>
                            <button onclick="reapply()" class="w-full border border-sdel text-sdel py-4 rounded-2xl font-black uppercase text-[10px]">
                                Try Again
                            </button>
                        </div>
                    `;
                    
                } else if (vendor.status === 'pending') {
                    statusView.innerHTML = `
                        <div class="glass-card p-10 space-y-4">
                            <div class="w-20 h-20 bg-sdel/10 rounded-full flex items-center justify-center mx-auto text-sdel">
                                <i data-lucide="clock-4" size="40"></i>
                            </div>
                            <h2 class="text-2xl font-black uppercase tracking-tighter">Under Review</h2>
                            <p class="text-xs text-[var(--dim)] font-bold uppercase tracking-widest leading-relaxed">
                                We'll review your application and payment reference: ${vendor.payment_ref || 'N/A'}
                            </p>
                            <div class="bg-black/20 p-3 rounded-xl text-[9px] font-bold">
                                Payment ID: <span class="text-sdel">${vendor.payment_ref || 'Not provided'}</span>
                            </div>
                        </div>
                    `;
                }
                
                lucide.createIcons();
                return true;
            }
            return false;
        }

        window.reapply = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            const { error } = await supabase.from('vendors').delete().eq('user_id', session.user.id);
            if (!error) location.reload();
            else showAlert("Action failed. Try again later.");
        }

        async function loadPlans() {
            const { data: configs } = await supabase.from('app_config').select('*').filter('id', 'ilike', 'vendor_%').order('price', { ascending: true });
            const cont = document.getElementById('plan-container');
            if (configs && configs.length > 0) {
                cont.innerHTML = configs.map(c => `
                    <div class="plan-card p-5 flex justify-between items-center" id="card-${c.id}" onclick="selectPlan('${c.id}', ${c.price})">
                        <div><p class="font-black uppercase text-xs tracking-tight">${c.description}</p></div>
                        <p class="text-sdel font-black text-sm">₦${c.price.toLocaleString()}</p>
                    </div>
                `).join('');
                selectPlan(configs[0].id, configs[0].price);
                document.getElementById('displayAmount').innerText = '₦' + configs[0].price.toLocaleString();
            }
        }

        window.showAlert = (msg) => {
            const box = document.getElementById('custom-alert');
            document.getElementById('alert-msg').innerText = msg;
            box.style.display = 'flex';
            setTimeout(() => { box.style.display = 'none'; }, 3500);
        }

        window.handleCategoryChange = () => {
            const val = document.getElementById('bizCat').value;
            const customDiv = document.getElementById('customCatDiv');
            if (val === 'Other') customDiv.classList.remove('hidden');
            else customDiv.classList.add('hidden');
            updatePreview();
        }

        window.selectPlan = (id, price) => {
            selectedPrice = price;
            selectedTierId = id;
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${id}`).classList.add('active');
            document.getElementById('displayAmount').innerText = '₦' + price.toLocaleString();
        }

        window.updatePreview = () => {
            document.getElementById('previewName').innerText = document.getElementById('bizName').value || "Your Business Name";
            const mainCat = document.getElementById('bizCat').value;
            const customCat = document.getElementById('customCat').value;
            document.getElementById('previewCat').innerText = (mainCat === 'Other' ? customCat : mainCat) || "Select Category";
        }

        window.registerVendor = async () => {
            const btn = document.getElementById('regBtn');
            const biz = document.getElementById('bizName').value;
            let cat = document.getElementById('bizCat').value;
            if(cat === 'Other') cat = document.getElementById('customCat').value;
            if(!biz || !cat) return showAlert("Missing shop details, homie!");
            
            const paymentRef = document.getElementById('paymentRef').value;
            const confirmPaid = document.getElementById('payConfirmCheck').checked;
            
            if (!confirmPaid) {
                showAlert("Please confirm you have paid (checkbox)");
                return;
            }
            if (!paymentRef) {
                showAlert("Please enter payment reference ID");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Connecting...";
            const { data: { session } } = await supabase.auth.getSession();
            if(!session) return window.location.href = 'login.html';
            
            const { error } = await supabase.from('vendors').insert({
                user_id: session.user.id,
                business_name: biz,
                category: cat,
                tier_id: selectedTierId,
                fee_paid: selectedPrice,
                status: 'pending',
                payment_ref: paymentRef
            });
            
            if(!error) {
                showAlert("Application Sent Successfully");
                setTimeout(() => location.reload(), 1500);
            } else {
                if(error.code === '23505') showAlert("You already have a shop registered!");
                else if(error.message.includes('payment_ref')) showAlert("Payment ref column missing. Contact admin.");
                else showAlert(error.message);
                btn.disabled = false;
                btn.innerText = "Launch My Shop";
            }
        };

        async function init() {
            await loadPlans();
            const hasShop = await checkVendorStatus();
            if (!hasShop) {
                document.getElementById('reg-form').classList.remove('hidden');
                document.getElementById('status-view').classList.add('hidden');
            }
            lucide.createIcons();
        }
        init();
    </script>
</body>
</html>
