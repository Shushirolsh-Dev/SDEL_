<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'sunlight') {
                document.documentElement.classList.add('sunlight-mode');
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sdel | Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        html { opacity: 0; transition: opacity 0.3s ease; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { background-color: #000; color: white; overflow-x: hidden; transition: background-color 0.3s, color 0.3s; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-zinc { background: rgba(18, 18, 18, 0.7); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); position: relative; z-index: 10; transition: all 0.3s; }
        nav { background: rgba(0,0,0,0.9); transition: background-color 0.3s; }
        .bottom-nav { background: rgba(0,0,0,0.95); border-top: 1px solid rgba(255,255,255,0.1); }

        .sunlight-mode body { background-color: #ffffff; color: #121212; }
        .sunlight-mode nav { background: rgba(255,255,255,0.95); }
        .sunlight-mode .card-zinc { background: #f4f4f5; border: 2px solid #e4e4e7; color: #121212; }
        .sunlight-mode .bottom-nav { background: #ffffff; border-top: 2px solid #e4e4e7; }
        .sunlight-mode .bottom-nav i { color: #000000; } /* Changed to black for inactive icons */
        .sunlight-mode .bottom-nav i.text-sdel { color: #FF6600; } /* Keep active icon orange */
        .sunlight-mode .stars { display: none; }
        
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        .star { position: absolute; background-color: rgba(255,255,255,0.6); border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { from { transform: translateY(-10vh); } to { transform: translateY(110vh); } }

        .modal-overlay { backdrop-filter: blur(25px); z-index: 200; position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; padding: 24px; overflow-y: auto; }
        .input-zinc { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; width: 100%; padding: 16px; border-radius: 16px; font-size: 14px; outline: none; }
        .warning-box { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); border-radius: 16px; padding: 16px; margin-bottom: 20px; }
    </style>
</head>
<body class="pb-32">

    <div class="stars" id="stars"></div>

    <nav class="p-6 flex items-center justify-between sticky top-0 backdrop-blur-md z-50">
        <button onclick="history.back()" class="text-white bg-transparent border-none outline-none cursor-pointer">
            <i data-lucide="chevron-left"></i>
        </button>
        <h1 class="text-lg font-black uppercase tracking-tighter">My <span class="text-sdel">Account</span></h1>
        <button id="theme-toggle" class="text-gray-500 hover:text-sdel transition">
            <i data-lucide="sun" id="theme-icon" size="24"></i>
        </button>
    </nav>

    <main class="p-6 space-y-8">
        <div class="flex flex-col items-center text-center space-y-4">
            <div id="p-initials" class="w-24 h-24 rounded-full bg-zinc-900 border-4 border-zinc-800 flex items-center justify-center text-3xl font-black text-sdel uppercase">--</div>
            <div>
                <h2 id="p-full-name" class="text-2xl font-black uppercase tracking-tight italic">Loading...</h2>
                <p id="p-email" class="text-gray-500 text-xs font-bold uppercase tracking-widest">---</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="card-zinc p-5 rounded-3xl text-center">
                <p class="text-[9px] font-black uppercase text-gray-500 mb-1">Balance</p>
                <p id="p-balance" class="text-xl font-black italic">₦0</p>
            </div>
            <div class="card-zinc p-5 rounded-3xl text-center">
                <p class="text-[9px] font-black uppercase text-gray-500 mb-1">Status</p>
                <p class="text-xl font-black italic text-green-500">Active</p>
            </div>
        </div>

        <div class="space-y-3">
            <h3 class="text-[10px] font-black uppercase text-gray-500 tracking-widest px-2">Settings</h3>
            <div onclick="openModal('edit-modal')" class="card-zinc p-4 rounded-3xl flex items-center justify-between cursor-pointer hover:border-sdel/50 transition">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-zinc-900 rounded-full flex items-center justify-center text-sdel"><i data-lucide="user" size="18"></i></div>
                    <span class="text-sm font-bold uppercase">Personal Info</span>
                </div>
                <i data-lucide="chevron-right" class="text-gray-600"></i>
            </div>
            <div onclick="openModal('security-modal')" class="card-zinc p-4 rounded-3xl flex items-center justify-between cursor-pointer hover:border-sdel/50 transition">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-zinc-900 rounded-full flex items-center justify-center text-blue-500"><i data-lucide="shield-check" size="18"></i></div>
                    <span class="text-sm font-bold uppercase">Security</span>
                </div>
                <i data-lucide="chevron-right" class="text-gray-600"></i>
            </div>
        </div>

        <div class="space-y-4 pt-4">
            <button id="logout-btn" class="w-full bg-zinc-900 text-red-500 py-4 rounded-3xl font-black uppercase text-[10px] tracking-widest border border-red-500/20 hover:bg-red-500 hover:text-white transition">Sign Out</button>
            <button onclick="openDeleteModal()" class="w-full text-zinc-600 py-2 font-bold uppercase text-[9px] tracking-[0.2em] hover:text-red-600 transition">Delete Account Forever</button>
        </div>
    </main>

    <div id="edit-modal" class="modal-overlay">
        <div class="flex justify-between items-center mb-8 relative z-10">
            <h2 class="text-xl font-black uppercase italic">Edit <span class="text-sdel">Profile</span></h2>
            <button onclick="closeModal('edit-modal')" class="text-white"><i data-lucide="x"></i></button>
        </div>
        <div class="space-y-4 relative z-10">
            <input id="edit-fname" type="text" class="input-zinc" placeholder="First Name">
            <input id="edit-lname" type="text" class="input-zinc" placeholder="Last Name">
            <button id="save-btn" class="w-full bg-sdel text-black py-4 rounded-2xl font-black text-xs">Save</button>
        </div>
    </div>

    <div id="security-modal" class="modal-overlay">
        <div class="flex justify-between items-center mb-8 relative z-10">
            <h2 class="text-xl font-black uppercase italic">Update <span class="text-sdel">Security</span></h2>
            <button onclick="closeModal('security-modal')" class="text-white"><i data-lucide="x"></i></button>
        </div>
        <div class="space-y-4 relative z-10">
            <input id="new-pass" type="password" class="input-zinc" placeholder="New Password">
            <button id="pass-btn" class="w-full bg-sdel text-black py-4 rounded-2xl font-black text-xs">Update</button>
        </div>
    </div>

    <nav class="fixed bottom-0 inset-x-0 p-5 flex justify-around items-center bottom-nav z-[100]">
        <i data-lucide="home" class="opacity-40" onclick="location.href='dashboard.html'"></i>
        <i data-lucide="compass" class="opacity-40" onclick="location.href='explore.html'"></i>
        <div class="bg-sdel h-14 w-14 rounded-2xl flex items-center justify-center -mt-12 shadow-2xl border-4 border-black" onclick="location.href='post-story.html'">
            <i data-lucide="camera" class="text-black" size="28"></i>
        </div>
        <i data-lucide="shopping-cart" class="opacity-40" onclick="location.href='market.html'"></i>
        <i data-lucide="user" class="text-sdel" size="28"></i>
    </nav>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let currentUser = null;
        let userProfile = null;

        const themeBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        
        function updateThemeUI() {
            const isSunlight = localStorage.getItem('theme') === 'sunlight';
            if (isSunlight) {
                document.documentElement.classList.add('sunlight-mode');
                themeIcon.setAttribute('data-lucide', 'moon');
            } else {
                document.documentElement.classList.remove('sunlight-mode');
                themeIcon.setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();
        }

        themeBtn.addEventListener('click', () => {
            const currentlySunlight = localStorage.getItem('theme') === 'sunlight';
            localStorage.setItem('theme', currentlySunlight ? 'dark' : 'sunlight');
            updateThemeUI();
        });

        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = star.style.height = (Math.random() * 2 + 1) + 'px';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh'; 
                star.style.animationDuration = (Math.random() * 30 + 40) + 's';
                star.style.animationDelay = '-' + (Math.random() * 50) + 's'; 
                container.appendChild(star);
            }
        }

        updateThemeUI();
        createStars();

        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.replace('login.html'); }
            else { 
                document.documentElement.style.opacity = "1";
                currentUser = session.user;
                loadProfile(); 
            }
        }

        async function loadProfile() {
            const { data: profile } = await supabase.from('profile').select('*').eq('id', currentUser.id).single();
            if (!profile) return;
            userProfile = profile;
            document.getElementById('p-full-name').innerText = (profile.first_name || "User") + " " + (profile.last_name || "");
            document.getElementById('p-email').innerText = currentUser.email;
            document.getElementById('p-balance').innerText = `₦${(profile.wallet_balance || 0).toLocaleString()}`;
            document.getElementById('p-initials').innerText = (profile.first_name?.[0] || "U").toUpperCase();
        }

        window.openModal = (id) => document.getElementById(id).style.display = 'block';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        document.getElementById('logout-btn').addEventListener('click', () => supabase.auth.signOut().then(() => window.location.replace('login.html')));

        // Delete Account Functionality
        window.openDeleteModal = () => {
            if (!document.getElementById('delete-modal')) {
                const deleteModal = document.createElement('div');
                deleteModal.id = 'delete-modal';
                deleteModal.className = 'modal-overlay';
                deleteModal.innerHTML = `
                    <div class="flex justify-between items-center mb-6 relative z-10">
                        <h2 class="text-2xl font-black uppercase italic text-red-500">Delete <span class="text-white">Account</span></h2>
                        <button onclick="closeDeleteModal()" class="text-white"><i data-lucide="x" size="28"></i></button>
                    </div>
                    <div class="space-y-5 relative z-10">
                        <div class="warning-box">
                            <p class="text-red-500 text-xs font-black uppercase mb-2">⚠️ CRITICAL ACTION</p>
                            <p class="text-white/80 text-sm font-bold mb-1">Current Balance: <span class="text-sdel text-lg" id="delete-balance">₦0</span></p>
                            <p class="text-white/60 text-[10px] font-bold uppercase tracking-wider">This balance will be PERMANENTLY LOST</p>
                        </div>
                        
                        <div class="bg-black/40 p-5 rounded-2xl border border-white/10">
                            <p class="text-white/80 text-[11px] font-bold uppercase mb-4 leading-relaxed">
                                By deleting your account, you acknowledge that:
                            </p>
                            <ul class="text-white/60 text-[10px] font-bold uppercase space-y-3 mb-4">
                                <li class="flex items-start gap-2">• All personal data will be permanently erased</li>
                                <li class="flex items-start gap-2">• Your wallet balance (₦<span id="delete-balance-list">0</span>) will be forfeited</li>
                                <li class="flex items-start gap-2">• This action is irreversible and cannot be undone</li>
                                <li class="flex items-start gap-2">• You will lose access to all purchases and content</li>
                            </ul>
                        </div>

                        <div class="mt-6">
                            <p class="text-white/40 text-[9px] font-bold uppercase mb-2">Confirm by entering your password</p>
                            <input id="delete-password" type="password" class="input-zinc mb-3" placeholder="Enter your password">
                            <div id="delete-error" class="text-red-500 text-[10px] font-bold uppercase mb-3 hidden">Incorrect password</div>
                            <button id="confirm-delete-btn" class="w-full bg-red-600 text-white py-5 rounded-2xl font-black text-sm uppercase tracking-wider hover:bg-red-700 transition">Permanently Delete Account</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(deleteModal);
                lucide.createIcons();
            }
            
            // Update balance in delete modal
            const balance = userProfile?.wallet_balance || 0;
            document.getElementById('delete-balance') && (document.getElementById('delete-balance').innerText = `₦${balance.toLocaleString()}`);
            document.getElementById('delete-balance-list') && (document.getElementById('delete-balance-list').innerText = balance.toLocaleString());
            
            document.getElementById('delete-modal').style.display = 'block';
        }

        window.closeDeleteModal = () => {
            document.getElementById('delete-modal').style.display = 'none';
            document.getElementById('delete-password') && (document.getElementById('delete-password').value = '');
            document.getElementById('delete-error')?.classList.add('hidden');
        }

        // Handle delete confirmation
        document.addEventListener('click', async (e) => {
            if (e.target.id === 'confirm-delete-btn') {
                const password = document.getElementById('delete-password').value;
                const errorEl = document.getElementById('delete-error');
                
                if (!password) {
                    errorEl.innerText = 'Password is required';
                    errorEl.classList.remove('hidden');
                    return;
                }

                e.target.disabled = true;
                e.target.innerText = 'VERIFYING...';

                try {
                    // Verify password by attempting to sign in
                    const { error: signInError } = await supabase.auth.signInWithPassword({
                        email: currentUser.email,
                        password: password
                    });

                    if (signInError) {
                        errorEl.innerText = 'Incorrect password';
                        errorEl.classList.remove('hidden');
                        e.target.disabled = false;
                        e.target.innerText = 'Permanently Delete Account';
                        return;
                    }

                    e.target.innerText = 'DELETING...';

                    // Delete profile data
                    const { error: profileError } = await supabase
                        .from('profile')
                        .delete()
                        .eq('id', currentUser.id);

                    if (profileError) throw profileError;

                    // Delete auth user (requires admin - may need RLS)
                    const { error: deleteError } = await supabase.rpc('delete_user');
                    
                    if (deleteError) {
                        console.warn('Auth delete warning:', deleteError);
                    }

                    // Sign out
                    await supabase.auth.signOut();
                    
                    // Redirect to goodbye page or login
                    window.location.replace('login.html?deleted=true');
                    
                } catch (error) {
                    console.error('Delete error:', error);
                    errorEl.innerText = 'Error deleting account. Contact support.';
                    errorEl.classList.remove('hidden');
                    e.target.disabled = false;
                    e.target.innerText = 'Permanently Delete Account';
                }
            }
        });

        checkSession();
        lucide.createIcons();
    </script>
</body>
</html>
