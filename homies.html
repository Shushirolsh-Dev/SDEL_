<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // ANTI-FLICKER: Apply theme immediately
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'sunlight') {
                document.documentElement.classList.add('sunlight-mode');
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sdel | Homies</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        /* Default Dark Theme */
        body { background-color: #000; color: #fff; overflow-x: hidden; width: 100vw; height: 100%; -webkit-user-select: none; user-select: none; transition: background-color 0.3s; }
        nav { background-color: rgba(0,0,0,0.95); }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .header-text { font-weight: 800; letter-spacing: -0.01em; }
        .tab-active { color: #FF6600; border-bottom: 3px solid #FF6600; }
        #main-content { height: calc(100vh - 310px); overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 80px; }
        .tab-badge { background: #FF6600; color: black; font-size: 8px; padding: 1px 5px; border-radius: 4px; margin-left: 4px; vertical-align: middle; display: none; }
        
        /* Sunlight Mode */
        .sunlight-mode body { background-color: #ffffff; color: #121212; }
        .sunlight-mode nav { background-color: #ffffff; border-bottom: 1px solid #e4e4e7; }
        .sunlight-mode .bg-zinc-900 { background-color: #f4f4f5; border: 1px solid #d4d4d8; }
        .sunlight-mode .text-white { color: #121212; }
        .sunlight-mode .text-zinc-500, .sunlight-mode .text-zinc-600, .sunlight-mode .text-zinc-700 { color: #71717a; }
        .sunlight-mode .border-white\/5 { border-color: #e4e4e7; }
        .sunlight-mode .dropdown-menu { background: #ffffff; border: 2px solid #e4e4e7; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .sunlight-mode .menu-item { color: #121212; border-bottom: 1px solid #f4f4f5; }

        @keyframes full-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .rotate-icon { animation: full-rotate 4s linear infinite; }
        
        /* Updated Dropdown: Bigger and more accessible */
        .dropdown-menu { display: none; position: absolute; right: 10px; top: 50px; background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; z-index: 100; box-shadow: 0 15px 35px rgba(0,0,0,0.8); min-width: 180px; }
        .dropdown-menu.active { display: block; }
        .menu-item { padding: 18px 24px; font-size: 12px; font-weight: 900; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .menu-item:last-child { border-bottom: none; }

        #sdel-alert { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .alert-box { background: #111; border: 1px solid rgba(255,102,0,0.3); border-radius: 24px; width: 100%; max-width: 320px; padding: 30px; text-align: center; }
    </style>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://lgfyrlfjoazedwymjpfc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw');

        let currentUserId = null;
        let activeTab = 'general';
        let allConnections = [];
        let restrictions = [];

        window.showAlert = (msg, type = 'alert', onConfirm = null) => {
            const container = document.getElementById('sdel-alert');
            const messageEl = document.getElementById('alert-message');
            const actionsEl = document.getElementById('alert-actions');
            messageEl.innerText = msg;
            actionsEl.innerHTML = '';
            if (type === 'confirm') {
                actionsEl.innerHTML = `<button onclick="document.getElementById('sdel-alert').style.display='none'" class="flex-1 py-3 text-[10px] font-black uppercase text-zinc-500">Cancel</button>
                    <button id="alert-confirm-btn" class="flex-1 py-3 bg-sdel text-black rounded-xl text-[10px] font-black uppercase">Confirm</button>`;
                document.getElementById('alert-confirm-btn').onclick = () => { container.style.display = 'none'; if (onConfirm) onConfirm(); };
            } else {
                actionsEl.innerHTML = `<button onclick="document.getElementById('sdel-alert').style.display='none'" class="w-full py-3 bg-sdel text-black rounded-xl text-[10px] font-black uppercase">Understood</button>`;
            }
            container.style.display = 'flex';
        };

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return window.location.href = 'login.html';
            currentUserId = session.user.id;
            
            applyThemeUI();

            supabase.channel('homies-sync')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'dm_table' }, () => updateBadges().then(loadContent))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'connections' }, () => updateBadges().then(loadContent))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'user_limits' }, () => loadContent())
                .subscribe();

            updateBadges();
            switchTab('general');
        }

        function applyThemeUI() {
            if (localStorage.getItem('theme') === 'sunlight') {
                document.documentElement.classList.add('sunlight-mode');
            } else {
                document.documentElement.classList.remove('sunlight-mode');
            }
        }

        async function updateBadges() {
            const { count: unreadCount } = await supabase.from('dm_table').select('*', { count: 'exact', head: true }).eq('receiver_id', currentUserId).eq('is_read', false);
            const { count: reqCount } = await supabase.from('connections').select('*', { count: 'exact', head: true }).eq('receiver_id', currentUserId).eq('status', 'pending');
            const ub = document.getElementById('unread-count-badge');
            ub.innerText = unreadCount > 9 ? '9+' : unreadCount;
            ub.style.display = unreadCount > 0 ? 'inline-block' : 'none';
            const rb = document.getElementById('req-count-badge');
            rb.innerText = reqCount;
            rb.style.display = reqCount > 0 ? 'inline-block' : 'none';
        }

        async function loadContent() {
            const { data: restData } = await supabase.from('user_limits').select('*').or(`actor_id.eq.${currentUserId},target_id.eq.${currentUserId}`);
            restrictions = restData || [];
            if (activeTab === 'general' || activeTab === 'unread') {
                const { data: connections } = await supabase.from('connections').select('*, sender:profile!sender_id(*), receiver:profile!receiver_id(*)').eq('status', 'accepted').or(`sender_id.eq.${currentUserId},receiver_id.eq.${currentUserId}`);
                if (!connections || connections.length === 0) return renderChats([]);
                const chatData = await Promise.all(connections.map(async (c) => {
                    const partner = c.sender_id === currentUserId ? c.receiver : c.sender;
                    const { data: lastMsg } = await supabase.from('dm_table').select('*').or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${partner.id}),and(sender_id.eq.${partner.id},receiver_id.eq.${currentUserId})`).order('created_at', { ascending: false }).limit(1).maybeSingle();
                    const { count: unread } = await supabase.from('dm_table').select('*', { count: 'exact', head: true }).eq('sender_id', partner.id).eq('receiver_id', currentUserId).eq('is_read', false);
                    const isRestricted = restrictions.some(r => (r.actor_id === currentUserId && r.target_id === partner.id) || (r.actor_id === partner.id && r.target_id === currentUserId));
                    const amIActor = restrictions.some(r => r.actor_id === currentUserId && r.target_id === partner.id);
                    return { ...c, partner, lastMsg, unreadCount: unread || 0, isRestricted, amIActor };
                }));
                const activeChats = chatData.filter(c => {
                    if (activeTab === 'unread') return c.unreadCount > 0;
                    return c.lastMsg !== null || activeTab === 'general';
                });
                activeChats.sort((a, b) => (new Date(b.lastMsg?.created_at || 0)) - (new Date(a.lastMsg?.created_at || 0)));
                allConnections = activeChats;
                renderChats(allConnections);
            } else if (activeTab === 'requests') {
                const { data } = await supabase.from('connections').select('*, sender:profile!sender_id(*)').eq('receiver_id', currentUserId).eq('status', 'pending');
                renderRequests(data || []);
            }
        }

        window.searchMaster = (val) => {
            if (activeTab !== 'general') return;
            const trigger = document.getElementById('public-search-trigger');
            if (val.length < 1) { trigger.classList.add('hidden'); renderChats(allConnections); return; }
            trigger.classList.remove('hidden');
            const filtered = allConnections.filter(c => `${c.partner.first_name} ${c.partner.last_name} ${c.partner.username}`.toLowerCase().includes(val.toLowerCase()));
            if (filtered.length > 0) { renderChats(filtered); } 
            else { document.getElementById('main-content').innerHTML = `<div class="p-10 text-center text-zinc-600 text-[10px] font-black uppercase">No Homies match. Try Global Search.</div>`; }
        };

        window.searchPublic = async () => {
            const val = document.getElementById('search-input').value;
            const container = document.getElementById('main-content');
            container.innerHTML = `<p class="p-10 text-center text-sdel animate-pulse text-[10px] font-black uppercase">Scanning Sdel Grid...</p>`;
            const { data: users } = await supabase.from('profile').select('*').neq('id', currentUserId).or(`first_name.ilike.%${val}%,last_name.ilike.%${val}%,username.ilike.%${val}%`).limit(15);
            if (!users?.length) { container.innerHTML = `<div class="p-10 text-center text-zinc-500 font-black text-[10px] uppercase">No Grid Results</div>`; return; }
            const { data: conn } = await supabase.from('connections').select('*').or(`sender_id.eq.${currentUserId},receiver_id.eq.${currentUserId}`);
            container.innerHTML = users.map(u => {
                const rel = conn?.find(c => c.sender_id === u.id || c.receiver_id === u.id);
                let btn = `<button onclick="sendRequest('${u.id}')" class="bg-white text-black text-[10px] font-black px-4 py-1.5 rounded-full uppercase">Add</button>`;
                let action = ''; 
                if (rel?.status === 'pending') { btn = `<span class="text-[9px] font-black text-zinc-500 uppercase">Sent</span>`; } 
                else if (rel?.status === 'accepted') { btn = `<span class="text-[9px] font-black text-sdel uppercase">Homie</span>`; action = `onclick="openChat('${u.id}', false)"`; }
                return `<div class="flex justify-between items-center p-5 border-b border-white/5 active:bg-zinc-900/50 cursor-pointer" ${action}>
                    <div class="flex items-center space-x-4">
                        <div class="w-11 h-11 rounded-xl bg-zinc-900 border border-white/10 flex items-center justify-center text-sdel font-black">${u.first_name[0]}</div>
                        <div><p class="text-sm font-bold text-white uppercase">${u.first_name} ${u.last_name}</p><p class="text-[10px] text-zinc-500 font-medium">@${u.username}</p></div>
                    </div>
                    ${btn}
                </div>`;
            }).join('');
        };

        window.sendRequest = async (id) => { await supabase.from('connections').insert({ sender_id: currentUserId, receiver_id: id, status: 'pending' }); loadContent(); };
        window.handleRequest = async (connectionId, status) => { if (status === 'accepted') { await supabase.from('connections').update({ status: 'accepted' }).eq('id', connectionId); switchTab('general'); } else { await supabase.from('connections').delete().eq('id', connectionId); loadContent(); } };
        window.clearChatLocal = async (partnerId) => { window.showAlert("Clear this entire conversation?", 'confirm', async () => { await supabase.from('dm_table').delete().or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${partnerId}),and(sender_id.eq.${partnerId},receiver_id.eq.${currentUserId})`); loadContent(); }); };
        window.handleRestriction = async (partnerId, isRestricted, isOfficial) => { if (isOfficial) { window.showAlert("OFFICIAL ACCOUNT: Protected access."); return; } if (isRestricted) await supabase.from('user_limits').delete().eq('actor_id', currentUserId).eq('target_id', partnerId); else await supabase.from('user_limits').insert({ actor_id: currentUserId, target_id: partnerId }); loadContent(); };
        window.openChat = (partnerId, isRestricted) => { if (isRestricted) { window.showAlert("CHAT LOCKED: Restricted access."); return; } location.href = `dm.html?id=${partnerId}`; };
        
        window.toggleMenu = (e, id) => {
            e.stopPropagation();
            const menu = document.getElementById(`menu-${id}`);
            const isActive = menu.classList.contains('active');
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));
            if (!isActive) menu.classList.add('active');
        };

        function renderChats(connections) {
            const container = document.getElementById('main-content');
            if (!connections || connections.length === 0) { container.innerHTML = `<p class="p-10 text-center text-zinc-500 text-[10px] font-black uppercase">No chats yet</p>`; return; }
            container.innerHTML = connections.map(c => {
                const avatar = c.partner.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${c.partner.first_name}`;
                let cleanMsg = c.lastMsg ? c.lastMsg.content.replace(/Replying to.*?\n/gs, '').trim() : 'Homie Profile';
                return `
                <div class="relative flex items-center p-5 space-x-5 border-b border-white/5 active:bg-zinc-900/50 transition cursor-pointer" onclick="openChat('${c.partner.id}', ${c.isRestricted})">
                    <img src="${avatar}" class="w-14 h-14 rounded-full border-2 border-sdel/20 ${c.isRestricted ? 'grayscale opacity-40' : ''}">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <h3 class="text-base font-bold text-white uppercase truncate">${c.partner.first_name} ${c.partner.last_name}</h3>
                            <div class="flex items-center space-x-3">
                                ${c.isRestricted ? '<i data-lucide="lock" class="text-zinc-600 w-4 h-4"></i>' : (c.unreadCount > 0 ? `<span class="bg-sdel text-black text-[9px] px-2 py-0.5 rounded-full font-black animate-pulse">${c.unreadCount} NEW</span>` : '')}
                                <div class="p-2 -mr-2 active:scale-90" onclick="toggleMenu(event, '${c.partner.id}')">
                                    <i data-lucide="more-vertical" class="text-zinc-600 w-6 h-6"></i>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs ${c.isRestricted ? 'text-zinc-700' : 'text-zinc-500'} truncate mt-0.5 font-medium tracking-tighter">${c.isRestricted ? 'Conversation Locked' : cleanMsg}</p>
                    </div>
                    <div id="menu-${c.partner.id}" class="dropdown-menu" onclick="event.stopPropagation()">
                        <div class="menu-item text-white" onclick="clearChatLocal('${c.partner.id}')">Clear Conversation</div>
                        ${!c.partner.is_official ? `<div class="menu-item ${c.amIActor ? 'text-sdel' : 'text-red-600'}" onclick="handleRestriction('${c.partner.id}', ${c.amIActor}, false)">${c.amIActor ? 'Unlimit Homie' : 'Limit Homie'}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function renderRequests(requests) {
            const container = document.getElementById('main-content');
            if (requests.length === 0) { container.innerHTML = `<p class="p-10 text-center text-zinc-500 text-[10px] font-black uppercase">No pending requests</p>`; return; }
            container.innerHTML = requests.map(r => `
                <div class="flex justify-between items-center p-5 border-b border-white/5">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl bg-zinc-900 border border-white/10 flex items-center justify-center text-sdel font-black text-lg">${r.sender.first_name[0]}</div>
                        <div><p class="text-sm font-bold text-white uppercase">${r.sender.first_name} ${r.sender.last_name}</p><p class="text-[10px] text-zinc-500 font-medium">@${r.sender.username}</p></div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="handleRequest('${r.id}', 'accepted')" class="bg-sdel text-black text-[9px] font-black px-3 py-2 rounded-lg uppercase">Accept</button>
                        <button onclick="handleRequest('${r.id}', 'declined')" class="bg-zinc-800 text-white text-[9px] font-black px-3 py-2 rounded-lg uppercase">Ignore</button>
                    </div>
                </div>`).join('');
        }

        window.switchTab = (tab) => { activeTab = tab; document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active')); document.getElementById(`tab-${tab}`).classList.add('tab-active'); loadContent(); };
        document.addEventListener('click', () => document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active')));
        init();
    </script>
</head>
<body class="pb-24">
    <div id="sdel-alert">
        <div class="alert-box">
            <div class="w-12 h-12 bg-sdel/10 rounded-2xl flex items-center justify-center mx-auto mb-6"><i data-lucide="bell" class="text-sdel"></i></div>
            <p id="alert-message" class="text-xs font-bold uppercase leading-relaxed text-zinc-400 mb-8"></p>
            <div id="alert-actions" class="flex space-x-4"></div>
        </div>
    </div>

    <nav class="p-6 flex justify-between items-center sticky top-0 z-50">
        <h1 class="header-text text-2xl italic uppercase">Homies</h1>
        <i data-lucide="refresh-cw" class="text-zinc-500 rotate-icon" size="24" onclick="location.reload()"></i>
    </nav>

    <div class="flex px-6 border-b border-white/5 bg-transparent sticky top-[80px] z-40">
        <button id="tab-general" onclick="switchTab('general')" class="tab-btn flex-1 py-4 text-[10px] font-black uppercase tab-active">General</button>
        <button id="tab-requests" onclick="switchTab('requests')" class="tab-btn flex-1 py-4 text-[10px] font-black uppercase">Requests <span id="req-count-badge" class="tab-badge"></span></button>
        <button id="tab-unread" onclick="switchTab('unread')" class="tab-btn flex-1 py-4 text-[10px] font-black uppercase">Unread <span id="unread-count-badge" class="tab-badge"></span></button>
    </div>

    <div class="p-5 bg-transparent sticky top-[138px] z-40">
        <div class="bg-zinc-900 rounded-2xl px-6 py-4 flex items-center border border-white/5">
            <input type="text" id="search-input" oninput="searchMaster(this.value)" placeholder="Search Homies..." class="bg-transparent w-full text-sm focus:outline-none text-white font-bold capitalize">
            <i data-lucide="search" class="text-zinc-700" size="20"></i>
        </div>
        <div id="public-search-trigger" onclick="searchPublic()" class="hidden mt-4 p-4 bg-zinc-900/50 rounded-xl border border-white/5 flex justify-between items-center cursor-pointer active:scale-95 transition">
            <span class="text-[10px] font-black text-zinc-400 uppercase tracking-tight">Expand Search: Find on Sdel Grid</span>
            <i data-lucide="arrow-right" class="text-sdel" size="16"></i>
        </div>
    </div>

    <main id="main-content" class="flex flex-col"></main>

    <nav class="fixed bottom-0 inset-x-0 bg-transparent border-t border-white/10 p-5 flex justify-around items-center z-50">
        <div class="flex flex-col items-center text-sdel" onclick="location.href='homies.html'"><i data-lucide="message-square"></i><span class="text-[8px] font-black uppercase mt-1">Chats</span></div>
        <div class="flex flex-col items-center text-zinc-500" onclick="location.href='explore.html'"><i data-lucide="compass"></i><span class="text-[8px] font-black uppercase mt-1">Explore</span></div>
        <div class="flex flex-col items-center text-zinc-500" onclick="location.href='planets.html'"><i data-lucide="orbit"></i><span class="text-[8px] font-black uppercase mt-1">Planets</span></div>
    </nav>
    <script>lucide.createIcons();</script>
</body>
</html>
