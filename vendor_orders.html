<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdel | Accept / Decline Orders</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: #000; color: white; }
        .text-sdel { color: #FF6600; }
        .bg-sdel { background-color: #FF6600; }
        .card-dark { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 24px; }
        .order-card { background: #111; border: 1px solid #222; border-radius: 28px; transition: 0.2s; }
        .order-card:hover { border-color: #FF6600; }
        .accept-btn { background: white; color: black; font-weight: 700; padding: 16px; border-radius: 20px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; width: 100%; }
        .decline-btn { background: #1a1a1a; color: #ff4444; border: 1px solid #ff444422; font-weight: 700; padding: 16px; border-radius: 20px; font-size: 12px; text-transform: uppercase; width: 100%; }
        .decline-btn:hover { background: #ff444411; }
        .delivery-section { background: rgba(255, 102, 0, 0.05); border: 1px dashed rgba(255, 102, 0, 0.2); border-radius: 18px; padding: 16px; }
        .tab-active { background: #FF6600 !important; color: black !important; }
    </style>
</head>
<body class="p-5 max-w-3xl mx-auto pb-24">

    <!-- Toast notification -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-zinc-900 border border-sdel text-white px-6 py-3 rounded-2xl text-sm font-medium z-50 hidden">✓ Updated</div>

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold tracking-tight">Order <span class="text-sdel">Command</span></h1>
            <p class="text-xs text-zinc-500 mt-1" id="vendorDisplay">Loading vendor panel...</p>
        </div>
        <button onclick="refreshOrders()" class="bg-zinc-900 p-3 rounded-2xl border border-zinc-800">
            <i data-lucide="refresh-cw" size="18" class="text-zinc-400"></i>
        </button>
    </div>

    <!-- Queue stats -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="card-dark p-5">
            <p class="text-xs font-semibold text-zinc-500 uppercase mb-1">Queue size</p>
            <div class="flex items-baseline gap-2">
                <span class="text-3xl font-bold text-white" id="pendingCount">0</span>
                <span class="text-xs text-sdel font-medium">pending</span>
            </div>
        </div>
        <div class="card-dark p-5">
            <p class="text-xs font-semibold text-zinc-500 uppercase mb-1">Total value</p>
            <span class="text-2xl font-bold text-sdel" id="pendingTotal">₦0</span>
        </div>
    </div>

    <!-- Status tabs -->
    <div class="flex p-1 bg-zinc-900 rounded-2xl border border-zinc-800 mb-6">
        <button onclick="switchTab('pending')" id="tabPending" class="flex-1 py-3 text-xs font-bold uppercase rounded-xl transition-all tab-active">Pending</button>
        <button onclick="switchTab('accepted')" id="tabAccepted" class="flex-1 py-3 text-xs font-bold uppercase rounded-xl text-zinc-500">Accepted</button>
        <button onclick="switchTab('rejected')" id="tabRejected" class="flex-1 py-3 text-xs font-bold uppercase rounded-xl text-zinc-500">Declined</button>
    </div>

    <!-- Orders feed -->
    <div id="ordersFeed" class="space-y-4">
        <!-- Loading state -->
        <div class="text-center py-12 text-zinc-600 text-sm font-medium">Loading orders...</div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const supabase = createClient(
            'https://lgfyrlfjoazedwymjpfc.supabase.co', 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnlybGZqb2F6ZWR3eW1qcGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTc1MTksImV4cCI6MjA4MjA5MzUxOX0.g1xVMCtSkkQIu2s1pkvWwxDDvgNGbikAMkyfbZJywVw'
        );

        let currentUserId = null;
        let currentTab = 'pending';

        // Show toast
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.borderColor = isError ? '#ef4444' : '#FF6600';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2500);
        }

        // Switch between tabs
        window.switchTab = (tab) => {
            currentTab = tab;
            
            // Update tab styling
            document.getElementById('tabPending').className = 'flex-1 py-3 text-xs font-bold uppercase rounded-xl transition-all ' + (tab === 'pending' ? 'tab-active' : 'text-zinc-500');
            document.getElementById('tabAccepted').className = 'flex-1 py-3 text-xs font-bold uppercase rounded-xl transition-all ' + (tab === 'accepted' ? 'tab-active' : 'text-zinc-500');
            document.getElementById('tabRejected').className = 'flex-1 py-3 text-xs font-bold uppercase rounded-xl transition-all ' + (tab === 'rejected' ? 'tab-active' : 'text-zinc-500');
            
            loadOrders();
        };

        // Load orders based on current tab
        async function loadOrders() {
            if (!currentUserId) return;

            const feed = document.getElementById('ordersFeed');
            
            const { data: orders, error } = await supabase
                .from('orders')
                .select('*')
                .eq('vendor_id', currentUserId)
                .eq('status', currentTab)
                .order('created_at', { ascending: false });

            if (error) {
                feed.innerHTML = `<div class="text-center py-12 text-red-500 text-sm">Error loading orders</div>`;
                return;
            }

            // Update queue stats (only show pending count/value when on pending tab)
            if (currentTab === 'pending') {
                const pendingTotal = orders.reduce((sum, o) => sum + (parseFloat(o.total_amount) || 0), 0);
                document.getElementById('pendingCount').innerText = orders.length;
                document.getElementById('pendingTotal').innerText = `₦${pendingTotal.toLocaleString()}`;
            } else {
                // Get pending count from separate query for header
                const { data: pendingOrders } = await supabase
                    .from('orders')
                    .select('total_amount')
                    .eq('vendor_id', currentUserId)
                    .eq('status', 'pending');
                
                const pendingTotal = (pendingOrders || []).reduce((sum, o) => sum + (parseFloat(o.total_amount) || 0), 0);
                document.getElementById('pendingCount').innerText = pendingOrders?.length || 0;
                document.getElementById('pendingTotal').innerText = `₦${pendingTotal.toLocaleString()}`;
            }

            if (orders.length === 0) {
                feed.innerHTML = `
                    <div class="text-center py-16 card-dark">
                        <i data-lucide="package" class="mx-auto text-zinc-700 mb-3" size="32"></i>
                        <p class="text-zinc-600 text-sm font-medium">No ${currentTab} orders</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Render orders
            feed.innerHTML = orders.map(order => {
                const delivery = order.delivery_info || {};
                
                return `
                <div class="order-card p-6 space-y-5">
                    <!-- Header with order code and amount -->
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="bg-zinc-800 text-zinc-400 text-[10px] font-bold px-3 py-1 rounded-full">${order.order_code || 'ORD-' + order.id.slice(0,6)}</span>
                            <h3 class="font-bold text-base mt-2">${delivery.name || 'Customer'}</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold text-sdel">₦${(parseFloat(order.total_amount) || 0).toLocaleString()}</p>
                            <p class="text-[10px] font-semibold text-zinc-500 uppercase">${order.payment_method || 'CASH'}</p>
                        </div>
                    </div>

                    <!-- Delivery details -->
                    <div class="delivery-section">
                        <div class="flex items-center gap-2 text-sdel text-xs font-bold uppercase mb-3">
                            <i data-lucide="map-pin" size="14"></i>
                            <span>Delivery</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-start gap-2">
                                <i data-lucide="user" size="14" class="text-zinc-500 mt-0.5"></i>
                                <span class="text-zinc-300">${delivery.name || 'N/A'}</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i data-lucide="phone" size="14" class="text-zinc-500 mt-0.5"></i>
                                <span class="text-zinc-300">${delivery.phone || 'No phone'}</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i data-lucide="home" size="14" class="text-zinc-500 mt-0.5"></i>
                                <span class="text-zinc-300">${delivery.address || 'N/A'} ${delivery.room ? ', ' + delivery.room : ''}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Items -->
                    <div class="bg-black/40 p-4 rounded-xl border border-white/5">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="shopping-bag" size="14" class="text-sdel"></i>
                            <span class="text-[10px] font-bold text-zinc-500 uppercase">Items</span>
                        </div>
                        <div class="space-y-2">
                            ${(order.items || []).map(item => `
                                <div class="flex justify-between text-sm">
                                    <span class="text-zinc-400">${item.name}</span>
                                    <span class="font-bold text-white">×${item.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${currentTab === 'pending' ? `
                        <!-- Accept/Decline buttons -->
                        <div class="grid grid-cols-2 gap-3 pt-2">
                            <button onclick="handleOrder('${order.id}', 'accepted')" class="accept-btn">Accept</button>
                            <button onclick="handleOrder('${order.id}', 'rejected')" class="decline-btn">Decline</button>
                        </div>
                    ` : `
                        <!-- Status badge for accepted/declined -->
                        <div class="text-center p-4 bg-zinc-900 rounded-xl border border-white/5">
                            <p class="text-xs font-bold uppercase ${currentTab === 'accepted' ? 'text-green-500' : 'text-red-500'}">
                                Order ${currentTab}
                            </p>
                            <p class="text-[10px] text-zinc-600 mt-1">${order.status_message || ''}</p>
                        </div>
                    `}
                </div>
            `}).join('');

            lucide.createIcons();
        }

        // Handle accept/decline
        window.handleOrder = async (orderId, newStatus) => {
            try {
                // Get order details first
                const { data: order, error: fetchError } = await supabase
                    .from('orders')
                    .select('user_id, order_code')
                    .eq('id', orderId)
                    .single();

                if (fetchError) throw fetchError;

                // Update order status
                const { error: updateError } = await supabase
                    .from('orders')
                    .update({ 
                        status: newStatus,
                        status_message: newStatus === 'accepted' ? 'Confirmed' : 'Declined',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', orderId)
                    .eq('vendor_id', currentUserId);

                if (updateError) throw updateError;

                // Send notification to customer
                await supabase.from('messages').insert([{
                    recipient_id: order.user_id,
                    content: `${newStatus === 'accepted' ? '✅ Order accepted' : '❌ Order declined'}\nCode: ${order.order_code}`,
                    type: 'team',
                    sender_id: currentUserId,
                    created_at: new Date().toISOString()
                }]);

                showToast(`Order ${newStatus} successfully`);
                
                // Refresh orders
                loadOrders();

            } catch (error) {
                console.error('Error:', error);
                showToast('Action failed', true);
            }
        };

        // Refresh handler
        window.refreshOrders = () => {
            loadOrders();
            showToast('Orders refreshed');
        };

        // Initialize
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = '/login.html';
                return;
            }
            
            currentUserId = session.user.id;
            document.getElementById('vendorDisplay').innerText = session.user.email || 'Vendor command';
            
            loadOrders();

            // Real-time subscription
            supabase
                .channel('order-updates')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'orders',
                    filter: `vendor_id=eq.${currentUserId}`
                }, () => {
                    loadOrders();
                })
                .subscribe();
        }

        init();
        lucide.createIcons();
    </script>
</body>
    </html>
